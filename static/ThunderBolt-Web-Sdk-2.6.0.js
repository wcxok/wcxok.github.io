!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.WebRTC=e()}}(function(){return function e(t,r,i){function n(o,s){if(!r[o]){if(!t[o]){var u="function"==typeof require&&require;if(!s&&u)return u(o,!0);if(a)return a(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var h=r[o]={exports:{}};t[o][0].call(h.exports,function(e){var r=t[o][1][e];return n(r||e)},h,h.exports,e,t,r,i)}return r[o].exports}for(var a="function"==typeof require&&require,o=0;o<i.length;o++)n(i[o]);return n}({1:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=e("./utils/logger"),o=function(){var e=function(){function e(){i(this,e)}return n(e,null,[{key:"process",value:function(t){t&&(t.reportAllLog&&(e.reportAllLog=!0,a.Logger.setGlobalReportAllLog(!0)),Number.isInteger(t.urlSwitchReconnectCnt)&&(e.urlSwitchReconnectCnt=t.urlSwitchReconnectCnt),Number.isInteger(t.videoPauseThresholdMs)&&(e.videoPauseThresholdMs=t.videoPauseThresholdMs),Number.isInteger(t.videoCheckIntervalMs)&&(e.videoCheckIntervalMs=t.videoCheckIntervalMs),Number.isInteger(t.audioPauseThresholdMs)&&(e.audioPauseThresholdMs=t.audioPauseThresholdMs),Number.isInteger(t.audioFreezeThresholdMs)&&(e.audioFreezeThresholdMs=t.audioFreezeThresholdMs))}}]),e}();return e.reportAllLog=!1,e.urlSwitchReconnectCnt=3,e.videoPauseThresholdMs=5e3,e.videoCheckIntervalMs=50,e.audioPauseThresholdMs=5e3,e.audioFreezeThresholdMs=30,e}();r.AdvanceConfig=o},{"./utils/logger":91}],2:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./utils/utils"),s=i(o),u=e("./utils/logger"),l=i(u),h=e("./utils/browser"),c=i(h),d=function(){var e=function(){function e(t){var r=this;n(this,e),this.webrtc=t,e.getDevices().then(function(){navigator.mediaDevices.ondevicechange=r.checkDeviceChange.bind(r)}).catch(function(){})}return a(e,[{key:"checkDeviceChange",value:function(){var t=this,r=new Map,i=new Map,n=new Map;navigator.mediaDevices.enumerateDevices().then(function(a){a.forEach(function(a){l.default.debug(a.kind+": "+a.label+" id = "+a.deviceId),"audioinput"==a.kind&&(r.set(a.deviceId,a),e.audioInputs.has(a.deviceId)||(e.audioInputs.set(a.deviceId,a),t.trigger("audio_input_changed",{state:"added",deviceId:a.deviceId}))),"videoinput"==a.kind&&(i.set(a.deviceId,a),e.videoInputs.has(a.deviceId)||(e.videoInputs.set(a.deviceId,a),t.trigger("video_input_changed",{state:"added",deviceId:a.deviceId}))),"audiooutput"===a.kind&&(n.set(a.deviceId,a),e.audioOutputs.has(a.deviceId)||(e.audioOutputs.set(a.deviceId,a),t.trigger("audio_output_changed",{state:"added",deviceId:a.deviceId})))});var o=!0,s=!1,u=void 0;try{for(var h,c=e.audioInputs.keys()[Symbol.iterator]();!(o=(h=c.next()).done);o=!0){var d=h.value;r.has(d)||(e.audioInputs.delete(d),t.trigger("audio_input_changed",{state:"removed",deviceId:d}))}}catch(e){s=!0,u=e}finally{try{!o&&c.return&&c.return()}finally{if(s)throw u}}var f=!0,p=!1,v=void 0;try{for(var m,g=e.videoInputs.keys()[Symbol.iterator]();!(f=(m=g.next()).done);f=!0){var y=m.value;i.has(y)||(e.videoInputs.delete(y),t.trigger("video_input_changed",{state:"removed",deviceId:y}))}}catch(e){p=!0,v=e}finally{try{!f&&g.return&&g.return()}finally{if(p)throw v}}var S=!0,b=!1,_=void 0;try{for(var E,T=e.audioOutputs.keys()[Symbol.iterator]();!(S=(E=T.next()).done);S=!0){var d=E.value;n.has(d)||(e.audioOutputs.delete(d),t.trigger("audio_output_changed",{state:"removed",deviceId:d}))}}catch(e){b=!0,_=e}finally{try{!S&&T.return&&T.return()}finally{if(b)throw _}}}).catch(function(e){t.webrtc.logger.error("webRtc.listenDevicesChange err:"+e.name+": "+e.message)})}},{key:"trigger",value:function(e,t){this.webrtc.trigger(e,t)}}],[{key:"detectDevice",value:function(e,t){return l.default.info("WebRTC.detectDevice("+s.default.argToString(e)+","+s.default.argToString(t)+")",!0),Promise.resolve().then(function(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return Promise.reject("NOT_SUPPORTED");var r=!0;if(t){if("string"!=typeof t)return Promise.reject("INVALID_DEVICE_ID");r={deviceId:{exact:t}}}var i=void 0;if("audio"===e)i={audio:r};else{if("video"!==e)return Promise.reject("INVALID_KIND");i={video:r}}return navigator.mediaDevices.getUserMedia(i).then(function(e){e.getTracks().forEach(function(e){e.stop()})}).catch(function(e){return Promise.reject(s.default.mediaErrorToString(e))})}).catch(function(e){return l.default.gError("WebRTC.detectDevice() fail: "+e),Promise.reject({error:e})})}},{key:"getAudioDevices",value:function(t){return e.getAudioDevicesInternal().then(function(r){return c.default.isWeChat&&0!==r.length&&""!==r[0].deviceId?r:!t||0!==r.length&&""!==r[0].label?r:e.detectDevice("audio").then(function(){return e.getAudioDevicesInternal()})})}},{key:"getVideoDevices",value:function(t){return e.getVideoDevicesInternal().then(function(r){return c.default.isWeChat&&0!==r.length&&""!==r[0].deviceId?r:!t||0!==r.length&&""!==r[0].label?r:e.detectDevice("video").then(function(){return e.getVideoDevicesInternal()})})}},{key:"getAudioDevicesInternal",value:function(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return l.default.gError("WebRTC.getAudioDevices enumerateDevices() not supported."),Promise.reject({error:"NOT_SUPPORTED"});var e=[];return navigator.mediaDevices.enumerateDevices().then(function(t){return t.forEach(function(t){l.default.debug(t.kind+": "+t.label+" id = "+t.deviceId),"audioinput"==t.kind&&e.push(t)}),e}).catch(function(e){return l.default.gError("WebRTC.getAudioDevices err:"+e.name+": "+e.message),Promise.reject({error:"NOT_SUPPORTED"})})}},{key:"getVideoDevicesInternal",value:function(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return l.default.gError("WebRTC.getVideoDevices enumerateDevices() not supported."),Promise.reject({error:"NOT_SUPPORTED"});var e=[];return navigator.mediaDevices.enumerateDevices().then(function(t){return t.forEach(function(t){l.default.debug(t.kind+": "+t.label+" id = "+t.deviceId),"videoinput"==t.kind&&e.push(t)}),e}).catch(function(e){return l.default.gError("WebRTC.getVideoDevices err:"+e.name+": "+e.message),Promise.reject({error:"NOT_SUPPORTED"})})}},{key:"getPlayoutDevices",value:function(){return c.default.isSafari?Promise.reject({error:"NOT_SUPPORTED"}):navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(e){return e.filter(function(e){return"audiooutput"===e.kind})}).catch(function(e){return l.default.gError("WebRTC.getAudioDevices err:"+e.name+": "+e.message),Promise.reject({error:"NOT_SUPPORTED"})}):(l.default.gError("WebRTC.getAudioDevices enumerateDevices() not supported."),Promise.reject({error:"NOT_SUPPORTED"}))}},{key:"getDevices",value:function(){return e.audioInputs.clear(),e.videoInputs.clear(),navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(t){return t.forEach(function(t){l.default.debug(t.kind+": "+t.label+" id = "+t.deviceId),"audioinput"==t.kind&&e.audioInputs.set(t.deviceId,t),"videoinput"==t.kind&&e.videoInputs.set(t.deviceId,t),"audiooutput"===t.kind&&e.audioOutputs.set(t.deviceId,t)}),t}).catch(function(e){return l.default.gError("WebRTC.getAudioDevice err: "+e.name+": "+e.message),Promise.reject({error:"NOT_SUPPORTED"})}):(l.default.gError("WebRTC.getAudioDevices enumerateDevices() not supported."),Promise.reject({error:"NOT_SUPPORTED"}))}}]),e}();return e.audioInputs=new Map,e.videoInputs=new Map,e.audioOutputs=new Map,e}();r.default=d,t.exports=r.default},{"./utils/browser":90,"./utils/logger":91,"./utils/utils":93}],3:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t,r,i){return{constraints:{width:{ideal:e},height:{ideal:t},frameRate:r},bitrate:i,minBitrate:arguments.length<=4||void 0===arguments[4]?120:arguments[4]}}function s(e,t,r,i,n,a){return{encode:e,bitrate:t,fps:r,gop:i,height:n,width:a}}function u(e,t,r,i){return{encode:e,bitrate:t,sample:r,channel:i}}function l(e){if(!e)throw"INVALID_CONFIG";if(!h(e.bitrate,1,1e4))throw"INVALID_BITRATE";if(void 0!==e.minBitrate&&!h(e.minBitrate,1,e.bitrate))throw"INVALID_MIN_BITRATE";if(!h(e.frameRate,1,100))throw"INVALID_FRAME_RATE";if(!h(e.width,2,4096))throw"INVALID_WIDTH";if(!h(e.height,2,4096))throw"INVALID_HEIGHT"}function h(e,t,r){return Number.isInteger(e)&&e>=t&&e<=r}function c(e){return"number"==typeof e.ideal?e.ideal:"number"==typeof e?e:0}function d(e,t){var r=c(e.width),i=c(e.height),n=c(t.width),a=c(t.height);if(0!==r&&0!==i&&0!==n&&0!==a){var o=f(r,i,n,a,E.default.os.isMobile),s=p(o,2),u=s[0],l=s[1];t.width={ideal:u},t.height={ideal:l},E.default.os.isMobile&&c(t.frameRate)>15&&(t.frameRate=15)}}function f(e,t,r,i,n){return n&&r>200&&(r=200),i=Math.round(t*r/e),i%2&&(i+=1),[r,i]}Object.defineProperty(r,"__esModule",{value:!0});var p=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),v=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();r.adjustLowResolution=f;var m=e("./utils/timeUtil"),g=i(m),y=e("./constant"),S=i(y),b=e("./AdvanceConfig"),_=e("./utils/browser"),E=i(_),T=S.default.AUDIO_MODE,I=function(){function e(t,r){var i,l=this;a(this,e),this.logger=t,this.videoCodec=r,this.videoModes=[3,1],this.audioMode=T.STANDARD,this.AEC=!!E.default.os.isMobile&&void 0,this.isDefaultConfig=!1,this.videoConfigs={1:o(320,240,15,200,120),2:o(640,480,15,500,300),3:o(960,544,24,1e3,300),4:o(1280,720,24,1600,300),5:o(1920,1080,24,4500,300)},this.audioConfigs=(i={},n(i,T.LOW,{useInBandFEC:!0,useDtx:!1,stereo:!1,bitrate:24}),n(i,T.STANDARD,{useInBandFEC:!0,useDtx:!1,stereo:!1,bitrate:void 0}),n(i,T.HIGH,{useInBandFEC:!0,useDtx:!1,stereo:!1,bitrate:128}),n(i,T.HIGH_STEREO,{useInBandFEC:!0,useDtx:!1,stereo:!0,bitrate:192}),i),this.lianmaiVideoParam=new Map,this.lianmaiVideoParam.set(1,s(100,150,15,30,180,320)),this.lianmaiVideoParam.set(2,s(100,200,15,30,240,320)),this.lianmaiVideoParam.set(3,s(100,500,15,30,360,640)),this.lianmaiVideoParam.set(4,s(100,500,15,30,480,640)),this.lianmaiVideoParam.set(5,s(100,1e3,24,48,544,960)),this.lianmaiVideoParam.set(6,s(100,2500,24,48,720,1280)),this.lianmaiVideoParam.set(7,s(100,4500,24,48,1080,1920)),this.lianmaiVideoParam.set(101,s(100,150,15,30,320,180)),this.lianmaiVideoParam.set(102,s(100,200,15,30,320,240)),this.lianmaiVideoParam.set(103,s(100,500,15,30,640,360)),this.lianmaiVideoParam.set(104,s(100,500,15,30,640,480)),this.lianmaiVideoParam.set(105,s(100,1e3,24,48,960,544)),this.lianmaiVideoParam.set(106,s(100,2500,24,48,1280,720)),this.lianmaiVideoParam.set(107,s(100,4500,24,48,1920,1080)),this.lianmaiAudioParam=new Map,this.lianmaiAudioParam.set(1,u(1,128,44100,2)),this.lianmaiAudioParam.set(2,u(1,128,44100,2)),this.lianmaiAudioParam.set(3,u(1,128,44100,2)),this.lianmaiAudioParam.set(4,u(1,128,44100,2)),this.lianmaiAudioParam.set(5,u(1,128,44100,2)),this.lianmaiAudioParam.set(6,u(1,128,44100,2)),this.lianmaiAudioParam.set(7,u(1,128,44100,2)),this.lianmaiAudioParam.set(101,u(1,128,44100,2)),this.lianmaiAudioParam.set(102,u(1,128,44100,2)),this.lianmaiAudioParam.set(103,u(1,128,44100,2)),this.lianmaiAudioParam.set(104,u(1,128,44100,2)),this.lianmaiAudioParam.set(105,u(1,128,44100,2)),this.lianmaiAudioParam.set(106,u(1,128,44100,2)),this.lianmaiAudioParam.set(107,u(1,128,44100,2)),this.gotConfigPromise=new Promise(function(e){l.gotConfigResolve=e}),this.seqNum=0}return v(e,[{key:"gotConfig",value:function(){return this.gotConfigPromise}},{key:"getAudioConstrains",value:function(){var e=this.audioConfigs[this.audioMode],t=e.constraints;return t||(t={sampleRate:this.audioSampleRate},t.channelCount=2),void 0!==this.AGC&&(t.autoGainControl=this.AGC),void 0!==this.AEC&&(t.echoCancellation=this.AEC),void 0!==this.ANS&&(t.noiseSuppression=this.ANS),JSON.parse(JSON.stringify(t))}},{key:"getOpusSdpLine",value:function(){var e="minptime=10",t=this.audioConfigs[this.audioMode];return e+=";usedtx="+(t.useDtx?1:0),t.useInBandFEC&&(e+=";useinbandfec=1"),t.stereo&&(e+=";stereo=1;sprop-stereo=1"),t.bitrate&&(e+=";maxaveragebitrate="+1e3*t.bitrate),e}},{key:"getVideoBitrate",value:function(e){try{return this.videoConfigs[this.videoModes[e]].bitrate}catch(t){return this.logger.warn("can not get video bitrate of layer "+e),0}}},{key:"getVideoMinBitrate",value:function(e){try{return this.videoConfigs[this.videoModes[e]].minBitrate}catch(t){return this.logger.warn("can not get video bitrate of layer "+e),0}}},{key:"getVideoMode",value:function(e){return this.videoModes[e]}},{key:"getVideoConstraints",value:function(e){return 0===e?this.getVideoConstraintsByMode(this.videoModes[e]):this.getLowVideoConstraintsByMode(this.videoModes[e])}},{key:"getVideoConstraintsByMode",value:function(e){if(this.videoConfigs[e])try{return JSON.parse(JSON.stringify(this.videoConfigs[e].constraints))}catch(e){throw"CONFIG_ERROR"}}},{key:"getLowVideoConstraintsByMode",value:function(e){var t=this.getVideoConstraints(0),r=this.getVideoConstraintsByMode(e);if(t&&r)return d(t,r),r}},{key:"getLianmaiAudioConfig",value:function(e){return this.lianmaiAudioParam.get(e)}},{key:"getLianmaiVideoConfig",value:function(e){return this.lianmaiVideoParam.get(e)}},{key:"getWebSingleConfig",value:function(e){var t=this,r=new XMLHttpRequest,i=1==e.userArea?"https://argoapi.livemediav.com/configs/httpQuery":"https://argoapi.jocloud.com/configs/httpQuery";i+="?uid="+String(e.uid)+"&appid="+String(e.appid)+"&channelId="+String(e.channel_id)+"&timeStamp="+String(g.default.utc())+"&seqNum="+String(this.seqNum++),r.open("POST",i,!0),r.timeout=this.isDefaultConfig?1e4:3e3,r.setRequestHeader("Content-Type","application/json;charset=utf-8");var n={module:"sdk",profiles:e,scope:"keys",keys:[["Web_single",null],["Web_lianmai",null],["Web_advance",null]]},a=this;r.onload=function(){if(r.status>=200&&r.status<400){a.isDefaultConfig=!1;var e=r.responseText;a.logger.info("PublishConfigMgr.getWebSingleConfig:"+e.replace(/\s/g,""),!0);var i=JSON.parse(e),n=i.configs,o=!0,s=!1,u=void 0;try{for(var l,h=n[Symbol.iterator]();!(o=(l=h.next()).done);o=!0){var c=l.value,d=c[2];if("Web_single"===d){var f=c[3],p=JSON.parse(f);p.audio&&t.updateAudioConfigFromArgo(p.audio),p.video&&t.updateVideoConfigFromArgo(p.video)}else if("Web_lianmai"===d){var v=c[3],m=JSON.parse(v),g=!0,y=!1,S=void 0;try{for(var b,_=m.config[Symbol.iterator]();!(g=(b=_.next()).done);g=!0){var E=b.value;a.lianmaiVideoParam.set(E.id,E.video_param),a.lianmaiAudioParam.set(E.id,E.audio_param)}}catch(e){y=!0,S=e}finally{try{!g&&_.return&&_.return()}finally{if(y)throw S}}a.logger.info("PublishConfigMgr.getWebLianmaiConfig lianmai audio:"+a.lianmaiAudioParam.size+" video:"+a.lianmaiVideoParam.size,!0)}else"Web_advance"===d&&"string"==typeof c[3]&&t.processArgoAdvanceConfig(c[3])}}catch(e){s=!0,u=e}finally{try{!o&&h.return&&h.return()}finally{if(s)throw u}}}a.gotConfigResolve()},r.onerror=function(){a.logger.error("PublishConfigMgr.getWebSingleConfig unable to get Web_Single error"),a.setDefaultConfigs(),a.gotConfigResolve()},r.ontimeout=function(){a.logger.error("PublishConfigMgr.getWebSingleConfig unable to get Web_Single timeout"),a.setDefaultConfigs(),a.gotConfigResolve()},r.send(JSON.stringify(n))}},{key:"updateAudioConfigFromArgo",value:function(e){var t=!0,r=!1,i=void 0;try{for(var n,a=e[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;this.audioConfigs[o.id]=Object.assign(this.audioConfigs[o.id]||{},o)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}},{key:"updateVideoConfigFromArgo",value:function(e){var t=!0,r=!1,i=void 0;try{for(var n,a=e[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;this.videoConfigs[o.id]=Object.assign(this.videoConfigs[o.id]||{},o)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}},{key:"setAudioMode",value:function(e){if(!this.audioConfigs[e])throw"INVALID_AUDIO_MODE";this.audioMode=e}},{key:"setVideoMode",value:function(e,t){var r=arguments.length<=2||void 0===arguments[2]?"INVALID_VIDEO_MODE":arguments[2];if(!this.videoConfigs[t])throw r;this.checkSystemRestrict(t),e>0&&this.checkVideoModeOrder(this.getVideoMode(e-1),t),this.videoModes[e]=t}},{key:"checkVideoModeOrder",value:function(e,t){var r=this.getVideoConstraintsByMode(e),i=this.getVideoConstraintsByMode(t);if(!r||!i)throw"INVALID_VIDEO_MODE";if(c(i.width)>=c(r.width)||c(i.height)>=c(r.height))throw"VIDEO_MODE_OUT_OF_ORDER"}},{key:"checkSystemRestrict",value:function(e){var t=this.getVideoConstraintsByMode(e),r=c(t.height);this.checkSystemRestrictOfHeight(r)}},{key:"checkSystemRestrictOfHeight",value:function(e){if(E.default.os.isIOS&&e>720&&"H264"===this.videoCodec)throw this.logger.warn("iOS H264 supports a maximum resolution of 1280*720"),"IOS_NOT_SUPPORTED"}},{key:"setVideoEncoderConfig",value:function(e,t,r){try{var i=1e3+e;return l(t),this.checkSystemRestrictOfHeight(t.height),this.videoConfigs[i]=o(t.width,t.height,t.frameRate,t.bitrate,t.minBitrate),this.setVideoMode(e,i),e+1<r&&this.checkVideoModeOrder(i,this.getVideoMode(e+1)),null}catch(e){return{error:e}}}},{key:"setDefaultConfigs",value:function(){this.isDefaultConfig||(this.isDefaultConfig=!0)}},{key:"processArgoAdvanceConfig",value:function(e){try{var t=JSON.parse(e);b.AdvanceConfig.process(t)}catch(e){this.logger.warn("processArgoAdvanceConfig error: "+e)}}},{key:"audioSampleRate",get:function(){return 48e3}},{key:"audioBitrate",get:function(){var e=this.audioConfigs[this.audioMode];return e.bitrate?e.bitrate:40}},{key:"audioChannel",get:function(){return this.isStereo?2:1}},{key:"isStereo",get:function(){return this.audioConfigs[this.audioMode].stereo}}]),e}();r.ProfileMgr=I},{"./AdvanceConfig":1,"./constant":10,"./utils/browser":90,"./utils/timeUtil":92}],4:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("./protobase/uri"),u=i(s),l=e("./protocol/streamSvr/PAnchorStartLive"),h=i(l),c=e("./protocol/streamSvr/PAnchorStartLiveRes"),d=i(c),f=e("./protocol/streamSvr/PAnchorStopLive"),p=i(f),v=e("./protocol/streamSvr/PAnchorStopLiveRes"),m=i(v),g=e("./protobase/ProtoUInt64"),y=i(g),S=e("./utils/timeUtil"),b=i(S),_=e("./protocol/streamSvr/StreamSvrEnum"),E=e("./protocol/streamSvr/StreamAttrDescript"),T=i(E),I=e("./protocol/streamSvr/PS3ChannelPushMsg"),R=i(I),A=e("./protocol/streamSvr/PQueryChannelStreams"),k=i(A),P=e("./protocol/streamSvr/PQueryChannelStreamsRes"),M=i(P),C=e("./apchannel/ApH5"),w=i(C),U=e("long"),O=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(U),L=e("./protocol/streamSvr/ChannelTranscoding"),N=i(L),D=e("./protocol/streamSvr/UserLayout"),V=i(D),x=e("./utils/utils"),K=i(x),j=e("./protocol/streamSvr/PRTMPStreamNotify2Service"),B=i(j),F=function(){function e(t){n(this,e),this.checkTimer=null,this.webRtcMgr=t,this.publisherMgr=this.webRtcMgr.publisherMgr,this.logger=t.logger,this.startNotify=!1,this.handleDic=new Map,this.addHandle(u.default.URI_STEAM_PAnchorStartLiveRes,this.onPAnchorStartLiveRes.bind(this)),this.addHandle(u.default.URI_STEAM_PAnchorStopLiveRes,this.onPAnchorStopLiveRes.bind(this)),this.addHandle(u.default.URI_STEAM_PQueryChannelStreamsRes,this.onPQueryChannelStreamsRes.bind(this)),this.checkTimes=0,this.bQuery=!1,this.originPushUrl=new Set,this.transCodePushUrl=new Map,this.urlToPushStreamInfo=new Map,this.transcodingTasks=new Map,this.substream=new Map,this.transcodingUserStream=new Map,this.apH5=null}return o(e,[{key:"onCheckTimer",value:function(){this.checkTimes++;var e=b.default.now();this.checkTimes%5==0&&(this.checkQuery(),this.startNotify&&this.notifyLive()),this.apH5.onCheckTimer(this.checkTimes,e)}},{key:"addHandle",value:function(e,t){this.handleDic.set(e,t)}},{key:"onProto",value:function(e,t){var r=this.handleDic.get(e);null!==r&&void 0!==r?r(t):this.logger.info("StreamSvr.onProto UNKNOWN uri="+e)}},{key:"onPAnchorStartLiveRes",value:function(e){var t=new d.default;t.unmarshall(e),t.result?this.logger.info("StreamSvr.onPAnchorStartLiveRes result:"+t.result+" channelId:"+t.channelId+" ctxId:"+JSON.stringify(t.ctxId)+" stream size:"+t.streams.size):this.logger.debug("StreamSvr.onPAnchorStartLiveRes result:"+t.result+" channelId:"+t.channelId+" ctxId:"+JSON.stringify(t.ctxId)+" stream size:"+t.streams.size)}},{key:"onPAnchorStopLiveRes",value:function(e){var t=new m.default;t.unmarshall(e),this.logger.info("StreamSvr.onPAnchorStopLiveRes result:"+t.result+" channelId:"+t.channelId+" ctxId:"+JSON.stringify(t.ctxId))}},{key:"onPQueryChannelStreamsRes",value:function(e){var t=new M.default;t.unmarshall(e),this.logger.info("StreamSvr.onPQueryChannelStreamsRes: "+JSON.stringify(t)),this.bQuery=!0;var r=t.appid.low;return this.transcodingUserStream.has(t.channelId)&&this.updateTranscodingUserStream(t.channelId,t.version,t.userStreams,t.speakers),t.channelId==this.webRtcMgr.channelId||this.substream.has(t.channelId)?this.webRtcMgr.pureAudio?void this.logger.debug("StreamSvr.onPQueryChannelStreamsRes, pureAudio mode don't receive remoteStreamInfo, channelId:"+t.channelId):void this.updateChannelStreams(r,t.channelId,t.userStreams,t.speakers,t.userStreamsExt,t.version):void this.logger.info("StreamSvr.onPQueryChannelStreamsRes this channelId:"+t.channelId+" has not subscribe")}},{key:"updateTranscodingUserStream",value:function(t,r,i,n){this.logger.debug("StreamSvr.updateTranscodingUserStream channelId:"+t);var o=this.transcodingUserStream.get(t),s=!1;if(o.version.lower(r)){o.version=new y.default(r.high,r.low);var u=!0,l=!1,h=void 0;try{for(var c,d=i.entries()[Symbol.iterator]();!(u=(c=d.next()).done);u=!0){var f=a(c.value,2),p=f[0],v=f[1],m=v.uid.low,g="";if(g=v.extend.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_EXTERNALUID)?v.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_EXTERNALUID):String(m),m==this.webRtcMgr.uid&&g!=this.webRtcMgr.uidStr)return void this.webRtcMgr.resetUid();if(this.logger.debug("StreamSvr.updateTranscodingUserStream uid:"+m+" uidStr:"+g+" streamName:"+p),o.userStreams.has(g)){var S=o.userStreams.get(g);if(!S)continue;if(S.uid=m,S.streamAttr.has(p)){var b=S.streamAttr.get(p);if(this.logger.debug("StreamSvr.updateTranscodingUserStream1 uid:"+m+" streamName:"+p+" l_attr:"+K.default.stringfyMap(b.attr)+" n_attr:"+K.default.stringfyMap(v.extend)),!T.default.attrCompareInfo(b.attr,v.extend)){var E=e.createStreamAttrDescript(v.extend);S.streamAttr.set(p,E),s=!0}}else{var E=e.createStreamAttrDescript(v.extend);S.streamAttr.set(p,E),s=!0}}}}catch(e){l=!0,h=e}finally{try{!u&&d.return&&d.return()}finally{if(l)throw h}}}var I=!0,R=!1,A=void 0;try{for(var k,P=o.userStreams.entries()[Symbol.iterator]();!(I=(k=P.next()).done);I=!0){var M=a(k.value,2),C=M[1],w=!0,U=!1,O=void 0;try{for(var L,N=C.streamAttr.entries()[Symbol.iterator]();!(w=(L=N.next()).done);w=!0){var D=a(L.value,1),p=D[0];i.has(p)||(C.streamAttr.delete(p),s=!0)}}catch(e){U=!0,O=e}finally{try{!w&&N.return&&N.return()}finally{if(U)throw O}}}}catch(e){R=!0,A=e}finally{try{!I&&P.return&&P.return()}finally{if(R)throw A}}s&&(this.updateLiveVersion(),this.notifyLive())}},{key:"triggerPushStreamStatus",value:function(e){var t=void 0;switch(e.action){case j.PUSH_STREAM_STATUS.PUSH_STATUS_SUCCESS:t="PUSH_STREAM_ONGOING";break;case j.PUSH_STREAM_STATUS.PUSH_STATUS_FAILED:t="PUSH_STREAM_FAILED";break;case j.PUSH_STREAM_STATUS.PULL_STATUS_FAILED:t="INTERNEL_ERROR";break;case j.PUSH_STREAM_STATUS.PUSH_STATUS_FINISHED:t="PUSH_STREAM_FINISHED";break;default:t="UNKNOWN_STATUS"}if(this.urlToPushStreamInfo.has(e.url)){var r=this.urlToPushStreamInfo.get(e.url);if(r.status!==t)if(r.isPush){var i={url:e.url,status:t,reason:""};"PUSH_STREAM_FINISHED"===t&&(this.publisherMgr.published||(i.reason="STREAM_IS_UNPUBLISHED"),e.taskName.length&&!this.transcodingTasks.get(e.taskName)&&(i.reason="TASK_IS_STOPPED")),this.webRtcMgr.webrtc.trigger("push_stream_status",i),r.status=t}else if(!r.isPush&&"PUSH_STREAM_FINISHED"===t){var i={url:e.url,status:t,reason:"URL_IS_REMOVED"};this.webRtcMgr.webrtc.trigger("push_stream_status",i),this.urlToPushStreamInfo.delete(e.url)}}}},{key:"onPRTMPStreamNotify",value:function(e){var t=new B.default;if(t.unmarshall(e),this.logger.debug("StreamSvr.onPRTMPStreamNotify: "+JSON.stringify(t)),t.uid.low===this.webRtcMgr.uid||t.taskName.length)return void this.triggerPushStreamStatus(t)}},{key:"onPS3ChannelPushMsg",value:function(e){var t=new R.default;if(t.unmarshall(e),this.logger.debug("StreamSvr.onPS3ChannelPushMsg: "+JSON.stringify(t)),!1===this.bQuery)return void this.logger.info("StreamSvr.onPS3ChannelPushMsg has not join success");var r=t.appid.low;return r!=this.webRtcMgr.appid?void this.logger.info("StreamSvr.onPS3ChannelPushMsg invaild appid:"+r):(this.transcodingUserStream.has(t.channelId)&&this.updateTranscodingUserStream(t.channelId,t.timestamp,t.userStreams,t.speakers),t.channelId==this.webRtcMgr.channelId||this.substream.has(t.channelId)?this.webRtcMgr.pureAudio?void this.logger.debug("StreamSvr.onPS3ChannelPushMsg, pureAudio mode don't receive remoteStreamInfo, channelId:"+t.channelId):void this.updateChannelStreams(r,t.channelId,t.userStreams,t.speakers,t.userStreamsExt,t.timestamp):void this.logger.debug("StreamSvr.onPS3ChannelPushMsg this channelId:"+t.channelId+" has not subscribe"))}},{key:"updateChannelStreams",value:function(e,t,r,i,n,o){var s=this;this.logger.debug("updateChannelStreams channelId:"+t+" userStream:"+r.size+" speakers:"+i.length);var u=this.webRtcMgr.uid,l="",h=this.substream.get(t),c=new Map,d=!0,f=!1,p=void 0;try{for(var v,m=r[Symbol.iterator]();!(d=(v=m.next()).done);d=!0){var g=function(){var r=a(v.value,2),i=r[0],d=r[1];if(d.streamType===_.InputSourceTypeEnum.VIDEO)l="video";else if(d.streamType===_.InputSourceTypeEnum.AUDIO)l="audio";else{if(d.streamType!==_.InputSourceTypeEnum.GROUP)return s.logger.warn("streamName: "+i+" has not support streamType:"+d.streamType),"continue";l="group"}var f=d.uid.low,p=[],m="";if(m=d.extend.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_EXTERNALUID)?d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_EXTERNALUID):String(f),f==u&&m!=s.webRtcMgr.uidStr)return s.webRtcMgr.resetUid(),{v:void 0};if(m==s.webRtcMgr.uidStr)return"continue";if(t!=s.channelId){var g=!0;if(h.forEach(function(e){if(e==m)return void(g=!1)}),g)return"continue"}var y=void 0;if("video"==l){n.forEach(function(e,t){var r=e.uid.low,i=Number(e.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_DUAL_SMALL)),n=Number(e.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_WIDTH)),a=Number(e.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_HEIGHT)),o=Number(e.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_BIT_RATE)),s=Number(e.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_FRAME_RATE)),u=e.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_ENCODE);u===String(_.CodecType.VIDEO_H265)?u="H265":u===String(_.CodecType.VIDEO_H264)?u="H264":u===String(_.CodecType.VIDEO_VP8)&&(u="VP8"),r==f&&p.push({layerIndex:i,streamName:t,streamType:l,speakerUidId:f,streamParam:{width:n,height:a,bitrate:o,frameRate:s,codec:u}})});var S=d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_ENCODE),b=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_WIDTH)),E=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_HEIGHT)),T=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_BIT_RATE)),I=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_FRAME_RATE));S===String(_.CodecType.VIDEO_H265)?S="H265":S===String(_.CodecType.VIDEO_H264)?S="H264":S===String(_.CodecType.VIDEO_VP8)&&(S="VP8"),y={width:b,height:E,bitrate:T,frameRate:I,codec:S}}else if("audio"==l){var R=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_SAMPLE)),A=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_CHANNEL)),T=Number(d.extend.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_BIT_RATE));y={sampleRate:R,channel:A,bitrate:T}}var k={appid:e,channelId:t,speakerUid:m,speakerUidId:f,streamType:l,streamName:i,streamParam:y,dualStream:p,defaultLayer:0,version:o,timestamp:Date.now()},P=k.appid.toString()+"_"+k.speakerUidId.toString(),M=c.get(P);M?M.push(k):c.set(P,[k])}();switch(g){case"continue":continue;default:if("object"==typeof g)return g.v}}}catch(e){f=!0,p=e}finally{try{!d&&m.return&&m.return()}finally{if(f)throw p}}this.webRtcMgr.subscriberMgr.updateChannelStreams(t,c)}},{key:"start",value:function(e){this.logger.info("StreamSvr.start chanelId:"+e,!0),this.channelId=e,this.checkTimer=window.setInterval(this.onCheckTimer.bind(this),1e3),this.apH5=new w.default(this,this.webRtcMgr.appid,this.channelId,this.webRtcMgr.uid,this.webRtcMgr.webrtc.git,this.webRtcMgr.userArea),this.apH5.start()}},{key:"stop",value:function(){this.logger.info("StreamSvr.stop",!0),window.clearInterval(this.checkTimer),this.checkTimer=null,this.stopLive(),this.clearPublishOriginStreamUrl(),this.clearSubscribe(),this.clearPublishTranscodingStreamUrl(),this.clearLiveTranscodingTask(),this.clearPushStreamInfo(),this.apH5&&this.apH5.stop(),this.bQuery=!1}},{key:"updateLiveVersion",value:function(){var e=O.fromString(Date.now().toString());this.liveversion=new y.default(e.high,e.low)}},{key:"startLive",value:function(){this.logger.info("StreamSvr.startLive channelId:"+this.channelId),this.startNotify=!0,this.updateLiveVersion(),this.notifyLive()}},{key:"notifyAudio",value:function(e){var t=this.webRtcMgr.appid,r=this.publisherMgr.publishers.get(0);if(r&&""!==r.audioStreamName){var i=r.audioStreamName,n=r.audioParam;if(n){
var a=n.bitrate,o=n.sampleRate,s=n.channel,u=n.codec,l=new T.default;l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_EXT_UID,this.webRtcMgr.uidStr),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_STREAM_NAME,i),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_STREAM_TYPE,""+_.InputSourceTypeEnum.AUDIO),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_APPID,""+t),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_BIT_RATE,""+a),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_ENCODE_TYPE,""+u),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_SAMPLE,""+o),l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_CHANNEL,""+s),this.webRtcMgr.pureAudio&&l.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_GROUP,"1"),e.streams.set(i,l)}else this.logger.warn("StreamSvr.notifyAudio unable to get audio param")}}},{key:"notifyVideo",value:function(e){if(!this.webRtcMgr.pureAudio)for(var t=this.webRtcMgr.appid,r=0;r<this.publisherMgr.size;r++){var i=this.publisherMgr.publishers.get(r),n=i.videoStreamName;if(""!==n){var a=i.videoParam;if(a){var o=a.width,s=a.height,u=a.bitrate,l=a.frameRate,h=a.codec,c=new T.default;if(c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_EXT_UID,this.webRtcMgr.uidStr),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_STREAM_NAME,n),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_STREAM_TYPE,""+_.InputSourceTypeEnum.VIDEO),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_APPID,""+t),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_FRAME_RATE,""+l),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_BIT_RATE,""+u),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_WIDTH,""+o),c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_HEIGHT,""+s),"VP8"==this.webRtcMgr.pubCodec?c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_ENCODE_TYPE,""+_.CodecType.VIDEO_VP8):c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_ENCODE_TYPE,""+h),0==r){var d=this.getPublishOriginStreamUrl();d.length&&c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_RTMP_URL,d)}else c.attr.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_DUAL_SMALL,""+r);e.streams.set(n,c)}}}}},{key:"notifyTransCodeTask",value:function(e){var t=this;if(!this.webRtcMgr.pureAudio){var r=this.webRtcMgr.uidStr,i=!0,n=!1,o=void 0;try{for(var s,u=this.transcodingTasks.entries()[Symbol.iterator]();!(i=(s=u.next()).done);i=!0)!function(){var r=a(s.value,2),i=r[0],n=r[1],o=new N.default,u=t.webRtcMgr.profileMgr.getLianmaiVideoConfig(n.transcodingMode),l=t.webRtcMgr.profileMgr.getLianmaiAudioConfig(n.transcodingMode),h={video:u,audio:l};o.userParam.set(1,JSON.stringify(h)),n.extConfig&&o.userParam.set(24,n.extConfig);var c=t.getPublishTranscodingStreamUrl(i);c.length&&(t.logger.debug("StreamSvr.notifyTransCodeTask taskId:"+i+" url:"+c),o.userParam.set(20,c)),n.userList&&n.userList.forEach(function(e){var r=new V.default;if(void 0!=e.layoutX&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_X,""+e.layoutX),void 0!=e.layoutY&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_Y,""+e.layoutY),void 0!=e.layoutW&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_WIDTH,""+e.layoutW),void 0!=e.layoutH&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_HEIGHT,""+e.layoutH),void 0!=e.zOrder&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_MIC_NO,""+e.zOrder),void 0!=e.bCrop&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_CROP,""+e.bCrop),void 0!=e.cropX&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_CROPRECT_X,""+e.cropX),void 0!=e.cropY&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_CROPRECT_Y,""+e.cropY),void 0!=e.cropW&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_CROPRECT_W,""+e.cropW),void 0!=e.cropH&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_CROPRECT_H,""+e.cropH),void 0!=e.alpha&&r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_ALPHA_DEGREE,""+e.alpha),void 0!=e.bStandard){var a=e.bStandard?1:0;r.params.set(_.UserLayoutEnum.USER_LAYOUT_KEY_TIME_BASELINE,""+a)}var s=t.transcodingUserStream.get(e.roomId);if(s){var u=s.userStreams.get(e.uid),l=new y.default(0,u.uid);0!=l.low&&o.userLayout.set(l,r),t.logger.debug("StreamSvr.notifyTransCodeTask taskId"+i+" uid:"+l.low+" pamra:"+K.default.stringfyMap(r.params)+" channelAvcConfig:"+JSON.stringify(h)+" extConfig:"+n.extConfig)}}),e.transcodings.set(i,o)}()}catch(e){n=!0,o=e}finally{try{!i&&u.return&&u.return()}finally{if(n)throw o}}var l=!0,h=!1,c=void 0;try{for(var d,f=this.transcodingUserStream.entries()[Symbol.iterator]();!(l=(d=f.next()).done);l=!0){var p=a(d.value,2),v=p[1],m=!0,g=!1,S=void 0;try{for(var b,E=v.userStreams[Symbol.iterator]();!(m=(b=E.next()).done);m=!0){var T=a(b.value,2),I=T[0],R=T[1];if(I!=r){var A=new y.default(0,R.uid);e.otherUserStreams.set(A,R.streamAttr)}}}catch(e){g=!0,S=e}finally{try{!m&&E.return&&E.return()}finally{if(g)throw S}}}}catch(e){h=!0,c=e}finally{try{!l&&f.return&&f.return()}finally{if(h)throw c}}this.logger.debug("StreamSvr.notifyTransCodeTask version: t_size:"+e.transcodings.size+" s_size:"+e.otherUserStreams.size)}}},{key:"notifyLive",value:function(){if(this.startNotify){this.logger.debug("StreamSvr.NotifyLive version:"+this.liveversion.low+" channelId:"+this.channelId);var e=new h.default,t=this.webRtcMgr.uid,r=this.webRtcMgr.uidStr,i=this.webRtcMgr.appid;e.uid=new y.default(0,t),e.appid=new y.default(0,i),e.version=this.liveversion,e.channelId=this.channelId,e.userInfo.userParam.set(_.ChannelUserKeyEnum.CHANNEL_USER_KEY_ROOM_ID,this.channelId),e.userInfo.userParam.set(_.ChannelUserKeyEnum.CHANNEL_USER_KEY_IS_OWNER,"1"),e.userInfo.userParam.set(_.ChannelUserKeyEnum.CHANNEL_USER_KEY_UNIQ_CHANNEL,"1"),e.extend.set(_.PAnchorStartLiveKeyEnum.EXTEND_KEY_EXTERNALUID,r),this.notifyAudio(e),this.notifyVideo(e),this.notifyTransCodeTask(e),e.speakers.push(e.uid),this.apH5.sendStreamSvr(this.channelId,e.marshall())}}},{key:"checkQuery",value:function(){this.logger.debug("StreamSvr.checkQuery :"+this.channelId+" bQuery:"+this.bQuery),!1===this.bQuery&&this.queryChannel(this.channelId)}},{key:"stopLive",value:function(){this.startNotify&&(this.startNotify=!1,this.notifyStopLive())}},{key:"notifyStopLive",value:function(){this.logger.info("StreamSvr.stopLive channelId:"+this.channelId);var e=new p.default,t=this.webRtcMgr.uid,r=this.webRtcMgr.appid;e.uid=new y.default(0,t),e.appid=new y.default(0,r);var i=O.fromString(Date.now().toString());e.version=new y.default(i.high,i.low),e.channelId=this.channelId;for(var n=0;n<this.publisherMgr.publishers.size;n++){var a=this.publisherMgr.publishers.get(n);a&&(0===n&&""!==a.audioStreamName&&e.streams.push(a.audioStreamName),""!==a.videoStreamName&&e.streams.push(a.videoStreamName))}this.apH5.sendStreamSvr(this.channelId,e.marshall())}},{key:"queryChannel",value:function(e){var t=new k.default;t.appid=new y.default(0,this.webRtcMgr.appid),t.channelId=e,t.fromUid=new y.default(0,this.webRtcMgr.uid),this.logger.info("StreamSvr.queryChannel:"+JSON.stringify(t)),this.apH5.sendStreamSvr(e,t.marshall())}},{key:"hasPublishStream",value:function(e,t){var r=!1,i=!1;return!!this.startNotify&&(this.publisherMgr.publishers.forEach(function(e){""!==e.videoStreamName&&(r=!0),""!==e.audioStreamName&&(i=!0)}),!(e&&!r)&&!(t&&!i))}},{key:"addPublishOriginStreamUrl",value:function(e){return this.originPushUrl.has(e)?{error:"HAS_ADD_URL"}:this.originPushUrl.size>=5?{error:"TOO_MUCH_URLS"}:this.hasPublishStream(!0)?(this.originPushUrl.add(e),this.updateLiveVersion(),this.notifyLive(),this.urlToPushStreamInfo.set(e,{url:e,status:"",isPush:!0}),null):{error:"HAS_NOT_PUBLISH_VIDEO"}}},{key:"removePublishOriginStreamUrl",value:function(e){if(!this.originPushUrl.has(e))return{error:"URL_NOT_EXIST"};this.originPushUrl.delete(e),this.updateLiveVersion(),this.notifyLive();var t=this.urlToPushStreamInfo.get(e);return t&&(t.isPush=!1,"PUSH_STREAM_FINISHED"===t.status&&this.urlToPushStreamInfo.delete(e)),null}},{key:"getPublishOriginStreamUrl",value:function(){var e=this,t="",r=0;return this.originPushUrl.forEach(function(i){t+=i,++r!=e.originPushUrl.size&&(t+=",")}),t}},{key:"clearPublishOriginStreamUrl",value:function(){this.originPushUrl.clear()}},{key:"addPublishTranscodingStreamUrl",value:function(e,t){if(!this.transcodingTasks.has(e))return{error:"TASKID_NOT_EXIST"};if(!this.hasPublishStream())return{error:"HAS_NOT_PUBLISH"};if(this.transCodePushUrl.has(e)){var r=this.transCodePushUrl.get(e);if(r.has(t))return{error:"HAS_ADD_URL"};if(r.size>=5)return{error:"TOO_MUCH_URLS"};r.add(t)}else{var r=new Set;r.add(t),this.transCodePushUrl.set(e,r)}return this.updateLiveVersion(),this.notifyLive(),this.urlToPushStreamInfo.set(t,{url:t,status:"",isPush:!0}),null}},{key:"removePublishTranscodingStreamUrl",value:function(e,t){if(!this.transCodePushUrl.has(e))return{error:"TASKID_NOT_EXIST"};var r=this.transCodePushUrl.get(e);if(!r.has(t))return{error:"URL_NOT_EXIST"};r.delete(t),r.size||this.transCodePushUrl.delete(e),this.updateLiveVersion(),this.notifyLive();var i=this.urlToPushStreamInfo.get(t);return i&&(i.isPush=!1),null}},{key:"getPublishTranscodingStreamUrl",value:function(e){var t=this.transCodePushUrl.get(e),r="",i=0;return t&&t.forEach(function(e){r+=e,++i!=t.size&&(r+=",")}),r}},{key:"clearPublishTranscodingStreamUrl",value:function(){this.transCodePushUrl.clear()}},{key:"clearPushStreamInfo",value:function(){this.urlToPushStreamInfo.clear()}},{key:"addSubscribe",value:function(e,t){if(this.substream.has(e)){var r=this.substream.get(e);r.add(t)}else{var r=new Set;r.add(t),this.substream.set(e,r)}this.queryChannel(e),this.apH5.addSubChannel(e)}},{key:"removeSubscribe",value:function(e,t){var r=this,i=!0;this.substream.has(e)&&function(){var n=r.substream.get(e);n.forEach(function(e){if(e==t)return void n.delete(e)}),n.size?i=!1:r.substream.delete(e)}(),this.transcodingUserStream.has(e)&&(i=!1),i&&this.apH5.delSubChannel(e)}},{key:"clearSubscribe",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.substream.entries()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var o=a(i.value,1),s=o[0];this.substream.delete(s),this.apH5.delSubChannel(s)}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}}},{key:"encodeUTF8",value:function(e){var t="",r=!0,i=!1,n=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=s.codePointAt(0);u<128?t+=s:u>127&&u<2048?t+=String.fromCharCode(u>>6|192,63&u|128):u>2047&&u<65536?t+=String.fromCharCode(u>>12|224,u>>6&63|128,63&u|128):u>65536&&u<1114112&&(t+=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,63&u|128))}}catch(e){i=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}return t}},{key:"setLiveTranscodingTask",value:function(e,t){var r=this;if(this.transcodingTasks.has(e)){var i=this.transcodingTasks.get(e);i.transcodingMode=t.transcodingMode,i.userCount=t.userCount,i.userList=t.userList,i.extConfig=JSON.stringify(t.extConfig,function(e,t){return"content"===e?r.encodeUTF8(t):t})}else{var n={transcodingMode:t.transcodingMode,userCount:t.userCount,userList:t.userList,extConfig:JSON.stringify(t.extConfig,function(e,t){return"content"===e?r.encodeUTF8(t):t})};this.transcodingTasks.set(e,n)}var o=this.transcodingTasks.get(e);o.userList&&o.userList.forEach(function(e){var t=e.uid,i=e.roomId;if(r.transcodingUserStream.has(i)){var n=r.transcodingUserStream.get(i);if(!n.userStreams.has(t)){var a=new Map;n.userStreams.set(t,{uid:0,streamAttr:a})}}else{var o={version:new y.default(0,0),userStreams:new Map},s={uid:0,streamAttr:new Map};o.userStreams.set(t,s),r.transcodingUserStream.set(i,o),r.apH5.addSubChannel(i)}r.queryChannel(i)});var s=!0,u=!1,l=void 0;try{for(var h,c=this.transcodingUserStream.entries()[Symbol.iterator]();!(s=(h=c.next()).done);s=!0){var d,f,p,v,m,g,S,b,_,E;!function(){var e=a(h.value,2),t=e[0],i=e[1],n=!0;d=!0,f=!1,p=void 0;try{for(v=i.userStreams.entries()[Symbol.iterator]();!(d=(m=v.next()).done);d=!0)!function(){var e=a(m.value,1),o=e[0],s=!0;g=!0,S=!1,b=void 0;try{for(_=r.transcodingTasks.entries()[Symbol.iterator]();!(g=(E=_.next()).done);g=!0){a(E.value,2)[1].userList.forEach(function(e){e.roomId==t&&(n=!1),o==e.uid&&(s=!1)})}}catch(e){S=!0,b=e}finally{try{!g&&_.return&&_.return()}finally{if(S)throw b}}s&&i.userStreams.delete(o)}()}catch(e){f=!0,p=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw p}}n&&(r.transcodingUserStream.delete(t),r.substream.has(t)||r.channelId==t||r.apH5.delSubChannel(t))}()}}catch(e){u=!0,l=e}finally{try{!s&&c.return&&c.return()}finally{if(u)throw l}}return this.updateLiveVersion(),this.notifyLive(),null}},{key:"removeLiveTranscodingTask",value:function(e){var t=this;if(this.transcodingTasks.has(e)){this.transcodingTasks.delete(e);var r=!0,i=!1,n=void 0;try{for(var o,s=this.transcodingUserStream.entries()[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var u,l,h,c,d,f,p,v,m,g;!function(){var e=a(o.value,2),r=e[0],i=e[1],n=!0;u=!0,l=!1,h=void 0;try{for(c=i.userStreams.entries()[Symbol.iterator]();!(u=(d=c.next()).done);u=!0)!function(){var e=a(d.value,1),o=e[0],s=!0;f=!0,p=!1,v=void 0;try{for(m=t.transcodingTasks.entries()[Symbol.iterator]();!(f=(g=m.next()).done);f=!0){a(g.value,2)[1].userList.forEach(function(e){e.roomId==r&&(n=!1),o==e.uid&&(s=!1)})}}catch(e){p=!0,v=e}finally{try{!f&&m.return&&m.return()}finally{if(p)throw v}}s&&i.userStreams.delete(o)}()}catch(e){l=!0,h=e}finally{try{!u&&c.return&&c.return()}finally{if(l)throw h}}n&&(t.transcodingUserStream.delete(r),t.substream.has(r)||t.channelId==r||t.apH5.delSubChannel(r))}()}}catch(e){i=!0,n=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw n}}return this.updateLiveVersion(),this.notifyLive(),null}return{error:"TASKID_NOT_EXIST"}}},{key:"clearLiveTranscodingTask",value:function(){this.transcodingTasks.clear();var e=!0,t=!1,r=void 0;try{for(var i,n=this.transcodingUserStream.entries()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var o=a(i.value,1),s=o[0];this.transcodingUserStream.delete(s),this.apH5.delSubChannel(s)}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}}}],[{key:"createStreamAttrDescript",value:function(e){var t=new T.default,r=t.attr;return e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_ENCODE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_ENCODE_TYPE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_ENCODE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_STREAM_TYPE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_STREAM_TYPE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_STREAM_TYPE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_APPID)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_APPID,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_APPID)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_FRAME_RATE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_FRAME_RATE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_FRAME_RATE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_BIT_RATE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_BIT_RATE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_BIT_RATE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_HEIGHT)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_HEIGHT,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_HEIGHT)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_WIDTH)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_WIDTH,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_WIDTH)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_SAMPLE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_SAMPLE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_SAMPLE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_CHANNEL)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_CHANNEL,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_CHANNEL)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_TIME_BASELINE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_TIME_BASELINE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_TIME_BASELINE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_ALPHA_DEGREE)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_ALPHA_DEGREE,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_ALPHA_DEGREE)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_EXTERNALUID)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_EXT_UID,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_EXTERNALUID)),e.has(_.StreamInfoKeyEnum.STREAM_INFO_KEY_DUAL_SMALL)&&r.set(_.StreamAttrKeyEnum.STREAM_ATTR_KEY_DUAL_SMALL,e.get(_.StreamInfoKeyEnum.STREAM_INFO_KEY_DUAL_SMALL)),t}}]),e}();r.default=F,t.exports=r.default},{"./apchannel/ApH5":7,"./protobase/ProtoUInt64":21,"./protobase/uri":23,"./protocol/streamSvr/ChannelTranscoding":55,"./protocol/streamSvr/PAnchorStartLive":57,"./protocol/streamSvr/PAnchorStartLiveRes":58,"./protocol/streamSvr/PAnchorStopLive":59,"./protocol/streamSvr/PAnchorStopLiveRes":60,"./protocol/streamSvr/PQueryChannelStreams":61,"./protocol/streamSvr/PQueryChannelStreamsRes":62,"./protocol/streamSvr/PRTMPStreamNotify2Service":63,"./protocol/streamSvr/PS3ChannelPushMsg":64,"./protocol/streamSvr/StreamAttrDescript":65,"./protocol/streamSvr/StreamSvrEnum":66,"./protocol/streamSvr/UserLayout":67,"./utils/timeUtil":92,"./utils/utils":93,long:98}],5:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){var t=g.default.WebRTCEvent;switch(e){case t.CONN_INITIAL:return"initial";case t.CONN_CANDIDATE:return"candidate";case t.CONN_CONNECTING:return"connecting";case t.CONN_FAILED:return"failed";case t.CONN_FINISHED:return"finished";case t.CONN_GATHERED:return"gathered";case t.CONN_READY:return"ready";case t.CONN_SDP:return"sdp";case t.CONN_STARTED:return"started"}return""}function o(){var e=navigator.connection||navigator.webkitConnection;return e?e.type||"":""}Object.defineProperty(r,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=e("./utils/Player"),l=i(u),h=e("./utils/AudioMeter"),c=i(h),d=e("./iceObserver"),f=i(d),p=e("./protobase/ProtoUInt64"),v=i(p),m=e("./protobase/MetaDataInfo"),g=i(m),y=e("./stat/MediaStat"),S=i(y),b=e("./utils/timeUtil"),_=i(b),E=e("./codecSwitch"),T=i(E),I=e("./utils/StatMonitor"),R=i(I),A=e("./protocol/PWebRTCCandidate"),k=i(A),P=e("./protocol/PWebRTCOffer"),M=i(P),C=e("./utils/logger"),w=e("./utils/StreamKeeper"),U=i(w),O=e("./utils/browser"),L=i(O),N=e("./getStats"),D=i(N),V=e("./utils/PeriodRecorder"),x=i(V),K=e("./stat/VideoQualityObserver"),j=e("./stat/AudioQualityObserver"),B=function(){function e(t,r,i,a){var o=this;n(this,e),this.isRemote=t,this.webrtcMgr=r,this.uidStr=i,this.channelId=a,this.serverConnectTimeout=7e3,this.uid=this.webrtcMgr.uid,this.pubUuid=null,this.logger=this.webrtcMgr.logger,this.stream=null,this.player=null,this.streamKeeper=new U.default,this.audioMeter=new c.default,this._hasAudio=!1,this._hasVideo=!1,this.userAudioEnabled=!0,this.userVideoEnabled=!0,this.volume=1,this.groupKey="",this.audioStreamKey="",this.videoStreamKey="",this.layer=0,this.codec="",this.pc=null,this.offerSeq=0,this.startTime=0,this.connectTime=0,this.waitConnected=!1,this.remoteSdp=null,this.networkScore=null,this.supportedVideoCodecs=[],this.connectionState=new x.default,this.iceConnectionState=new x.default,this.signalingState=new x.default,this.userEvents=new x.default,this.rtpmap=new Map,this.videoQualityObserver=new K.VideoQualityObserver,this.audioQualityObserver=new j.AudioQualityObserver,this.setLayerResolve=null,this.setLayerReject=null,this.resendPWebRTCLayer=null,this.serverIp="",this.serverPort=0,this.clientIp="",this.clientPort=0,this.appid=r.appid,this.publishResetCount=0,this.subscribeResetCount=0,this.iceObserver=new f.default(i,a,r.webrtc),this.mediaStat=new S.default(r.userArea,this.rtpmap,r.logger),this.mediaStatPerSec=new S.default(r.userArea,this.rtpmap,r.logger),this.audioMeter=new c.default,this.statMonitor=new R.default(t),this.statMonitor.on("exception",function(e){o.webrtcMgr.webrtc.trigger("exception",{uid:i,roomId:a,error:e})}),this.isExceptionHappened=!1}return s(e,[{key:"destroy",value:function(){this.info("destroy"),this.statMonitor.removeAllListeners("exception"),this.stopPlay(),this.audioMeter.stop(),this.publishResetCount=0,this.subscribeResetCount=0,this.videoQualityObserver.destroy()}},{key:"reportUdpConnectBehavior",value:function(){this.isRemote?this.subscribeResetCount?this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_ERROR,"room","nt_reconnect_[o]","sub_"+this.uidStr):this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","nt_connecting_[o]","sub_"+this.uidStr):this.publishResetCount?this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_ERROR,"room","nt_reconnect_[o]","pub_"+this.layer):this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","nt_connecting_[o]","pub_"+this.layer)}},{key:"reportUdpConnectStat",value:function(e,t){this.isRemote?this.subscribeResetCount?this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","nt_reconnect_"+t+"_[o]","sub_"+this.uidStr):this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","nt_connect_"+t+"_[o]","sub_"+this.uidStr):this.publishResetCount?this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","nt_reconnect_"+t+"_[o]","pub_"+this.layer):this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","nt_connect_"+t+"_[o]","pub_"+this.layer)}},{key:"addUserEvents",value:function(e){this.userEvents.add(e)}},{key:"connect",value:function(){var e=this;if(this.waitConnected=!0,null===this.pc){var t=void 0;try{t=new window.RTCPeerConnection(this.webrtcMgr.serverConfig)}catch(e){return this.warn("create pc error: "+e),Promise.reject("NOT_SUPPORTED")}if(this.pc=t,this.startTime=_.default.utc(),this.connectTime=_.default.now(),this.userEvents.add(this.isRemote?"subscribe":"publish"),this.reportUdpConnectBehavior(),!this.isRemote){var r=this.stream.getAudioTracks()[0];r?this.pc.addTrack(r):this.pc.addTransceiver("audio",{direction:"sendonly"});var i=this.stream.getVideoTracks()[0];i?this.pc.addTrack(i):this.pc.addTransceiver("video",{direction:"sendonly"})}this.pc.onicecandidate=this.onicecandidate.bind(this),this.pc.oniceconnectionstatechange=function(r){e.oniceconnectionstatechange(r,t)},this.pc.onsignalingstatechange=function(r){e.onsignalingstatechange(r,t)},this.pc.onconnectionstatechange=function(r){e.onconnectionstatechange(r,t)},this.pc.ontrack=function(r){e.ontrack(r,t)},this.pc.onremovestream=function(r){e.onremovestream(r,t)};var n=this.offerOption;return this.isRemote&&(n.offerToReceiveAudio&&this.pc.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo&&this.pc.addTransceiver("video",{direction:"recvonly"})),this.pc.createOffer(n).catch(this.gotDescriptionError.bind(this)).then(function(r){return e.gotDescription(r,t)})}}},{key:"resetIceConnState",value:function(e){var t=this;this.webrtcMgr.joined()&&this.pc&&(this.warn("resetIceConnState, resetCount:"+(this.isRemote?++this.subscribeResetCount:++this.publishResetCount).toString()+", resetReason:"+e),e&&(this.addUserEvents(e),this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_ERROR,"room","nt_reconnect_reason_[o]",e)),this.addUserEvents("resetIceConnState"),this.iceObserver.updateStat("new"),this.reportMediaStat(),this.resetStat(),this.networkScore=6,this.connect().catch(function(e){t.warn("resetIce connect error: "+e.error)}))}},{key:"disconnect",value:function(){this.waitConnected=!1,this.pc&&(this.userEvents.add(this.isRemote?"unsubscribe":"unpublish"),this.reportMediaStat(),this.resetStat(),this.networkScore=null,this.publishResetCount=0,this.subscribeResetCount=0)}},{key:"setRemoteDescription",value:function(e){var t=this;if(0!=e.seqNum&&e.seqNum<this.offerSeq)return this.warn("wrong seqNum! ignore answer, seqNum:"+e.seqNum+", offerSeq:"+this.offerSeq),Promise.reject("WRONG_SEQ");if(!this.pc)return this.info("peer connection is null",!0),Promise.reject("NO_PC");if(this.hasAudio&&this.hasVideo){var r=e.sdp.indexOf("m=audio"),i=e.sdp.indexOf("m=video");if(-1!=r&&-1!=i){var n=this.pc.getTransceivers()[0];switch((n.sender.track||n.receiver.track).kind){case"video":r<i&&(e.sdp=e.sdp.substring(0,r)+e.sdp.substring(i)+e.sdp.substring(r,i));break;case"audio":r>i&&(e.sdp=e.sdp.substring(0,i)+e.sdp.substring(r)+e.sdp.substring(i,r))}}}for(var a=[],o=/a=rtpmap:(\d+) ([a-zA-Z\d-]+)\/(\d+)(?:\/(\d+))?/g;null!==(a=o.exec(e.sdp));)this.rtpmap.set(parseInt(a[1]),a[2]);this.serverIp=e.address.address,this.serverPort=e.address.port,this.info("server: ("+this.serverIp+":"+this.serverPort+")");var s={sdp:e.sdp,type:e.sdpType};return s=T.default.setOpusConfig(s),this.info("setRemoteDescription "+JSON.stringify(s),!0),this.pc.setRemoteDescription(new window.RTCSessionDescription(s)).then(function(){t.info("setRemoteDescription success"),t.remoteSdp=e.sdp}).catch(function(e){return t.warn("setRemoteDescription error:"+e),Promise.reject("SET_REMOTE_SDP_FAIL")})}},{key:"reNegotiate",value:function(e){var t=this;if(!this.pc)return Promise.reject("?");var r=new RTCSessionDescription({type:"answer",sdp:e});return this.pc.createOffer(this.offerOption).then(function(e){return t.pc.setLocalDescription(e)}).then(function(){return t.pc.setRemoteDescription(r)}).then(function(){t.remoteSdp=e}).catch(function(){return Promise.reject("reNegotiate fail")})}},{key:"onconnectionstatechange",value:function(e,t){this.pc===t&&(this.info("onconnectionstatechange"+this.pcStat),this.connectionState.add(this.pc.connectionState),"connected"===this.pc.connectionState&&this.onConnect())}},{key:"onsignalingstatechange",value:function(e,t){this.pc===t&&(this.info("onsignalingstatechange"+this.pcStat),this.signalingState.add(this.pc.signalingState))}},{key:"oniceconnectionstatechange",value:function(e,t){if(this.pc===t){this.info("oniceconnectionstatechange"+this.pcStat);var r=this.pc.iceConnectionState;this.iceConnectionState.add(r),this.mediaStatPerSec.data.iceConnectionState+=r+"--",this.iceObserver.updateStat(r),"completed"===r&&(this.pc.connectionState||this.onConnect())}}},{key:"onicecandidate",value:function(e){if(e.candidate){this.debug("onicecandidate candidate="+e.candidate.candidate+" sdpMLineIndex="+e.candidate.sdpMLineIndex+" mid="+e.candidate.sdpMid);var t=new k.default;t.appid=this.webrtcMgr.appid,t.groupKey="no_stream_key",t.uid=this.webrtcMgr.uid,t.subscribeUuid=this.pubUuid?this.pubUuid:"",t.publish=this.isRemote?0:1,t.sdpMLineIndex=e.candidate.sdpMLineIndex,t.sdpMid=e.candidate.sdpMid,t.candidate="a="+e.candidate.candidate,this.webrtcMgr.send(t.marshall())}}},{key:"gotDescription",value:function(e,t){var r=this;if(this.info("gotDescription"),this.pc===t)return e=T.default.setOpusConfig(e,this.getOpusSdpLine()),this.supportedVideoCodecs=[],T.default.setPreferCodec({video:this.isRemote?this.codec:this.webrtcMgr.pubCodec},e),e.sdp.includes("H264")&&this.supportedVideoCodecs.push("H264"),e.sdp.includes("VP8")&&this.supportedVideoCodecs.push("VP8"),this.videoStreamKey&&this.codec&&!this.supportedVideoCodecs.includes(this.codec)?Promise.reject("VIDEO_CODEC_UNSUPPORTED"):(this.isRemote&&(e.sdp=T.default.setRtcpXrRrtr(e.sdp)),this.pc.setLocalDescription(e).then(function(){r.info("setLocalDescription successful");var t=_.default.now(),i=r.webrtcMgr.publisherMgr.addAndGetIdOffset();r.isRemote||(r.videoStreamId=new v.default(r.uid,t+i),r.audioStreamId=new v.default(r.uid,t+i+1));var n=new M.default;n.appid=r.webrtcMgr.appid,n.groupKey=r.groupKey,r.isRemote?(n.audioStreamKey=r.audioStreamKey,n.videoStreamKey=r.videoStreamKey):(n.audioStreamKey=r.genAudioStreamKey(),n.videoStreamKey=r.webrtcMgr.pureAudio?"":r.genVideoStreamKey()),n.audioStreamId=r.audioStreamId,n.videoStreamId=r.webrtcMgr.pureAudio?new v.default(0,0):r.videoStreamId,n.uid=r.webrtcMgr.uid,n.publish=r.isRemote?0:1,r.pubUuid&&(n.subscribeUuid=r.pubUuid),n.sdp=e.sdp,n.sdpType=e.type,r.offerSeq=r.webrtcMgr.globalSeqNum++,n.seqNum=r.offerSeq,n.layer=r.layer,n.codec="VP8"===r.codec?g.default.PWebRTCCodec.VP8:g.default.PWebRTCCodec.H264,r.info("send offer: "+JSON.stringify(n)),r.webrtcMgr.send(n.marshall())}))}},{key:"gotDescriptionError",value:function(e){return this.warn("gotDescriptionError could not create offer: "+e),Promise.reject("GET_OFFER_ERROR: "+e)}},{key:"onWebRTCEvent",value:function(e){this.info("onWebRTCEvent uid:"+e.uid+", event:"+e.event+" "+a(e.event),!0),this.pc&&e.event===g.default.WebRTCEvent.CONN_FINISHED&&e.seqNum===this.offerSeq&&this.onDisconnect("serverConnFinished")}},{key:"onDisconnect",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"iceConnDisconnect":arguments[0];this.isRemote?this.resetIceConnState(e):this.webrtcMgr.publisherMgr.resetIceConnState(e)}},{key:"onConnect",value:function(){this.info("onConnect",!0),this.waitConnected=!1,this.reportUdpConnectStat(C.LOGLEVEL_INFO,"success")}},{key:"checkIceConnState",value:function(e){null!==this.pc&&(this.isConnectionFail()?(this.warn("disconnect(iceConnectionError), iceConnectionState:"+this.pc.iceConnectionState+", connectionState:"+this.pc.connectionState),this.onDisconnect()):this.waitConnected&&e>this.connectTime+this.serverConnectTimeout&&!this.isConnected()&&(this.warn("disconnect(connectTimeOut),  ConnectTimeOut:"+this.serverConnectTimeout+", now:"+e+", connectTime:"+this.connectTime+this.pcStat),this.reportUdpConnectStat(C.LOGLEVEL_ERROR,"failed"),this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_ERROR,"room","nt_connect_cost_timeout_[o]",(e-this.connectTime).toString()),this.onDisconnect()))}},{key:"resetStat",value:function(){var e=this;this.iceObserver.reset(),this.isRemote&&(this.clearMediaStream(),this.setLayerReject&&(this.warn("set layer failed by peerConnection closed, reason: CONNECTION_RESET"),this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_ERROR,"room","aud_big_small_stream_failed_[o]",this.uidStr+"_"+this.resendPWebRTCLayer.layer),this.setLayerReject("CONNECTION_RESET"),this.setLayerResolve=null,this.setLayerReject=null,this.resendPWebRTCLayer=null));var t=this.pc;setTimeout(function(){e.mediaStat.init(),t&&t.close()},1e3),this.pc=null,this.signalingState.reset(),this.iceConnectionState.reset(),this.connectionState.reset(),this.userEvents.reset(),this.statMonitor.reset(),this.setHistorySessionStats(),this.mediaStatPerSec.init(),this.serverIp="",this.serverPort=0,this.clientIp="",this.clientPort=0}},{key:"setHistorySessionStats",value:function(){this.isRemote?this.webrtcMgr.historyRecvBytes+=this.mediaStatPerSec.data.videoPacketBytes+this.mediaStatPerSec.data.audioPacketBytes:this.webrtcMgr.historySendBytes+=this.mediaStatPerSec.data.videoPacketBytes+this.mediaStatPerSec.data.audioPacketBytes}},{key:"reportFirstFrameStat",value:function(e){var t=this.statMonitor.checkFirstFrameStat(e),r=!0,i=!1,n=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u="";u=this.isRemote?this.uidStr:s.includes("video")?this.layer.toString():"",this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room",s,u),s.includes("video")?this.addUserEvents("firstVideoFrame"):this.addUserEvents("firstAudioFrame")}}catch(e){i=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}}},{key:"reportVideoUplinkException",value:function(e){var t=this.statMonitor.checkVideoUplinkException(e);this.isConnected()&&t&&!this.isExceptionHappened?(this.warn("unexpected video uplink exception!"),this.addUserEvents("videoUplinkException"),this.isExceptionHappened=!0,this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_ERROR,"room","anchor_video_uplink_exception_[o]",this.layer.toString())):this.isConnected()&&!t&&this.isExceptionHappened&&(this.warn("video uplink exception resume!"),this.addUserEvents("videoUplinkResume"),this.isExceptionHappened=!1,this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_video_uplink_exception_resume_[o]",this.layer.toString()))}},{key:"updateMediaStatPerSecStreamKey",value:function(){this.mediaStatPerSec.data.videoStreamName=this.videoStreamKey,this.mediaStatPerSec.data.audioStreamName=this.audioStreamKey,this.mediaStatPerSec.data.groupStreamName=this.groupKey}},{key:"updateMediaStatPerSec",value:function(e){var t=this;this.pc&&function(){var r=t.pc;(0,D.default)(r).then(function(i){t.statMonitor.update(i),
t.isRemote&&t.audioQualityObserver.update(t.hasAudio,i.audioTrack),t.reportFirstFrameStat(i),t.reportVideoUplinkException(i);var n=t.isRemote?0:1;S.default.validStat(r,t.mediaStat)&&(!0===t.iceObserver.reconnecting&&(t.mediaStatPerSec.data.iceConnectionState+="disconnected--"),t.updateMediaStatPerSecStreamKey(),t.mediaStatPerSec.updateByStatPerSec(i,t.mediaStat,n,e),t.isRemote&&t.videoQualityObserver.avgInterframeDelay.updateFrameRate(t.mediaStatPerSec.data.videoFrameRate),t.pc===r&&(t.networkScore=t.mediaStatPerSec.data.networkScore))})}()}},{key:"reportMediaStat",value:function(){var e=this;this.pc&&function(){var t=e.pc,r=new S.default(e.webrtcMgr.userArea,e.rtpmap,e.logger);e.updateMediaStatData(r.data),(0,D.default)(t).then(function(i){S.default.validStat(t,e.mediaStat)&&r.updateByStat(i,e.mediaStat),r.send()})}()}},{key:"updateMediaStatData",value:function(e){this.updateSpecialStat(e),e.appid=this.webrtcMgr.appid,e.videoStreamName=this.videoStreamKey||"",e.audioStreamName=this.audioStreamKey||"",e.groupStreamName=this.groupKey||"",e.uid=this.webrtcMgr.uid,e.uidStr=this.webrtcMgr.uidStr||"",e.subscriberNum=this.isRemote?this.webrtcMgr.subscriberMgr.subscribers.size:0,e.publisherOrSubscriber=this.isRemote?0:1,e.subscriber_uuid=this.pubUuid||"",e.signalingState=this.signalingState.getRecord(),e.iceConnectionState=this.iceConnectionState.getRecord(),e.connectionState=this.connectionState.getRecord(),e.events=this.userEvents.getRecord(),e.startTime=this.startTime,e.tokenAuthResult=this.webrtcMgr.tokenAuthResult,e.channelId=this.webrtcMgr.channelId||"",e.sdkVersion=this.webrtcMgr.webrtc.sdkVersion||"",e.browserType=encodeURIComponent(this.webrtcMgr.webrtc.browserType||""),e.kernelType=encodeURIComponent(this.webrtcMgr.webrtc.kernelType||""),e.volume=Math.round(this.getAudioLevel()),e.connectCount=this.webrtcMgr.connectCnt,e.publishResetCount=this.isRemote?"":this.publishResetCount,e.subscribeResetCount=this.isRemote?this.subscribeResetCount:"",e.userAgent=encodeURIComponent(this.webrtcMgr.webrtc.systemInfo||""),e.deviceModel=encodeURIComponent(this.webrtcMgr.webrtc.deviceModel),e.networkType=encodeURIComponent(o()),e.layer=this.layer,e.avpCandidate=this.clientIp.length?this.clientIp+":"+this.clientPort:"",e.sdkCandidate=this.serverIp.length?this.serverIp+":"+this.serverPort:"",e.position=this.player?this.player.position:""}},{key:"reportPlayBehavior",value:function(e){this.isRemote?e?(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_play_video_[o]",this.uidStr),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_play_audio_[o]",this.uidStr)):(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_stop_play_video_[o]",this.uidStr),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_stop_play_audio_[o]",this.uidStr)):e?(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_play_video_[o]",this.layer.toString()),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_play_audio")):(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_stop_play_video_[o]",this.layer.toString()),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_stop_play_audio"))}},{key:"reportPlayStat",value:function(e,t){this.isRemote?(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","aud_play_video_"+t+"_[o]",this.uidStr),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","aud_play_audio_"+t+"_[o]",this.uidStr)):(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","anchor_play_video_"+t+"_[o]",this.layer.toString()),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(e,"room","anchor_play_audio_"+t))}},{key:"play",value:function(e,t,r){var i=this;if(this.player)return Promise.reject("ALREADY_PLAY");if(!this.audioTrack&&!this.videoTrack)return Promise.reject("HAS_NOT_SUBSCRIBE");this.player=new l.default(this.logger,this.labelPrefix,e,this.hasAudio,this.hasVideo,this.getPlayStream(),t,this.isRemote,r),this.isRemote&&this.videoQualityObserver.updatePlayer(this.player),this.player.on("state_change",function(e,t){null!==i.player&&i.player!==e||i.webrtcMgr.webrtc.trigger("player_state_change",t)}),this.player.on("mute_play",function(e){i.player===e&&i.webrtcMgr.webrtc.trigger("mute_play",{uid:i.uidStr})}),this.player.on("mute_play_resume",function(e){i.player===e&&i.webrtcMgr.webrtc.trigger("mute_play_resume",{uid:i.uidStr})}),this.reportPlayBehavior(!0);var n=this.player;return this.player.play(this.volume).then(function(){L.default.isSafari&&i.audioMeter.updateStream(i.stream),i.player===n&&i.reportPlayStat(C.LOGLEVEL_INFO,"success")}).catch(function(e){return i.player===n&&(i.reportPlayStat(C.LOGLEVEL_ERROR,"failed"),i.stopPlay()),Promise.reject(e)})}},{key:"resume",value:function(){return this.player?this.player.resume():Promise.reject("HAS_NOT_PLAY")}},{key:"setAudioOutputDevice",value:function(e){return this.player?this.player.setAudioOutputDevice(e):Promise.reject("HAS_NOT_PLAY")}},{key:"stopPlay",value:function(){return this.player?(this.reportPlayBehavior(!1),this.player.destroy(),this.player=null,this.isRemote&&this.videoQualityObserver.updatePlayer(void 0),null):{error:"HAS_NOT_PLAY"}}},{key:"pausePlay",value:function(){this.player&&this.player.media&&this.player.media.pause()}},{key:"isConnected",value:function(){return!!this.pc&&(this.pc.connectionState?"connected"===this.pc.connectionState:"connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}},{key:"isIceConnected",value:function(){return this.pc&&("connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}},{key:"isConnectionFail",value:function(){return!!this.pc&&("failed"===this.pc.iceConnectionState||"closed"===this.pc.iceConnectionState||"failed"===this.pc.connectionState||"closed"===this.pc.connectionState)}},{key:"clearMediaStream",value:function(){var e=this;this.stream.getTracks().forEach(function(t){e.stream.removeTrack(t)})}},{key:"getAudioLevel",value:function(){return this.audioMeter.level}},{key:"reportAbilityStat",value:function(e,t){this.isRemote?t?e?this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_enable_video_track_[o]",this.uidStr):this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_disable_video_track_[o]",this.uidStr):e?this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_enable_audio_track_[o]",this.uidStr):this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","aud_disable_audio_track_[o]",this.uidStr):t?e?this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_enable_video_track_[o]",this.layer.toString()):this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_disable_video_track_[o]",this.layer.toString()):e?this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_enable_audio_track"):this.webrtcMgr.reportUserEventMgr.addEvent(C.LOGLEVEL_INFO,"room","anchor_disable_audio_track")}},{key:"disableAudio",value:function(){return this.userAudioEnabled&&this.audioEnabled?(this.reportAbilityStat(!1,!1),this.addUserEvents("disableAudio"),this.userAudioEnabled=!1,this.audioTrack.enabled=!1,null):{error:"INVALID_OPERATION"}}},{key:"enableAudio",value:function(){return!1===this.userAudioEnabled&&!0===this.hasAudio?(this.reportAbilityStat(!0,!1),this.addUserEvents("enableAudio"),this.userAudioEnabled=!0,this.audioTrack.enabled=!0,null):{error:"INVALID_OPERATION"}}},{key:"disableVideo",value:function(){return this.userVideoEnabled&&this.videoEnabled?(this.reportAbilityStat(!1,!0),this.addUserEvents("disableVideo"),this.userVideoEnabled=!1,this.videoTrack.enabled=!1,null):{error:"INVALID_OPERATION"}}},{key:"enableVideo",value:function(){return!1===this.userVideoEnabled&&!0===this.hasVideo?(this.reportAbilityStat(!0,!0),this.addUserEvents("enableVideo"),this.userVideoEnabled=!0,this.videoTrack.enabled=!0,null):{error:"INVALID_OPERATION"}}},{key:"setAudioVolume",value:function(e){return this.audioTrack?(this.volume=e,this.player&&this.player.setAudioVolume(e),null):{error:"AUDIO_TRACK_NOT_EXISTED"}}},{key:"debug",value:function(e){var t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];this.logger.debug(this.label+" "+e,t)}},{key:"info",value:function(e){var t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];this.logger.info(this.label+" "+e,t)}},{key:"warn",value:function(e){this.logger.warn(this.label+" "+e)}},{key:"genAudioStreamName",value:function(){return"a_"+this.uidStr+"_"+this.channelId+"_"+this.layer+"_0"}},{key:"genVideoStreamName",value:function(){return"v_"+this.uidStr+"_"+this.channelId+"_"+this.layer+"_0"}},{key:"genAudioStreamKey",value:function(){return this.appid+"_"+this.genAudioStreamName()}},{key:"genVideoStreamKey",value:function(){return this.appid+"_"+this.genVideoStreamName()}},{key:"setClientAddress",value:function(e){this.debug("setClientAddress, clientIp:"+e.address+", clientPort:"+e.port),this.clientIp=e.address,this.clientPort=e.port}},{key:"getOpusSdpLine",value:function(){return this.isRemote?"minptime=10;useinbandfec=1;usedtx=0":this.webrtcMgr.profileMgr.getOpusSdpLine()}},{key:"pcStat",get:function(){return" ice:"+this.pc.iceConnectionState+", connection:"+this.pc.connectionState+", signaling:"+this.pc.signalingState}},{key:"offerOption",get:function(){var e=this.isRemote;return{offerToReceiveAudio:e,offerToReceiveVideo:e}}},{key:"audioTrack",get:function(){return this.stream?this.stream.getAudioTracks()[0]:void 0}},{key:"videoTrack",get:function(){return this.stream?this.stream.getVideoTracks()[0]:void 0}},{key:"audioEnabled",get:function(){return!!this.audioTrack&&this.audioTrack.enabled}},{key:"videoEnabled",get:function(){return!!this.videoTrack&&this.videoTrack.enabled}},{key:"hasAudio",get:function(){return this._hasAudio},set:function(e){this._hasAudio=e,this.statMonitor.hasAudio=e}},{key:"width",get:function(){return this.videoTrack?this.videoTrack.getSettings().width:void 0}},{key:"height",get:function(){return this.videoTrack?this.videoTrack.getSettings().height:void 0}},{key:"frameRate",get:function(){if(this.videoTrack&&this.videoTrack.getSettings().frameRate)return Math.round(this.videoTrack.getSettings().frameRate)}},{key:"hasVideo",get:function(){return this._hasVideo},set:function(e){this._hasVideo=e,this.statMonitor.hasVideo=e}},{key:"isPlaying",get:function(){return!!this.player&&this.player.isPlaying}}]),e}();r.default=B,t.exports=r.default},{"./codecSwitch":9,"./getStats":11,"./iceObserver":12,"./protobase/MetaDataInfo":17,"./protobase/ProtoUInt64":21,"./protocol/PWebRTCCandidate":40,"./protocol/PWebRTCOffer":46,"./stat/AudioQualityObserver":72,"./stat/MediaStat":73,"./stat/VideoQualityObserver":77,"./utils/AudioMeter":83,"./utils/PeriodRecorder":86,"./utils/Player":87,"./utils/StatMonitor":88,"./utils/StreamKeeper":89,"./utils/browser":90,"./utils/logger":91,"./utils/timeUtil":92}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i;r.ClientType=i,function(e){e[e.PC_YY=0]="PC_YY",e[e.WEB_YY=1]="WEB_YY",e[e.ANDROID_YY=2]="ANDROID_YY",e[e.IOS_YY=3]="IOS_YY",e[e.ALL_YY=4]="ALL_YY",e[e.WP_YY=5]="WP_YY",e[e.WEBSOCKET_YY_H5=8]="WEBSOCKET_YY_H5"}(i||(r.ClientType=i={}));var n;r.AP_LINK_STATE=n,function(e){e[e.FAILED=-1]="FAILED",e[e.INIT=0]="INIT",e[e.START=1]="START",e[e.CONNECTING=2]="CONNECTING",e[e.CONNECTED=3]="CONNECTED",e[e.READY=5]="READY",e[e.DISCONNECTING=6]="DISCONNECTING",e[e.NO_IP=7]="NO_IP"}(n||(r.AP_LINK_STATE=n={}));var a;r.SVR_CHAN_STATE=a,function(e){e[e.JOIN=1]="JOIN",e[e.JOINSUCC=2]="JOINSUCC",e[e.LEAVE=3]="LEAVE",e[e.LEAVESUCC=4]="LEAVESUCC"}(a||(r.SVR_CHAN_STATE=a={}));var o;r.LoginRetryProc=o,function(e){e[e.E_LOGIN_SUCCESS=0]="E_LOGIN_SUCCESS",e[e.E_INVALID=1]="E_INVALID",e[e.E_ALREADY_EXIST=2]="E_ALREADY_EXIST",e[e.E_USER_NOT_FOUND=3]="E_USER_NOT_FOUND"}(o||(r.LoginRetryProc=o={}));var s;r.RouteDataMask=s,function(e){e[e.ROUTE_SESSIONID_MASK=1]="ROUTE_SESSIONID_MASK",e[e.HASH_KEY_MASK=2]="HASH_KEY_MASK",e[e.ALLOC_SERVICE_MASK=4]="ALLOC_SERVICE_MASK"}(s||(r.RouteDataMask=s={}))},{}],7:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("./ApLink"),u=e("./ApEnum"),l=e("./../protobase/ProtoUnmarshall"),h=i(l),c=e("../protocol/ap/PSvcPing"),d=i(c),f=e("../protocol/ap/PSvcRouteReq"),p=i(f),v=e("../protobase/uri"),m=i(v),g=e("../protocol/ap/PSvcSubsGroupReq"),y=i(g),S=e("../protocol/ap/PSvcSubsGroupRes"),b=i(S),_=e("../protocol/ap/PSvcPong"),E=i(_),T=e("../utils/timeUtil"),I=i(T),R=e("../protocol/ap/PSvcBroadcast"),A=i(R),k=e("../utils/utils"),P=i(k),M=e("../protocol/ap/PSvcRouteRes"),C=i(M),w=new Set,U=function(){var e=function(){function e(t,r,i,a,o,s){n(this,e),this.streamSvr=t,this.logger=t.logger,this.appid=r,this.channelId=i,this.channelIdhash=P.default.hashString(this.appid+"-"+this.channelId),this.uid=a,this.git=o,this.handleDic=new Map,this.linkState=u.AP_LINK_STATE.INIT,this.sendBuf=[],this.gSeq=0,this.instId=Math.round(4294967295*Math.random()),this.channState=u.SVR_CHAN_STATE.LEAVESUCC,this.joinContext={},this.leaveContext={},this.subChannel=new Map,this.innerBcGroups=new Map,this.tryCnt=0,this.userArea=s,this.addHandle(m.default.PSvcSubsGroupResURI,this.onPSvcSubsGroupRes.bind(this)),this.addHandle(m.default.PSvcPongURI,this.onPSvcPong.bind(this)),this.addHandle(m.default.PSvcBroadcastURI,this.onPSvcBroadcast.bind(this)),this.addHandle(m.default.PSvcRouteResURI,this.onPSvcRouteRes.bind(this)),this.pingCnt=0}return o(e,[{key:"onPSvcBroadcast",value:function(e){var t=new A.default;t.unmarshall(e);var r=t.groupType.toString64()+"_"+t.groupId.toString64();if(this.logger.debug("ApH5.onPSvcBroadcast:"+t.toString()+" bcKey:"+r+", uid:"+this.uid+", seqId:"+t.seqId),this.innerBcGroups.has(r)){var i=new Uint8Array(t.data.byteLength);i.set(t.data,0),t.data=null;var n=new DataView(i.buffer),a=new h.default(n);switch(a.uri){case m.default.URI_STEAM_PS3ChannelPushMsg:this.streamSvr.onPS3ChannelPushMsg(a);break;case m.default.URI_RTMP_PRTMPStreamNotify2Service:this.streamSvr.onPRTMPStreamNotify(a);break;default:w.has(a.uri)||(w.add(a.uri),this.logger.warn("ApH5.onPSvcBroadcast unknown uri:"+a.uri))}}}},{key:"onPSvcRouteRes",value:function(e){var t=new C.default;t.unmarshall(e);var r=new Uint8Array(t.data.byteLength);r.set(t.data,0),t.data=null;var i=new DataView(r.buffer),n=new h.default(i);this.streamSvr.onProto(n.uri,n)}},{key:"onPSvcPong",value:function(e){this.logger.debug("ApH5.onPSvcPong"),(new E.default).unmarshall(e),this.pingCnt=0}},{key:"onPSvcSubsGroupRes",value:function(e){var t=new b.default;t.unmarshall(e),200==t.resCode?(this.logger.info("ApH5.onPSvcSubsGroupRes success"),this.tryCnt=0,this.joinContext.context==t.context&&(this.logger.info("ApH5.onPSvcSubsGroupRes join channel success, origin state:"+this.channState),this.channState===u.SVR_CHAN_STATE.JOIN&&(this.channState=u.SVR_CHAN_STATE.JOINSUCC,this.streamSvr.queryChannel(this.streamSvr.channelId))),this.leaveContext.context==t.context&&(this.logger.info("ApH5.onPSvcSubsGroupRes leave channel success"),this.linkState===u.SVR_CHAN_STATE.LEAVE&&(this.channState=u.SVR_CHAN_STATE.LEAVESUCC))):this.logger.error("ApH5.onPSvcSubsGroupRes error:"+JSON.stringify(t))}},{key:"getSeqId",value:function(){return this.gSeq+=1,this.gSeq}},{key:"start",value:function(){this.linkState=u.AP_LINK_STATE.START,this.connectAp()}},{key:"stop",value:function(){this.leaveChannel(),this.linkState=u.AP_LINK_STATE.INIT,this.apLink&&(this.apLink.close(),this.apLink=null),this.clearSendBuf(),this.clearSubChannel()}},{key:"addHandle",value:function(e,t){this.handleDic.set(e,t)}},{key:"onProto",value:function(e,t){var r=this.handleDic.get(e);null!==r&&void 0!==r?r(t):this.logger.info("ApH5.onProto UNKNOWN uri="+e)}},{key:"onCheckTimer",value:function(e,t){this.linkState!==u.AP_LINK_STATE.INIT&&(this.checkConnect(),this.checkPing(t,e),this.checkChannel(e),this.apLink&&this.apLink.onCheckTimer(t))}},{key:"checkPing",value:function(e,t){if(this.linkState===u.AP_LINK_STATE.READY&&t%2==0){if(this.pingCnt>=11)return this.logger.warn("ApH5.onPingTimer ping time out, pingCnt:"+this.pingCnt),this.apLink.onclose(),void(this.pingCnt=0);this.pingCnt++,this.ping(e)}}},{key:"checkConnect",value:function(){this.linkState==u.AP_LINK_STATE.DISCONNECTING&&this.connectAp()}},{key:"checkChannel",value:function(e){this.linkState==u.AP_LINK_STATE.READY&&e%5==0&&(this.channState===u.SVR_CHAN_STATE.JOIN&&(this.tryCnt++,this.joinContext={},this.joinChannelBc()),this.channState===u.SVR_CHAN_STATE.LEAVE&&(this.tryCnt++,this.leaveContext={},this.leaveChannelBc(),this.tryCnt>5&&(this.channState=u.SVR_CHAN_STATE.LEAVESUCC,this.tryCnt=0)))}},{key:"onConnected",value:function(e){this.apLink&&this.apLink===e&&(this.logger.info("ApH5.onConnected",!0),this.linkState=u.AP_LINK_STATE.CONNECTED,this.linkState=u.AP_LINK_STATE.READY,this.pingCnt=0,this.joinChannel(),this.sendForTraceUser(),this.checkSubChannel(),this.flushBuf())}},{key:"onClose",value:function(e){this.apLink===e&&(this.logger.warn("ApH5.onClosed"),this.linkState!==u.AP_LINK_STATE.INIT&&(this.linkState=u.AP_LINK_STATE.DISCONNECTING),this.apLink&&(this.apLink.close(),this.apLink=null),this.clearSendBuf(),this.channState===u.SVR_CHAN_STATE.JOINSUCC&&(this.channState=u.SVR_CHAN_STATE.JOIN),this.resetSubChannel())}},{key:"onError",value:function(e){this.apLink===e&&(this.logger.warn("ApH5.onError"),this.linkState=u.AP_LINK_STATE.DISCONNECTING,this.apLink&&(this.apLink.close(),this.apLink=null),this.clearSendBuf(),this.channState===u.SVR_CHAN_STATE.JOINSUCC&&(this.channState=u.SVR_CHAN_STATE.JOIN),this.resetSubChannel())}},{key:"onData",value:function(e,t){var r=new h.default(t);switch(e){case 0:break;default:this.onProto(e,r)}}},{key:"ping",value:function(e){this.logger.debug("ApH5.sendPing now:"+e);var t=new d.default;t.context=this.getSeqId().toString(),this.send(t.marshall())}},{key:"clearSendBuf",value:function(){this.sendBuf.length>500&&(this.sendBuf=[])}},{key:"flushBuf",value:function(){var e=this.sendBuf.length;if(0!=e){this.logger.info("ApH5.flushBuf len="+e);for(var t=0;t<e;++t){var r=this.sendBuf[t];if(r.origin)this.send(r.data);else{var i=this.wrapApRouter(r);this.send(i.buf)}}}this.sendBuf=[]}},{key:"wrapApRouter",value:function(e){var t=e.appid,r=e.svcName,i=e.fnName,n=e.routeArgs,a=e.clientHeaders,o=e.protoType,s=new p.default;e.preAllocSeq?s.context=e.preAllocSeq:s.context=this.getSeqId().toString(),s.uid=0,s.appid=t,s.instId=this.instId,s.svcName=r,s.traceId="webrtc_"+s.instId.toString()+"_"+s.context,i&&(s.fnName=i),o&&(s.protoType=o),s.data=e.data,s.dataCRC=0,n&&(s.routeArgs=n),a&&(s.clientHeaders=a);var u=s.marshall();return this.logger.debug("ApH5.wrapApRouter send service route request:"+s.toString()),{buf:u,seqId:s.context}}},{key:"send",value:function(e){this.apLink&&this.apLink.send(e)}},{key:"ready",value:function(){return this.apLink&&this.linkState==u.AP_LINK_STATE.READY}},{key:"sendApRouter",value:function(e){if(this.ready()){var t=this.wrapApRouter(e);this.send(t.buf)}else{var t=Object.assign({},e);t.preAllocSeq=this.getSeqId().toString(),t.fnName=e.fnName,t.uri=e.uri,this.sendBuf.push(t)}}},{key:"connectAp",value:function(){var t=this.appid,r=Math.floor(1e6*Math.random());this.ws="wss://"+e.kApHost+"/websocket?appid="+t+"&version="+encodeURIComponent(this.git)+"&uuid="+encodeURIComponent(r.toString()),this.apLink&&(this.apLink.destroy(),this.apLink=null),this.apLink=new s.ApLink(this.logger,this),this.logger.info("ApH5.connect start to connect ws server. url="+this.ws),this.linkState=u.AP_LINK_STATE.CONNECTING,this.apLink.connect(this.ws)}},{key:"subscribeBc",value:function(e){var t=this.getSeqId(),r=new y.default;r.context=t.toString(),r.appid=this.appid,e.subs&&(r.joinGroups=e.subs,this.joinContext={subReqStartTs:I.default.now(),context:r.context}),e.unsubs&&(r.leaveGroups=e.unsubs,this.leaveContext={subReqStartTs:I.default.now(),context:r.context}),this.logger.info("ApH5.subscribeBc "+JSON.stringify(r));var i=r.marshall();this.ready()&&this.send(i)}},{key:"joinChannelBc",value:function(){var e=this.channelIdhash,t={subs:[{grpType:2147483686,grpId:e}]};this.innerBcGroups.set(P.default.number2ProtoUInt64(2147483686).toString64()+"_"+P.default.number2ProtoUInt64(this.channelIdhash).toString64(),1),this.logger.info("ApH5.joinChannelBc innerBcGroups="+JSON.stringify(this.innerBcGroups)),this.subscribeBc(t)}},{key:"leaveChannelBc",value:function(){var e=this.channelIdhash,t={unsubs:[{grpType:2147483686,grpId:e}]},r=P.default.number2ProtoUInt64(2147483686).toString64()+"_"+P.default.number2ProtoUInt64(this.channelIdhash).toString64();this.innerBcGroups.delete(r),this.logger.info("ApH5.leaveChannelBc"),this.subscribeBc(t)}},{key:"joinChannel",value:function(){this.logger.info("ApH5 join channel :"+this.channelId+" channelhash:"+this.channelIdhash),this.channState=u.SVR_CHAN_STATE.JOIN,this.joinChannelBc()}},{key:"sendForTraceUser",value:function(){this.logger.info("ApH5 sendForTraceUser, appid:"+this.appid+", fnName:"+this.uid),this.sendApRouter({appid:this.appid,svcName:"svcLog",fnName:this.uid.toString(),data:""})}},{key:"sendStreamSvr",value:function(e,t){var r=new Map;r.set("channelid",e);var i="Service_SimpleStreamSvr";1===this.userArea?i="Oversea_SimpleStreamSvr":2===this.userArea&&(i="YY_SimpleStreamSvr"),this.sendApRouter({appid:this.appid,svcName:i,data:t,routeArgs:r})}},{key:"leaveChannel",value:function(){this.channState!=u.SVR_CHAN_STATE.JOINSUCC&&this.logger.info("ApH5 has not join channel success :"+this.channelId),this.channState=u.SVR_CHAN_STATE.LEAVE,this.leaveChannelBc()}},{key:"addSubChannel",value:function(e){this.logger.info("ApH5.addSubChannel channelId="+e);var t=P.default.hashString(this.appid+"-"+e),r=[{grpType:2147483686,grpId:t}];this.innerBcGroups.set(P.default.number2ProtoUInt64(2147483686).toString64()+"_"+P.default.number2ProtoUInt64(t).toString64(),1),this.logger.info("ApH5.joinChannelBc innerBcGroups="+JSON.stringify(this.innerBcGroups));var i=this.getSeqId(),n=new y.default;n.context=i.toString(),n.appid=this.appid,n.joinGroups=r;var a={channelId:e,channelHash:t,context:n.context,join:!0,joinSucc:!1,leave:!1};this.subChannel.set(e,a),this.logger.info("ApH5.subscribeBc "+JSON.stringify(n));var o=n.marshall();this.ready()&&this.send(o)}},{key:"delSubChannel",value:function(e){this.logger.info("ApH5.delSubChannel channelId="+e);var t=P.default.hashString(this.appid+"-"+e),r=[{grpType:2147483686,grpId:t}];this.innerBcGroups.delete(P.default.number2ProtoUInt64(2147483686).toString64()+"_"+P.default.number2ProtoUInt64(t).toString64()),this.logger.info("ApH5.joinChannelBc innerBcGroups="+JSON.stringify(this.innerBcGroups));var i=this.getSeqId(),n=new y.default;n.context=i.toString(),n.appid=this.appid,n.leaveGroups=r;var a={channelId:e,channelHash:t,context:n.context,join:!1,joinSucc:!1,leave:!0};this.subChannel.set(e,a),this.logger.info("ApH5.subscribeBc "+JSON.stringify(n));var o=n.marshall();this.ready()&&this.send(o)}},{key:"resetSubChannel",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.subChannel.entries()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var o=a(i.value,2),s=o[0],u=o[1];u.leave?this.subChannel.delete(s):u.join&&(u.joinSucc=!1)}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}}},{key:"checkSubChannel",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.subChannel.entries()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var o=a(i.value,2),s=o[1];if(!s.joinSucc){var u=s.channelHash,l=[{grpType:2147483686,grpId:u}],h=new y.default;h.context=s.context,h.appid=this.appid,h.joinGroups=l,this.logger.info("ApH5.checkSubChannel subscribeBc "+JSON.stringify(h));var c=h.marshall();this.ready()&&this.send(c)}}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}}},{key:"clearSubChannel",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.subChannel.entries()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var o=a(i.value,1),s=o[0];this.subChannel.delete(s)}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}var u=!0,l=!1,h=void 0;try{for(var c,d=this.innerBcGroups.entries()[Symbol.iterator]();!(u=(c=d.next()).done);u=!0){var f=a(c.value,1),p=f[0];this.innerBcGroups.delete(p)}}catch(e){l=!0,h=e}finally{try{!u&&d.return&&d.return()}finally{if(l)throw h}}}}]),e}();return e.kApHost="web-ap-service.jocloud.com",e}();r.default=U,t.exports=r.default},{"../protobase/uri":23,"../protocol/ap/PSvcBroadcast":47,"../protocol/ap/PSvcPing":48,"../protocol/ap/PSvcPong":49,"../protocol/ap/PSvcRouteReq":50,"../protocol/ap/PSvcRouteRes":51,"../protocol/ap/PSvcSubsGroupReq":52,"../protocol/ap/PSvcSubsGroupRes":53,"../utils/timeUtil":92,"../utils/utils":93,"./../protobase/ProtoUnmarshall":22,"./ApEnum":6,"./ApLink":8}],8:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=e("./../utils/timeUtil"),o=function(e){return e&&e.__esModule?e:{default:e}}(a),s=function(){function e(t,r){i(this,e),this.logger=t,this.ws=null,this.linkHanlder=r}return n(e,[{key:"destroy",value:function(){this.close()}},{key:"isConnected",value:function(){return this.connected}},{key:"connect",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];this.lastRecvTick=o.default.now(),this.ws=null,this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=this.onopen.bind(this),this.ws.onerror=this.onerror.bind(this),this.ws.onclose=this.onclose.bind(this),this.ws.onmessage=this.onmessage.bind(this)}},{key:"onCheckTimer",value:function(e){this.onTimeOut(e)}},{key:"close",value:function(){this.ws&&(this.connected=!1,this.ws.onopen=null,this.ws.onerror=null,this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.ws=null)}},{key:"onTimeOut",value:function(e){if(e-this.lastRecvTick>23e3)return this.logger.warn("ApLink recvTick timeout23000"),void this.onclose()}},{key:"onopen",value:function(){this.logger.info("ApLink.onopen"),this.connected=!0,this.lastRecvTick=o.default.now(),this.linkHanlder.onConnected(this)}},{key:"send",value:function(e){this.ws&&this.connected&&this.ws.send(e)}},{key:"onerror",value:function(e){this.logger.warn("ApLink.onerror err="+JSON.stringify(e)),this.connected=!1,this.linkHanlder.onError(this)}},{key:"onclose",value:function(){this.logger.info("ApLink.onclose"),this.connected=!1,this.linkHanlder.onClose(this)}},{key:"onmessage",value:function(e){this.lastRecvTick=o.default.now(),e.data instanceof ArrayBuffer?this.processArrayBuffer(e.data):this.processText(e.data)}},{key:"processText",value:function(e){this.logger.info("wc_wss.processText data="+e)}},{key:"processArrayBuffer",value:function(e){for(var t=new DataView(e),r=0,i=0,n=0;r+10<e.byteLength;){if(i=t.getUint32(r,!0),r+i>e.byteLength||i<10)return void this.logger.error("ProtoLink.processArrayBuffer length error pktLen="+i+" bufferLen="+e.byteLength);n=t.getUint32(r+4,!0);var a=new DataView(e,r,i);this.linkHanlder.onData(n,a),r+=i}}}]),e}();r.ApLink=s},{"./../utils/timeUtil":92}],9:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e)}return n(e,null,[{key:"parseTypeCodec",value:function(e,t){for(var r={num:[],name:[],lines:[]},i=-1,n=0;n<e.length;n++)if(-1!==e[n].search("m="+t)){i=n;break}if(-1!==i){r.num=e[i].split(" ").slice(3),r.name=new Array(r.num.length);for(var n=0;n<r.num.length;n++)for(var a=0;a<e.length;a++){var o=e[a].split(new RegExp("a=(.*):"+r.num[n]+" (.*)","i"));o.length>2&&("rtpmap"===o[1]&&(r.name[n]=o[2]),r.lines[n]?r.lines[n].push(a):r.lines[n]=[a])}}return r}},{key:"extractCodec",value:function(e){var t={video:null,audio:null};return t.video=this.parseTypeCodec(e,"video"),t.audio=this.parseTypeCodec(e,"audio"),t}},{key:"isSupportCodec",value:function(e,t){for(var r=-1,i=-1,n=0;n<t.num.length;n++)-1!==t.name[n].search(e)&&(-1===r||t.num[n]<r)&&(r=t.num[n],i=n);return i}},{key:"modifySdp",value:function(e,t,r,i){if(!t)return i;var n=this.isSupportCodec(t,r);if(-1===n)return i;for(var a=0;a<i.length;a++)if(-1!==i[a].search("m="+e)){var o=i[a].split(" ");o.splice(3),o.push(r.num[n]),i[a]=o.join(" ")}for(var a=0;a<r.num.length;a++)if(a!==n)for(var s=0;s<=r.lines[a].length;s++)i[r.lines[a][s]]="";return i}},{key:"addUseDtx",value:function(e){for(var t=0;t<e.length;t++)if(-1!==e[t].search("a=fmtp")){" "!==e[t][-1]&&(e[t]+=";"),e[t]+="usedtx=1";break}return e}},{key:"setPreferCodec",value:function(e,t){var r="\r\n";-1===t.sdp.search(r)&&(r="\n");var i=t.sdp.split(r),n=this.extractCodec(i);i=this.modifySdp("video",e.video,n.video,i),i=this.modifySdp("audio",e.audio,n.audio,i),e.addUseDtx&&(i=this.addUseDtx(i));var a=[],o=!0,s=!1,u=void 0;try{for(var l,h=i[Symbol.iterator]();!(o=(l=h.next()).done);o=!0){var c=l.value;""!==c&&a.push(c)}}catch(e){s=!0,u=e}finally{try{!o&&h.return&&h.return()}finally{if(s)throw u}}return t.sdp=a.join(r)+r,t}},{key:"updateBandwidthRestriction",value:function(e,t,r){e=this.removeBandwidthRestriction(e);return e=e.replace(/a=rtpmap:(\d+) (H264|VP8)\/(\d+)(\n|\r\n)/g,"a=rtpmap:$1 $2/$3$4b=AS:"+t+"$4a=fmtp:$1 x-google-start-bitrate="+t+"$4a=fmtp:$1 x-google-min-bitrate="+r+"$4")}},{key:"removeBandwidthRestriction",value:function(e){return e=e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,""),e=e.replace(/b=AS:.*\n/,"").replace(/b=TIAS:.*\n/,""),e=e.replace(/a=fmtp:(\d*) x-google-start-bitrate=(\d*)(\n|\r\n)/,""),e=e.replace(/a=fmtp:(\d*) x-google-min-bitrate=(\d*)(\n|\r\n)/,"")}},{key:"setOpusConfig",value:function(e,t){return e.sdp=e.sdp.replace(/a=rtpmap:(\d+) opus\/48000\/2(\n|\r\n)/,"a=rtpmap:$1 opus/48000/2$2a=rtcp-fb:$1 nack$2"),t&&(e.sdp=e.sdp.replace("minptime=10;useinbandfec=1",t)),e}},{key:"setRtcpXrRrtr",value:function(e){return e.replace(/a=rtcp-fb:(\d+) goog-remb/,"a=rtcp-fb:$1 goog-remb\na=rtcp-fb:$1 rrtr")}}]),e}();r.default=a,t.exports=r.default},{}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i={MODE:{GROUP:0,STREAM:1},PLAY_TYPE:{NORMAL:1,SCREEN_SHARE:2,MIX:3},AUDIO_MODE:{LOW:1,STANDARD:2,HIGH:3,HIGH_STEREO:4}};r.default=i,t.exports=r.default},{}],11:[function(e,t,r){"use strict";function i(e){var t={audio:{},video:{},remoteAudio:{},remoteVideo:{},localCandidate:{},remoteCandidate:{},videoTrack:{},audioTrack:{},dtlsState:"",
currentRoundTripTime:0};return e.getStats().then(function(e){var r=[];return e.forEach(function(e){r.push(e)}),r.forEach(function(e){var r=/-/g,i=e.type.replace(r,"_");n[i]&&n[i](e,t)}),t})}Object.defineProperty(r,"__esModule",{value:!0});var n={};n.inbound_rtp=function(e,t){"video"!==e.mediaType&&"audio"!==e.mediaType||(t[e.mediaType]=e)},n.outbound_rtp=function(e,t){"video"!==e.mediaType&&"audio"!==e.mediaType||(t[e.mediaType]=e)},n.remote_inbound_rtp=function(e,t){"video"!==e.kind&&"audio"!==e.kind||("audio"===e.kind?t.remoteAudio=e:"video"===e.kind&&(t.remoteVideo=e))},n.track=function(e,t){e.hasOwnProperty("frameWidth")?t.videoTrack=e:"audio"===e.kind&&(t.audioTrack=e)},n.transport=function(e,t){t.dtlsState=e.dtlsState},n.candidate_pair=function(e,t){!0===e.nominated&&(t.currentRoundTripTime=e.currentRoundTripTime)},n.local_candidate=function(e,t){"prflx"===e.candidateType?t.localCandidate=e:"srflx"===e.candidateType&&(t.localCandidate=e)},n.remote_candidate=function(e,t){t.remoteCandidate=e},r.default=i,t.exports=r.default},{}],12:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e){return"connected"===e||"completed"===e}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=function(){function e(t,r,n){i(this,e),this.uid=t,this.channelId=r,this.webrtc=n,this.stat="new",this.reconnecting=!1}return a(e,[{key:"updateStat",value:function(e){n(this.stat)&&!n(e)?(this.reconnecting=!0,this.trigger("stream_reconnect_start")):this.reconnecting&&n(e)&&(this.trigger("stream_reconnect_end"),this.reconnecting=!1),this.stat=e}},{key:"reset",value:function(){this.stat="new"}},{key:"trigger",value:function(e){this.webrtc.trigger(e,{uid:this.uid,roomId:this.channelId})}}]),e}();r.default=o,t.exports=r.default},{}],13:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){function r(r,i){var n=new FileReader;n.onload=function(t){e(r,t.target.result)},n.onerror=function(){t("read file error - "+n.error)},n.readAsArrayBuffer(i)}var i=document.createElement("input");i.type="file",i.accept="audio/*";var n=!1;i.onclick=function(){n=!0},document.body.onfocus=function(){setTimeout(function(){n&&(n=!1,i.value||t("no file choose"))},500)},i.onchange=function(){if(null===i||null===i.files||null===i.files[0])return void t("file is null");var e="";i.value&&(e=i.value.split(/[\/\\]/).pop()),r(e,i.files[0])},i.style.display="none",i.click()}function o(e,t,r){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.onload=function(){t(e,i.response)},i.onerror=function(){r()},i.open("GET",e,!0),i.send()}Object.defineProperty(r,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},l=e("./MixerSource"),h=function(e){function t(e,r,n,a,o){i(this,t),u(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,r,n),this.option=r,this.context=n,this.destination=a,this.playGain=o,this.startedAt=0,this.pausedAt=0,this.playing=!1,this.fileName=null,this.logger.info("BufferMixerSource.ctr()"),this.buffer=null,this.sourceNode=null,this.gainNode.connect(this.destination),!1!==r.extraPlay&&this.gainNode.connect(o)}return n(t,e),s(t,[{key:"onGetBuffer",value:function(e,t){this.fileName=e,this.context.decodeAudioData(t,this.onDecodeSuccess.bind(this),this.onDecodeFail.bind(this))}},{key:"onDecodeSuccess",value:function(e){this.logger.info("BufferMixerSource.onDecodeSuccess"),this.buffer=e,this.play()}},{key:"onDecodeFail",value:function(e){this.logger.info("BufferMixerSource.onDecodeFail: "+e.message),this.stop()}},{key:"play",value:function(){if(!this.stopped){this.logger.info("BufferMixerSource.play");var e=this.context.createBufferSource();e.buffer=this.buffer,e.connect(this.gainNode),this.callbackHandler=this.endCallback.bind(this),e.addEventListener("ended",this.callbackHandler);var t=void 0;t=this.pausedAt>0?this.pausedAt:this.playTime,e.start(0,t),this.sourceNode=e,this.startedAt=this.context.currentTime-t,this.pausedAt=0,this.playing=!0,this.emittedPlayed||(this.emit("played",this.fileName),this.emittedPlayed=!0)}}},{key:"start",value:function(){var e=this;this.logger.info("BufferMixerSource.start"),this.local?a(this.onGetBuffer.bind(this),function(t){e.logger.info("add local src fail"),e.emit("error",t),e.stop()}):o(this.url,this.onGetBuffer.bind(this),function(){e.logger.info("add online src fail"),e.stop()})}},{key:"resume",value:function(){if(this.logger.info("BufferMixerSource.resume"),this.playing||0===this.pausedAt)return{error:"NOT_PAUSE"};this.play()}},{key:"pause",value:function(){return this.logger.info("BufferMixerSource.pause"),this.pausedAt?{error:"ALREADY_PAUSE"}:(this.pausedAt=this.context.currentTime-this.startedAt,this.clearSourceNode(),this.startedAt=0,this.playing=!1,null)}},{key:"getCurrentTime",value:function(){return this.pausedAt?this.pausedAt:this.startedAt?this.context.currentTime-this.startedAt:0}},{key:"setCurrentTime",value:function(e){return this.buffer&&e>=this.buffer.duration?void this.stop():this.pausedAt?void(this.pausedAt=e):(this.pause(),this.pausedAt=e,void this.play())}},{key:"getDuration",value:function(){return this.buffer?this.buffer.duration:0}},{key:"clearSourceNode",value:function(){this.sourceNode&&(this.sourceNode.removeEventListener("ended",this.callbackHandler),this.sourceNode.disconnect(),this.sourceNode.stop(0),this.sourceNode=null)}},{key:"stop",value:function(){this.logger.info("BufferMixerSource.stop"),this.stopped||(this.clearSourceNode(),this.gainNode.disconnect(),this.stopped=!0,this.logger.info("BufferMixerSource.stop"),this.emit("ended"))}},{key:"endCallback",value:function(){if(this.loop)return void this.play();this.cycle--,this.cycle>0?this.play():this.stop()}}]),t}(l.MixerSource);r.default=h,t.exports=r.default},{"./MixerSource":15}],14:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./OnlineMixerSource"),s=i(o),u=e("./BufferMixerSource"),l=i(u),h=e("./MixerSource"),c=e("../utils/browser"),d=i(c),f=e("../utils/AudioContextMgr"),p=i(f),v=function(){function e(t,r){n(this,e),this.context=t,this.stream=r,this.source=this.context.createMediaStreamSource(r),d.default.isSafari&&(this.gain=this.context.createGain(),this.source.connect(this.gain))}return a(e,[{key:"connect",value:function(e){this.gain?(this.gain.gain.value=1,this.currentDst!==e&&(this.gain.connect(e),this.currentDst=e)):this.source.connect(e)}},{key:"disconnect",value:function(){this.gain?this.gain.gain.value=0:this.source.disconnect()}}]),e}(),m=function(){var e=function(){function e(t,r){n(this,e),this.logger=t,this.trigger=r,this.userTrack=void 0,this.userSource=void 0,this.addedTracksAndSources=[],this.replaced=!1,this._userVolume=h.MixerSource.DefaultVolume,this.logger.debug("Mixer.ctr"),this.sources=new Map,this.context=(0,p.default)(),this.destination=this.context.createMediaStreamDestination(),this.userGain=this.context.createGain(),this.mixGain=this.context.createGain(),this.playGain=this.context.createGain(),this.playGain.connect(this.context.destination),this.userGain.connect(this.mixGain),this.mixGain.connect(this.destination),d.default.os.isAndroid&&(this.androidLocalPlayGain=this.context.createGain(),this.androidLocalPlayGain.gain.value=.001,this.mixGain.connect(this.androidLocalPlayGain),this.androidLocalPlayGain.connect(this.context.destination)),this.mixTrack=this.destination.stream.getAudioTracks()[0]}return a(e,[{key:"addUserTrack",value:function(e){this.userTrack=e;var t=new MediaStream;t.addTrack(e),this.userSource=new v(this.context,t),this.userSource.connect(this.userGain)}},{key:"addTrack",value:function(e){if(e===this.mixTrack)return{error:"ALREADY_ADD"};if(this.addedTracksAndSources.find(function(t){return t.track===e}))return{error:"ALREADY_ADD"};var t=new MediaStream;t.addTrack(e);var r=this.context.createMediaStreamSource(t);r.connect(this.userGain),this.addedTracksAndSources.push({track:e,source:r})}},{key:"removeTrack",value:function(e){if(e===this.mixTrack)return this.clearAllInputs(),null;if(e===this.userTrack)return this.userTrack.stop(),this.userSource.disconnect(),this.userTrack=null,this.userSource=null,null;var t=this.addedTracksAndSources.find(function(t){return t.track===e});return t?(t.source.disconnect(),t.track.stop(),this.addedTracksAndSources=this.addedTracksAndSources.filter(function(t){return t.track!==e}),null):{error:"NO_TRACK"}}},{key:"startMixing",value:function(t,r){var i=this;return this.logger.info("Mixer.startMix("+t+","+JSON.stringify(r)+")"),new Promise(function(n,a){if(t<0||t>e.MaxId)return i.logger.info("Mixer.startMix with wrong id: "+t),!1;i.sources.has(t)&&i.stopMixing(t);var o=void 0;o=r.local||d.default.os.isIOS?new l.default(i.logger,r,i.context,i.mixGain,i.playGain):new s.default(i.logger,r,i.context,i.mixGain,i.playGain),i.sources.set(t,o);var u=!1;if(o.on("ended",function(){i.sources.delete(t),0===t&&i.replaced&&(i.replaced=!1,i.userSource&&i.userSource.connect(i.userGain)),u&&i.trigger("audio_mixing_finished",{id:t})}),o.on("played",function(e){u=!0,i.trigger("audio_mixing_played",{id:t,fileName:e}),n(e)}),o.on("error",function(e){i.logger.warn("mixer source error: "+e),a("SOURCE_LOAD_ERROR")}),r.replace){if(0!==t)return void a("INVALID_MIX_ID");i.replaced=!0,i.userSource&&i.userSource.disconnect()}o.start()})}},{key:"stopMixing",value:function(e){this.logger.info("Mixer.stopMix("+e+")");var t=this.sources.get(e);return t?(t.stop(),null):{error:"MIX_AUDIO_NOT_EXISTED"}}},{key:"setVolume",value:function(e,t){var r=this.getMixerSourceFromId(e);return r?(r.volume=t,null):{error:"MIX_AUDIO_NOT_EXISTED"}}},{key:"getVolume",value:function(e){var t=this.getMixerSourceFromId(e);return t?t.volume:h.MixerSource.DefaultVolume}},{key:"pause",value:function(e){this.logger.info("Mixer.pause");var t=this.getMixerSourceFromId(e);return t?t.pause():{error:"MIX_AUDIO_NOT_EXISTED"}}},{key:"resume",value:function(e){this.logger.info("Mixer.resume");var t=this.getMixerSourceFromId(e);return t?t.resume():{error:"MIX_AUDIO_NOT_EXISTED"}}},{key:"getCurrentTime",value:function(e){var t=this.getMixerSourceFromId(e);return t?t.getCurrentTime():0}},{key:"setCurrentTime",value:function(e,t){this.logger.info("Mixer.setCurrentTime");var r=this.getMixerSourceFromId(e);return r?(r.setCurrentTime(t),null):{error:"MIX_AUDIO_NOT_EXISTED"}}},{key:"getDuration",value:function(e){var t=this.getMixerSourceFromId(e);return t?t.getDuration():0}},{key:"getAllIds",value:function(){return Array.from(this.sources.keys())}},{key:"getMixerSourceFromId",value:function(e){var t=this.sources.get(e);return t||(this.logger.info("Cannot find MixerSource"),null)}},{key:"destroy",value:function(){this.logger.info("Mixer.destroy()"),this.clearAllInputs(),this.userGain.disconnect(),this.mixGain.disconnect(),this.playGain.disconnect(),this.androidLocalPlayGain&&this.androidLocalPlayGain.disconnect()}},{key:"clearAllInputs",value:function(){this.sources.forEach(function(e){e.stop()}),this.sources.clear(),this.userTrack&&this.userSource&&(this.userSource.disconnect(),this.userTrack.stop()),this.userSource=void 0,this.userTrack=void 0;var e=!0,t=!1,r=void 0;try{for(var i,n=this.addedTracksAndSources[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var a=i.value;a.source.disconnect(),a.track.stop()}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}this.addedTracksAndSources=[]}},{key:"replaceUserTrack",value:function(e){if(this.userTrack){this.userTrack=e;var t=new MediaStream;t.addTrack(e),this.userSource.disconnect(),this.userSource=new v(this.context,t),this.userSource.connect(this.userGain)}}},{key:"enableAudio",value:function(){this.userTrack&&(this.userTrack.enabled=!0),this.mixGain.gain.value=1,this.playGain.gain.value=1}},{key:"disableAudio",value:function(){this.userTrack&&(this.userTrack.enabled=!1),this.mixGain.gain.value=0,this.playGain.gain.value=0}},{key:"userVolume",get:function(){return this._userVolume},set:function(e){e>100&&(e=100),e<0&&(e=0),this.logger.info("MixerSource.set.volume "+e),this._userVolume=e,this.userGain.gain.value=this._userVolume/100}},{key:"inputCount",get:function(){var e=this.addedTracksAndSources.length;return this.userTrack&&(e+=1),e}}]),e}();return e.MaxId=1e4,e}();r.default=m,t.exports=r.default},{"../utils/AudioContextMgr":81,"../utils/browser":90,"./BufferMixerSource":13,"./MixerSource":15,"./OnlineMixerSource":16}],15:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},s=e("events"),u=function(){var e=function(e){function t(e,r,n){i(this,t),o(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.logger=e,this.option=r,this.context=n,this.stopped=!1,this.emittedPlayed=!1,this._volume=t.DefaultVolume,this.url=r.url,this.playTime=r.playTime?r.playTime/1e3:0,this.cycle=r.cycle?r.cycle:1,this.local=!!r.local,this.loop=!!r.loop,this.gainNode=n.createGain()}return n(t,e),a(t,[{key:"volume",get:function(){return this._volume},set:function(e){e>100&&(e=100),e<0&&(e=0),this.logger.info("MixerSource.set.volume "+e),this._volume=e,this.gainNode.gain.value=this._volume/100}}]),t}(s.EventEmitter);return e.DefaultVolume=100,e}();r.MixerSource=u},{events:97}],16:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},s=e("./MixerSource"),u=function(e){function t(e,r,n,a,s){i(this,t),o(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,r,n),this.option=r,this.context=n,this.destination=a,this.playGain=s,this.duration=0,this.paused=!1,this.audioElement=document.createElement("audio"),this.audioElement.src=r.url?r.url:"",this.audioElement.crossOrigin="anonymous",this.sourceNode=n.createMediaElementSource(this.audioElement),this.sourceNode.connect(this.gainNode),this.gainNode.connect(a),!1!==r.extraPlay&&this.gainNode.connect(s),this.initElement()}return n(t,e),a(t,[{key:"initElement",value:function(){var e=this;this.audioElement.onloadedmetadata=function(){e.duration=e.audioElement.duration},this.audioElement.addEventListener("ended",function(){e.audioElement.currentTime=e.playTime,e.loop?e.play():(e.cycle--,e.cycle>0?e.play():e.stop())}),this.audioElement.addEventListener("play",function(){})}},{key:"play",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]||arguments[0];this.audioElement.play().then(function(){if(t&&(e.audioElement.currentTime=e.playTime),!e.emittedPlayed){var r=e.audioElement.src.split(/[\/\\]/).pop();e.emit("played",r),e.emittedPlayed=!0}}).catch(function(t){e.paused||(e.emit("error",""+t),e.stop())})}},{key:"start",value:function(){this.stopped||this.play()}},{key:"resume",value:function(){return!1===this.paused?{error:"NOT_PAUSE"}:(this.logger.info("OnlineMixerSource.resume"),this.play(!1),this.paused=!1,null)}},{key:"pause",value:function(){return!0===this.paused?{error:"ALREADY_PAUSE"}:(this.logger.info("OnlneMixerSource.pause"),this.audioElement.pause(),this.paused=!0,null)}},{key:"getCurrentTime",value:function(){return this.audioElement.currentTime}},{key:"setCurrentTime",value:function(e){this.audioElement.currentTime=e}},{key:"getDuration",value:function(){return this.duration}},{key:"stop",value:function(){this.stopped||(this.stopped=!0,this.logger.info("OnlineMixerSource.stop"),this.audioElement.pause(),this.sourceNode.disconnect(),this.gainNode.disconnect(),this.emit("ended"))}}]),t}(s.MixerSource);r.default=u,t.exports=r.default},{"./MixerSource":15}],17:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});r.default={PUBLISHER_CUR_BIT_RATE:7,PUBLISHER_MIN_BIT_RATE:8,PUBLISHER_MAX_BIT_RATE:9,PUBLISHER_TOTAL_BIT_RATE:10,PUBLISHER_RESOLUTION:11,PUBLISHER_FRAME_RATE:12,PUBLISHER_SUBSTREAM_NUM:13,PUBLISHER_MIN_PEER_NODE_NUM:14,PUBLISHER_MAX_PEER_NODE_NUM:15,PUBLISHER_START_PUBLISH_TIME:16,PUBLISHER_PUBLISHING_TIME:17,PUBLISHER_STREAM_ALIVE:-1,PUBLISHER_VIDEOSDK_VER:31,PUBLISHER_CAP_SRC_RESELUTION_RATIO:32,PUBLISHER_CAP_ENC_INFO:33,PUBLISHER_CAP_ENC_INFO_EX:34,PUBLISHER_HIGH_DELAY:35,PUBLISHER_TOP_SID:36,PUBLISHER_CAP_ENC_INFO_PLUS:37,PUBLISHER_MY_MAX_BIT_RATE:38,PUBLISHER_APP_TYPE:39,PUBLISHER_PUBLISH_ID:40,PUBLISHER_RESEND_JITTER:41,PUBLISHER_CLIENT_TYPE:42,PUBLISHER_SECRET_KEY:43,PUBLISER_MULTICODERATE_SEND_FRAME_JITTER:45,SERVER_TRANSCODE:105,SERVER_VALID_TRANSCODE:106,SERVER_TRANSCODE_STOPPED:107,SERVER_ORI_STREAM_ID_STAMP:108,SERVER_TRANS_CODE_TYPE_3_SUPPORT:109,SERVER_TRANS_CODE_ORI_STREAM_CODE_RATE:110,SERVER_TRANSCODE_TRANS_LEVEL:111,SERVER_H265_STREAM:112,SERVER_FASTACCESS_MODE:113,SERVER_FASTACCESS_FIRST_SEQ:114,SERVER_FASTACCESS_LAST_SEQ:115,SERVER_STREAM_TYPE:200,ORI_STREAM_TIMESTAMP:201,USER_RESEND_LIMIT:202,StreamCfgKey:{PUBLISHID:1,SPEAKER_UID:2,STREAM_TYPE:3,SET_BIT_RATE:4,STREAM_ENCODE_TYPE:5,STREMA_AUDIO_CHANNELS:6,STREAM_AUDIO_SAMPLERATE:7,STREMA_PUBLISH_STREAM_PROVIDER:8,SID_BROADCAST_AUDIO:9,PUBLISHER_MC_POS:10,SET_FRAME_RATE:11,RESOLUTION_WIDTH:12,RESOLUTION_HEIGHT:13,SERVICE_TYPE:1001,FAST_ACCESS_MODE:1005,FAST_ACCESS_INTERVAL:1006,FAST_ACCESS_FIRST_SEQ:1007,FAST_ACCESS_LAST_SEQ:1008,FAST_ACCESS_FIRST_DTS:1009,FAST_ACCESS_LAST_DTS:1010,USER_RESEND_LIMIT:1011,PUBLISHER_SECRET_KEY:2001,PUBLISHER_FRAME_RATE:2002,PUBLISHER_START_PUBLISH_TIME:2004,PUBLISHER_CUR_BIT_RATE:2005,PUBLISER_MAX_PTS_DTS_DIFF:2006,PUBLISHER_MY_MAX_BIT_RATE:2007,PUBLISHER_CLIENT_TYPE:2008,PUBLISHER_CHECK_INCORRECT_STREAM:2010,PUBLISHER_TOTAL_BIT_RATE:2011,PUBLISHER_MIN_BIT_RATE:2014,PUBLISHER_STREAM_ALIVE:2015,PUBLISHER_VIDEOSDK_VER:2016,PUBLISHER_CAP_ENC_INFO:2017,PUBLISHER_CAP_ENC_INFO_EX:2018,PUBLISHER_CAP_ENC_INFO_PLUS:2019,PUBLISHER_CAP_SRC_RESELUTION_RATIO:2020,PUBLISHER_RESEND_JITTER:2021,PUBLISHER_PROXY_GROUPID:2022,PUBLISHER_PROXY_AREATYPE:2023,WEBRTC_STREAM_LAYER:10001},StreamCfgValue:{STREAM_TYPE_VALUE:{VALUE_VIDEO:1,VALUE_AUDIO:2},FAST_ACCESS_MODE_VALUE:{VALUE_PUSH:1,VALUE_PULL:2}},PWebRTCCodec:{H264:0,VP8:1},PWebRTCMessageKey:{VIDEO_BIT_RATE:0,VIDEO_TRANS_STATUS:1,AUDIO_TRANS_STATUS:100,NEGOTIATION:200},WebRTCEvent:{CONN_INITIAL:101,CONN_STARTED:102,CONN_GATHERED:103,CONN_READY:104,CONN_FINISHED:105,CONN_CONNECTING:106,CONN_CANDIDATE:201,CONN_SDP:202,CONN_FAILED:500},LiveUserMsgData:{USER_MSG_UP_LOSS_RATE:1,USER_MSG_DN_LOSS_RATE:2,USER_MSG_PING_RTT:3,USER_MSG_CLIENT_TYPE:4,USER_MSG_SEQ:5,USER_MSG_LINK_IP:6,USER_MSG_SUBSID:7,USER_MSG_NOW:8,USER_MSG_CAN_SPEAK:9,USER_MSG_LOCAL_TIME:10,USER_MSG_OS_TIME:11,USER_MSG_MUTE_AUDIO:21,USER_MSG_NETWORK_TX_QUALITY:22,USER_MSG_NETWORK_RX_QUALITY:23,USER_MSG_STRING_UID:65536},LiveSystemLayerRes:{SET_LAYER_SUCCUSS:0,SET_LAYER_ERR_NO_USER:101,SET_LAYER_ERR_NO_PEERCONNECTION:102,SET_LAYER_ERR_PUBUID:103}},t.exports=r.default},{}],18:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(t,r){var n=arguments.length<=2||void 0===arguments[2]||arguments[2];i(this,e),this.logger=t,this.linkHandler=r,this.ws=null,this.connected=!1,this.isYY=n}return n(e,[{key:"destroy",value:function(){this.linkHandler=null,this.reset()}},{key:"connect",value:function(e){this.reset(),this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=this.onopen.bind(this),this.ws.onerror=this.onerror.bind(this),this.ws.onclose=this.onclose.bind(this),this.ws.onmessage=this.onmessage.bind(this)}},{key:"reset",value:function(){this.ws&&(this.connected=!1,this.ws.onopen=null,this.ws.onerror=null,this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.ws=null)}},{key:"send",value:function(e){this.ws&&this.connected&&this.ws.send(e)}},{key:"onopen",value:function(){this.connected=!0,this.linkHandler&&this.linkHandler.onopen()}},{key:"onerror",value:function(e){this.connected=!1,this.ws=null,this.linkHandler&&(this.linkHandler.onerror(e),this.linkHandler=null)}},{key:"onclose",value:function(e){this.connected=!1,this.ws=null,this.linkHandler&&(this.logger.warn("WebSocket.onclose, evt.code:"+e.code),this.linkHandler.onclose(),this.linkHandler=null)}},{key:"onmessage",value:function(e){e.data instanceof ArrayBuffer?this.processArrayBuffer(e.data):this.processText(e.data)}},{key:"processText",value:function(e){this.logger.info("ProtoLink.processText data="+e)}},{key:"processArrayBuffer",value:function(e){for(var t=new DataView(e),r=0,i=0,n=0;r+10<e.byteLength;){if(i=t.getUint32(r,!0),r+i>e.byteLength||i<10)return void this.logger.error("ProtoLink.processArrayBuffer length error pktLen="+i+" bufferLen="+e.byteLength);n=t.getUint32(r+4,!0);var a=new DataView(e,r,i);this.linkHandler&&this.linkHandler.onData(n,a),r+=i}}}]),e}();r.default=a,t.exports=r.default},{}],19:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]||arguments[0];i(this,e),this.hasHeader=t,this.segments=[],this.data=null,this.totalLen=0,this.uri=0,this.hasHeader&&(this.pushUInt32(10),this.pushUInt32(this.uri),this.pushUInt16(200))}return n(e,[{key:"destroy",value:function(){}},{key:"marshall",value:function(){if(0===this.segments.length)return null;this.data=new Uint8Array(this.totalLen);for(var e=0,t=0;t<this.segments.length;++t){var r=this.segments[t];this.data.set(r,e),e+=r.length}return this.hasHeader&&(this.replaceUInt32(0,this.totalLen),this.replaceUInt32(4,this.uri)),this.data}},{key:"setUri",value:function(e){this.uri=e}},{key:"replaceUInt32",value:function(e,t){new DataView(this.data.buffer).setUint32(e,t,!0)}},{key:"pushUInt8",value:function(e){var t=new Uint8Array(1);new DataView(t.buffer).setUint8(0,e),this.segments.push(t),this.totalLen++}},{key:"pushBool",value:function(e){this.pushUInt8(e?1:0)}},{key:"pushUInt16",value:function(e){var t=new Uint8Array(2);new DataView(t.buffer).setUint16(0,e,!0),this.segments.push(t),this.totalLen+=2}},{key:"pushUInt32",value:function(e){var t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,e,!0),this.segments.push(t),this.totalLen+=4}},{key:"pushUInt64",value:function(e){var t=new Uint8Array(8),r=new DataView(t.buffer);r.setUint32(0,e.low,!0),r.setUint32(4,e.high,!0),this.segments.push(t),this.totalLen+=8}},{key:"pushUGID",value:function(e){this.pushUInt16(12),this.pushUInt32(e.sid),this.pushUInt32(e.appId),this.pushUInt32(e.channelId)}},{key:"pushUint8Array",value:function(e){this.pushUInt16(e.length),this.segments.push(e),this.totalLen+=e.length}},{key:"pushUint8ArrayWithoutLen",value:function(e){this.segments.push(e),this.totalLen+=e.length}},{key:"pushUint8Array32",value:function(e){this.pushUInt32(e.length),this.segments.push(e),this.totalLen+=e.length}},{key:"pushUIntArray",value:function(e){this.pushUInt32(e.length);for(var t=0;t<e.length;t++)this.pushUInt32(e[t])}},{key:"pushString",value:function(e){this.pushUInt16(e.length);for(var t=new Uint8Array(e.length),r=new DataView(t.buffer),i=0;i<e.length;++i)r.setUint8(i,e.charCodeAt(i));this.segments.push(t),this.totalLen+=e.length}},{key:"pushString32",value:function(e){this.pushUInt32(e.length);for(var t=new Uint8Array(e.length),r=new DataView(t.buffer),i=0;i<e.length;++i)r.setUint8(i,e.charCodeAt(i));this.segments.push(t),this.totalLen+=e.length}},{key:"pushUInt32AndUInt32Map",value:function(e){this.pushUInt32(e.size);var t=!0,r=!1,i=void 0;try{for(var n,a=e[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;this.pushUInt32(o[0]),this.pushUInt32(o[1])}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}}]),e}();r.default=a,t.exports=r.default},{}],20:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?0:arguments[0],r=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=arguments.length<=2||void 0===arguments[2]?0:arguments[2];i(this,e),this.sid=t,this.appId=r,this.channelId=n}return n(e,[{key:"fromString",value:function(e){if(this.sid=0,this.appId=0,this.channelId=0,-1!==e.toString().indexOf("-")){var t=e.split("-");return this.sid=parseInt(t[0])||0,this.appId=parseInt(t[1])||0,this.channelId=parseInt(t[2])||0,!0}return!1}},{key:"toString",value:function(){return this.sid+"-"+this.appId+"-"+this.channelId}},{key:"equal",value:function(e){return this.toString()===e.toString()}},{key:"toBigint",value:function(){return 4294967296*this.sid+this.appId}}]),e}();r.default=a,t.exports=r.default},{}],21:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?0:arguments[0],r=arguments.length<=1||void 0===arguments[1]?0:arguments[1];i(this,e),this.high=t,this.low=r}return n(e,[{key:"destroy",value:function(){}},{key:"equal",value:function(e){return null!==e&&(this.low===e.low&&this.high===e.high)}},{key:"lower",value:function(e){return e.high>this.high||e.high==this.high&&e.low>this.low}},{key:"toString64",value:function(){var e=Number(this.high).toString(16),t=Number(this.low).toString(16);if(t.length<8)for(var r=8-t.length;r;)t="0"+t,r--;return e+t}}]),e}();r.default=a,t.exports=r.default},{}],22:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./ProtoUInt64"),s=i(o),u=e("./ProtoUGID"),l=i(u),h=function(){function e(t){var r=arguments.length<=1||void 0===arguments[1]||arguments[1];n(this,e),this.view=t,this.pos=0,this.len=0,this.uri=0,this.resCode=0,!0===r&&(this.len=this.popUInt32(),this.uri=this.popUInt32(),this.resCode=this.popUInt16());for(var i=0;i<this.view.byteLength;i++);}return a(e,[{key:"destroy",value:function(){}},{key:"bytesAvailable",value:function(){return this.view.byteLength-this.pos}},{key:"popBool",value:function(){if(this.pos+1>this.view.byteLength)return!1;var e=this.view.getUint8(this.pos);return this.pos++,"1"===e.toString()}},{key:"popUInt8",value:function(){if(this.pos+1>this.view.byteLength)return 0;var e=this.view.getUint8(this.pos);return this.pos++,e}},{key:"popUInt16",value:function(){if(this.pos+2>this.view.byteLength)return 0;var e=this.view.getUint16(this.pos,!0);return this.pos+=2,e}},{key:"popUInt32",value:function(){if(this.pos+4>this.view.byteLength)return 0;var e=this.view.getUint32(this.pos,!0);return this.pos+=4,e}},{key:"popUInt64",value:function(){if(this.pos+8>this.view.byteLength)return new s.default;var e=this.view.getUint32(this.pos,!0);this.pos+=4;var t=this.view.getUint32(this.pos,!0);return this.pos+=4,new s.default(t,e)}},{key:"popUGID",value:function(){var e=(this.popUInt16(),this.popUInt32()),t=this.popUInt32(),r=this.popUInt32();return new l.default(e,t,r)}},{key:"popUint8Array",value:function(){var e=this.popUInt16();if(this.pos+e>this.view.byteLength)return null;var t=new Uint8Array(this.view.buffer,this.pos,e);return this.pos+=e,t}},{key:"popUint8Array32",value:function(){var e=this.popUInt32();if(this.pos+e>this.view.byteLength)return null;var t=new Uint8Array(this.view.buffer,this.pos,e);return this.pos+=e,t}},{
key:"popUInt32Vector",value:function(){var e=this.popUInt32();if(this.pos+4*e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r++)t.push(this.popUInt32());return t}},{key:"popUInt16Vector",value:function(){var e=this.popUInt32();if(this.pos+2*e>this.view.byteLength)return null;for(var t=[],r=0;r<e;r++)t.push(this.popUInt16());return t}},{key:"popString",value:function(){var e=this.popUInt16();if(this.pos+e>this.view.byteLength)return null;for(var t="",r=0;r<e;++r)t+=String.fromCharCode(this.popUInt8());return t}}]),e}();r.default=h,t.exports=r.default},{"./ProtoUGID":20,"./ProtoUInt64":21}],23:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default={URI_VIDEO_PNotifyCurrentCdnStream:2739202,URI_VIDEO_PNotifyCurrentStream4:2675714,URI_VIDEO_PSubscribeStream3:2667266,URI_VIDEO_PSubscribeStreamRes3:2667522,URI_VIDEO_PVideoSyncSpeakerTime3:2674690,URI_VIDEO_PStreamData3:2666754,URI_VIDEO_PStopStream3:2666498,URI_VIDEO_PForceConnectVideoProxy3:2685442,URI_VIDEO_PPullStreamData:2694146,URI_VIDEO_PResendStreamData4:2689026,URI_VIDEO_PResendStreamDataFailAck:2694402,URI_VIDEO_PVideoProxyPing3:2669570,URI_VIDEO_PVideoProxyPingRes4:2683650,URI_VIDEO_PNotifyMultiVideo:2746370,URI_VIDEO_PLoginAndSubscribe:4097282,URI_VIDEO_PLoginAndSubscribeRes:4097538,URI_VIDEO_PNotifyUplinkRecvCount3:2672642,URI_VIDEO_PP2pVideoPing3:2671874,URI_VIDEO_PVideoBroadcast3:2672130,URI_VIDEO_PUpdateVideoConfig2:2569474,URI_VIDEO_PVideoQualityStatistics:2591746,URI_AUDIO_PLoginMediaProxy2:227586,URI_AUDIO_PLoginMediaProxyRes2:233218,URI_AUDIO_PMediaProxyPing:208386,URI_AUDIO_PMediaProxyPingRes:208642,URI_AUDIO_PP2pPing3:41218,URI_AUDIO_PReSendVoice2:22530,URI_AUDIO_PChatQualityVoiceExRes:71682,URI_AUDIO_PFastAccessVoice:821250,URI_AUDIO_PVoiceNak:27138,URI_AUDIO_PVoicePacketSet:27394,URI_AUDIO_PFastAccessCfg:227842,URI_MCS_PLoginVp:258,URI_MCS_PLoginVpRes:514,URI_AVP_PLiveLoginAvpProxy:7680264,URI_AVP_PLiveLoginAvpProxyRes:7680520,URI_AVP_PLiveAvpPing:7683080,URI_AVP_PLiveAvpPingRes:7683336,URI_AVP_PLiveNotifyPublishStatus:7701e3,URI_AVP_PLiveNotifyPublishStatusRes:7701256,URI_AVP_PLiveNotifyStreamStatus:7681800,URI_AVP_PLiveStopStream:7703048,URI_AVP_PLiveSubscribe:7681288,URI_AVP_PLiveSubscribeRes:7681544,URI_AVP_PLiveStopPublishStream:7682824,URI_AVP_PLiveStartPublish:7682312,URI_AVP_PLiveStartPublishRes:7682568,URI_AVP_PLiveUpdateToken:7708424,URI_AVP_PLiveSdkAuthResNotify:7708680,URI_AVP_PLiveBizAuthResNotify:7708936,URI_AVP_PLiveUserMsgData:7733768,URI_AVP_PLiveUserBroadCastData:7734280,URI_AVP_PLiveSdkAuthResNew:7734536,URI_WEBRTC_POffer:3840264,URI_WEBRTC_PAnswer:3840520,URI_WEBRTC_PCandidate:3840776,URI_WEBRTC_PCandidateRes:3841032,URI_WEBRTC_PEvent:3841800,URI_WEBRTC_PMessage:3842056,URI_WEBRTC_PLayer:3842312,URI_WEBRTC_PLayerRes:3842568,URI_AP_PApRouteData:333,URI_AP_PApRouteDataRes:589,URI_AP_PApLogin:845,URI_AP_PApLoginRes:1101,URI_AP_PApPing:1357,URI_AP_PApPingRes:1613,URI_STEAM_PAnchorStartLive:256080,URI_STEAM_PAnchorStartLiveRes:256336,URI_STEAM_PAnchorStopLive:256592,URI_STEAM_PAnchorStopLiveRes:256848,URI_STEAM_PS3ChannelPushMsg:257104,URI_STEAM_PQueryChannelStreams:260944,URI_STEAM_PQueryChannelStreamsRes:261200,URI_RTMP_PRTMPStreamNotify2Service:9984276,PSvcLoginReqURI:1446744,PSvcLoginResURI:1447e3,PSvcLogoutReqURI:1447256,PSvcLogoutResURI:1447512,PSvcPingURI:1447768,PSvcPongURI:1448024,PSvcRouteReqURI:1449304,PSvcRouteResURI:1449560,PSvcSubsGroupReqURI:1450328,PSvcSubsGroupResURI:1450584,PSvcBroadcastURI:1450840},t.exports=r.default},{}],24:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.vipUser=0,this.vipProxy=0,this.availPeers=0,this.uid=0,this.appid=0,this.stampc=0,this.loginStamp=0,this.uplinkBw=0,this.bPunched=!1,this.streamKey=""}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_AVP_PLiveAvpPing),e.pushUInt8(this.vipUser),e.pushUInt8(this.vipProxy),e.pushUInt16(this.availPeers),e.pushUInt32(this.uid),e.pushUInt32(this.appid),e.pushUInt32(this.stampc),e.pushUInt32(this.loginStamp),e.pushUInt32(this.uplinkBw),e.pushUInt8(this.bPunched),e.pushString(this.streamKey),e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],25:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.stampc=0,this.stamps=0,this.proxyRtt=0,this.wanIp=0,this.wanPort=0,this.reserved=0,this.peerType=0,this.flag=0,this.mediaUpLossRate=0,this.wanIpV6="",this.publishLayerToAddress=new Map,this.subscribeUuidToAddress=new Map}return n(e,[{key:"unmarshall",value:function(e){this.stampc=e.popUInt32(),this.stamps=e.popUInt32(),this.proxyRtt=e.popUInt32(),this.wanIp=e.popUInt32(),this.wanPort=e.popUInt16(),this.reserved=e.popUInt32(),this.peerType=e.popUInt8(),this.flag=e.popUInt8(),1&this.flag&&(this.mediaUpLossRate=e.popUInt32()),this.wanIpV6=e.popString();for(var t=e.popUInt32();t-- >0;){var r=e.popUInt8(),i={address:e.popString(),port:e.popUInt16(),addressType:"udp4"};this.publishLayerToAddress.set(r,i)}for(var n=e.popUInt32();n-- >0;){var a=e.popString(),i={address:e.popString(),port:e.popUInt16(),addressType:"udp4"};this.subscribeUuidToAddress.set(a,i)}}}]),e}();r.default=a,t.exports=r.default},{}],26:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.appid=0,this.uid=0,this.bPublish=!0,this.streamName="",this.groupName="",this.bizAuthResult=0}return n(e,[{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.bPublish=e.popBool(),this.streamName=e.popString(),this.groupName=e.popString(),this.bizAuthResult=e.popUInt32()}}]),e}();r.default=a,t.exports=r.default},{}],27:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.version=0,this.clientType=9,this.tcpId=0,this.commandType=0,this.localPort=0,this.uid=0,this.appid=0,this.loginStamp=0,this.sdkVersion=0,this.serviceType=0,this.oriUserArea=0,this.destUserArea=0,this.videoGroupId=0,this.sceneId=0,this.isAnchorSystem=!0,this.channelName=null,this.localIps=null,this.audioCodecType=null,this.vpToken=null,this.apToken=null,this.proxyType=0,this.externalUid=null}return a(e,[{key:"destroy",value:function(){}},{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_AVP_PLiveLoginAvpProxy),e.pushUInt8(this.version),e.pushUInt8(this.clientType),e.pushUInt8(this.tcpId),e.pushUInt8(this.commandType),e.pushUInt16(this.localPort),e.pushUInt32(this.uid),e.pushUInt32(this.appid),e.pushUInt32(this.loginStamp),e.pushUInt32(this.sdkVersion),e.pushUInt32(this.serviceType),e.pushUInt32(this.oriUserArea),e.pushUInt32(this.destUserArea),e.pushUInt32(this.videoGroupId),e.pushUInt32(this.sceneId),e.pushUInt8(this.isAnchorSystem),e.pushString(this.channelName),e.pushUIntArray(this.localIps),e.pushUIntArray(this.audioCodecType),e.pushString(this.vpToken),e.pushString(this.apToken),e.pushUInt32(this.proxyType),e.pushString(this.externalUid),e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],28:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.reject=0,this.firstViewer=0,this.wlanPort=0,this.clientAreaType=0,this.proxyAreaType=0,this.appid=0,this.uid=0,this.wlanIp=0,this.isAnchorSystem=!1,this.curTcpLoginStamp=0}return n(e,[{key:"unmarshall",value:function(e){this.reject=e.popUInt8(),this.firstViewer=e.popUInt8(),this.wlanPort=e.popUInt16(),this.clientAreaType=e.popUInt16(),this.proxyAreaType=e.popUInt16(),this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.wlanIp=e.popUInt32(),this.isAnchorSystem=e.popUInt8(),this.curTcpLoginStamp=e.popUInt32()}}]),e}();r.default=a,t.exports=r.default},{}],29:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.streamKey="",this.streamId=null,this.status=new Map}return a(e,[{key:"destroy",value:function(){}},{key:"marshall",value:function(){var e=new s.default;e.setUri(l.default.URI_AVP_PLiveNotifyPublishStatus),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushString(this.streamKey),e.pushUInt64(this.streamId),e.pushUInt32(this.status.size);var t=!0,r=!1,i=void 0;try{for(var n,a=this.status.entries()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,u=o[0],h=o[1];e.pushUInt16(u),e.pushUInt32(h)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.streamKey=e.popString(),this.streamId=e.popUInt64();for(var t=e.popUInt32();t--;){var r=e.popUInt16(),i=e.popUInt32();this.status.set(r,i)}}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],30:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.authStatus=0,this.speakerUid=0,this.status=0,this.streamId=null,this.streamkey=""}return n(e,[{key:"unmarshall",value:function(e){this.authStatus=e.popUInt8(),this.speakerUid=e.popUInt32(),this.status=e.popUInt32(),this.streamId=e.popUInt64(),this.streamkey=e.popString()}}]),e}();r.default=a,t.exports=r.default},{}],31:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.streamKeyToId=new Map,this.status=new Map}return n(e,[{key:"destory",value:function(){}},{key:"unmarshall",value:function(e){for(var t=e.popUInt32();t-- >0;){for(var r=e.popString(),i=e.popUInt32(),n=new Set;i--;){var a=e.popUInt64();n.add(a)}this.streamKeyToId.set(r,n)}for(var o=e.popUInt32();o-- >0;){for(var r=e.popUInt64(),i=e.popUInt32(),s=new Map;i--;){var u=e.popUInt16(),a=e.popUInt32();s.set(u,a)}this.status.set(r,s)}}}]),e}();r.default=a,t.exports=r.default},{}],32:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.appid=0,this.uid=0,this.sdkAuthResult=0}return n(e,[{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.sdkAuthResult=e.popUInt32()}}]),e}();r.default=a,t.exports=r.default},{}],33:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.uid=0,this.appid=0,this.streamId=null,this.streamKey="",this.groupKeys=[]}return a(e,[{key:"marshall",value:function(){var e=new s.default;e.setUri(l.default.URI_AVP_PLiveStopPublishStream),e.pushUInt32(this.uid),e.pushUInt32(this.appid),e.pushUInt64(this.streamId),e.pushString(this.streamKey),e.pushUInt32(this.groupKeys.length);var t=!0,r=!1,i=void 0;try{for(var n,a=this.groupKeys[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;e.pushString(o)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],34:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.streamKey="",this.streamId=null,this.status=new Map}return a(e,[{key:"destory",value:function(){}},{key:"marshall",value:function(){var e=new s.default;e.setUri(l.default.URI_AVP_PLiveStopStream),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushString(this.streamKey),e.pushUInt64(this.streamId),e.pushUInt32(this.status.size);var t=!0,r=!1,i=void 0;try{for(var n,a=this.status.entries()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,u=o[0],h=o[1];e.pushUInt16(u),e.pushUInt32(h)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.streamKey=e.popString(),this.streamId=e.popUInt64();for(var t=e.popUInt32();t--;){var r=e.popUInt16(),i=e.popUInt32();this.status.set(r,i)}}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],35:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/uri"),s=i(o),u=e("../protobase/ProtoMarshall"),l=i(u),h=function(){function e(){n(this,e),this.uid=0,this.appid=0,this.option=0,this.subscribe=!1,this.streamKeyCfg=new Map,this.groupKeyCfg=new Map}return a(e,[{key:"marshall",value:function(){var e=new l.default;e.setUri(s.default.URI_AVP_PLiveSubscribe),e.pushUInt32(this.uid),e.pushUInt32(this.appid),e.pushUInt32(this.option),e.pushBool(this.subscribe),e.pushUInt32(this.streamKeyCfg.size);var t=!0,r=!1,i=void 0;try{for(var n,a=this.streamKeyCfg.entries()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,u=o[0],h=o[1];e.pushString(u),e.pushUInt32(h.size);var c=!0,d=!1,f=void 0;try{for(var p,v=h.entries()[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){var m=p.value,g=m[0],y=m[1];e.pushUInt32(g),e.pushUInt32(y)}}catch(e){d=!0,f=e}finally{try{!c&&v.return&&v.return()}finally{if(d)throw f}}}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}e.pushUInt32(this.groupKeyCfg.size);var S=!0,b=!1,_=void 0;try{for(var E,T=this.groupKeyCfg.entries()[Symbol.iterator]();!(S=(E=T.next()).done);S=!0){var o=E.value,u=o[0],h=o[1];e.pushString(u),e.pushUInt32(h.size);var I=!0,R=!1,A=void 0;try{for(var k,P=h.entries()[Symbol.iterator]();!(I=(k=P.next()).done);I=!0){var m=k.value,g=m[0],y=m[1];e.pushUInt32(g),e.pushUInt32(y)}}catch(e){R=!0,A=e}finally{try{!I&&P.return&&P.return()}finally{if(R)throw A}}}}catch(e){b=!0,_=e}finally{try{!S&&T.return&&T.return()}finally{if(b)throw _}}return e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],36:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.uid=0,this.subscribe=!1,this.streamResInfos=new Map}return n(e,[{key:"unmarshall",value:function(e){this.uid=e.popUInt32(),this.subscribe=e.popBool();for(var t=e.popUInt32();t--;){var r=e.popUInt32(),i=e.popUInt32();this.streamResInfos.set(r,i)}}}]),e}();r.default=a,t.exports=r.default},{}],37:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.token="",this.bizAuthExtInfo=""}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_AVP_PLiveUpdateToken),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushString(this.token),e.pushString(this.bizAuthExtInfo),e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],38:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../protobase/ProtoMarshall"),u=i(s),l=e("../protobase/uri"),h=i(l),c=e("../protobase/ProtoUInt64"),d=i(c),f=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.uid64bit=new d.default(0,0),this.broadCastInt=new Map,this.broadCastString=new Map,this.groupKeys=[]}return o(e,[{key:"marshall",value:function(){var e=new u.default;e.setUri(h.default.URI_AVP_PLiveUserBroadCastData),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushUInt64(this.uid64bit),e.pushUInt32(this.broadCastInt.size);var t=!0,r=!1,i=void 0;try{for(var n,o=this.broadCastInt.entries()[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var s=a(n.value,2),l=s[0],c=s[1];e.pushUInt16(l),e.pushUInt32(c)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}e.pushUInt32(this.broadCastString.size);var d=!0,f=!1,p=void 0;try{for(var v,m=this.broadCastString.entries()[Symbol.iterator]();!(d=(v=m.next()).done);d=!0){var g=a(v.value,2),l=g[0],c=g[1];e.pushUInt32(l),e.pushString(c)}}catch(e){f=!0,p=e}finally{try{!d&&m.return&&m.return()}finally{if(f)throw p}}e.pushUInt32(this.groupKeys.length);for(var y=0;y<this.groupKeys.length;++y)e.pushString(this.groupKeys[y]);return e.pushString(this.externalUid),e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.uid64bit=e.popUInt64();for(var t=e.popUInt32(),r=0;r<t;r++)this.broadCastInt.set(e.popUInt16(),e.popUInt32());t=e.popUInt32();for(var r=0;r<t;r++)this.broadCastString.set(e.popUInt16(),e.popString());for(var i=e.popUInt32(),r=0;r<i;r++)this.groupKeys.push(e.popString());this.externalUid=e.popString()}}]),e}();r.default=f,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/ProtoUInt64":21,"../protobase/uri":23}],39:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.appid=0,this.groupKey="",this.uid=0,this.subscribeUuid="",this.publish=0,this.rescode=0,this.sdp="",this.sdpType="",this.seqNum=0,this.layer=0,this.address={address:"",port:0,addressType:"udp4"}}return n(e,[{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.groupKey=e.popString(),this.uid=e.popUInt32(),this.subscribeUuid=e.popString(),this.publish=e.popUInt8(),this.rescode=e.popUInt8(),this.sdp=e.popString(),this.sdpType=e.popString(),this.seqNum=e.popUInt32(),this.layer=e.popUInt8(),this.address.address=e.popString(),this.address.port=e.popUInt16()}}]),e}();r.default=a,t.exports=r.default},{}],40:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.groupKey="",this.uid=0,this.subscribeUuid="",this.publish=0,this.sdpMLineIndex=0,this.sdpMid="",this.candidate="",this.layer=0}return a(e,[{key:"destroy",value:function(){}},{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_WEBRTC_PCandidate),e.pushUInt32(this.appid),e.pushString(this.groupKey),e.pushUInt32(this.uid),e.pushString(this.subscribeUuid),e.pushUInt8(this.publish),e.pushUInt32(this.sdpMLineIndex),e.pushString(this.sdpMid),e.pushString(this.candidate),e.pushUInt8(this.layer),e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],41:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.appid=0,this.groupKey="",this.uid=0,this.subscribeUuid="",this.publish=0,this.res=0}return n(e,[{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.groupKey=e.popString(),this.uid=e.popUInt32(),this.subscribeUuid=e.popString(),this.publish=e.popUInt8(),this.res=e.popUInt8()}}]),e}();r.default=a,t.exports=r.default},{}],42:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.groupKey="",this.uid=0,this.event=0,this.publish=0,this.subscribeUuid="",this.layer=0,this.seqNum=0}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_WEBRTC_PEvent),e.pushUInt32(this.appid),e.pushString(this.groupKey),e.pushUInt32(this.uid),e.pushUInt16(this.event),e.pushUInt8(this.publish),e.pushString(this.subscribeUuid),e.pushUInt8(this.layer),e.pushUInt32(this.seqNum),e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.groupKey=e.popString(),this.uid=e.popUInt32(),this.event=e.popUInt16(),this.publish=e.popUInt8(),this.subscribeUuid=e.popString(),this.layer=e.popUInt8(),this.seqNum=e.popUInt32()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],43:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.pubUid=0,this.layer=0,this.seqNum=0}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_WEBRTC_PLayer),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushUInt32(this.pubUid),e.pushUInt8(this.layer),e.pushUInt32(this.seqNum),e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.pubUid=e.popUInt32(),this.layer=e.popUInt8(),this.seqNum=e.popUInt32()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],44:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.pubUid=0,this.layer=0,this.result=0,this.seqNum=0}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.URI_WEBRTC_PLayerRes),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushUInt32(this.pubUid),e.pushUInt8(this.layer),e.pushUInt32(this.result),e.pushUInt32(this.seqNum),e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.pubUid=e.popUInt32(),this.layer=e.popUInt8(),this.result=e.popUInt32(),this.seqNum=e.popUInt32()}}]),e}();r.default=h,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/uri":23}],45:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../protobase/ProtoMarshall"),u=i(s),l=e("../protobase/ProtoUInt64"),h=i(l),c=e("../protobase/uri"),d=i(c),f=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.groupKey="",this.streamId=new h.default(0,0),this.message=new Map,this.layer=0}return o(e,[{key:"marshall",value:function(){var e=new u.default;e.setUri(d.default.URI_WEBRTC_PMessage),e.pushUInt32(this.appid),e.pushUInt32(this.uid),e.pushString(this.groupKey),e.pushUInt64(this.streamId),e.pushUInt32(this.message.size);var t=!0,r=!1,i=void 0;try{for(var n,o=this.message[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var s=a(n.value,2),l=s[0],h=s[1];e.pushUInt32(l),e.pushUInt32(h)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}return e.pushUInt8(this.layer),e.marshall()}},{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.uid=e.popUInt32(),this.groupKey=e.popString(),this.streamId=e.popUInt64();for(var t=e.popUInt32();t--;){var r=e.popUInt32(),i=e.popUInt32();this.message.set(r,i)}this.layer=e.popUInt8()}}]),e}();r.default=f,t.exports=r.default},{"../protobase/ProtoMarshall":19,
"../protobase/ProtoUInt64":21,"../protobase/uri":23}],46:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../protobase/ProtoMarshall"),s=i(o),u=e("../protobase/ProtoUInt64"),l=i(u),h=e("../protobase/uri"),c=i(h),d=function(){function e(){n(this,e),this.appid=0,this.uid=0,this.groupKey="",this.videoStreamKey="",this.audioStreamKey="",this.videoStreamId=new l.default(0,0),this.audioStreamId=new l.default(0,0),this.subscribeUuid="",this.publish=0,this.sdp="",this.sdpType="",this.seqNum=0,this.layer=0,this.codec=0}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(c.default.URI_WEBRTC_POffer),e.pushUInt32(this.appid),e.pushString(this.groupKey),e.pushString(this.videoStreamKey),e.pushString(this.audioStreamKey),e.pushUInt64(this.videoStreamId),e.pushUInt64(this.audioStreamId),e.pushString(this.subscribeUuid),e.pushUInt32(this.uid),e.pushUInt8(this.publish),e.pushString(this.sdp),e.pushString(this.sdpType),e.pushUInt32(this.seqNum),e.pushUInt8(this.layer),e.pushUInt8(this.codec),e.marshall()}}]),e}();r.default=d,t.exports=r.default},{"../protobase/ProtoMarshall":19,"../protobase/ProtoUInt64":21,"../protobase/uri":23}],47:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.appid=0,this.groupType=null,this.groupId=null,this.svcName="",this.fnName="",this.protoType="",this.data=null,this.dataCRC=0,this.serverId=null,this.seqId=null,this.traceId=""}return n(e,[{key:"unmarshall",value:function(e){this.appid=e.popUInt32(),this.groupType=e.popUInt64(),this.groupId=e.popUInt64(),this.svcName=e.popString(),this.fnName=e.popString(),this.protoType=e.popString(),this.data=e.popUint8Array32(),this.dataCRC=e.popUInt32(),this.serverId=e.popUInt64(),this.seqId=e.popUInt64(),this.traceId=e.popString()}},{key:"toString",value:function(){return"appid="+this.appid+" groupType="+JSON.stringify(this.groupType)+" groupId="+JSON.stringify(this.groupId)+" svcName="+this.svcName+" fnName="+this.fnName+" protoType="+this.protoType+" dataCRC="+this.dataCRC+" serverId="+JSON.stringify(this.serverId)+" seqId="+JSON.stringify(this.seqId)+" traceId="+this.traceId}}]),e}();r.default=a,t.exports=r.default},{}],48:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoMarshall"),s=i(o),u=e("../../protobase/uri"),l=i(u),h=function(){function e(){n(this,e),this.context=""}return a(e,[{key:"marshall",value:function(){var e=new s.default;return e.setUri(l.default.PSvcPingURI),e.pushString(this.context),e.marshall()}}]),e}();r.default=h,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"../../protobase/uri":23}],49:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.context="",this.timestamp=null}return n(e,[{key:"unmarshall",value:function(e){this.context=e.popString(),this.timestamp=e.popUInt64()}}]),e}();r.default=a,t.exports=r.default},{}],50:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../../protobase/ProtoMarshall"),u=i(s),l=e("../../protobase/uri"),h=i(l),c=e("long"),d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(c),f=e("../../utils/utils"),p=i(f),v=e("../../utils/logger"),m=i(v),g=function(){function e(){n(this,e),this.context="",this.uid=0,this.appid=0,this.instId=0,this.svcName="",this.fnName="",this.protoType="",this.data=null,this.dataCRC=0,this.routeArgs=new Map,this.clientHeaders=new Map,this.traceId=""}return o(e,[{key:"marshall",value:function(){var e=new u.default;e.setUri(h.default.PSvcRouteReqURI),e.pushString(this.context);var t=d.fromString(this.uid.toString());e.pushUInt32(t.low),e.pushUInt32(t.high),e.pushUInt32(this.appid),e.pushUInt32(this.instId),e.pushString(this.svcName),e.pushString(this.fnName),e.pushString(this.protoType),"string"==typeof this.data?e.pushString32(this.data):e.pushUint8Array32(this.data),e.pushUInt32(this.dataCRC),e.pushUInt32(this.routeArgs.size);var r=!0,i=!1,n=void 0;try{for(var o,s=this.routeArgs[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var l=a(o.value,2),c=l[0],f=l[1];e.pushString(c),e.pushString(f)}}catch(e){i=!0,n=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw n}}e.pushUInt32(this.clientHeaders.size);var p=!0,v=!1,g=void 0;try{for(var y,S=this.clientHeaders[Symbol.iterator]();!(p=(y=S.next()).done);p=!0){var b=a(y.value,2),c=b[0],f=b[1];e.pushString(c),e.pushString(f)}}catch(e){v=!0,g=e}finally{try{!p&&S.return&&S.return()}finally{if(v)throw g}}return e.pushString(this.traceId),m.default.debug(this.toString()),e.marshall()}},{key:"toString",value:function(){return"context="+this.context+" uid="+this.uid+" appid="+this.appid+" instId="+this.instId+" svcName="+this.svcName+" fnName="+this.fnName+" protoType="+this.protoType+" traceId="+this.traceId+" routeArgs="+p.default.stringfyMap(this.routeArgs)+" clientHeaders="+p.default.stringfyMap(this.clientHeaders)}}]),e}();r.default=g,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"../../protobase/uri":23,"../../utils/logger":91,"../../utils/utils":93,long:98}],51:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=e("../../utils/utils"),o=function(e){return e&&e.__esModule?e:{default:e}}(a),s=function(){function e(){i(this,e),this.context="",this.resCode=0,this.resMsg="",this.svcName="",this.fnName="",this.protoType="",this.data=null,this.dataCRC=0,this.serverHeaders=new Map,this.traceId=""}return n(e,[{key:"unmarshall",value:function(e){this.context=e.popString(),this.resCode=e.popUInt32(),this.resMsg=e.popString(),this.svcName=e.popString(),this.fnName=e.popString(),this.protoType=e.popString(),this.data=e.popUint8Array32(),this.dataCRC=e.popUInt32();for(var t=e.popUInt32(),r=0;r<t;r++)this.serverHeaders.set(e.popString(),e.popString());this.traceId=e.popString()}},{key:"toString",value:function(){return"context="+this.context+" resCode="+this.resCode+" resMsg="+this.resMsg+" svcName="+this.svcName+" fnName="+this.fnName+" traceId="+this.traceId+" serverHeaders="+o.default.stringfyMap(this.serverHeaders)}}]),e}();r.default=s,t.exports=r.default},{"../../utils/utils":93}],52:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoMarshall"),s=i(o),u=e("../../protobase/uri"),l=i(u),h=e("long"),c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(h),d=function(){function e(){n(this,e),this.context="",this.appid=0,this.joinGroups=[],this.leaveGroups=[]}return a(e,[{key:"marshall",value:function(){var e=new s.default;e.setUri(l.default.PSvcSubsGroupReqURI),e.pushString(this.context),e.pushUInt32(this.appid);var t=this.joinGroups.length;if(0==t)e.pushUInt32(0);else{e.pushUInt32(t);for(var r=0;r<t;r++){var i=c.fromString(this.joinGroups[r].grpType.toString());e.pushUInt32(i.low),e.pushUInt32(i.high);var n=c.fromString(this.joinGroups[r].grpId.toString());e.pushUInt32(n.low),e.pushUInt32(n.high)}}if(0==(t=this.leaveGroups.length))e.pushUInt32(0);else{e.pushUInt32(t);for(var r=0;r<t;r++){var i=c.fromString(this.leaveGroups[r].grpType.toString());e.pushUInt32(i.low),e.pushUInt32(i.high);var n=c.fromString(this.leaveGroups[r].grpId.toString());e.pushUInt32(n.low),e.pushUInt32(n.high)}}return e.marshall()}}]),e}();r.default=d,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"../../protobase/uri":23,long:98}],53:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.context="",this.resCode=0}return n(e,[{key:"unmarshall",value:function(e){this.context=e.popString(),this.resCode=e.popUInt32()}}]),e}();r.default=a,t.exports=r.default},{}],54:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=e("../../protobase/ProtoUInt64"),o=function(e){return e&&e.__esModule?e:{default:e}}(a),s=function(){function e(){i(this,e),this.uid=new o.default(0,0),this.streamType=0,this.codeRate=0,this.extend=new Map}return n(e,[{key:"unmarshall",value:function(e){this.uid=e.popUInt64(),this.streamType=e.popUInt32(),this.codeRate=e.popUInt32();for(var t=e.popUInt32(),r=0;r<t;r++){var i=e.popUInt32(),n=e.popString();this.extend.set(i,n)}}}]),e}();r.default=s,t.exports=r.default},{"../../protobase/ProtoUInt64":21}],55:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoMarshall"),s=function(e){return e&&e.__esModule?e:{default:e}}(o),u=function(){function e(){i(this,e),this.userParam=new Map,this.userLayout=new Map}return a(e,[{key:"marshall",value:function(){var e=new s.default(!1);e.pushUInt32(this.userParam.size);var t=!0,r=!1,i=void 0;try{for(var a,o=this.userParam.entries()[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var u=n(a.value,2),l=u[0],h=u[1];e.pushUInt32(l),e.pushString(h)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}e.pushUInt32(this.userLayout.size);var c=!0,d=!1,f=void 0;try{for(var p,v=this.userLayout.entries()[Symbol.iterator]();!(c=(p=v.next()).done);c=!0){var m=n(p.value,2),g=m[0],y=m[1];e.pushUInt64(g),e.pushUint8ArrayWithoutLen(y.marshall())}}catch(e){d=!0,f=e}finally{try{!c&&v.return&&v.return()}finally{if(d)throw f}}return e.marshall()}}]),e}();r.default=u,t.exports=r.default},{"../../protobase/ProtoMarshall":19}],56:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoMarshall"),s=function(e){return e&&e.__esModule?e:{default:e}}(o),u=function(){function e(){i(this,e),this.userParam=new Map}return a(e,[{key:"marshall",value:function(){var e=new s.default(!1);e.pushUInt32(this.userParam.size);var t=!0,r=!1,i=void 0;try{for(var a,o=this.userParam.entries()[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var u=n(a.value,2),l=u[0],h=u[1];e.pushUInt32(l),e.pushString(h)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}return e.marshall()}}]),e}();r.default=u,t.exports=r.default},{"../../protobase/ProtoMarshall":19}],57:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../../protobase/uri"),u=i(s),l=e("../../protobase/ProtoMarshall"),h=i(l),c=e("../../protobase/ProtoUInt64"),d=i(c),f=e("./ChannelUserInfo"),p=i(f),v=function(){function e(){n(this,e),this.uri=u.default.URI_STEAM_PAnchorStartLive,this.uid=new d.default(0,0),this.appid=new d.default(0,0),this.version=new d.default(0,0),this.ctxId=new d.default(0,0),this.userInfo=new p.default,this.streams=new Map,this.speakers=[],this.extend=new Map,this.transcodings=new Map,this.otherUserStreams=new Map}return o(e,[{key:"marshall",value:function(){var e=new h.default;e.setUri(u.default.URI_STEAM_PAnchorStartLive),e.pushUInt64(this.uid),e.pushUInt64(this.appid),e.pushUInt64(this.version),e.pushUInt64(this.ctxId),e.pushString(this.channelId),e.pushUint8ArrayWithoutLen(this.userInfo.marshall()),e.pushUInt32(this.streams.size);var t=!0,r=!1,i=void 0;try{for(var n,o=this.streams.entries()[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var s=a(n.value,2),l=s[0],c=s[1];e.pushString(l),e.pushUint8ArrayWithoutLen(c.marshall())}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}e.pushUInt32(this.speakers.length);for(var d=0;d<this.speakers.length;++d)e.pushUInt64(this.speakers[d]);e.pushUInt32(this.extend.size);var f=!0,p=!1,v=void 0;try{for(var m,g=this.extend.entries()[Symbol.iterator]();!(f=(m=g.next()).done);f=!0){var y=a(m.value,2),S=y[0],b=y[1];e.pushUInt32(S),e.pushString(b)}}catch(e){p=!0,v=e}finally{try{!f&&g.return&&g.return()}finally{if(p)throw v}}e.pushUInt32(this.transcodings.size);var _=!0,E=!1,T=void 0;try{for(var I,R=this.transcodings.entries()[Symbol.iterator]();!(_=(I=R.next()).done);_=!0){var A=a(I.value,2),k=A[0],P=A[1];e.pushString(k),e.pushUint8ArrayWithoutLen(P.marshall())}}catch(e){E=!0,T=e}finally{try{!_&&R.return&&R.return()}finally{if(E)throw T}}e.pushUInt32(this.otherUserStreams.size);var M=!0,C=!1,w=void 0;try{for(var U,O=this.otherUserStreams.entries()[Symbol.iterator]();!(M=(U=O.next()).done);M=!0){var L=a(U.value,2),k=L[0],P=L[1];e.pushUInt64(k),e.pushUInt32(P.size);var N=!0,D=!1,V=void 0;try{for(var x,K=P.entries()[Symbol.iterator]();!(N=(x=K.next()).done);N=!0){var j=a(x.value,2),B=j[0],F=j[1];e.pushString(B),e.pushUint8ArrayWithoutLen(F.marshall())}}catch(e){D=!0,V=e}finally{try{!N&&K.return&&K.return()}finally{if(D)throw V}}}}catch(e){C=!0,w=e}finally{try{!M&&O.return&&O.return()}finally{if(C)throw w}}return e.marshall()}}]),e}();r.default=v,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"../../protobase/ProtoUInt64":21,"../../protobase/uri":23,"./ChannelUserInfo":56}],58:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./AnchorStreamInfo"),s=i(o),u=e("../../protobase/ProtoUInt64"),l=i(u),h=function(){function e(){n(this,e),this.result=0,this.ctxId=new l.default(0,0),this.streams=new Map,this.speakers=[]}return a(e,[{key:"unmarshall",value:function(e){this.result=e.popUInt32(),this.ctxId=e.popUInt64(),this.channelId=e.popString();for(var t=e.popUInt32(),r=0;r<t;r++){var i=e.popString(),n=new s.default;n.unmarshall(e),this.streams.set(i,n)}for(var a=e.popUInt32(),r=0;r<a;r++){var o=e.popUInt64();this.speakers.push(o)}}}]),e}();r.default=h,t.exports=r.default},{"../../protobase/ProtoUInt64":21,"./AnchorStreamInfo":54}],59:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../../protobase/ProtoMarshall"),u=i(s),l=e("../../protobase/uri"),h=i(l),c=e("../../protobase/ProtoUInt64"),d=i(c),f=function(){function e(){n(this,e),this.uri=h.default.URI_STEAM_PAnchorStopLive,this.uid=new d.default(0,0),this.appid=new d.default(0,0),this.version=new d.default(0,0),this.ctxId=new d.default(0,0),this.streams=[],this.extend=new Map}return o(e,[{key:"marshall",value:function(){var e=new u.default;e.setUri(h.default.URI_STEAM_PAnchorStopLive),e.pushUInt64(this.uid),e.pushUInt64(this.appid),e.pushUInt64(this.version),e.pushUInt64(this.ctxId),e.pushString(this.channelId),e.pushUInt32(this.streams.length);for(var t=0;t<this.streams.length;++t)e.pushString(this.streams[t]);e.pushUInt32(this.extend.size);var r=!0,i=!1,n=void 0;try{for(var o,s=this.extend.entries()[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var l=a(o.value,2),c=l[0],d=l[1];e.pushUInt32(c),e.pushString(d)}}catch(e){i=!0,n=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw n}}return e.marshall()}}]),e}();r.default=f,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"../../protobase/ProtoUInt64":21,"../../protobase/uri":23}],60:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=e("../../protobase/ProtoUInt64"),o=function(e){return e&&e.__esModule?e:{default:e}}(a),s=function(){function e(){i(this,e),this.result=0,this.ctxId=new o.default(0,0)}return n(e,[{key:"unmarshall",value:function(e){this.result=e.popUInt32(),this.ctxId=e.popUInt64(),this.channelId=e.popString()}}]),e}();r.default=s,t.exports=r.default},{"../../protobase/ProtoUInt64":21}],61:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../../protobase/ProtoMarshall"),u=i(s),l=e("../../protobase/uri"),h=i(l),c=e("../../protobase/ProtoUInt64"),d=i(c),f=function(){function e(){n(this,e),this.uri=h.default.URI_STEAM_PQueryChannelStreams,this.fromUid=new d.default(0,0),this.appid=new d.default(0,0),this.ctxId=new d.default(0,0),this.extend=new Map}return o(e,[{key:"marshall",value:function(){var e=new u.default;e.setUri(h.default.URI_STEAM_PQueryChannelStreams),e.pushString(this.channelId),e.pushUInt64(this.appid),e.pushUInt64(this.fromUid),e.pushUInt64(this.ctxId),e.pushUInt32(this.extend.size);var t=!0,r=!1,i=void 0;try{for(var n,o=this.extend.entries()[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var s=a(n.value,2),l=s[0],c=s[1];e.pushUInt32(l),e.pushString(c)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}return e.marshall()}}]),e}();r.default=f,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"../../protobase/ProtoUInt64":21,"../../protobase/uri":23}],62:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./AnchorStreamInfo"),s=i(o),u=e("../../protobase/ProtoUInt64"),l=i(u),h=function(){function e(){n(this,e),this.appid=new l.default(0,0),this.version=new l.default(0,0),this.exist=!1,this.isAudioGroup=!1,this.ctxId=new l.default(0,0),this.userStreams=new Map,this.speakers=[],this.userStreamsExt=new Map}return a(e,[{key:"unmarshall",value:function(e){this.channelId=e.popString(),this.appid=e.popUInt64(),this.version=e.popUInt64(),this.exist=e.popBool(),this.isAudioGroup=e.popBool(),this.ctxId=e.popUInt64();for(var t=e.popUInt32(),r=0;r<t;r++){var i=e.popString(),n=new s.default;n.unmarshall(e),this.userStreams.set(i,n)}for(var a=e.popUInt32(),r=0;r<a;r++){var o=e.popUInt64();this.speakers.push(o)}t=e.popUInt32();for(var r=0;r<t;r++){var i=e.popString(),n=new s.default;n.unmarshall(e),this.userStreamsExt.set(i,n)}}}]),e}();r.default=h,t.exports=r.default},{"../../protobase/ProtoUInt64":21,"./AnchorStreamInfo":54}],63:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n,a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoUInt64"),s=function(e){return e&&e.__esModule?e:{default:e}}(o);r.PUSH_STREAM_STATUS=n,function(e){e[e.PUSH_STATUS_SUCCESS=0]="PUSH_STATUS_SUCCESS",e[e.PUSH_STATUS_FAILED=1]="PUSH_STATUS_FAILED",e[e.PULL_STATUS_FAILED=2]="PULL_STATUS_FAILED",e[e.PUSH_STATUS_FINISHED=3]="PUSH_STATUS_FINISHED"}(n||(r.PUSH_STREAM_STATUS=n={}));var u=function(){function e(){i(this,e),this.action=n.PUSH_STATUS_SUCCESS,this.url="",this.taskName="",this.channelId="",this.uid=new s.default(0,0)}return a(e,[{key:"unmarshall",value:function(e){this.action=e.popUInt32(),this.url=e.popString(),this.taskName=e.popString(),this.channelId=e.popString(),this.uid=e.popUInt64()}}]),e}();r.default=u},{"../../protobase/ProtoUInt64":21}],64:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./AnchorStreamInfo"),s=i(o),u=e("../../protobase/ProtoUInt64"),l=i(u),h=function(){function e(){n(this,e),this.userStreams=new Map,this.appid=new l.default(0,0),this.timestamp=new l.default(0,0),this.stopped=!1,this.isAudioGroup=!1,this.userStreams=new Map,this.speakers=[],this.userStreamsExt=new Map}return a(e,[{key:"unmarshall",value:function(e){this.channelId=e.popString(),this.appid=e.popUInt64(),this.timestamp=e.popUInt64(),this.stopped=e.popBool(),this.isAudioGroup=e.popBool();for(var t=e.popUInt32(),r=0;r<t;r++){var i=e.popString(),n=new s.default;n.unmarshall(e),this.userStreams.set(i,n)}for(var a=e.popUInt32(),r=0;r<a;r++){var o=e.popUInt64();this.speakers.push(o)}t=e.popUInt32();for(var r=0;r<t;r++){var i=e.popString(),n=new s.default;n.unmarshall(e),this.userStreamsExt.set(i,n)}}}]),e}();r.default=h,t.exports=r.default},{"../../protobase/ProtoUInt64":21,"./AnchorStreamInfo":54}],65:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoMarshall"),s=function(e){return e&&e.__esModule?e:{default:e}}(o),u=e("./StreamSvrEnum"),l=function(){function e(){i(this,e),this.attr=new Map}return a(e,[{key:"marshall",value:function(){var e=new s.default(!1);e.pushUInt32(this.attr.size);var t=!0,r=!1,i=void 0;try{for(var a,o=this.attr.entries()[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var u=n(a.value,2),l=u[0],h=u[1];e.pushUInt32(l),e.pushString(h)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}return e.marshall()}}],[{key:"attrCompareInfo",value:function(e,t){return e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_FRAME_RATE)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_FRAME_RATE)&&(e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_BIT_RATE)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_BIT_RATE)&&(e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_HEIGHT)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_HEIGHT)&&(e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_WIDTH)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_WIDTH)&&(e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_ENCODE_TYPE)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_ENCODE)&&(e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_CHANNEL)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_CHANNEL)&&e.get(u.StreamAttrKeyEnum.STREAM_ATTR_KEY_AUDIO_SAMPLE)===t.get(u.StreamInfoKeyEnum.STREAM_INFO_KEY_AUDIO_SAMPLE))))))}}]),e}();r.default=l,t.exports=r.default},{"../../protobase/ProtoMarshall":19,"./StreamSvrEnum":66}],66:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i;r.InputSourceTypeEnum=i,function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO",e[e.GROUP=3]="GROUP"}(i||(r.InputSourceTypeEnum=i={}));var n;r.StreamAttrEnum=n,function(e){e[e.ORI_STREAM=1]="ORI_STREAM",e[e.TRANS_CODE_STREAM=2]="TRANS_CODE_STREAM",e[e.MIX_STREAM=3]="MIX_STREAM"}(n||(r.StreamAttrEnum=n={}));var a;r.CodecType=a,function(e){e[e.CODEC_NONE=-1]="CODEC_NONE",e[e.VOICE_MID=0]="VOICE_MID",e[e.MUSIC_MID=1]="MUSIC_MID",e[e.VOICE_HIGHER=2]="VOICE_HIGHER",e[e.VOICE_HIGH=3]="VOICE_HIGH",e[e.VOICE_HIGHER_JITTER=4]="VOICE_HIGHER_JITTER",e[e.MUSIC_MID_JITTER=5]="MUSIC_MID_JITTER",e[e.VOICE_MID_AND_MUSIC_MID=7]="VOICE_MID_AND_MUSIC_MID",e[e.VOICE_HIGH_AND_MUSIC_MID=8]="VOICE_HIGH_AND_MUSIC_MID",e[e.VOICE_HIGHER_AND_MUSIC_MID_JITTER=9]="VOICE_HIGHER_AND_MUSIC_MID_JITTER",e[e.VOICE_HIGHER_AND_MUSIC_MID=10]="VOICE_HIGHER_AND_MUSIC_MID",
e[e.VOICE_HIGHER_QUALITY1_AND_MUSIC_MID=11]="VOICE_HIGHER_QUALITY1_AND_MUSIC_MID",e[e.VOICE_LOW_FOR_MOBILE=21]="VOICE_LOW_FOR_MOBILE",e[e.VOICE_HIGHER_QUALITY1=22]="VOICE_HIGHER_QUALITY1",e[e.VOICE_LOW_FOR_MOBILE_QUALITY2=23]="VOICE_LOW_FOR_MOBILE_QUALITY2",e[e.MUSIC_MID_1_32KBR=24]="MUSIC_MID_1_32KBR",e[e.MUSIC_MID_1_40KBR=25]="MUSIC_MID_1_40KBR",e[e.MUSIC_MID_1_48KBR=26]="MUSIC_MID_1_48KBR",e[e.MUSIC_MID_2_24KBR=27]="MUSIC_MID_2_24KBR",e[e.MUSIC_MID_2_32KBR=28]="MUSIC_MID_2_32KBR",e[e.MUSIC_MID_2_40KBR=29]="MUSIC_MID_2_40KBR",e[e.MUSIC_MID_2_48KBR=30]="MUSIC_MID_2_48KBR",e[e.MUSIC_MID_2_24KBR_VBR=31]="MUSIC_MID_2_24KBR_VBR",e[e.MUSIC_MID_2_32KBR_VBR=32]="MUSIC_MID_2_32KBR_VBR",e[e.MUSIC_MID_2_40KBR_VBR=33]="MUSIC_MID_2_40KBR_VBR",e[e.MUSIC_MID_2_48KBR_VBR=34]="MUSIC_MID_2_48KBR_VBR",e[e.MUSIC_AAC_44100HZ_STEREO_128KBPS=35]="MUSIC_AAC_44100HZ_STEREO_128KBPS",e[e.MUSIC_AAC_44100HZ_STEREO_160KBPS=36]="MUSIC_AAC_44100HZ_STEREO_160KBPS",e[e.MUSIC_AAC_44100HZ_STEREO_192KBPS=37]="MUSIC_AAC_44100HZ_STEREO_192KBPS",e[e.MUSIC_ELD_AAC_44100HZ_STEREO=38]="MUSIC_ELD_AAC_44100HZ_STEREO",e[e.MUSIC_ELD_AAC_SBR_44100HZ_STEREO=39]="MUSIC_ELD_AAC_SBR_44100HZ_STEREO",e[e.MUSIC_AAC_48000HZ_STEREO=40]="MUSIC_AAC_48000HZ_STEREO",e[e.MUSIC_AAC_44100HZ_MONO=41]="MUSIC_AAC_44100HZ_MONO",e[e.MUSIC_OPUS=50]="MUSIC_OPUS",e[e.VIDEO_H264=100]="VIDEO_H264",e[e.VIDEO_H265=101]="VIDEO_H265",e[e.VIDEO_VP8=102]="VIDEO_VP8"}(a||(r.CodecType=a={}));var o;r.StreamTypeEnum=o,function(e){e[e.VIDEO_STREAM=1]="VIDEO_STREAM",e[e.AUDIO_STREAM=2]="AUDIO_STREAM",e[e.MIX_VIDEO_STREAM=3]="MIX_VIDEO_STREAM",e[e.MIX_AUDIO_STREAM=4]="MIX_AUDIO_STREAM",e[e.SINGLE_MIX_VIDEO_STREAM=5]="SINGLE_MIX_VIDEO_STREAM",e[e.SINGLE_MIX_AUDIO_STREAM=6]="SINGLE_MIX_AUDIO_STREAM"}(o||(r.StreamTypeEnum=o={}));var s;r.PAnchorStartLiveKeyEnum=s,function(e){e[e.EXTEND_KEY_AUDIO_GROUP=2]="EXTEND_KEY_AUDIO_GROUP",e[e.EXTEND_KEY_EXTERNALUID=3]="EXTEND_KEY_EXTERNALUID"}(s||(r.PAnchorStartLiveKeyEnum=s={}));var u;r.StreamInfoKeyEnum=u,function(e){e[e.STREAM_INFO_KEY_ENCODE=1]="STREAM_INFO_KEY_ENCODE",e[e.STREAM_INFO_KEY_STREAM_TYPE=2]="STREAM_INFO_KEY_STREAM_TYPE",e[e.STREAM_INFO_KEY_APPID=3]="STREAM_INFO_KEY_APPID",e[e.STREAM_INFO_KEY_FRAME_RATE=4]="STREAM_INFO_KEY_FRAME_RATE",e[e.STREAM_INFO_KEY_BIT_RATE=5]="STREAM_INFO_KEY_BIT_RATE",e[e.STREAM_INFO_KEY_HEIGHT=6]="STREAM_INFO_KEY_HEIGHT",e[e.STREAM_INFO_KEY_WIDTH=7]="STREAM_INFO_KEY_WIDTH",e[e.STREAM_INFO_KEY_AUDIO_SAMPLE=8]="STREAM_INFO_KEY_AUDIO_SAMPLE",e[e.STREAM_INFO_KEY_AUDIO_CHANNEL=9]="STREAM_INFO_KEY_AUDIO_CHANNEL",e[e.STREAM_INFO_KEY_TIME_BASELINE=10]="STREAM_INFO_KEY_TIME_BASELINE",e[e.STREAM_INFO_KEY_ALPHA_DEGREE=11]="STREAM_INFO_KEY_ALPHA_DEGREE",e[e.STREAM_INFO_KEY_EXTERNALUID=12]="STREAM_INFO_KEY_EXTERNALUID",e[e.STREAM_INFO_KEY_DUAL_SMALL=13]="STREAM_INFO_KEY_DUAL_SMALL"}(u||(r.StreamInfoKeyEnum=u={}));var l;r.PAnchorStopLiveKeyEnum=l,function(e){e[e.EXTEND_KEY_IS_OWNER=1]="EXTEND_KEY_IS_OWNER",e[e.EXTEND_KEY_AUDIO_GROUP=2]="EXTEND_KEY_AUDIO_GROUP"}(l||(r.PAnchorStopLiveKeyEnum=l={}));var h;r.ChannelUserKeyEnum=h,function(e){e[e.CHANNEL_USER_KEY_ROOM_ID=1]="CHANNEL_USER_KEY_ROOM_ID",e[e.CHANNEL_USER_KEY_IS_OWNER=2]="CHANNEL_USER_KEY_IS_OWNER",e[e.CHANNEL_USER_KEY_UNIQ_CHANNEL=3]="CHANNEL_USER_KEY_UNIQ_CHANNEL",e[e.CHANNEL_USER_KEY_MIC_NO=4]="CHANNEL_USER_KEY_MIC_NO",e[e.CHANNEL_USER_KEY_LAYOUT_H=5]="CHANNEL_USER_KEY_LAYOUT_H",e[e.CHANNEL_USER_KEY_LAYOUT_W=6]="CHANNEL_USER_KEY_LAYOUT_W",e[e.CHANNEL_USER_KEY_LAYOUT_X=7]="CHANNEL_USER_KEY_LAYOUT_X",e[e.CHANNEL_USER_KEY_LAYOUT_Y=8]="CHANNEL_USER_KEY_LAYOUT_Y",e[e.CHANNEL_USER_KEY_LAYOUT_GLOBAL_H=9]="CHANNEL_USER_KEY_LAYOUT_GLOBAL_H",e[e.CHANNEL_USER_KEY_LAYOUT_GLOBAL_W=10]="CHANNEL_USER_KEY_LAYOUT_GLOBAL_W",e[e.CHANNEL_USER_KEY_LAYOUT_CROP=11]="CHANNEL_USER_KEY_LAYOUT_CROP",e[e.CHANNEL_USER_KEY_LAYOUT_CROPRECT_X=12]="CHANNEL_USER_KEY_LAYOUT_CROPRECT_X",e[e.CHANNEL_USER_KEY_LAYOUT_CROPRECT_Y=13]="CHANNEL_USER_KEY_LAYOUT_CROPRECT_Y",e[e.CHANNEL_USER_KEY_LAYOUT_CROPRECT_W=14]="CHANNEL_USER_KEY_LAYOUT_CROPRECT_W",e[e.CHANNEL_USER_KEY_LAYOUT_CROPRECT_H=15]="CHANNEL_USER_KEY_LAYOUT_CROPRECT_H",e[e.CHANNEL_USER_KEY_QUALITY_LEVEL=16]="CHANNEL_USER_KEY_QUALITY_LEVEL"}(h||(r.ChannelUserKeyEnum=h={}));var c;r.StreamAttrKeyEnum=c,function(e){e[e.STREAM_ATTR_KEY_STREAM_NAME=1]="STREAM_ATTR_KEY_STREAM_NAME",e[e.STREAM_ATTR_KEY_STREAM_TYPE=2]="STREAM_ATTR_KEY_STREAM_TYPE",e[e.STREAM_ATTR_KEY_APPID=3]="STREAM_ATTR_KEY_APPID",e[e.STREAM_ATTR_KEY_FRAME_RATE=4]="STREAM_ATTR_KEY_FRAME_RATE",e[e.STREAM_ATTR_KEY_BIT_RATE=5]="STREAM_ATTR_KEY_BIT_RATE",e[e.STREAM_ATTR_KEY_HEIGHT=6]="STREAM_ATTR_KEY_HEIGHT",e[e.STREAM_ATTR_KEY_WIDTH=7]="STREAM_ATTR_KEY_WIDTH",e[e.STREAM_ATTR_KEY_ENCODE_TYPE=8]="STREAM_ATTR_KEY_ENCODE_TYPE",e[e.STREAM_ATTR_KEY_AUDIO_SAMPLE=9]="STREAM_ATTR_KEY_AUDIO_SAMPLE",e[e.STREAM_ATTR_KEY_AUDIO_CHANNEL=10]="STREAM_ATTR_KEY_AUDIO_CHANNEL",e[e.STREAM_ATTR_KEY_TIME_BASELINE=11]="STREAM_ATTR_KEY_TIME_BASELINE",e[e.STREAM_ATTR_KEY_ALPHA_DEGREE=12]="STREAM_ATTR_KEY_ALPHA_DEGREE",e[e.STREAM_ATTR_KEY_RTMP_URL=13]="STREAM_ATTR_KEY_RTMP_URL",e[e.STREAM_ATTR_KEY_DUAL_SMALL=14]="STREAM_ATTR_KEY_DUAL_SMALL",e[e.STREAM_ATTR_KEY_EXT_UID=15]="STREAM_ATTR_KEY_EXT_UID",e[e.STREAM_ATTR_KEY_AUDIO_GROUP=16]="STREAM_ATTR_KEY_AUDIO_GROUP"}(c||(r.StreamAttrKeyEnum=c={}));var d;r.UserLayoutEnum=d,function(e){e[e.USER_LAYOUT_KEY_X=1]="USER_LAYOUT_KEY_X",e[e.USER_LAYOUT_KEY_Y=2]="USER_LAYOUT_KEY_Y",e[e.USER_LAYOUT_KEY_WIDTH=3]="USER_LAYOUT_KEY_WIDTH",e[e.USER_LAYOUT_KEY_HEIGHT=4]="USER_LAYOUT_KEY_HEIGHT",e[e.USER_LAYOUT_KEY_MIC_NO=5]="USER_LAYOUT_KEY_MIC_NO",e[e.USER_LAYOUT_KEY_CROP=6]="USER_LAYOUT_KEY_CROP",e[e.USER_LAYOUT_KEY_CROPRECT_X=7]="USER_LAYOUT_KEY_CROPRECT_X",e[e.USER_LAYOUT_KEY_CROPRECT_Y=8]="USER_LAYOUT_KEY_CROPRECT_Y",e[e.USER_LAYOUT_KEY_CROPRECT_W=9]="USER_LAYOUT_KEY_CROPRECT_W",e[e.USER_LAYOUT_KEY_CROPRECT_H=10]="USER_LAYOUT_KEY_CROPRECT_H",e[e.USER_LAYOUT_KEY_ALPHA_DEGREE=11]="USER_LAYOUT_KEY_ALPHA_DEGREE",e[e.USER_LAYOUT_KEY_TIME_BASELINE=12]="USER_LAYOUT_KEY_TIME_BASELINE"}(d||(r.UserLayoutEnum=d={}))},{}],67:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("../../protobase/ProtoMarshall"),s=function(e){return e&&e.__esModule?e:{default:e}}(o),u=function(){function e(){i(this,e),this.params=new Map}return a(e,[{key:"marshall",value:function(){var e=new s.default(!1);e.pushUInt32(this.params.size);var t=!0,r=!1,i=void 0;try{for(var a,o=this.params.entries()[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var u=n(a.value,2),l=u[0],h=u[1];e.pushUInt32(l),e.pushString(h)}}catch(e){r=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw i}}return e.marshall()}}]),e}();r.default=u,t.exports=r.default},{"../../protobase/ProtoMarshall":19}],68:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e){return new Promise(function(t){if(!K.default.os.isMobile)return void t();var r=new MediaStream;r.addTrack(e);var i=document.createElement("video");i.srcObject=r,i.muted=!0,i.setAttribute("style","bottom: 0; right: 0; width: 1px; high: 1px; position: absolute;"),i.setAttribute("playsinline",""),K.default.os.isIOS&&document.body.appendChild(i);var n=setTimeout(function(){K.default.os.isIOS&&document.body.removeChild(i),t()},5e3),a=function e(){K.default.os.isIOS&&document.body.removeChild(i),i.removeEventListener("playing",e),i.srcObject=null,clearTimeout(n),t()};i.addEventListener("playing",a),i.play()})}Object.defineProperty(r,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},l=e("./UserStream"),h=i(l),c=e("./utils/timeUtil"),d=i(c),f=e("./protocol/PLiveNotifyPublishStatus"),p=i(f),v=e("./protobase/MetaDataInfo"),m=i(v),g=e("./protocol/PLiveStopPublishStream"),y=i(g),S=e("./protocol/PWebRTCMessage"),b=i(S),_=e("./mix/Mixer"),E=i(_),T=e("./protocol/PLiveUserBroadCastData"),I=i(T),R=e("./videoEffector"),A=e("./utils/logger"),k=e("./codecSwitch"),P=i(k),M=e("./protocol/PLiveStopStream"),C=i(M),w=e("./protobase/ProtoUInt64"),U=i(w),O=e("./constant"),L=i(O),N=e("./protocol/streamSvr/StreamSvrEnum"),D=e("./utils/utils"),V=i(D),x=e("./utils/browser"),K=i(x),j=function(e){function t(e,r,i){n(this,t),u(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,!1,e,e.uidStr,e.channelId),this.publishState=!1,this.screenStream=null,this.cameraStream=null,this.streamMixer=null,this.destroyed=!1,this.videoEffector=new R.VideoEffector(this.logger),this.audioStreamName="",this.videoStreamName="",this.publishResolve=null,this.publishReject=null,this.playStream=new MediaStream,this.needReGetAudio=!1,this.needReGetVideo=!1,this.labelPrefix="["+this.webrtcMgr.uid+"]",this.label="["+this.webrtcMgr.uid+"]Publisher",this.info("constructor"),this.profileMgr=e.profileMgr,this.layer=r,this.uid=this.webrtcMgr.uid,this.videoStreamId=new U.default(0,0),this.audioStreamId=new U.default(0,0),0===this.webrtcMgr.mode?(this.groupKey=this.webrtcMgr.groupKey,this.audioStreamName=this.genAudioStreamName(),this.audioStreamKey=this.genAudioStreamKey()):(i.audio.enable&&(this.audioStreamName=this.genAudioStreamName(),this.audioStreamKey=this.genAudioStreamKey()),i.video.enable&&(this.videoStreamName=this.genVideoStreamName(),this.videoStreamKey=this.genVideoStreamKey())),this.codec=this.webrtcMgr.pubCodec,i.audio.enable&&(this.audioDeviceId=i.audio.deviceId,this.audioSourceTrack=i.audio.source,this.audioTypeIdeal=i.audio.type),i.video.enable&&(this.videoDeviceId=i.video.deviceId,this.videoSourceTrack=i.video.source),this.playType=i.playType,this.mixer=new E.default(this.logger,this.webrtcMgr.webrtc.trigger.bind(this.webrtcMgr.webrtc))}return a(t,e),s(t,[{key:"destroy",value:function(){this.destroyed=!0,this.unpublish(),this.stream&&0===this.layer&&this.webrtcMgr.webrtc.trigger("local_stream_remove",this.getLocalStream()),this.stream&&(this.stream.getTracks().forEach(function(e){return e.stop()}),this.stream=null),this.mixer&&(this.mixer.destroy(),this.mixer=null),this.screenStream&&(this.screenStream.getTracks().forEach(function(e){return e.stop()}),this.screenStream=null),this.cameraStream&&(this.cameraStream.getTracks().forEach(function(e){return e.stop()}),this.cameraStream=null),this.streamMixer&&this.streamMixer.releaseStreams(),this.webrtcMgr.audioLevelReporter.remove(this.uidStr),this.streamKeeper.clear(),u(Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.reportCaptureCloseStat()}},{key:"reportCaptureCloseStat",value:function(){0===this.layer&&(this.videoStreamKey&&this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","video_capture_close"),this.audioStreamKey&&this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","audio_capture_close"))}},{key:"reportPublishStat",value:function(e){this.videoStreamKey&&(e?this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","anchor_publish_video_[o]",this.layer.toString()):this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","anchor_unpublish_video_[o]",this.layer.toString())),this.audioStreamKey&&(e?this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","anchor_publish_audio"):this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","anchor_unpublish_audio"))}},{key:"clearPublishPromise",value:function(e){e&&this.publishReject?(this.warn("publish failed, reason: "+e),this.addUserEvents("publishFail"),this.publishReject(e)):this.publishResolve&&this.publishResolve(),this.publishResolve=null,this.publishReject=null}},{key:"publish",value:function(){var e=this;return this.reportPublishStat(!0),(this.publishResolve||this.publishReject)&&this.clearPublishPromise("CANCEL"),new Promise(function(t,r){e.connect().then(function(){e.publishResolve=t,e.publishReject=r}).catch(function(e){r(e)})})}},{key:"unpublish",value:function(){(this.publishResolve||this.publishReject)&&this.clearPublishPromise("CANCEL"),this.publishState&&(this.sendPLiveUserBroadCastData(!0),this.publishState=!1),this.pc&&(this.sendStopPublishStream(),this.reportPublishStat(!1),this.disconnect())}},{key:"onVideoModeChange",value:function(){var e=this,t=this.profileMgr.getVideoConstraints(this.layer),r=this.profileMgr.getVideoBitrate(this.layer);return t&&r?(this.videoDeviceId&&(t.deviceId=this.videoDeviceId),this.changeVideoConstraints(t).then(function(){return e.onBitrateChange()}).then(function(){if(e.stream.getVideoTracks()[0])return o(e.stream.getVideoTracks()[0])})):Promise.reject("INVALID_VIDEO_MODE")}},{key:"onCheckTimer",value:function(e,t,r){var i=this.getAudioLevel();this.webrtcMgr.audioLevelReporter.set(this.uidStr,i),this.pc&&(this.debug("onCheckTimer pc status signalingState:"+this.pc.signalingState+" iceConnectionState:"+this.pc.iceConnectionState+" connectionState:"+this.pc.connectionState),this.checkIceConnState(e),this.updateMediaStatPerSec(i),r%5==0&&this.publishState&&(this.sendNotifyCurrentStream(),this.sendPLiveUserBroadCastData()),t%20==0&&this.reportMediaStat(),this.checkResolutionChange())}},{key:"init",value:function(){var e=this;if(this.stream)return Promise.reject("STREAM_ALREADY_CREATED");try{this.profileMgr.checkSystemRestrict(this.videoMode),this.layer>0&&this.profileMgr.checkVideoModeOrder(this.profileMgr.getVideoMode(this.layer-1),this.videoMode)}catch(e){return Promise.reject(e)}var t=[],r=[];return Promise.resolve().then(function(){return e.loadCustomTrack(t,r)}).then(function(){return e.loadDeviceTrack(t,r)}).then(function(){return e.loadScreenTrack(t,r)}).then(function(){return e.gotTrackTuples(t,r)}).catch(function(e){return t.forEach(function(e){e.track.stop()}),r.forEach(function(e){e.track.stop()}),Promise.reject(e)})}},{key:"loadCustomTrack",value:function(e,t){if(this.audioSourceTrack&&e.push({track:this.audioSourceTrack,type:"custom"}),this.videoSourceTrack)return t.push({track:this.videoSourceTrack,type:"custom"}),o(this.videoSourceTrack)}},{key:"loadDeviceTrack",value:function(e,t){var r=this;if(!K.default.hasGetUserMedia())return Promise.reject("NOT_SUPPORTED");var i=void 0;return this.playType===L.default.PLAY_TYPE.NORMAL?i={audio:!this.audioSourceTrack&&this.getAudioConstraints(),video:!this.videoSourceTrack&&this.getVideoConstraints()}:this.playType===L.default.PLAY_TYPE.SCREEN_SHARE&&("all"!==this.audioTypeIdeal&&"microphone"!==this.audioTypeIdeal||(i={audio:this.getAudioConstraints(),video:!1})),i&&(i.video||i.audio)?(this.info("device constraints: "+JSON.stringify(i)),this.getUserMedia(i).then(function(i){return r.getUserMediaSuccess(i,e,t)}).catch(this.didntGetUserMedia.bind(this))):void 0}},{key:"loadScreenTrack",value:function(e,t){if(this.playType===L.default.PLAY_TYPE.SCREEN_SHARE){if(K.default.os.isMobile||!navigator.mediaDevices||"function"!=typeof navigator.mediaDevices.getDisplayMedia)return Promise.reject("SCREEN_CAPTURE_NOT_SUPPORTED");var r=!1;this.audioSourceTrack||"microphone"===this.audioTypeIdeal||(r=this.getAudioConstraints(!1));var i={audio:r,video:this.getVideoConstraints()};return this.info("screen constraints: "+JSON.stringify(i)),navigator.mediaDevices.getDisplayMedia(i).then(function(r){r.getVideoTracks().forEach(function(e){t.push({track:e,type:"screen"})}),r.getAudioTracks().forEach(function(t){e.push({track:t,type:"system"})})}).catch(this.didntGetUserMedia.bind(this))}}},{key:"getUserMedia",value:function(e){var t=this;return navigator.mediaDevices.getUserMedia(e).catch(function(r){return K.default.os.isAndroid&&r.name&&"PERMISSION_DENIED"!==r.name&&e.video?(delete e.video.width,delete e.video.height,delete e.video.frameRate,navigator.mediaDevices.getUserMedia(e).then(function(e){return t.logger.warn("getUserMedia without constraints"),e})):Promise.reject(r)})}},{key:"getUserMediaSuccess",value:function(e,t,r){if(e.getVideoTracks().forEach(function(e){r.push({track:e,type:"camera"})}),e.getAudioTracks().forEach(function(e){t.push({track:e,type:"microphone"})}),e.getVideoTracks()[0])return o(e.getVideoTracks()[0])}},{key:"getAudioConstraints",value:function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0];if(this.audioStreamKey||this.groupKey){var t=this.profileMgr.getAudioConstrains();return e&&this.audioDeviceId&&(t.deviceId={exact:this.audioDeviceId}),t}return!1}},{key:"getVideoConstraints",value:function(){if(this.videoStreamKey){var e=this.profileMgr.getVideoConstraints(this.layer);return this.videoDeviceId&&(e.deviceId={exact:this.videoDeviceId}),e}return!1}},{key:"reportCaptureOpenStat",value:function(e){0===this.layer&&(e?(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","video_capture_open_success"),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_INFO,"room","audio_capture_open_success")):(this.hasVideo&&this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_ERROR,"room","video_capture_open_failed"),this.hasAudio&&this.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_ERROR,"room","audio_capture_open_failed")))}},{key:"gotTrackTuples",value:function(e,t){var r=this;if(this.info("gotTrackTuples"),this.destroyed)return e.forEach(function(e){return e.track.stop()}),t.forEach(function(e){return e.track.stop()}),Promise.reject("CANCEL");if(this.stream=new MediaStream,t[0]&&(this.stream.addTrack(t[0].track),this.videoTypeActually=t[0].type),e.length>0){this.mixer.addUserTrack(e[0].track);for(var i=1;i<e.length;i++)this.mixer.addTrack(e[i].track);1===this.mixer.inputCount&&K.default.os.isIOS?this.stream.addTrack(this.mixer.userTrack):this.stream.addTrack(this.mixer.mixTrack),1===e.length?this.audioTypeActually=e[0].type:this.audioTypeActually="all"}if(this.stream.getAudioTracks().length>1||this.stream.getVideoTracks().length>1)return Promise.reject("INVALID_TRACK_LENGTH");e.forEach(function(e){return r.monitorTrackTuple(e)}),t.forEach(function(e){return r.monitorTrackTuple(e)}),this.updatePlayStream(),this.audioMeter.updateNode(this.mixer.mixGain),this.hasAudio=!!this.stream.getAudioTracks()[0]&&this.stream.getAudioTracks()[0].enabled,this.hasVideo=!!this.stream.getVideoTracks()[0]&&this.stream.getVideoTracks()[0].enabled,this.hasAudio||(this.audioStreamKey="",this.audioStreamName=""),this.reportCaptureOpenStat(!0);var n=this.getLocalStream();return 0===this.layer&&this.webrtcMgr.webrtc.trigger("local_stream_add",n),0===this.layer&&this.streamKeeper.keep(this.stream),Promise.resolve(n)}},{key:"getLocalStream",value:function(){var e={uid:this.webrtcMgr.uidStr,roomId:this.webrtcMgr.channelId,stream:this.stream};return""===this.audioStreamKey&&""===this.groupKey||(e.audio={bitrate:this.profileMgr.audioBitrate,sampleRate:this.profileMgr.audioSampleRate,channel:this.profileMgr.audioChannel,type:this.audioTypeActually}),""!==this.videoStreamKey&&(e.video={width:this.width?this.width:0,height:this.height?this.height:0,bitrate:this.bitRate,codec:this.webrtcMgr.pubCodec,frameRate:this.frameRate?this.frameRate:0,type:this.videoTypeActually}),e}},{key:"getVideoDeviceId",value:function(){if(this.stream){var e=this.stream.getVideoTracks()[0];if(e)return e.getSettings().deviceId}}},{key:"didntGetUserMedia",value:function(e){return this.warn("didntGetUserMedia could not get user media err: "+String(e)),this.reportCaptureOpenStat(!1),Promise.reject(V.default.mediaErrorToString(e))}},{key:"onWebRTCAnswer",value:function(e){var t=this;this.bitRate&&(e.sdp=P.default.updateBandwidthRestriction(e.sdp,this.bitRate,this.minBitRate)),this.setRemoteDescription(e).then(function(){t.sendNotifyCurrentStream(),t.sendPLiveUserBroadCastData(!1),t.publishState=!0,t.clearPublishPromise()}).catch(function(e){"SET_REMOTE_SDP_FAIL"===e&&(t.clearPublishPromise(e),t.webrtcMgr.publisherMgr.unPublish())})}},{key:"sendNotifyCurrentStream",value:function(){var e=new p.default;if(e.appid=this.webrtcMgr.appid,e.uid=this.uid,this.webrtcMgr.pureAudio)this.groupKey&&""!==this.groupKey&&(e.status=new Map,e.streamId=this.audioStreamId,e.status.set(m.default.StreamCfgKey.STREAM_TYPE,m.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_AUDIO),e.streamKey=this.groupKey,this.debug("pureAudio sendNotify:"+JSON.stringify(e)),this.webrtcMgr.send(e.marshall()));else{if(this.videoStreamKey&&""!==this.videoStreamKey){var t=this.mediaStatPerSec.data.resolution.split("x"),r=2===t.length?Number(t[0]):this.width,i=2===t.length?Number(t[1]):this.height;e.status=new Map,e.streamId=this.videoStreamId,e.status.set(m.default.StreamCfgKey.STREAM_TYPE,m.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_VIDEO),e.status.set(m.default.StreamCfgKey.SET_BIT_RATE,this.bitRate),e.status.set(m.default.StreamCfgKey.SET_FRAME_RATE,this.frameRate?this.frameRate:30),e.status.set(m.default.StreamCfgKey.RESOLUTION_WIDTH,r),e.status.set(m.default.StreamCfgKey.RESOLUTION_HEIGHT,i),e.status.set(m.default.StreamCfgKey.WEBRTC_STREAM_LAYER,this.layer),e.streamKey=this.videoStreamKey,this.debug("video sendNotify:"+JSON.stringify(e)+", width:"+r+", height:"+i),this.webrtcMgr.send(e.marshall())}this.audioStreamKey&&""!==this.audioStreamKey&&(e.status=new Map,e.streamId=this.audioStreamId,e.status.set(m.default.StreamCfgKey.STREAM_TYPE,m.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_AUDIO),e.streamKey=this.audioStreamKey,this.debug("audio sendNotify:"+JSON.stringify(e)),this.webrtcMgr.send(e.marshall()))}}},{key:"sendStopPublishStream",value:function(){this.info("sendStopPublishStream");var e=new y.default;e.uid=this.uid,e.appid=this.appid,this.webrtcMgr.pureAudio?this.groupKey&&""!==this.groupKey&&(e.streamId=this.audioStreamId,e.streamKey=this.webrtcMgr.groupKey,this.audioStreamKey&&""!==this.audioStreamKey&&e.groupKeys.push(this.audioStreamKey),this.webrtcMgr.send(e.marshall()),this.info("pureAudio send stop:"+JSON.stringify(e))):(this.audioStreamKey&&""!==this.audioStreamKey&&(e.streamId=this.audioStreamId,e.streamKey=this.audioStreamKey,this.info("audio send stop:"+JSON.stringify(e)),this.webrtcMgr.send(e.marshall())),this.videoStreamKey&&""!==this.videoStreamKey&&(e.streamId=this.videoStreamId,e.streamKey=this.videoStreamKey,this.info("video send stop:"+JSON.stringify(e)),this.webrtcMgr.send(e.marshall())))}},{key:"sendPLiveUserBroadCastData",value:function(e){var t=new I.default;t.appid=this.webrtcMgr.appid,t.uid=this.webrtcMgr.uid,t.externalUid=this.webrtcMgr.uidStr,this.audioStreamKey&&""!==this.audioStreamKey&&t.groupKeys.push(this.audioStreamKey),this.videoStreamKey&&""!==this.videoStreamKey&&t.groupKeys.push(this.videoStreamKey),this.groupKey&&""!==this.groupKey&&t.groupKeys.push(this.groupKey),void 0!==e&&t.broadCastInt.set(m.default.LiveUserMsgData.USER_MSG_MUTE_AUDIO,Number(e));var r=this.webrtcMgr.getOverallNetworkScore();t.broadCastInt.set(m.default.LiveUserMsgData.USER_MSG_NETWORK_TX_QUALITY,r.uplinkScore),t.broadCastInt.set(m.default.LiveUserMsgData.USER_MSG_NETWORK_RX_QUALITY,r.downlinkScore),0!==this.webrtcMgr.tcpRtt&&(t.broadCastInt.set(m.default.LiveUserMsgData.USER_MSG_LOCAL_TIME,d.default.now()+this.webrtcMgr.localOsDiffTime),t.broadCastInt.set(m.default.LiveUserMsgData.USER_MSG_OS_TIME,d.default.now())),this.webrtcMgr.send(t.marshall())}},{key:"updateVideoBandWidth",value:function(e){this.info("update video bandwidth "+e);var t=new b.default;t.appid=this.webrtcMgr.appid,t.uid=this.webrtcMgr.uid,this.webrtcMgr.pureAudio?this.groupKey&&""!==this.groupKey&&(t.groupKey=this.webrtcMgr.groupKey):this.videoStreamKey&&""!==this.videoStreamKey&&(t.groupKey=""),t.streamId=this.videoStreamId,t.message.set(m.default.PWebRTCMessageKey.VIDEO_BIT_RATE,e),this.webrtcMgr.send(t.marshall())}},{key:"startMixing",value:function(e,t){var r=this;return this.stream?this.hasAudio?this.useMixTrack().then(function(){return r.mixer.startMixing(e,t)}):Promise.reject("AUDIO_TRACK_NOT_EXISTED"):Promise.reject("STREAM_IS_CREATING")}},{key:"setUserVolume",value:function(e){return this.stream?this.hasAudio?(this.useMixTrack(),this.mixer.userVolume=e,this.setAudioVolume(e/100),null):{error:"AUDIO_TRACK_NOT_EXISTED"}:{error:"STREAM_IS_CREATING"}}},{key:"changeVideoConstraints",value:function(e){var t=this;return this.runFuncWithBeautyPause(function(){t.info("changeVideoConstraints");var r=void 0;return t.stream&&(r=t.stream.getVideoTracks()[0]),r?r.applyConstraints(e).catch(function(e){if("OverconstrainedError"===e.name&&K.default.os.isAndroid)return t.stopVideoDeviceTrack(),t.reGetVideoDeviceTrack()}):Promise.reject("VIDEO_TRACK_NOT_EXISTED")})}},{key:"onBitrateChange",value:function(){var e=this,t=this.bitRate;if(!this.pc||this.pc&&!this.remoteSdp)return this.info("changeBitrate to "+t),Promise.resolve();var r=P.default.updateBandwidthRestriction(this.remoteSdp,t,this.minBitRate);return this.reNegotiate(r).then(function(){e.info("changeBitrate to "+t)}).catch(function(){return Promise.reject("SET_BITRATE_ERROR")})}},{key:"changeDevice",value:function(e,t){var r=this;return this.runFuncWithBeautyPause(function(){if(1!==r.playType)return Promise.reject("INVALID_PLAY_TYPE");if("audio"===e){var i=function(){var e=r.mixer.userTrack;return e?e.getSettings().deviceId===t?{v:Promise.reject("SAME_DEVICE")}:{v:r.getDeviceTrack("audio",t).then(function(i){e=r.mixer.userTrack,r.mixer.replaceUserTrack(i),r.updatePlayStream(),r.audioDeviceId=t,e&&e.stop(),r.audioSourceTrack&&(r.audioSourceTrack=void 0)})}:{v:Promise.reject("AUDIO_TRACK_NOT_EXISTED")}}();if("object"==typeof i)return i.v}return r.replaceDevice(e,t)})}},{key:"replaceDevice",value:function(e,t){var r=this,i=arguments.length<=2||void 0===arguments[2]||arguments[2];if(!this.stream)return Promise.reject("STREAM_HAS_NOT_BEEN_CREATED");var n="audio"===e?this.audioTrack:this.videoTrack;if(!n)return Promise.reject(e+"_TRACK_NOT_EXISTED");var a=n.getSettings().deviceId;return t===a&&i?Promise.reject("SAME_DEVICE"):this.getDeviceTrack(e,t).then(function(i){var a=Promise.resolve();if(r.pc){var s=r.pc.getSenders().filter(function(t){return t.track&&t.track.kind===e})[0];a=s.replaceTrack(i)}return a.then(function(){return n="audio"===e?r.audioTrack:r.videoTrack,r.stream.addTrack(i),r.stream.removeTrack(n),n.stop(),"video"===e&&(r.videoDeviceId=t,r.videoSourceTrack&&(r.videoSourceTrack=void 0)),"audio"===e&&(r.audioDeviceId=t,r.audioSourceTrack&&(r.audioSourceTrack=void 0),r.mixer.replaceUserTrack(i)),r.monitorTrackTuple({track:i,type:"audio"===e?"microphone":"camera"}),r.updatePlayStream(),r.player&&r.player.handleTrackChange(),o(i)})})}},{key:"getDeviceTrack",value:function(e,t){if(!K.default.hasGetUserMedia())return Promise.reject("NOT_SUPPORTED");var r={};return"audio"===e?r.audio=this.getAudioConstraints():"video"===e&&(r.video=this.getVideoConstraints()),t&&(r[e].deviceId={exact:t}),this.getUserMedia(r).then(function(t){var r=t.getTracks().filter(function(t){return t.kind===e})[0];return r||Promise.reject("NO_TRACK")}).catch(this.didntGetUserMedia.bind(this))}},{key:"getMixer",value:function(){return this.mixer}},{key:"enableBeauty",value:function(e){if(this.videoEffector.enabled())return this.videoEffector.updatePara(e),Promise.resolve();if(!this.stream||0===this.stream.getVideoTracks().length)return Promise.reject("VIDEO_TRACK_NOT_EXISTED");var t=this.videoEffector.enable(this.stream);return this.videoEffector.updatePara(e),t?this.changeVideoTrack(this.videoEffector.getOutputTrack()):Promise.reject("VideoEffector enable fail")}},{key:"disableBeauty",value:function(){if(this.videoEffector.enabled()){var e=this.videoEffector.getInputTrack();return e&&this.changeVideoTrack(e),this.videoEffector.disable(),Promise.resolve()}return Promise.reject("HAS_NOT_ENABLE_BEAUTY")}},{key:"changeVideoTrack",value:function(e){if(!this.stream||0===this.stream.getVideoTracks().length)return Promise.reject("VIDEO_TRACK_NOT_EXISTED");if(this.stream.removeTrack(this.stream.getVideoTracks()[0]),this.stream.addTrack(e),this.updatePlayStream(),this.pc){return this.pc.getSenders().filter(function(e){return"video"===e.track.kind})[0].replaceTrack(e)}return Promise.resolve()}},{key:"runFuncWithBeautyPause",value:function(e){var t=this;return this.videoEffector.enabled()?this.disableBeauty().then(function(){return e()}).then(function(e){return t.enableBeauty().then(function(){return e})}).catch(function(e){return t.enableBeauty().then(function(){return Promise.reject(e)})}):e()}},{key:"monitorTrackTuple",value:function(e){var t=this,r=e.track,i=e.type;r.onended=function(){"video"===r.kind?(t.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_ERROR,"room","anchor_video_track_end_[o]",t.layer.toString()),t.addUserEvents("videoTrackEnd")):(t.webrtcMgr.reportUserEventMgr.addEvent(A.LOGLEVEL_ERROR,"room","anchor_audio_track_end_[o]",i),t.addUserEvents("audioTrackEnd")),t.triggerTrackEvent(r.kind,"end",i)},r.onmute=function(){t.triggerTrackEvent(r.kind,"mute",i),t.addUserEvents(r.kind+"_mute"),"audio"===r.kind&&K.default.os.isIOS&&(t.stopAudioDeviceTrack(),t.stopVideoDeviceTrack(),t.reGetVideoDeviceTrack().then(function(){t.reGetAudioDeviceTrackWithRetry()})),"video"===r.kind&&K.default.os.isAndroid&&K.default.isWeChat&&"visible"===document.visibilityState&&(t.info("try to reget video track because track mute when visible"),t.stopVideoDeviceTrack(),t.reGetVideoDeviceTrack())},r.onunmute=function(){t.triggerTrackEvent(r.kind,"unmute",i),t.addUserEvents(r.kind+"_unmute")}}},{key:"triggerTrackEvent",value:function(e,t,r){var i=e+"_track_"+t;this.warn(i+", type:"+r+", layer:"+this.layer),this.webrtcMgr.webrtc.trigger(i,{uid:this.uidStr,roomId:this.webrtcMgr.channelId,type:r,layer:this.layer})}},{key:"updateSpecialStat",value:function(e){e.publishVideoStreamId=V.default.streamIdToString(this.videoStreamId),e.publishAudioStreamId=V.default.streamIdToString(this.audioStreamId),e.videoMode=String(this.videoMode)}},{key:"ontrack",value:function(e,t){}},{key:"onremovestream",value:function(e,t){}},{key:"addTrack",value:function(e){var t=this;return this.stream?"audio"===e.kind?this.useMixTrack().then(function(){return t.addAudioTrack(e)}):"video"===e.kind?this.addVideoTrack(e):Promise.reject("INVALID_TRACK"):Promise.reject("STREAM_IS_CREATING")}},{key:"addVideoTrack",value:function(e){var t=this;return this.stream.getVideoTracks()[0]?Promise.reject("SAME_KIND_TRACK_EXISTED"):0===this.webrtcMgr.mode?Promise.reject("NOT_SUPPORTED_IN_GROUP_MODE"):this.setSenderTrack(e).then(function(){return t.stream.addTrack(e),t.videoStreamName=t.genVideoStreamName(),t.videoStreamKey=t.genVideoStreamKey(),t.videoSourceTrack=e,t.hasVideo=!0,t.onTrackChange()})}},{key:"addAudioTrack",value:function(e){var t=this,r=this.mixer.addTrack(e)
;if(r)return Promise.reject(r.error);if(this.audioTrack)return Promise.resolve(this.getLocalStream());var i=this.mixer.mixTrack;return this.stream.addTrack(i),this.setSenderTrack(i).then(function(){return t.audioStreamName=t.genAudioStreamName(),t.audioStreamKey=t.genAudioStreamKey(),t.hasAudio=!0,t.onTrackChange()})}},{key:"removeTrack",value:function(e){var t=this;return this.stream?"audio"===e.kind?this.useMixTrack().then(function(){return t.removeAudioTrack(e)}):"video"===e.kind?this.removeVideoTrack(e):Promise.reject("INVALID_TRACK"):Promise.reject("STREAM_IS_CREATING")}},{key:"removeVideoTrack",value:function(e){var t=this;return 1===this.stream.getTracks().length?Promise.reject("NO_TRACK_LEFT"):e!==this.stream.getVideoTracks()[0]?Promise.reject("INVALID_TRACK"):this.videoEffector.enabled()?Promise.reject("INVALID_WHEN_BEAUTY"):this.clearSenderTrack(e).then(function(){return t.stream.removeTrack(e),e.stop(),t.sendPLiveStopStream(t.videoStreamKey,t.videoStreamId),t.videoStreamName="",t.videoStreamKey="",t.hasVideo=!1,t.onTrackChange()})}},{key:"removeAudioTrack",value:function(e){var t=this;if(1===this.stream.getTracks().length&&(this.mixer.inputCount<2||e===this.mixer.mixTrack))return Promise.reject("NO_TRACK_LEFT");if(!this.audioTrack)return Promise.reject("INVALID_TRACK");if(this.removeMixerTrack(e)){if(0===this.mixer.inputCount){var r=this.mixer.mixTrack;return this.stream.removeTrack(r),this.clearSenderTrack(r).then(function(){return t.sendPLiveStopStream(t.audioStreamKey,t.audioStreamId),t.audioStreamName="",t.audioStreamKey="",t.hasAudio=!1,t.onTrackChange()})}return Promise.resolve(this.getLocalStream())}return Promise.reject("INVALID_TRACK")}},{key:"removeMixerTrack",value:function(e){return!this.mixer.removeTrack(e)}},{key:"replaceTrack",value:function(e,t){var r=this;if(!this.stream)return Promise.reject("STREAM_IS_CREATING");var i=this.getTrackOfKind(e.kind);return i&&i!==e?"audio"===e.kind?this.useMixTrack().then(function(){return r.replaceAudioTrack(e,t)}):"video"===e.kind?this.replaceVideoTrack(e):Promise.reject("INVALID_TRACK"):Promise.reject("INVALID_TRACK")}},{key:"replaceAudioTrack",value:function(e,t){if(t){if(!this.removeMixerTrack(t))return Promise.reject("INVALID_OLD_SOURCE_TRACK")}else this.mixer.clearAllInputs();var r=this.mixer.addTrack(e);return r?Promise.reject(r.error):Promise.resolve(this.onTrackChange())}},{key:"replaceVideoTrack",value:function(e){var t=this;return this.replaceSenderTrack(e).then(function(){return t.videoTrack.stop(),t.stream.removeTrack(t.videoTrack),t.stream.addTrack(e),t.videoSourceTrack=e,t.onTrackChange()})}},{key:"getTrackOfKind",value:function(e){if(this.stream)return this.stream.getTracks().filter(function(t){return t.kind===e})[0]}},{key:"setSenderTrack",value:function(e){if(this.pc){if("video"===e.kind&&!this.supportedVideoCodecs.includes(this.codec))return Promise.reject("VIDEO_CODEC_UNSUPPORTED");var t=this.pc.getSenders().filter(function(e){return null===e.track})[0];return t?t.replaceTrack(e):Promise.reject("INVALID_TRACK")}return Promise.resolve()}},{key:"clearSenderTrack",value:function(e){if(this.pc){var t=this.pc.getSenders().filter(function(t){return t.track===e})[0];return t?t.replaceTrack(null):Promise.reject("INVALID_TRACK")}return Promise.resolve()}},{key:"replaceSenderTrack",value:function(e){if(this.pc){var t=this.pc.getSenders().filter(function(t){return!!t.track&&t.track.kind===e.kind})[0];return t?t.replaceTrack(e):Promise.reject("INVALID_TRACK")}return Promise.resolve()}},{key:"onTrackChange",value:function(){return this.publishState&&(this.sendNotifyCurrentStream(),this.webrtcMgr.streamSvr.startLive()),this.player&&this.player.update(this.volume,this.hasAudio,this.hasVideo),this.updatePlayStream(),this.getLocalStream()}},{key:"sendPLiveStopStream",value:function(e,t){if(""!==e&&t){this.info("sendPLiveStopStream: "+e);var r=new C.default;r.appid=this.webrtcMgr.appid,r.uid=this.uid,r.streamKey=e,r.streamId=t}}},{key:"updatePlayStream",value:function(){var e=this.mixer.userTrack,t=this.videoTrack,r=this.playStream.getAudioTracks()[0],i=this.playStream.getVideoTracks()[0];this.updatePlayStreamTrack(e,r),this.updatePlayStreamTrack(t,i)}},{key:"updatePlayStreamTrack",value:function(e,t){e!==t&&(t&&this.playStream.removeTrack(t),e&&this.playStream.addTrack(e))}},{key:"getPlayStream",value:function(){return this.playStream}},{key:"enableAudio",value:function(){return this.mixer.enableAudio(),u(Object.getPrototypeOf(t.prototype),"enableAudio",this).call(this)}},{key:"disableAudio",value:function(){return this.audioTrack!==this.mixer.userTrack&&this.mixer.disableAudio(),u(Object.getPrototypeOf(t.prototype),"disableAudio",this).call(this)}},{key:"checkResolutionChange",value:function(){var e=this.width,t=this.height;e&&this.lastWidth&&t&&this.lastHeight&&(e===this.lastWidth&&t===this.lastHeight||0===this.layer&&this.publishState&&this.webrtcMgr.streamSvr.startLive()),this.lastWidth=e,this.lastHeight=t}},{key:"onIOSVisibilityChange",value:function(e){var t=this;this.info("onIOSVisibilityChange "+e),e?this.reGetVideoDeviceTrack().then(function(){t.reGetAudioDeviceTrack()}):(this.stopAudioDeviceTrack(),this.stopVideoDeviceTrack())}},{key:"onAndroidWeChatVisibilityChange",value:function(e){var t=this;this.info("onAndroidWeChatVisibilityChange "+e),e&&setTimeout(function(){t.destroyed||t.videoTrack&&t.videoTrack.muted&&"visible"===document.visibilityState&&(t.info("try to reget video track because track mute"),t.stopVideoDeviceTrack(),t.reGetVideoDeviceTrack())},1500)}},{key:"reGetAudioDeviceTrackWithRetry",value:function(){var e=this;this.destroyed||this.reGetAudioDeviceTrack().catch(function(){setTimeout(function(){e.logger.info("try to reget audio device"),e.needReGetAudio=!0,e.reGetAudioDeviceTrackWithRetry()},2e3)})}},{key:"stopAudioDeviceTrack",value:function(){this.audioTrack&&!this.audioSourceTrack&&(this.info("stop audio track"),this.audioTrack.stop(),this.needReGetAudio=!0)}},{key:"stopVideoDeviceTrack",value:function(){this.videoTrack&&!this.videoSourceTrack&&(this.info("stop video track"),this.videoTrack.stop(),this.needReGetVideo=!0)}},{key:"reGetAudioDeviceTrack",value:function(){var e=this;return this.needReGetAudio?(this.needReGetAudio=!1,this.replaceDevice("audio",this.audioDeviceId,!1).then(function(){e.info("get new audio track")}).catch(function(t){return e.warn("fail get audio track "+t),Promise.reject(t)})):Promise.resolve()}},{key:"reGetVideoDeviceTrack",value:function(){var e=this;return this.needReGetVideo?(this.needReGetVideo=!1,this.replaceDevice("video",this.videoDeviceId,!1).then(function(){e.info("get new video track")}).catch(function(t){e.warn("fail get video track "+t)})):Promise.resolve()}},{key:"useMixTrack",value:function(){var e=this;return Promise.resolve().then(function(){var t=e.audioTrack;if(t&&t!==e.mixer.mixTrack)return e.stream.removeTrack(t),e.stream.addTrack(e.mixer.mixTrack),e.replaceSenderTrack(e.mixer.mixTrack).catch(function(t){e.warn("useMixTrack fail "+t)})})}},{key:"videoParam",get:function(){return{width:this.width,height:this.height,frameRate:this.frameRate,bitrate:this.bitRate,codec:"VP8"===this.codec?N.CodecType.VIDEO_VP8:N.CodecType.VIDEO_H264}}},{key:"audioParam",get:function(){return{channel:this.profileMgr.audioChannel,bitrate:this.profileMgr.audioBitrate,sampleRate:this.profileMgr.audioSampleRate,codec:N.CodecType.MUSIC_OPUS}}},{key:"bitRate",get:function(){return this.profileMgr.getVideoBitrate(this.layer)}},{key:"minBitRate",get:function(){return this.profileMgr.getVideoMinBitrate(this.layer)}},{key:"videoMode",get:function(){return this.profileMgr.getVideoMode(this.layer)}}]),t}(h.default);r.default=j,t.exports=r.default},{"./UserStream":5,"./codecSwitch":9,"./constant":10,"./mix/Mixer":14,"./protobase/MetaDataInfo":17,"./protobase/ProtoUInt64":21,"./protocol/PLiveNotifyPublishStatus":29,"./protocol/PLiveStopPublishStream":33,"./protocol/PLiveStopStream":34,"./protocol/PLiveUserBroadCastData":38,"./protocol/PWebRTCMessage":45,"./protocol/streamSvr/StreamSvrEnum":66,"./utils/browser":90,"./utils/logger":91,"./utils/timeUtil":92,"./utils/utils":93,"./videoEffector":94}],69:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t,r){var i={enable:!1};if(t)if(i.enable=!0,t.source){if(!p.default.isTrack(t.source)||t.source.kind!==e)throw"INVALID_SOURCE_TRACK";if(r!==d.default.PLAY_TYPE.NORMAL&&"video"===e)throw"VIDEO_SOURCE_TRACK_NOT_SUPPORT_IN_SCREEN_SHARE";i.source=t.source}else if(t.deviceId&&r===d.default.PLAY_TYPE.NORMAL){if("string"!=typeof t.deviceId)throw"INVALID_DEVICE_ID";i.deviceId=t.deviceId}else if(r===d.default.PLAY_TYPE.SCREEN_SHARE&&"audio"===e){if(t.type&&!["microphone","system","all"].includes(t.type))throw"INVALID_AUDIO_TYPE";if(i.type=t.type||"system",["microphone","all"].includes(i.type)&&t.deviceId){if("string"!=typeof t.deviceId)throw"INVALID_DEVICE_ID";i.deviceId=t.deviceId}}return i}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("./publisher"),u=i(s),l=e("./utils/logger"),h=i(l),c=e("./constant"),d=i(c),f=e("./utils/utils"),p=i(f),v=e("./utils/browser"),m=i(v),g=function(){function e(t){n(this,e),this.published=!1,this.streamCreated=!1,this.dualEnabled=!1,this.publishers=new Map,this.webrtcMgr=t,this.logger=t.logger,this.profileMgr=t.profileMgr,this.ConnectTimeOut=7e3,this.idOffset=0,this.logger.debug("webrtc publisherMgr constructor")}return o(e,[{key:"destroy",value:function(){this.logger.debug("webrtc PublisherMgr.destroy"),this.closeStream()}},{key:"onCheckTimer",value:function(e,t,r){this.publishers.forEach(function(i){i.onCheckTimer(e,t,r)})}},{key:"resetIceConnState",value:function(e){this.logger.warn("PublisherMgr.resetIceConnState, resetReason:"+e),this.published&&this.publishers.forEach(function(t){t.resetIceConnState(e)})}},{key:"addAndGetIdOffset",value:function(){return this.idOffset+=2,this.idOffset}},{key:"enableDualStream",value:function(e){var t=this;if(!p.default.isNil(e))try{this.profileMgr.setVideoMode(1,e)}catch(e){return Promise.reject(e)}if(!this.webrtcMgr.joined())return Promise.resolve();if(!this.publishers.get(0)||""===this.publishers.get(0).videoStreamKey)return Promise.resolve();var r=this.publishers.get(0).playType;if(1!==r)return Promise.reject("SCREEN_SHARE_NOT_SUPPORT_DUAL_STREAM");if(this.publishers.get(0).videoSourceTrack)return Promise.reject("VIDEO_SOURCE_TRACK_NOT_SUPPORT_IN_DUAL_STREAM");var i=this.publishers.get(0).getVideoDeviceId(),n={audio:{enable:!1},video:{enable:!0,deviceId:i},playType:r},a=new u.default(this.webrtcMgr,1,n);return this.publishers.set(1,a),this.publishers.get(0).stream?i?this.createLayerStream(1).then(function(){return t.published&&!a.pc?a.publish().then(function(){return t.webrtcMgr.streamSvr.startLive(),Promise.resolve()}).catch(function(e){return t.disableDualStream(),Promise.reject(e)}):Promise.resolve()}).catch(function(e){return t.disableDualStream(),Promise.reject(e)}):Promise.reject("DEVICE_ERROR"):Promise.resolve()}},{key:"createStream",value:function(e){var t=this;return this.webrtcMgr.joined()?this.webrtcMgr.profileMgr.gotConfig().then(function(){if(t.size>0)return t.streamCreated?Promise.reject("STREAM_ALREADY_CREATED"):Promise.reject("STREAM_IS_CREATING");for(var r=t.parseMediaStreamParam(e),i=0;i<r.length;i++){var n=new u.default(t.webrtcMgr,i,r[i]);t.publishers.set(i,n)}return t.createLayerStream(0).then(function(){return t.streamCreated=!0,t.getLocalStream()}).catch(function(e){return t.closeStream(),Promise.reject(e)})}):Promise.reject("HAS_NOT_JOIN")}},{key:"createLayerStream",value:function(e){var t=this;return this.publishers.get(e).init().then(function(){if(++e<t.size){if(1===e){var r=t.publishers.get(0).getVideoDeviceId();if(!r)return Promise.reject("DEVICE_ERROR");for(var i=1;i<t.size;i++)t.publishers.get(i).videoDeviceId=r}return t.createLayerStream(e)}})}},{key:"parseMediaStreamParam",value:function(e){if(!e||!e.audio&&!e.video||!e.audio&&this.webrtcMgr.pureAudio)throw"INVALID_STREAM_PARAM";var t=this.getPlayType(e),r=[],i=a("audio",e.audio,t),n=this.webrtcMgr.pureAudio?{enable:!1}:a("video",e.video,t);this.parseMediaStreamParamAudio(e.audio);var o=this.parseMediaStreamParamVideo(e.video);if(o>1&&n.source)throw"VIDEO_SOURCE_TRACK_NOT_SUPPORT_IN_DUAL_STREAM";if(o>1&&1!==t)throw"SCREEN_SHARE_NOT_SUPPORT_DUAL_STREAM";for(var s=0;s<o;s++)r.push({audio:0===s?i:{enable:!1},video:n,playType:t});return r}},{key:"parseMediaStreamParamAudio",value:function(e){e&&("boolean"==typeof e.AEC&&(this.profileMgr.AEC=e.AEC),"boolean"==typeof e.AGC&&(this.profileMgr.AGC=e.AGC),"boolean"==typeof e.ANS&&(this.profileMgr.ANS=e.ANS))}},{key:"parseMediaStreamParamVideo",value:function(e){return e&&!p.default.isNil(e.videoMode)&&this.profileMgr.setVideoMode(0,e.videoMode),e&&!p.default.isNil(e.highVideoMode)&&this.profileMgr.setVideoMode(0,e.highVideoMode,"INVALID_HIGH_VIDEO_MODE"),e&&!p.default.isNil(e.lowVideoMode)&&this.profileMgr.setVideoMode(1,e.lowVideoMode,"INVALID_LOW_VIDEO_MODE"),!this.webrtcMgr.pureAudio&&e&&this.dualEnabled?2:1}},{key:"getPlayType",value:function(e){if(this.webrtcMgr.pureAudio)return d.default.PLAY_TYPE.NORMAL;if(e.playType){if(Object.values(d.default.PLAY_TYPE).includes(e.playType)){if(e.playType!==d.default.PLAY_TYPE.NORMAL&&!e.video)throw"NO_VIDEO_NOT_SUPPORT_IN_SCREEN_SHARE";return e.playType}throw"INVALID_PLAY_TYPE"}return d.default.PLAY_TYPE.NORMAL}},{key:"disableDualStream",value:function(){return this.publishers.get(1)?(this.publishers.get(1).destroy(),this.publishers.delete(1),this.published&&this.webrtcMgr.streamSvr.startLive(),null):null}},{key:"closeStream",value:function(){return 0===this.size?{error:"STREAM_HAS_NOT_BEEN_CREATED"}:(this.unPublish(),this.publishers.forEach(function(e){e.destroy()}),this.publishers.clear(),this.streamCreated=!1,null)}},{key:"publish",value:function(){var e=this;if(!this.streamCreated)return Promise.reject("STREAM_HAS_NOT_BEEN_CREATED");if(this.published)return Promise.reject("ALREADY_PUBLISH");this.published=!0;var t=[];return this.publishers.forEach(function(e){t.push(e.publish())}),Promise.all(t).then(function(){return e.webrtcMgr.streamSvr.startLive(),Promise.resolve()}).catch(function(t){return e.unPublish(),Promise.reject(t)})}},{key:"unPublish",value:function(){return this.published?(this.published=!1,this.publishers.forEach(function(e){e.unpublish()}),this.webrtcMgr.streamSvr.stopLive(),null):{error:"HAS_NOT_PUBLISH"}}},{key:"destroyPublisher",value:function(e){if(!this.hasPublished())return Promise.reject("CANCEL");var t=this.publishers.get(e);return t?(t.destroy(),this.publishers.delete(e),Promise.resolve()):Promise.reject("NO_PUBLISHER")}},{key:"setAudioMode",value:function(e){if(this.size>0)return{error:"INVALID_OPERATION_AFTER_STREAM_CREATED"};try{return this.profileMgr.setAudioMode(e),null}catch(e){return{error:e}}}},{key:"setVideoMode",value:function(e,t){var r=this;return Promise.resolve().then(function(){return t+1<r.size&&r.profileMgr.checkVideoModeOrder(e,r.profileMgr.getVideoMode(t+1)),r.profileMgr.setVideoMode(t,e),r.onVideoModeChange(t)})}},{key:"setVideoEncoderConfig",value:function(e,t){var r=this;return Promise.resolve().then(function(){var i=r.profileMgr.setVideoEncoderConfig(t,e,r.size);return i?Promise.reject(i.error):r.onVideoModeChange(t)})}},{key:"onVideoModeChange",value:function(e){var t=this,r=this.publishers.get(e);return r?r.onVideoModeChange().then(function(){return t.published&&t.webrtcMgr.streamSvr.startLive(),t.getLocalStream()}):Promise.resolve()}},{key:"setClientAddress",value:function(e){var t=this;e.publishLayerToAddress.forEach(function(e,r){var i=t.publishers.get(r);i&&i.setClientAddress(e)})}},{key:"onWebRTCAnswer",value:function(e){h.default.info("PublisherMgr.onWebRTCAnswer, pkg.uid:"+e.uid+", pkg.seqNum:"+e.seqNum+", pkg.layer:"+e.layer);var t=this.getPublisherFromPkg(e);e.publish&&t&&t.uid===e.uid&&t.onWebRTCAnswer(e)}},{key:"onNotifyPublishStatusRes",value:function(e){0!==e.authStatus&&h.default.info("webrtc PublisherMgr.onNotifyPublishStatusRes, auth fail, uid:"+this.webrtcMgr.uid+", authStatus:"+e.authStatus)}},{key:"onBizAuthResNotify",value:function(e){var t=this.getPublisherFromPkg(e);0!==e.bizAuthResult&&e.bPublish&&t.uid===e.uid&&(h.default.info("webrtc PublisherMgr.onBizAuthResNotify, auth fail, uid:"+this.webrtcMgr.uid+", stream:"+e.streamName+", group:"+e.groupName+", result:"+e.bizAuthResult+", bPublish:"+e.bPublish),this.webrtcMgr.webrtc.trigger("publish_auth_fail",{uid:this.webrtcMgr.uidStr,stream:e.streamName,group:e.groupName,result:e.bizAuthResult,isPublish:e.bPublish}),this.webrtcMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_ERROR,"room","anchor_publish_auth_failed_[o]",t.layer.toString()),t.addUserEvents("pubAuthFail"),this.hasPublished()&&this.unPublish())}},{key:"onWebRTCEvent",value:function(e){h.default.info("PublisherMgr.onWebRTCEvent, pkg.uid:"+e.uid);var t=this.getPublisherFromPkg(e);e.publish&&t&&t.uid===e.uid&&t.onWebRTCEvent(e)}},{key:"onWebRTCMessage",value:function(e){}},{key:"getPublisherFromPkg",value:function(e){return e.layer?this.publishers.get(e.layer):this.publishers.get(0)}},{key:"startMixing",value:function(e,t){var r=this.publishers.get(0);return r?r.startMixing(e,t):Promise.reject("STREAM_HAS_NOT_BEEN_CREATED")}},{key:"setPublishVolume",value:function(e){var t=this.publishers.get(0);return t?t.setUserVolume(e):{error:"STREAM_HAS_NOT_BEEN_CREATED"}}},{key:"getAudioLevel",value:function(){var e=this.publishers.get(0);return e?e.getAudioLevel():0}},{key:"getNetWorkScore",value:function(){var e=this.publishers.get(0);return e?e.networkScore:null}},{key:"getLocalStream",value:function(){var e=this.publishers.get(0);return e?Promise.resolve(e.getLocalStream()):Promise.reject("STREAM_HAS_NOT_BEEN_CREATED")}},{key:"changeDevice",value:function(e,t){var r=this;if(0===this.publishers.size)return Promise.reject("STREAM_HAS_NOT_BEEN_CREATED");var i=[];return"audio"===e?i.push(this.publishers.get(0).changeDevice(e,t)):(m.default.os.isAndroid&&"video"===e&&this.publishers.forEach(function(e){e.videoTrack&&e.videoTrack.stop()}),this.publishers.forEach(function(r){var n=r.changeDevice(e,t);i.push(n)})),Promise.all(i).then(function(){return"video"===e&&r.published&&r.webrtcMgr.streamSvr.startLive(),r.getLocalStream()})}},{key:"hasPublished",value:function(){return this.publishers.size>0&&this.published}},{key:"enableBeauty",value:function(e,t){if(0===this.publishers.size)return Promise.reject("STREAM_HAS_NOT_BEEN_CREATED");var r=[];return this.publishers.forEach(function(i){e?r.push(i.enableBeauty(t)):r.push(i.disableBeauty())}),Promise.all(r).then()}},{key:"operateTrack",value:function(e,t,r){if("video"===e.kind&&this.dualEnabled)return Promise.reject("NOT_SUPPORT_WITH_DUAL_STREAM");var i=this.publishers.get(0);if(!i)return Promise.reject("STREAM_NOT_EXISTED");switch(t){case"add":return i.addTrack(e);case"remove":return i.removeTrack(e);case"replace":return i.replaceTrack(e,r)}}},{key:"onVisibilityChange",value:function(e){var t=!0,r=!1,i=void 0;try{for(var n,a=this.publishers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;m.default.os.isIOS?o.onIOSVisibilityChange(e):m.default.os.isAndroid&&m.default.isWeChat&&o.onAndroidWeChatVisibilityChange(e)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}},{key:"size",get:function(){return this.publishers.size}}]),e}();r.default=g,t.exports=r.default},{"./constant":10,"./publisher":68,"./utils/browser":90,"./utils/logger":91,"./utils/utils":93}],70:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});r.VSSource="\nattribute vec4 aVertexPosition;\nattribute vec2 aTextureCoord;\nvarying highp vec2 vTextureCoord;\n\nvoid main(void) {\n  gl_Position = aVertexPosition;\n  vTextureCoord = aTextureCoord;\n}\n";r.FSSource="\nprecision lowp float;\nuniform sampler2D uSampler;\nvarying lowp vec2 vTextureCoord;\nuniform lowp float brightness;\nuniform lowp float smoothness;\n\nvoid main() {\n    vec3 centralColor;\n    float width = 1280.0;\n    float height = 720.0;\n\n    centralColor = texture2D(uSampler, vTextureCoord).rgb;\n\n    if(smoothness < 0.01) {\n        gl_FragColor = vec4(centralColor, 1.0);\n    } else {\n        float x_a = float(width);\n        float y_a = float(height);\n        float mul_x = 2.0 / x_a;\n        float mul_y = 2.0 / y_a;\n        vec2 blurCoordinates0 = vTextureCoord + vec2(0.0 * mul_x, -10.0 * mul_y);\n        vec2 blurCoordinates2 = vTextureCoord + vec2(8.0 * mul_x, -5.0 * mul_y);\n        vec2 blurCoordinates4 = vTextureCoord + vec2(8.0 * mul_x, 5.0 * mul_y);\n        vec2 blurCoordinates6 = vTextureCoord + vec2(0.0 * mul_x, 10.0 * mul_y);\n        vec2 blurCoordinates8 = vTextureCoord + vec2(-8.0 * mul_x, 5.0 * mul_y);\n        vec2 blurCoordinates10 = vTextureCoord + vec2(-8.0 * mul_x, -5.0 * mul_y);\n\n        mul_x = 1.8 / x_a;\n        mul_y = 1.8 / y_a;\n        vec2 blurCoordinates1 = vTextureCoord + vec2(5.0 * mul_x, -8.0 * mul_y);\n        vec2 blurCoordinates3 = vTextureCoord + vec2(10.0 * mul_x, 0.0 * mul_y);\n        vec2 blurCoordinates5 = vTextureCoord + vec2(5.0 * mul_x, 8.0 * mul_y);\n        vec2 blurCoordinates7 = vTextureCoord + vec2(-5.0 * mul_x, 8.0 * mul_y);\n        vec2 blurCoordinates9 = vTextureCoord + vec2(-10.0 * mul_x, 0.0 * mul_y);\n        vec2 blurCoordinates11 = vTextureCoord + vec2(-5.0 * mul_x, -8.0 * mul_y);\n\n        mul_x = 1.6 / x_a;\n        mul_y = 1.6 / y_a;\n        vec2 blurCoordinates12 = vTextureCoord + vec2(0.0 * mul_x,-6.0 * mul_y);\n        vec2 blurCoordinates14 = vTextureCoord + vec2(-6.0 * mul_x,0.0 * mul_y);\n        vec2 blurCoordinates16 = vTextureCoord + vec2(0.0 * mul_x,6.0 * mul_y);\n        vec2 blurCoordinates18 = vTextureCoord + vec2(6.0 * mul_x,0.0 * mul_y);\n\n        mul_x = 1.4 / x_a;\n        mul_y = 1.4 / y_a;\n        vec2 blurCoordinates13 = vTextureCoord + vec2(-4.0 * mul_x,-4.0 * mul_y);\n        vec2 blurCoordinates15 = vTextureCoord + vec2(-4.0 * mul_x,4.0 * mul_y);\n        vec2 blurCoordinates17 = vTextureCoord + vec2(4.0 * mul_x,4.0 * mul_y);\n        vec2 blurCoordinates19 = vTextureCoord + vec2(4.0 * mul_x,-4.0 * mul_y);\n\n        float central;\n        float gaussianWeightTotal;\n        float sum;\n        float sampler;\n        float distanceFromCentralColor;\n        float gaussianWeight;\n\n        float distanceNormalizationFactor = 3.6;\n\n        central = texture2D(uSampler, vTextureCoord).g;\n        gaussianWeightTotal = 0.2;\n        sum = central * 0.2;\n\n        sampler = texture2D(uSampler, blurCoordinates0).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates1).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates2).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates3).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates4).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates5).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates6).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates7).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates8).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates9).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates10).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates11).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.09 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates12).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates13).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates14).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates15).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates16).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates17).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates18).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sampler = texture2D(uSampler, blurCoordinates19).g;\n        distanceFromCentralColor = min(abs(central - sampler) * distanceNormalizationFactor, 1.0);\n        gaussianWeight = 0.1 * (1.0 - distanceFromCentralColor);\n        gaussianWeightTotal += gaussianWeight;\n        sum += sampler * gaussianWeight;\n\n        sum = sum/gaussianWeightTotal;\n\n        sampler = centralColor.g - sum + 0.5;\n\n        for(int i = 0; i < 5; ++i) {\n            if(sampler <= 0.5) {\n                sampler = sampler * sampler * 2.0;\n            } else {\n                sampler = 1.0 - ((1.0 - sampler)*(1.0 - sampler) * 2.0);\n            }\n        }\n\n        float aa = 1.0 + pow(sum, 0.3) * 0.09;\n        vec3 smoothColor = centralColor * aa - vec3(sampler) * (aa - 1.0);\n        smoothColor = clamp(smoothColor, vec3(0.0), vec3(1.0));\n\n        smoothColor = mix(centralColor, smoothColor, pow(centralColor.g, 0.33));\n        smoothColor = mix(centralColor, smoothColor, pow(centralColor.g, 0.39));\n\n        smoothColor = mix(centralColor, smoothColor, smoothness);\n        vec3 skinBlurColor = pow(smoothColor, vec3(0.96));\n        gl_FragColor = vec4(skinBlurColor * vec3(brightness), 1.0);\n    }\n }\n"},{}],71:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},u=e("events"),l=e("./protobase/ProtoLink"),h=i(l),c=e("./utils/timeUtil"),d=i(c),f=function(e){function t(e,r,i){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.logger=i,i.info("SocketIO.constructor",!0),this.wss=e,this.ts=1e3*r,this.link=new h.default(i,this),this.timer=null}return a(t,e),o(t,[{key:"destroy",value:function(){this.link.destroy(),this.link=null,this.timer&&window.clearTimeout(this.timer)}},{key:"onCheckTimer",value:function(e){this.onTimeOut(e)}},{key:"onTimeOut",value:function(e){if(e-this.lastRecvTick>23e3)return this.logger.warn("webrtc socket.io recvTick timeout:23000"),void this.onclose()}},{key:"connect",value:function(){this.logger.info("SocketIO.connect",!0),
this.lastRecvTick=d.default.now(),this.link.connect(this.wss),this.timer=setTimeout(this.timeout.bind(this),this.ts)}},{key:"send",value:function(e){this.link.send(e)}},{key:"onopen",value:function(){this.timer&&window.clearTimeout(this.timer),this.logger.info("SocketIO.onopen",!0),this.emit("open")}},{key:"onerror",value:function(e){this.logger.warn("SocketIO.onerror="+e),this.emit("error",e)}},{key:"onclose",value:function(){this.logger.warn("SocketIO.onclose"),this.emit("close")}},{key:"onData",value:function(e,t){this.lastRecvTick=d.default.now(),this.emit("message",e,t)}},{key:"timeout",value:function(){this.logger.warn("SocketIO.timeout timeout:"+this.ts),this.emit("timeout",this.ts),this.timer&&window.clearTimeout(this.timer),this.timer=null}},{key:"isConnected",value:function(){return!!this.link&&this.link.connected}}]),t}(u.EventEmitter);r.default=f,t.exports=r.default},{"./protobase/ProtoLink":18,"./utils/timeUtil":92,events:97}],72:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},s=e("../AdvanceConfig"),u=e("./QualityObserver"),l=function(e){return e&&e.__esModule?e:{default:e}}(u),h=48,c=function(e){function t(){i(this,t),o(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.kPauseThresholdSample=s.AdvanceConfig.audioPauseThresholdMs*h,this.kFreezeThresholdSample=s.AdvanceConfig.audioFreezeThresholdMs*h,this.configInfo=s.AdvanceConfig.audioFreezeThresholdMs+"-"+s.AdvanceConfig.audioPauseThresholdMs,this.trackIdentifier="",this.totalDurationSample=0,this.freezeSamples=0,this.pauseSamples=0,this.lastTotalSamples=0,this.lastConcealedSamples=0,this.lastSecondFreezeSamples=0,this.waitFirstAudio=!0,this.noAudioSamples=0,this.statUpdateTimeMs=0}return n(t,e),a(t,[{key:"update",value:function(e,t){if(!t||"string"!=typeof t.trackIdentifier||!Number.isInteger(t.totalSamplesReceived)||!Number.isInteger(t.concealedSamples))return void(this.configInfo="unsupported");if(this.trackIdentifier!==t.trackIdentifier&&(this.trackIdentifier=t.trackIdentifier,this.lastTotalSamples=0,this.lastConcealedSamples=0,0!==this.statUpdateTimeMs)){var r=(Date.now()-this.statUpdateTimeMs)*h;r>t.totalSamplesReceived&&(this.noAudioSamples+=r-t.totalSamplesReceived)}var i=t.totalSamplesReceived-this.lastTotalSamples,n=t.concealedSamples-this.lastConcealedSamples;this.lastTotalSamples=t.totalSamplesReceived,this.lastConcealedSamples=t.concealedSamples,e?(this.process(i,n),this.statUpdateTimeMs=Date.now()):(this.statUpdateTimeMs=0,this.waitFirstAudio=!0)}},{key:"process",value:function(e,t){var r=t<e;if(this.waitFirstAudio)return void(r&&(this.totalDurationSample+=e,this.waitFirstAudio=!1));r?(this.lastSecondFreezeSamples>0&&(this.addFreeze(this.lastSecondFreezeSamples),this.lastSecondFreezeSamples=0),this.noAudioSamples>0?(this.noAudioSamples+=t,this.noAudioSamples>=this.kPauseThresholdSample?this.addPause(this.noAudioSamples):this.addFreeze(this.noAudioSamples),this.noAudioSamples=0):t>=this.kFreezeThresholdSample&&(this.lastSecondFreezeSamples=t),this.totalDurationSample+=e):(this.noAudioSamples+=e,this.noAudioSamples+=this.lastSecondFreezeSamples,this.lastSecondFreezeSamples=0)}},{key:"addPause",value:function(e){this.pauseSamples+=e,this.pauseNum++}},{key:"addFreeze",value:function(e){this.freezeSamples+=e,this.freezeNum++}},{key:"totalDurationMs",get:function(){return Math.round(this.totalDurationSample/h)}},{key:"freezeDurationMs",get:function(){return Math.round(this.freezeSamples/h)}},{key:"pauseDurationMs",get:function(){return Math.round(this.pauseSamples/h)}}]),t}(l.default);r.AudioQualityObserver=c},{"../AdvanceConfig":1,"./QualityObserver":75}],73:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(t.jitterBufferDelay&&t.jitterBufferEmittedCount){var r=t.jitterBufferDelay-e.delay,i=t.jitterBufferEmittedCount-e.count;i&&(e.delayMs=Math.round(1e3*r/i)),e.delay=t.jitterBufferDelay,e.count=t.jitterBufferEmittedCount}}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../utils/logger"),u=i(s),l=e("./hiidoUtil"),h=i(l),c=e("../utils/timeUtil"),d=i(c),f=e("./MediaStatData"),p=i(f),v=function(){function e(t,r,i){n(this,e),this.logger=i,this.pc=null,this.data=new p.default,this.HOST=1===t?"https://hlog.hiido.com/c.gif?act=webrtcsdkmediastat":"https://mlog.hiido.com/c.gif?act=webrtcsdkmediastat",this.rtpmap=r,this.init()}return o(e,[{key:"init",value:function(){this.pc=null,this.audioJitterInfo={delay:0,count:0,delayMs:0},this.videoJitterInfo={delay:0,count:0,delayMs:0}}},{key:"updateByStatPerSec",value:function(e,t,r,i){this.data.publisherOrSubscriber=r;var n=0;if(n=0===this.data.time||d.default.utc()<=this.data.time?1:d.default.utc()-this.data.time,this.data.time=d.default.utc(),e.localCandidate.ip&&e.localCandidate.port&&(this.data.avpCandidate=e.localCandidate.ip+":"+e.localCandidate.port),e.remoteCandidate.ip&&e.remoteCandidate.port&&(this.data.sdkCandidate=e.remoteCandidate.ip+":"+e.remoteCandidate.port),this.data.dtlsState=e.dtlsState||"",this.data.rtt=e.currentRoundTripTime&&!isNaN(e.currentRoundTripTime)?1e3*e.currentRoundTripTime:"",t.data.rttPerSec+=(""===t.data.rttPerSec?"":"-")+String(this.data.rtt),t.data.rtt=this.data.rtt>t.data.rtt?this.data.rtt:t.data.rtt,e.video){this.data.qualityLimitationReason=e.video.qualityLimitationReason||"",this.data.videoCodec=e.video.codecId||"";var o=this.data.videoCodec.lastIndexOf("_");if(-1!==o){var s=this.data.videoCodec.substr(o+1);this.data.videoCodec=this.rtpmap.get(parseInt(s))}this.data.videoPacketBytes=(e.video.bytesSent||e.video.bytesReceived||0)-this.data.videoPacketBytes,this.data.videoPacketCount=(e.video.packetsSent||e.video.packetsReceived||0)-this.data.videoPacketCount,this.data.videoRetransmittedPacketsSent=(e.video.retransmittedPacketsSent||0)-this.data.videoRetransmittedPacketsSent,this.data.remoteVideoPacketLost=(e.remoteVideo.packetsLost||0)-this.data.remoteVideoPacketLost,this.data.videoPacketBytes<0||this.data.videoPacketCount<0?(this.data.videoPacketBytes=e.video.bytesSent||e.video.bytesReceived||0,this.data.videoRetransmittedPacketsSent=e.video.retransmittedPacketsSent||0,this.data.remoteVideoPacketLost=e.remoteVideo.packetsLost||0,this.data.videoPacketCount=e.video.packetsSent||e.video.packetsReceived||0,this.data.videoPacketLost=r?e.video.retransmittedPacketsSent||0:e.video.nackCount||0):(this.data.videoPacketLost=r?Math.max(this.data.videoRetransmittedPacketsSent,this.data.remoteVideoPacketLost):(e.video.nackCount||0)-this.data.videoPacketLost,this.data.videoBitRate=Math.round(8*this.data.videoPacketBytes/n/1e3),t.data.videoBitRatePerSec+=(""===t.data.videoBitRatePerSec?"":"-")+String(this.data.videoBitRate),this.data.videoPacketBytes=e.video.bytesSent||e.video.bytesReceived||0,this.data.videoPacketCount+this.data.videoPacketLost!==0?(this.data.videoLostRate=this.data.videoPacketLost>0?100*this.data.videoPacketLost/(this.data.videoPacketCount+this.data.videoPacketLost):0,this.data.videoLostRate=Math.round(this.data.videoLostRate),t.data.videoPacketLostPerSec+=(""===t.data.videoPacketLostPerSec?"":"-")+String(this.data.videoLostRate)):(this.data.videoLostRate="",t.data.videoPacketLostPerSec+=(""===t.data.videoPacketLostPerSec?"":"-")+String(this.data.videoLostRate)),this.data.videoRetransmittedPacketsSent=e.video.retransmittedPacketsSent||0,this.data.remoteVideoPacketLost=e.remoteVideo.packetsLost||0,this.data.videoPacketCount=e.video.packetsSent||e.video.packetsReceived||0,this.data.videoPacketLost=r?e.video.retransmittedPacketsSent||0:e.video.nackCount||0),e.videoTrack&&(this.data.resolution=e.videoTrack.frameWidth?e.videoTrack.frameWidth+"x"+e.videoTrack.frameHeight:"",this.data.videoFrameCount=(e.videoTrack.framesSent||e.videoTrack.framesReceived||0)-this.data.videoFrameCount,this.data.videoFrameCount<0?this.data.videoFrameCount=e.videoTrack.framesSent||e.videoTrack.framesReceived||0:(this.data.videoFrameRate=Math.round(this.data.videoFrameCount/n),t.data.videoFrameRatePerSec+=(""===t.data.videoFrameRatePerSec?"":"-")+String(this.data.videoFrameRate),this.data.videoFrameCount=e.videoTrack.framesSent||e.videoTrack.framesReceived||0))}if(e.audio){this.data.audioCodec=e.audio.codecId||"opus";var o=this.data.audioCodec.lastIndexOf("_");if(-1!==o){var s=this.data.audioCodec.substr(o+1);this.data.audioCodec=this.rtpmap.get(parseInt(s))}this.data.audioPacketBytes=(e.audio.bytesSent||e.audio.bytesReceived||0)-this.data.audioPacketBytes,this.data.audioPacketCount=(e.audio.packetsSent||e.audio.packetsReceived||0)-this.data.audioPacketCount,this.data.audioPacketLost=(r?e.audio.retransmittedPacketsSent||0:e.audio.packetsLost||0)-this.data.audioPacketLost,this.data.audioPacketBytes<0||this.data.audioPacketCount<0?(this.data.audioPacketBytes=e.audio.bytesSent||e.audio.bytesReceived||0,this.data.audioPacketCount=e.audio.packetsSent||e.audio.packetsReceived||0,this.data.audioPacketLost=r?e.audio.retransmittedPacketsSent||0:e.audio.packetsLost||0):(this.data.audioBitRate=Math.round(8*this.data.audioPacketBytes/n/1e3),t.data.audioBitRatePerSec+=(""===t.data.audioBitRatePerSec?"":"-")+String(this.data.audioBitRate),this.data.audioPacketBytes=e.audio.bytesSent||e.audio.bytesReceived||0,this.data.audioPacketCount+this.data.audioPacketLost!==0?(this.data.audioLostRate=this.data.audioPacketLost>0?100*this.data.audioPacketLost/(this.data.audioPacketCount+this.data.audioPacketLost):0,this.data.audioLostRate=Math.round(this.data.audioLostRate),t.data.audioPacketLostPerSec+=(""===t.data.audioPacketLostPerSec?"":"-")+String(this.data.audioLostRate)):(this.data.audioLostRate="",t.data.audioPacketLostPerSec+=(""===t.data.audioPacketLostPerSec?"":"-")+String(this.data.audioLostRate)),this.data.audioPacketCount=e.audio.packetsSent||e.audio.packetsReceived||0,this.data.audioPacketLost=r?e.audio.retransmittedPacketsSent||0:e.audio.packetsLost||0,this.data.volume=Math.round(i),t.data.audioLevelPerSec+=(""===t.data.audioLevelPerSec?"":"-")+String(this.data.volume))}if(e.audioTrack&&(a(this.audioJitterInfo,e.audioTrack),this.data.audioPlayoutDelay=this.audioJitterInfo.delayMs,this.data.audioPlayoutDelay)){var u=""===t.data.audioPlayoutDelayPerSec?"":"-";t.data.audioPlayoutDelayPerSec+=u+String(this.data.audioPlayoutDelay),t.data.audioPlayoutDelay=Math.max(t.data.audioPlayoutDelay,this.data.audioPlayoutDelay)}if(e.videoTrack&&(a(this.videoJitterInfo,e.videoTrack),this.data.videoPlayoutDelay=this.videoJitterInfo.delayMs,this.data.videoPlayoutDelay)){var u=""===t.data.videoPlayoutDelayPerSec?"":"-";t.data.videoPlayoutDelayPerSec+=u+String(this.data.videoPlayoutDelay),t.data.videoPlayoutDelay=Math.max(t.data.videoPlayoutDelay,this.data.videoPlayoutDelay)}this.data.networkScore=this.calNetworkScore(),this.data.iceConnectionState="",t.data.networkScorePerSec+=(""===t.data.networkScorePerSec?"":"-")+String(this.data.networkScore)}},{key:"setAndClearDataOfPerSec",value:function(e){e.data.videoFrameRatePerSec=this.data.videoFrameRatePerSec,e.data.videoBitRatePerSec=this.data.videoBitRatePerSec,e.data.videoPacketLostPerSec=this.data.videoPacketLostPerSec,e.data.audioLevelPerSec=this.data.audioLevelPerSec,e.data.audioBitRatePerSec=this.data.audioBitRatePerSec,e.data.audioPacketLostPerSec=this.data.audioPacketLostPerSec,e.data.networkScorePerSec=this.data.networkScorePerSec,e.data.rttPerSec=this.data.rttPerSec,e.data.audioPlayoutDelayPerSec=this.data.audioPlayoutDelayPerSec,e.data.videoPlayoutDelayPerSec=this.data.videoPlayoutDelayPerSec,this.data.videoFrameRatePerSec="",this.data.videoBitRatePerSec="",this.data.videoPacketLostPerSec="",this.data.audioLevelPerSec="",this.data.audioBitRatePerSec="",this.data.audioPacketLostPerSec="",this.data.networkScorePerSec="",this.data.rttPerSec="",this.data.audioPlayoutDelayPerSec="",this.data.videoPlayoutDelayPerSec=""}},{key:"updateByStat",value:function(e,t){var r=0;0!==t.data.time&&(r=d.default.utc()-t.data.time),this.data.time=d.default.utc(),t.data.time=this.data.time,e.localCandidate.ip&&e.localCandidate.port&&(this.data.avpCandidate=e.localCandidate.ip+":"+e.localCandidate.port),e.remoteCandidate.ip&&e.remoteCandidate.port&&(this.data.sdkCandidate=e.remoteCandidate.ip+":"+e.remoteCandidate.port),this.data.dtlsState=e.dtlsState||"",this.data.rtt=e.currentRoundTripTime&&!isNaN(e.currentRoundTripTime)?1e3*e.currentRoundTripTime:"",this.data.rtt=t.data.rtt>this.data.rtt?t.data.rtt:this.data.rtt,t.data.rtt=0,e.video&&(this.data.videoCodec=(e.video.codecId||"")+"_"+(e.video.encoderImplementation||e.video.decoderImplementation||""),this.data.qualityLimitationReason=e.video.qualityLimitationReason||"",this.data.videoPacketCount=e.video.packetsSent||e.video.packetsReceived||0,this.data.videoPacketCount-=t.data.videoPacketCount,this.data.videoPacketCount=Math.max(0,this.data.videoPacketCount),t.data.videoPacketCount=e.video.packetsSent||e.video.packetsReceived||0,this.data.videoPacketBytes=e.video.bytesSent||e.video.bytesReceived||0,this.data.videoPacketBytes-=t.data.videoPacketBytes,this.data.videoPacketBytes=Math.max(0,this.data.videoPacketBytes),t.data.videoPacketBytes=e.video.bytesSent||e.video.bytesReceived||0,this.data.videoNacksReceived=e.video.nackCount||0,this.data.videoNacksReceived-=t.data.videoNacksReceived,this.data.videoNacksReceived=Math.max(0,this.data.videoNacksReceived),t.data.videoNacksReceived=e.video.nackCount||0,this.data.videoPlisReceived=e.video.pliCount||0,this.data.videoPlisReceived-=t.data.videoPlisReceived,this.data.videoPlisReceived=Math.max(0,this.data.videoPlisReceived),t.data.videoPlisReceived=e.video.pliCount||0,this.data.videoFrameCodec=e.video.framesEncoded||e.video.framesDecoded||0,this.data.videoFrameCodec-=t.data.videoFrameCodec,this.data.videoFrameCodec=Math.max(0,this.data.videoFrameCodec),t.data.videoFrameCodec=e.video.framesEncoded||e.video.framesDecoded||0,r>0&&(this.data.videoBitRate=Math.round(8*this.data.videoPacketBytes/r/1e3)),this.data.publisherOrSubscriber?(this.data.videoRetransmittedPacketsSent=e.video.retransmittedPacketsSent||0,this.data.videoRetransmittedPacketsSent-=t.data.videoRetransmittedPacketsSent,this.data.videoRetransmittedPacketsSent=Math.max(0,this.data.videoRetransmittedPacketsSent),t.data.videoRetransmittedPacketsSent=e.video.retransmittedPacketsSent||0,this.data.remoteVideoPacketLost=e.remoteVideo.packetsLost||0,this.data.remoteVideoPacketLost-=t.data.remoteVideoPacketLost,this.data.remoteVideoPacketLost=Math.max(0,this.data.remoteVideoPacketLost),t.data.remoteVideoPacketLost=e.remoteVideo.packetsLost||0,this.data.videoPacketLost=Math.max(this.data.videoRetransmittedPacketsSent,this.data.remoteVideoPacketLost)):(this.data.videoPacketLost=e.video.nackCount||0,this.data.videoPacketLost-=t.data.videoPacketLost,this.data.videoPacketLost=Math.max(0,this.data.videoPacketLost),t.data.videoPacketLost=e.video.nackCount||0),this.data.videoPacketCount+this.data.videoPacketLost!==0&&(this.data.videoLostRate=this.data.videoPacketLost>0?100*this.data.videoPacketLost/(this.data.videoPacketCount+this.data.videoPacketLost):0,this.data.videoLostRate=Math.round(this.data.videoLostRate)),e.videoTrack&&(this.data.resolution=e.videoTrack.frameWidth?e.videoTrack.frameWidth+"x"+e.videoTrack.frameHeight:"",this.data.videoFrameCount=e.videoTrack.framesSent||e.videoTrack.framesReceived||0,this.data.videoFrameCount-=t.data.videoFrameCount,this.data.videoFrameCount=Math.max(0,this.data.videoFrameCount),t.data.videoFrameCount=e.videoTrack.framesSent||e.videoTrack.framesReceived||0,r>0&&(this.data.videoFrameRate=Math.round(this.data.videoFrameCount/r)),this.data.videoFrameDrop=this.data.videoFrameCount-this.data.videoFrameCodec,this.data.videoFrameDrop=this.data.videoFrameDrop<0?0:this.data.videoFrameDrop,this.data.hugeFramesSent=e.videoTrack.hugeFramesSent||0,this.data.hugeFramesSent-=t.data.hugeFramesSent,this.data.hugeFramesSent=Math.max(0,this.data.hugeFramesSent),t.data.hugeFramesSent=e.videoTrack.hugeFramesSent||0)),e.audio&&(this.data.audioCodec=e.audio.codecId||"",this.data.audioPacketCount=e.audio.packetsSent||e.audio.packetsReceived||0,this.data.audioPacketCount-=t.data.audioPacketCount,this.data.audioPacketCount=Math.max(0,this.data.audioPacketCount),t.data.audioPacketCount=e.audio.packetsSent||e.audio.packetsReceived||0,this.data.audioPacketBytes=e.audio.bytesSent||e.audio.bytesReceived||0,this.data.audioPacketBytes-=t.data.audioPacketBytes,this.data.audioPacketBytes=Math.max(0,this.data.audioPacketBytes),t.data.audioPacketBytes=e.audio.bytesSent||e.audio.bytesReceived||0,r>0&&(this.data.audioBitRate=Math.round(8*this.data.audioPacketBytes/r/1e3)),this.data.publisherOrSubscriber?(this.data.audioPacketLost=e.audio.retransmittedPacketsSent||0,this.data.audioPacketLost-=t.data.audioPacketLost,this.data.audioPacketLost=Math.max(0,this.data.audioPacketLost),t.data.audioPacketLost=e.audio.retransmittedPacketsSent||0):(this.data.audioPacketLost=e.audio.packetsLost||0,this.data.audioPacketLost-=t.data.audioPacketLost,this.data.audioPacketLost=Math.max(0,this.data.audioPacketLost),t.data.audioPacketLost=e.audio.packetsLost||0),this.data.audioPacketCount+this.data.audioPacketLost!==0&&(this.data.audioLostRate=this.data.audioPacketLost>0?100*this.data.audioPacketLost/(this.data.audioPacketCount+this.data.audioPacketLost):0,this.data.audioLostRate=Math.round(this.data.audioLostRate))),this.data.networkScore=this.calNetworkScore(),this.data.audioPlayoutDelay=t.data.audioPlayoutDelay,this.data.videoPlayoutDelay=t.data.videoPlayoutDelay,t.data.audioPlayoutDelay=0,t.data.videoPlayoutDelay=0,t.setAndClearDataOfPerSec(this)}},{key:"isIceDisconnected",value:function(){return this.data.iceConnectionState.includes("disconnected")||this.data.iceConnectionState.includes("failed")||this.data.iceConnectionState.includes("closed")}},{key:"calNetworkScore",value:function(){var e=0,t=0,r=0;if("closed"===this.data.dtlsState||"failed"===this.data.dtlsState||this.isIceDisconnected())return r=6;if(""!==this.data.videoStreamName&&""!==this.data.videoCodec){if(""!==this.data.rtt&&(this.data.rtt<=50&&(e=1),this.data.rtt>50&&this.data.rtt<=100?e=2:this.data.rtt>100&&this.data.rtt<=200?e=3:this.data.rtt>200&&this.data.rtt<=300?e=4:this.data.rtt>300&&(e=5)),""===this.data.videoLostRate)return r=0;0===this.data.videoLostRate&&(t=1),this.data.videoLostRate>0&&this.data.videoLostRate<=10?t=2:this.data.videoLostRate>10&&this.data.videoLostRate<=20?t=3:this.data.videoLostRate>20&&this.data.videoLostRate<=30?t=4:this.data.videoLostRate>30&&(t=5),r=Math.max(e,t)}else if(""!==this.data.audioStreamName&&""!==this.data.audioCodec){if(""!==this.data.rtt&&(this.data.rtt<=50&&(e=1),this.data.rtt>50&&this.data.rtt<=100?e=2:this.data.rtt>100&&this.data.rtt<=200?e=3:this.data.rtt>200&&this.data.rtt<=300?e=4:this.data.rtt>300&&(e=5)),""===this.data.audioLostRate)return r=0;0===this.data.audioLostRate&&(t=1),this.data.audioLostRate>0&&this.data.audioLostRate<=10?this.data.audioLostRate<=1?t=2:this.data.audioLostRate<=3?t=this.data.publisherOrSubscriber?2:3:this.data.audioLostRate<=5?t=this.data.publisherOrSubscriber?2:4:this.data.audioLostRate>5&&(t=this.data.publisherOrSubscriber?2:5):this.data.audioLostRate>10&&this.data.audioLostRate<=20?t=this.data.publisherOrSubscriber?3:5:this.data.audioLostRate>20&&this.data.audioLostRate<=30?t=this.data.publisherOrSubscriber?4:5:this.data.audioLostRate>30&&(this.data.publisherOrSubscriber,t=5),r=Math.max(e,t)}return u.default.debug("calNetworkScore, [videoLostRate:"+this.data.videoLostRate+", audioLostRate:"+this.data.audioLostRate+", score2:"+t+"], [rtt:"+this.data.rtt+", score1:"+e+"], finalScore:"+r),r}},{key:"send",value:function(){h.default.sendData(this.data,this.HOST,this.logger)}}],[{key:"validStat",value:function(e,t){return null===t.pc?(t.pc=e,!0):t.pc===e}}]),e}();r.default=v,t.exports=r.default},{"../utils/logger":91,"../utils/timeUtil":92,"./MediaStatData":74,"./hiidoUtil":78}],74:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function e(){i(this,e),this.time=0,this.appid=0,this.videoStreamName="",this.audioStreamName="",this.groupStreamName="",this.uid=0,this.uidStr="",this.subscriberNum=0,this.publishVideoStreamId="",this.publishAudioStreamId="",this.publisherOrSubscriber=1,this.subscriber_uuid="",this.videoCodec="",this.qualityLimitationReason="",this.videoPacketCount=0,this.videoPacketBytes=0,this.videoNacksReceived=0,this.videoPlisReceived=0,this.videoFrameCodec=0,this.videoPacketLost=0,this.videoLostRate="",this.resolution="",this.videoFrameCount=0,this.videoFrameDrop=0,this.hugeFramesSent=0,this.audioCodec="",this.audioPacketCount=0,this.audioPacketBytes=0,this.audioPacketLost=0,this.audioLostRate="",this.avpCandidate="",this.sdkCandidate="",this.dtlsState="",this.rtt="",this.signalingState="",this.iceConnectionState="",this.connectionState="",this.events="",this.startTime=0,this.tokenAuthResult="",this.channelId="",this.sdkVersion="",this.browserType="",this.videoMode="",this.networkScore=0,this.volume=0,this.connectCount=0,this.publishResetCount="",this.subscribeResetCount="",this.userAgent="",this.layer="",this.videoFrameRate=0,this.videoBitRate=0,this.audioBitRate=0,this.videoFrameRatePerSec="",this.videoBitRatePerSec="",this.videoPacketLostPerSec="",this.audioLevelPerSec="",this.audioBitRatePerSec="",this.audioPacketLostPerSec="",this.networkScorePerSec="",this.rttPerSec="",this.videoRetransmittedPacketsSent=0,this.remoteVideoPacketLost=0,this.audioPlayoutDelayPerSec="",this.videoPlayoutDelayPerSec="",this.audioPlayoutDelay=0,this.videoPlayoutDelay=0,this.position="",this.kernelType="",this.audioFreezeDuration=0,this.audioPauseDuration=0,this.audioDuration=0,this.audioFreezeConfig="",this.videoFreezeDuration=0,this.videoPauseDuration=0,this.videoDuration=0,this.videoFreezeConfig="",this.deviceModel="",this.networkType=""};r.default=n,t.exports=r.default},{}],75:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.absolute=0}return n(e,[{key:"update",value:function(e){var t=e-this.absolute;return this.absolute=e,t}}]),e}(),o=function(){function e(){i(this,e),this.periodTotalDurationMs=new a,this.periodFreezeDurationMs=new a,this.periodFreezeNum=new a,this.periodPauseDurationMs=new a,this.periodPauseNum=new a,this.freezeNum=0,this.pauseNum=0}return n(e,[{key:"getPeriodTotalDurationMs",value:function(){return this.periodTotalDurationMs.update(this.totalDurationMs)}},{key:"getPeriodFreezeDurationMs",value:function(){return this.periodFreezeDurationMs.update(this.freezeDurationMs)}},{key:"getPeriodFreezeNum",value:function(){return this.periodFreezeNum.update(this.freezeNum)}},{key:"getPeriodPauseDurationMs",value:function(){return this.periodPauseDurationMs.update(this.pauseDurationMs)}},{key:"getPeriodPauseNum",value:function(){return this.periodPauseNum.update(this.pauseNum)}},{key:"freezePercent",get:function(){return this.freezeDurationMs>0&&this.totalDurationMs>0?Math.round(100*this.freezeDurationMs/this.totalDurationMs):0}}]),e}();r.default=o,t.exports=r.default},{}],76:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=e("./hiidoUtil"),s=i(o),u=e("../utils/timeUtil"),l=i(u),h=function(){function e(t,r,i,a,o,s){n(this,e),this.name=t,this.ts=r,this.val=i,this.lval=a,this.level=o,this.oval=s}return a(e,[{key:"toString",value:function(){var e="",t="";for(var r in this)Object.prototype.hasOwnProperty.call(this,r)&&(e+=t+this[r],t="|");return e}}]),e}(),c=function(){var e=function(){function e(t,r){n(this,e),this.logger=r,this.host=1===t?"https://hlog.hiido.com/c.gif?act=sdkuidevent":"https://mlog.hiido.com/c.gif?act=sdkuidevent",this.lastSendTime=0,this.eventSet=new Set,this.record={appid:0,scid:"",cn:"",uid:0,euid:"",data:""},this.hasSetUserInfo=!1}return a(e,[{key:"destroy",value:function(){0!==this.eventSet.size&&this.sendUserEvent(),this.hasSetUserInfo=!1}},{key:"onCheckTimer",value:function(){var t=l.default.utc();0===this.lastSendTime&&(this.lastSendTime=t),0!==this.eventSet.size&&(t-this.lastSendTime>=e.REPORT_INTERVAL||this.eventSet.size>=e.MAX_EVENT_NUM)&&(this.sendUserEvent(),this.lastSendTime=t)}},{key:"setUserInfo",value:function(e){this.record.appid=e.appid,this.record.cn=e.cn,this.record.euid=e.euid,this.record.scid=e.scid,this.record.uid=e.uid,this.hasSetUserInfo=!0}},{key:"setHostByUserArea",value:function(e){this.host=1===e?"https://hlog.hiido.com/c.gif?act=sdkuidevent":"https://mlog.hiido.com/c.gif?act=sdkuidevent"}},{key:"addEvent",value:function(e,t,r){var i=arguments.length<=3||void 0===arguments[3]?"":arguments[3],n=arguments.length<=4||void 0===arguments[4]?"":arguments[4],a=Date.now(),o=new h(t,a,r,n,e,i);this.eventSet.add(o),this.logger.debug("addEvent, name:"+t+", val:"+r+", oval:"+i)}},{key:"setEventToRecord",value:function(){this.record.data="";var e="",t=!0,r=!1,i=void 0;try{for(var n,a=this.eventSet[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;this.record.data+=e+o.toString(),e=";"}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}this.eventSet.clear()}},{key:"sendUserEvent",value:function(){this.setEventToRecord(),s.default.sendData(this.record,this.host,this.logger)}}]),e}();return e.MAX_EVENT_NUM=40,e.REPORT_INTERVAL=10,e}();r.default=c,t.exports=r.default},{"../utils/timeUtil":92,"./hiidoUtil":78}],77:[function(e,t,r){"use strict";function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("../AdvanceConfig"),u=e("./QualityObserver"),l=function(e){return e&&e.__esModule?e:{default:e}}(u),h=function(){function e(){n(this,e),this.history=[],this.sum=0}return o(e,[{key:"updateFrameRate",value:function(e){if(!(e<=0))for(this.history.push(e),this.sum+=e;this.sum-this.history[0]>=30;)this.sum-=this.history[0],this.history.shift()}},{key:"value",get:function(){return this.history.length&&this.sum>5?Math.round(1e3*this.history.length/this.sum):0}}]),e}();r.AvgInterframeDelayCalculator=h;var c=function(e){function t(){n(this,t),a(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.running=!1,this.isPaused=!1,this.visible="visible"===document.visibilityState,this.avgInterframeDelay=new h,this.noFrameMs=0,this.waitFirstFrame=!0,this.firstFrameRenderedMs=0,this.lastFrameRenderedMs=0,this.lastFrameVisible=this.visible,this.freezeDurationMs=0,this.pauseDurationMs=0,this.historyFramesDurationMs=0}return i(t,e),o(t,[{key:"destroy",value:function(){this.timer&&(clearInterval(this.timer),this.timer=void 0),this.player=void 0,this.media=void 0}},{key:"isCheckValid",value:function(){return this.visible&&this.lastFrameVisible}},{key:"onVideoStop",value:function(){this.historyFramesDurationMs+=this.framesDurationMs,this.lastFrameRenderedMs=0,this.firstFrameRenderedMs=0,this.isPaused=!1,this.running=!1,this.waitFirstFrame=!0}},{key:"onMediaChange",value:function(){this.historyFramesDurationMs+=this.framesDurationMs,this.waitFirstFrame?(this.noFrameMs=0,this.isPaused=!1):(this.lastFrameRenderedMs=-this.noFrameMs,this.firstFrameRenderedMs=-this.noFrameMs)}},{key:"onRenderedFrame",value:function(e){if(e!==this.lastFrameRenderedMs&&0!==e){if(this.noFrameMs=0,e<this.lastFrameRenderedMs)return this.historyFramesDurationMs+=this.lastFrameRenderedMs-this.firstFrameRenderedMs,this.firstFrameRenderedMs=e,this.lastFrameRenderedMs=e,void(this.lastFrameVisible=this.visible);if(this.waitFirstFrame)return this.waitFirstFrame=!1,this.firstFrameRenderedMs=e,this.lastFrameRenderedMs=e,void(this.lastFrameVisible=this.visible);var t=e-this.lastFrameRenderedMs;if(this.isPaused)this.isPaused=!1,this.isCheckValid()&&(this.pauseDurationMs+=t,this.pauseNum++);else{var r=!1,i=this.avgInterframeDelay.value;i&&(r=t>Math.max(3*i,i+150)),r&&this.isCheckValid()&&(this.freezeDurationMs+=t,this.freezeNum++)}this.lastFrameRenderedMs=e,this.lastFrameVisible=this.visible}}},{key:"updatePlayer",value:function(e){this.player=e,this.timer||(this.timer=window.setInterval(this.onTimer.bind(this),s.AdvanceConfig.videoCheckIntervalMs))}},{key:"onTimer",value:function(){if(this.running){if(!this.player||!this.player.hasVideo)return void this.onVideoStop();this.player.media&&this.player.media!==this.media&&(this.media=this.player.media,this.onMediaChange())}else this.running||this.player&&this.player.hasVideo&&this.player.media&&(this.media=this.player.media,this.running=!0);this.running&&(this.noFrameMs+=s.AdvanceConfig.videoCheckIntervalMs,this.noFrameMs>=s.AdvanceConfig.videoPauseThresholdMs&&(this.isPaused=!0),this.onRenderedFrame(Math.round(1e3*this.media.currentTime)))}},{key:"framesDurationMs",get:function(){return this.lastFrameRenderedMs-this.firstFrameRenderedMs}},{key:"totalDurationMs",get:function(){return this.historyFramesDurationMs+this.framesDurationMs}},{key:"freezeThreshold",get:function(){var e=this.avgInterframeDelay.value;return e?Math.max(3*e,e+150):0}}]),t}(l.default);r.VideoQualityObserver=c},{"../AdvanceConfig":1,"./QualityObserver":75}],78:[function(e,t,r){
"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e){return o[e]?o[e]:e}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o={audioPlayoutDelayPerSec:"aDlyPS",videoPlayoutDelayPerSec:"vDlyPs",audioPlayoutDelay:"aDlyM",videoPlayoutDelay:"vDlyM",position:"pos",kernelType:"ker",audioFreezeDuration:"aFrz",audioPauseDuration:"aPDur",audioDuration:"aDur",audioFreezeConfig:"aFrzCfg",videoFreezeDuration:"vFrz",videoPauseDuration:"vPDur",videoDuration:"vDur",videoFreezeConfig:"vFrzCfg",deviceModel:"dm",networkType:"nt"},s=function(){var e=function(){function e(){i(this,e)}return a(e,null,[{key:"sendData",value:function(t,r,i){if(!t||!r)return i.error("HiidoUtil.SendData error, check your params"),!1;var n=e.genUrl(r,t);return i.debug("HiidoUtil.SendData url:"+n,!0),e.urlSet.push(n),e.timer||(e.timer=setInterval(function(){e.sendUrl(e.urlSet.pop())},200)),!0}},{key:"genUrl",value:function(e,t){var r=e;for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&"function"!=typeof t[i]&&""!==t[i]&&(r+="&"+n(i)+"="+t[i]);return r}},{key:"sendUrl",value:function(t){t?(e.imgSendUrl.src=t,e.imgSendUrl.crossOrigin="anonymous"):(clearInterval(e.timer),e.timer=null)}}]),e}();return e.urlSet=[],e.imgSendUrl=new Image,e.timer=null,e}();r.default=s,t.exports=r.default},{}],79:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e){e.dur>0?e.per=Math.ceil(100*(e.frz+e.pause)/e.dur):e.per=0}Object.defineProperty(r,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},l=e("./protobase/ProtoUInt64"),h=i(l),c=e("./utils/utils"),d=i(c),f=e("./protocol/PWebRTCLayer"),p=i(f),v=e("./UserStream"),m=i(v),g=e("./utils/FirstFrameDetector"),y=i(g),S=e("./utils/logger"),b=e("./protocol/PLiveSubscribe"),_=i(b),E=e("./protobase/MetaDataInfo"),T=i(E),I=function(e){function t(e,r,i,a,o,s){n(this,t),u(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,!0,a,r,s),this.needVideo=!1,this.needAudio=!1,this.dualStream=[],this.remoteStreamInfos=[],this.lastRemoteStreamInfos=[],this.subscribeResolve=null,this.subscribeReject=null,this.firstFrameDetector=new y.default,this.needSwitchToHigh=!1,this.labelPrefix="["+i.high+"]",this.label="["+i.high+"]Subscriber",this.info("constructor"),this.appid=e,this.pubUuid=e.toString()+"_"+i.high.toString(),this.pubUid=i.high,this.pubUidStr=r,this.externalUid=r,this.hasUidStr=o,this.streamId=i,this.checkStreamExpireInterval=16e3,this.videoStreamId=new h.default(0,0),this.audioStreamId=new h.default(0,0),this.stream=new MediaStream}return a(t,e),s(t,[{key:"destroy",value:function(){this.webrtcMgr.subscriberMgr.deleteSubscriber(this.pubUuid),this.webrtcMgr.webrtc.trigger("remote_stream_remove",this.getRemoteStream()),this.unsubscribe(),u(Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"subscribe",value:function(e){var t=this;return new Promise(function(r,i){var n=!!e&&e.lowStream,a=t.getLowStreamIndex();if(n){if(!1===e.video)return void i("LOW_STREAM_MUST_HAVE_VIDEO");if(0===a)return void i("LOW_STREAM_NOT_EXISTED");if(t.subscribed)return void i("LOW_STREAM_CAN_NOT_SET_WHEN_HAS_SUBSCRIBED")}if(!t.checkSubscribeValid(e))return void i("INVALID_SUBSCRIBE");if(t.needAudio=!e||e.audio,t.needVideo=!e||e.video,t.info("subscribe uid: "+t.pubUidStr+", audio: "+t.needAudio+", video: "+t.needVideo),t.needVideo){var o=t.remoteStreamInfos.filter(function(e){return"video"===e.streamType})[0];if(o&&"H265"===o.streamParam.codec)return void i("REMOTE_USER_PUBLISH_H265");if(t.subscribed&&o&&!t.supportedVideoCodecs.includes(o.streamParam.codec))return t.needVideo=!1,void i("VIDEO_CODEC_UNSUPPORTED")}if(!t.updateLocalStreamInfos())return void i("INVALID_SUBSCRIBE");n&&(t.layer=a,t.updateStreamKey(t.getStreamKeybyLayer(t.layer),"video")),t.resetFirstFrameDetector(),t.clearSubscribePromise("CANCEL"),t.subscribeResolve=r,t.subscribeReject=i,t.checkStreamSubscribed(),t.connect().catch(function(e){t.subscribeResolve=null,t.subscribeReject=null,t.unsubscribe(),i(e)})})}},{key:"unsubscribe",value:function(){return this.subscribed?(this.stopPlay(),this.needAudio=!1,this.needVideo=!1,this.updateLocalStreamInfos(),this.clearSubscribePromise("CANCEL"),this.disconnect(),this.layer=0,null):{error:"HAS_NOT_SUBSCRIBE"}}},{key:"onCheckTimer",value:function(e,t,r){if(this.pc){this.debug("onCheckTimer, pubUuid:"+this.pubUuid+" pc status signalingState:"+this.pc.signalingState+" iceConnectionState:"+this.pc.iceConnectionState+" connectionState:"+this.pc.connectionState),this.checkIceConnState(e);var i=this.getAudioLevel();this.updateMediaStatPerSec(i),this.webrtcMgr.audioLevelReporter.set(this.pubUidStr,i),t%20==0&&(this.logQualityInfo(),this.reportMediaStat())}this.checkRemoteStreamInfoExpire()}},{key:"checkSubscribeValid",value:function(e){var t=!e||e.audio,r=!e||e.video,i=!0,n=!1,a=void 0;try{for(var o,s=this.remoteStreamInfos[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var u=o.value;if("audio"===u.streamType||"group"===u.streamType){if(t)return!0}else if("video"===u.streamType&&r)return!0}}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return!1}},{key:"checkRemoteStreamInfoExpire",value:function(){if(0!==this.webrtcMgr.mode){var e=Date.now(),t=this.remoteStreamInfos[0].timestamp;e-t>this.checkStreamExpireInterval&&(this.warn("stream broadcast missing over "+this.checkStreamExpireInterval+" ms, query first, streamInfo:"+JSON.stringify(this.remoteStreamInfos)),this.checkStreamExpireInterval+=16e3,this.webrtcMgr.streamSvr.queryChannel(this.channelId)),e-t>4e4&&(this.warn("checkSubStreamInfoExpire remoteStreamInfo expire now:"+Date.now().toString()+" streamInfo:"+JSON.stringify(this.remoteStreamInfos)),this.destroy())}}},{key:"getStreamKeybyLayer",value:function(e){if(0===e){var t=!0,r=!1,i=void 0;try{for(var n,a=this.remoteStreamInfos[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;if("video"===o.streamType)return o.appid+"_"+o.streamName}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return""}for(var s=0;s<this.dualStream.length;s++)if(this.dualStream[s].layerIndex&&Number(this.dualStream[s].layerIndex)===e)return this.appid+"_"+this.dualStream[s].streamName;return""}},{key:"updateStreamKey",value:function(e,t){this.info("updateStreamKey() streamType: "+t+", key: "+e),"audio"===t?this.audioStreamKey=e:"video"===t?this.videoStreamKey=e:"group"===t&&(this.groupKey=e)}},{key:"updateStreamId",value:function(e,t){return e===this.audioStreamKey?this.audioStreamId=t:e===this.videoStreamKey?this.videoStreamId=t:e===this.groupKey&&(this.streamId=t),!1}},{key:"ontrack",value:function(e,t){if(t!=this.pc)return void this.info("ontrack stream pc is expired");this.stream.addTrack(e.track),this.stream.getTracks().length<2||(this.updateMediaStreamEnableState(),this.streamKeeper.keep(this.stream),this.audioMeter.updateStream(this.stream),this.checkStreamSubscribed())}},{key:"checkStreamSubscribed",value:function(){if(this.isConnected()&&(void 0!==this.audioTrack||void 0!==this.videoTrack)&&this.subscribeResolve){var e=this.getRemoteStream();this.hasAudio||delete e.audio,this.hasVideo||delete e.video,this.info("remote stream subscribed "+JSON.stringify(e)),this.webrtcMgr.webrtc.trigger("remote_stream_subscribed",e),this.subscribeResolve(e),this.clearSubscribePromise()}}},{key:"onremovestream",value:function(){this.warn("onremovestream stream pc need reset"),this.resetIceConnState("onremovestream")}},{key:"onWebRTCAnswer",value:function(e){this.setRemoteDescription(e).catch(function(){})}},{key:"setRemoteVideoLayer",value:function(e){var t=this;if(this.info("set video layer "+e),!1===this.subscribed)return Promise.reject("NO_SUBSCRIBE");if(e===this.layer||this.resendPWebRTCLayer&&e===this.resendPWebRTCLayer.layer)return this.info("same target stream currentLayer:"+this.layer+" targetLayer:"+e),Promise.reject("SAME_TARGET_STREAM");for(var r=!1,i=0;i<this.dualStream.length;i++)this.dualStream[i].layerIndex&&this.dualStream[i].layerIndex===e&&(r=!0);return 0==e&&(r=!0),!1===r?(this.info("set video layer:"+e+" fail"),Promise.reject("STREAM_NOT_EXISTED")):((this.setLayerResolve||this.setLayerReject)&&this.clearLayerPromise("CANCEL"),this.resendPWebRTCLayer=new p.default,this.resendPWebRTCLayer.appid=this.webrtcMgr.appid,this.resendPWebRTCLayer.uid=this.webrtcMgr.uid,this.resendPWebRTCLayer.pubUid=this.pubUid,this.resendPWebRTCLayer.layer=e,this.resendPWebRTCLayer.seqNum=this.webrtcMgr.globalSeqNum++,this.webrtcMgr.send(this.resendPWebRTCLayer.marshall()),this.info("send layer request to server, layer:"+e+", seqNum:"+this.resendPWebRTCLayer.seqNum,!0),this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_INFO,"room","aud_big_small_stream_[o]",this.pubUidStr+"_"+e),new Promise(function(e,r){t.setLayerResolve=e,t.setLayerReject=r}))}},{key:"updateRemoteStreamInfos",value:function(e){if(this.debug("updateChannelStreams "+JSON.stringify(e)),this.remoteStreamInfos[0]&&this.remoteStreamInfos[0].channelId!==e[0].channelId)return void this.warn("subscriber ignore stream info with different channel "+e[0].channelId);var t=this.isStreamParamUpdate(this.remoteStreamInfos,e);if(this.lastRemoteStreamInfos=this.remoteStreamInfos,this.remoteStreamInfos=e,0===this.lastRemoteStreamInfos.length){var r=this.getRemoteStream();this.info("remote_stream_add: "+JSON.stringify(r)),this.webrtcMgr.webrtc.trigger("remote_stream_add",r)}else t&&(this.info("stream param update "+JSON.stringify(this.remoteStreamInfos)),this.webrtcMgr.webrtc.trigger("remote_stream_update",this.getRemoteStream()));this.updateCodec(),this.subscribed&&t&&this.updateLocalStreamInfos(),this.needSwitchToHigh&&(this.needSwitchToHigh=!1,this.info("remote dual stream disable, set video layer to 0"),this.setRemoteVideoLayer(0),this.layer=0,this.updateStreamKey(this.getStreamKeybyLayer(this.layer),"video"),this.webrtcMgr.webrtc.trigger("auto_switch_to_high_video",this.getRemoteStream()))}},{key:"checkResolutionChange",value:function(e,t){t.width&&t.height&&(t.width===e.width&&t.height===e.height||(this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_WARN,"room","aud_change_relation:[o]",t.width+"*"+t.height),this.addUserEvents("streamParamChange")))}},{key:"isStreamParamUpdate",value:function(e,t){for(var r=this,i=["audio","video"],n=0;n<i.length;n++){var a=function(){var a=i[n],o=e.filter(function(e){return e.streamType===a})[0],s=t.filter(function(e){return e.streamType===a})[0];if(o&&s){var u=o.version,l=s.version;if(u&&l&&u.lower(l)&&!1===d.default.objectEquals(o.streamParam,s.streamParam))return r.checkResolutionChange(o.streamParam,s.streamParam),{v:!0};if("video"===a&&r.isDualStreamParamChange(o,s))return{v:!0}}return o&&!s?{v:!0}:!o&&s?{v:!0}:void 0}();if("object"==typeof a)return a.v}return!1}},{key:"isSameLayerOrTargetLayer",value:function(e){return this.layer===e||this.resendPWebRTCLayer&&this.resendPWebRTCLayer.layer===e}},{key:"isDualStreamParamChange",value:function(e,t){return this.getLowStreamLength(e)!==this.getLowStreamLength(t)?(this.isSameLayerOrTargetLayer(1)&&0===this.getLowStreamLength(t)&&(this.needSwitchToHigh=!0),!0):this.getLowStreamLength(t)>0?!d.default.objectEquals(e.dualStream,t.dualStream):void 0}},{key:"getLowStreamLength",value:function(e){return Array.isArray(e.dualStream)?e.dualStream.length:0}},{key:"resetFirstFrameDetector",value:function(){var e=this;this.firstFrameDetector=new y.default,this.firstFrameDetector.on("first_frame_decode",function(t,r){t===e.firstFrameDetector&&e.webrtcMgr.webrtc.trigger("first_"+r+"_frame_decode",{uid:e.pubUidStr,roomId:e.channelId})}),this.stream&&this.firstFrameDetector.start(this.stream,this.pc)}},{key:"updateCodec",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.remoteStreamInfos[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var a=i.value;if("video"===a.streamType&&a.streamParam.codec)return void(this.codec=a.streamParam.codec)}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}}},{key:"reportSubscribeStat",value:function(e,t){"video"===e?t?this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_INFO,"room","aud_subscribe_video_[o]",this.pubUidStr):this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_INFO,"room","aud_unsubscribe_video_[o]",this.pubUidStr):t?this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_INFO,"room","aud_subscribe_audio_[o]",this.pubUidStr):this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_INFO,"room","aud_unsubscribe_audio_[o]",this.pubUidStr)}},{key:"updateLocalStreamInfos",value:function(){this.debug("updateLocalStreamInfos");var e=[],t=[],r=this.updateSingleLocalStream("audio",this.audioStreamKey,this.needAudio,e,t),i=this.updateSingleLocalStream("video",this.videoStreamKey,this.needVideo,e,t),n=this.updateSingleLocalStream("group",this.groupKey,this.needAudio,e,t);return this.updateLocalDualStreamInfo(e,t),e.length>0&&this.sendSubscribeInfo(!0,e),t.length>0&&this.sendSubscribeInfo(!1,t),!!(r||i||n)&&(this.stream.getTracks().length>0&&this.updateMediaStreamEnableState(),!0)}},{key:"updateSingleLocalStream",value:function(e,t,r,i,n){var a=this.remoteStreamInfos.filter(function(t){return t.streamType===e})[0];if(!a&&""!==t){this.updateStreamKey("",e);var o=this.lastRemoteStreamInfos.filter(function(t){return t.streamType===e})[0];return o&&"group"!==e&&n.push({streamType:e,streamName:o.streamName,speakerUidId:o.speakerUidId}),!0}if(r&&""===t&&a){var s=a.streamParam.codec;return"video"===e&&this.subscribed&&!this.supportedVideoCodecs.includes(s)?(this.warn("unsupported codec: "+s),this.webrtcMgr.webrtc.trigger("subscribe_video_fail",{error:"VIDEO_CODEC_UNSUPPORTED",uid:this.uidStr,roomId:this.channelId}),!1):("group"!==e&&i.push({streamType:e,streamName:a.streamName,speakerUidId:a.speakerUidId,layer:0}),this.reportSubscribeStat(e,!0),this.updateStreamKey(a.appid+"_"+a.streamName,e),!0)}return!(r||""===t||!a)&&("group"!==e&&n.push({streamType:e,streamName:a.streamName,speakerUidId:a.speakerUidId}),this.reportSubscribeStat(e,!1),this.updateStreamKey("",e),!0)}},{key:"updateLocalDualStreamInfo",value:function(e,t){var r=this,i=!1,n=[];return this.remoteStreamInfos.forEach(function(e){"video"===e.streamType&&e.dualStream&&(n=e.dualStream)}),this.dualStream.forEach(function(e){var a=!0;n.forEach(function(t){t.streamName===e.streamName&&(a=!1)}),r.needVideo||(a=!0),a&&(t.push({streamType:e.streamType,streamName:e.streamName,speakerUidId:e.speakerUidId}),i=!0)}),this.needVideo?(n.forEach(function(t){if(r.needVideo){var n=!0;r.dualStream.forEach(function(e){e.streamName===t.streamName&&(n=!1)}),n&&(e.push({streamType:t.streamType,streamName:t.streamName,speakerUidId:t.speakerUidId,layer:t.layerIndex}),i=!0)}}),this.needVideo&&(this.dualStream=n),i):(this.dualStream=[],i)}},{key:"getRemoteStream",value:function(){var e=this,t={uid:this.pubUidStr,roomId:this.channelId},r=!0,i=!1,n=void 0;try{for(var a,o=this.remoteStreamInfos[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;if("group"===s.streamType||"audio"===s.streamType)t.audio=s.streamParam;else if("video"===s.streamType&&(t.video=s.streamParam,t.hasLowVideo=!1,s.dualStream.length>0&&(t.hasLowVideo=!0,this.layer>0))){var u=s.dualStream.filter(function(t){return t.layerIndex===e.layer})[0];u&&(t.video=u.streamParam)}}}catch(e){i=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}return this.stream.getTracks().length>0&&(t.stream=this.stream),t}},{key:"updateMediaStreamEnableState",value:function(){this.stream.getAudioTracks().length>0&&(this.hasAudio=""!==this.audioStreamKey||""!==this.groupKey,this.audioTrack.enabled=this.userAudioEnabled&&this.hasAudio),this.stream.getVideoTracks().length>0&&(this.hasVideo=""!==this.videoStreamKey,this.videoTrack.enabled=this.userVideoEnabled&&this.hasVideo),this.player?this.player.update(this.volume,this.hasAudio,this.hasVideo):this.resetElementSrcObject(),this.firstFrameDetector.start(this.stream,this.pc),this.info("updateRemoteStreamEnableState() audio: "+this.hasAudio+", video: "+this.hasVideo)}},{key:"resetElementSrcObject",value:function(){for(var e=["audio","video"],t=0;t<e.length;t++){var r=e[t],i=!0,n=!1,a=void 0;try{for(var o,s=document.getElementsByTagName(r)[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var u=o.value,l=u;l.srcObject===this.stream&&(this.info("reset element src object"),l.srcObject=null,l.srcObject=this.stream,l.play())}}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}}}},{key:"getLowStreamIndex",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.remoteStreamInfos[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var a=i.value;if("video"===a.streamType&&a.dualStream&&a.dualStream.length>0)return a.dualStream[0].layerIndex}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}return 0}},{key:"clearSubscribePromise",value:function(e){e&&this.subscribeReject&&this.subscribeReject(e),this.subscribeReject=null,this.subscribeResolve=null}},{key:"onConnect",value:function(){u(Object.getPrototypeOf(t.prototype),"onConnect",this).call(this),this.checkStreamSubscribed()}},{key:"updateSpecialStat",value:function(e){e.publishVideoStreamId=d.default.streamIdToString(this.videoStreamId),e.publishAudioStreamId=d.default.streamIdToString(this.groupKey?this.streamId:this.audioStreamId),e.videoMode="";var t=this.audioQualityObserver;e.audioDuration=t.totalDurationMs,e.audioFreezeDuration=t.freezeDurationMs,e.audioPauseDuration=t.pauseDurationMs,e.audioFreezeConfig=t.configInfo;var r=this.videoQualityObserver;e.videoDuration=r.totalDurationMs,e.videoFreezeDuration=r.freezeDurationMs,e.videoPauseDuration=r.pauseDurationMs,e.videoFreezeConfig=String(r.freezeThreshold)}},{key:"logQualityInfo",value:function(){var e=this.audioQualityObserver,t=this.videoQualityObserver,r={audio:{total:{per:0,dur:e.totalDurationMs,frz:e.freezeDurationMs,frzN:e.freezeNum,pause:e.pauseDurationMs,pauseN:e.pauseNum},period:{per:0,dur:e.getPeriodTotalDurationMs(),frz:e.getPeriodFreezeDurationMs(),frzN:e.getPeriodFreezeNum(),pause:e.getPeriodPauseDurationMs(),pauseN:e.getPeriodPauseNum()}},video:{total:{per:0,dur:t.totalDurationMs,frz:t.freezeDurationMs,frzN:t.freezeNum,pause:t.pauseDurationMs,pauseN:t.pauseNum},period:{per:0,dur:t.getPeriodTotalDurationMs(),frz:t.getPeriodFreezeDurationMs(),frzN:t.getPeriodFreezeNum(),pause:t.getPeriodPauseDurationMs(),pauseN:t.getPeriodPauseNum()}}};o(r.audio.total),o(r.audio.period),o(r.video.total),o(r.video.period),this.logger.debug(this.label+" freezeInfo",!0,{freezeInfo:JSON.stringify(r),videoFreezePercent:r.video.period.per,audioFreezePercent:r.audio.period.per})}},{key:"sendSubscribeInfo",value:function(e,t){var r=new _.default;r.appid=this.appid,r.uid=this.uid,r.subscribe=e;var i=!0,n=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var u=o.value,l=u.streamName,h=u.streamType,c=u.speakerUidId,d=u.layer,f=this.appid+"_"+l,p=new Map;"audio"===h?(p.set(T.default.StreamCfgKey.STREAM_TYPE,T.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_AUDIO),p.set(T.default.StreamCfgKey.SPEAKER_UID,c),r.streamKeyCfg.set(f,p)):"video"===h&&(p.set(T.default.StreamCfgKey.STREAM_TYPE,T.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_VIDEO),p.set(T.default.StreamCfgKey.SPEAKER_UID,c),d&&p.set(T.default.StreamCfgKey.WEBRTC_STREAM_LAYER,d),r.streamKeyCfg.set(f,p));var v=e?"sendSubscribeInfo":"sendUnSubscribeInfo";this.info(v+" streamType:"+h+" streamName:"+l+" speakerUidId:"+c)}}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}this.webrtcMgr.send(r.marshall())}},{key:"getSubscribedInfo",value:function(){var e=this,t=[];return this.remoteStreamInfos.forEach(function(r){"video"===r.streamType&&""!==e.videoStreamKey?t.push(r):"audio"===r.streamType&&""!==e.audioStreamKey&&t.push(r)}),t}},{key:"onWebRTCLayerRes",value:function(e){e.seqNum===this.resendPWebRTCLayer.seqNum&&(e.result===T.default.LiveSystemLayerRes.SET_LAYER_SUCCUSS?(this.layer=e.layer,this.updateStreamKey(this.getStreamKeybyLayer(this.layer),"video"),this.clearLayerPromise(),this.info("set layer "+e.layer+" success",!0)):(this.clearLayerPromise(this.tranWebRtcLayerResToString(e.result)),this.warn("set layer "+e.layer+" failed, reason: "+this.tranWebRtcLayerResToString(e.result))))}},{key:"tranWebRtcLayerResToString",value:function(e){var t=T.default.LiveSystemLayerRes;switch(e){case t.SET_LAYER_SUCCUSS:return"SUCCESS";case t.SET_LAYER_ERR_NO_USER:return"HAS_NOT_JOIN";case t.SET_LAYER_ERR_NO_PEERCONNECTION:return"HAS_NOT_SUBSCRIBE";case t.SET_LAYER_ERR_PUBUID:return"NO_STREAM"}return""}},{key:"clearLayerPromise",value:function(e){e&&this.setLayerReject?(this.warn("set video layer "+this.resendPWebRTCLayer.layer+" failed, reason: "+e),this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_ERROR,"room","aud_big_small_stream_failed_[o]",this.pubUidStr+"_"+this.resendPWebRTCLayer.layer),this.addUserEvents("switchToVideoLayer"+this.resendPWebRTCLayer.layer+"Fail"),this.setLayerReject(e)):this.setLayerResolve&&(this.webrtcMgr.reportUserEventMgr.addEvent(S.LOGLEVEL_INFO,"room","aud_big_small_stream_success_[o]",this.pubUidStr+"_"+this.resendPWebRTCLayer.layer),this.addUserEvents("switchToVideoLayer"+this.resendPWebRTCLayer.layer+"Success"),this.setLayerResolve(this.getRemoteStream())),this.setLayerResolve=null,this.setLayerReject=null,this.resendPWebRTCLayer=null}},{key:"checkAndSendWebRTCLayer",value:function(){(this.setLayerResolve||this.setLayerReject)&&this.resendPWebRTCLayer&&(this.webrtcMgr.send(this.resendPWebRTCLayer.marshall()),this.info("resend layer request to server, layer:"+this.resendPWebRTCLayer.layer+", seqNum:"+this.resendPWebRTCLayer.seqNum,!0))}},{key:"getPlayStream",value:function(){return this.stream}},{key:"onVisibilityChange",value:function(e){this.videoQualityObserver.visible=e}},{key:"subscribed",get:function(){return null!==this.pc}}]),t}(m.default);r.default=I,t.exports=r.default},{"./UserStream":5,"./protobase/MetaDataInfo":17,"./protobase/ProtoUInt64":21,"./protocol/PLiveSubscribe":35,"./protocol/PWebRTCLayer":43,"./utils/FirstFrameDetector":84,"./utils/logger":91,"./utils/utils":93}],80:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("./utils/logger"),u=i(s),l=e("./subscriber"),h=i(l),c=e("./protobase/MetaDataInfo"),d=i(c),f=e("./protobase/ProtoUInt64"),p=i(f),v=e("./protocol/PLiveSubscribe"),m=i(v),g=e("./utils/browser"),y=i(g),S=function(){function e(t){n(this,e),this.networkScore=null,u.default.debug("SubscriberMgr.constructor"),this.webrtcMgr=t,this.subscribers=new Map,this.subscribersByUidStr=new Map,this.streamKeyMap=new Map,this.ConnectTimeOut=7e3,this.logger=this.webrtcMgr.logger}return o(e,[{key:"destroy",value:function(){u.default.info("SubscriberMgr.destroy, subscriber num:"+this.subscribers.size);var e=!0,t=!1,r=void 0;try{for(var i,n=this.subscribers.values()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){var a=i.value;if(null!=a){var o=a.pubUuid;this.deleteSubscriber(o),a.destroy()}}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}this.streamKeyMap=new Map,this.networkScore=null}},{key:"onCheckTimer",value:function(e,t,r){this.networkScore=null;var i=!0,n=!1,a=void 0;try{for(var o,s=this.subscribers.values()[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var u=o.value;if(null!=u){if(!1===u.subscribed)continue;u.onCheckTimer(e,t,r),null!==this.networkScore?null!==u.networkScore&&(this.networkScore=Math.max(this.networkScore,u.networkScore)):this.networkScore=u.networkScore}}}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}}},{key:"resetIceConnState",value:function(e){this.logger.warn("SubscriberMgr.resetIceConnState, resetReason:"+e);var t=!0,r=!1,i=void 0;try{for(var n,a=this.subscribers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){n.value.resetIceConnState(e)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}},{key:"updateChannelStreams",value:function(e,t){var r=!0,i=!1,n=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var u=a(o.value,2),l=u[0],h=u[1],c=this.getSubscriber(l);if(!c){var d=h[0];c=this.newSubscriber(d.appid,d.speakerUid,new p.default(d.speakerUidId,0),!0,e)}c.updateRemoteStreamInfos(h)}}catch(e){i=!0,n=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw n}}this.subscribers.forEach(function(r){if(r.channelId===e){var i=r.pubUuid;t.get(i)||r.destroy()}})}},{key:"getUuid",value:function(e,t){return e.toString()+"_"+t.toString()}},{key:"getSubscriberByUidStr",value:function(e){return this.subscribersByUidStr.get(e)}},{key:"getSubscriber",value:function(e){return this.subscribers.get(e)}},{key:"newSubscriber",value:function(e,t,r,i,n){u.default.info("SubscriberMgr.newSubscriber appid:"+e+", uid:"+t+", streamId:"+r.toString64()+", hasUidStr:"+i);var a=new h.default(e,String(t),r,this.webrtcMgr,i,n);return this.subscribers.set(a.pubUuid,a),this.subscribersByUidStr.set(a.pubUidStr,a),a}},{key:"deleteSubscriber",value:function(e){var t=this.subscribers.get(e);t&&(u.default.info("SubscriberMgr.deleteSubscriber, uid:"+t.pubUidStr+", streamId:"+t.streamId.toString64()),this.subscribersByUidStr.delete(t.pubUidStr),this.subscribers.delete(e),this.webrtcMgr.audioLevelReporter.remove(t.pubUidStr))}},{key:"subscribe",value:function(e,t){var r=this.getSubscriberByUidStr(e);return r?r.subscribe(t):Promise.reject("STREAM_NOT_EXISTED")}},{key:"unsubscribe",value:function(e){var t=this.getSubscriberByUidStr(e);return t?t.unsubscribe():{error:"STREAM_NOT_EXISTED"}}},{key:"getAudioLevel",value:function(e,t){var r=this.getSubscriberByUidStr(t);return r?r.getAudioLevel():0}},{key:"onVisibilityChange",value:function(e){var t=!0,r=!1,i=void 0;try{for(var n,a=this.subscribers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value;o.onVisibilityChange(e)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}if(y.default.os.isIOS)if(e)this.resetIceConnState("iOSForeground");else{var s=!0,u=!1,l=void 0;try{for(var h,c=this.subscribers.values()[Symbol.iterator]();!(s=(h=c.next()).done);s=!0){var o=h.value;o.pausePlay()}}catch(e){u=!0,l=e}finally{try{!s&&c.return&&c.return()}finally{if(u)throw l}}}}},{key:"onNotifyStreamStatus",value:function(e){var t=this;if(u.default.info("SubscriberMgr.onNotifyCurrentStream, groupKey num: "+e.streamKeyToId.size),0!==e.streamKeyToId.size){var r=!0,i=!1,n=void 0;try{for(var o,s=e.streamKeyToId.entries()[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var l,h,c,d,f;!function(){var e=a(o.value,2),r=e[0],i=e[1];u.default.info("SubscriberMgr.onNotifyCurrentStream, groupKey: "+r+" stream num: "+i.size),l=!0,h=!1,c=void 0;try{for(d=i[Symbol.iterator]();!(l=(f=d.next()).done);l=!0){var n=f.value,s=t.getUuid(t.webrtcMgr.appid,n.high);if(n.high!==t.webrtcMgr.uid){var v=t.getSubscriber(s);if(v)v.updateStreamId(r,new p.default(n.high,n.low));else if(0===t.webrtcMgr.mode){if(r!==t.webrtcMgr.groupKey){t.logger.warn("notify group key not equal, local: "+t.webrtcMgr.groupKey+", remote: "+r);continue}v=t.newSubscriber(t.webrtcMgr.appid,n.high,n,!1,t.webrtcMgr.channelId);var m={appid:t.webrtcMgr.appid,channelId:t.webrtcMgr.channelId,speakerUid:void 0,speakerUidId:n.high,streamType:"group",streamName:t.webrtcMgr.groupName,streamParam:{},dualStream:void 0,defaultLayer:0,version:void 0,timestamp:Date.now()};v.updateRemoteStreamInfos([m])}}}}catch(e){h=!0,c=e}finally{try{!l&&d.return&&d.return()}finally{if(h)throw c}}0===t.webrtcMgr.mode&&t.subscribers.forEach(function(e){if(e.groupKey===r){var n=!0,a=!1,o=void 0;try{for(var s,u=i[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){if(s.value.equal(e.streamId))return}}catch(e){a=!0,o=e}finally{try{!n&&u.return&&u.return()}finally{if(a)throw o}}t.logger.warn("SubscriberMgr.onNotifyCurrentStream, Can not find streamId "+e.streamId.toString64()+" in notify "),e.destroy()}})}()}}catch(e){i=!0,n=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw n}}}}},{key:"onStopStream",value:function(e){u.default.info("SubscriberMgr.onStopStream, uid:"+e.streamId.high+", streamKey:"+e.streamKey);var t=this.getUuid(e.appid,e.streamId.high),r=this.getSubscriber(t);r&&(this.logger.info("SubscriberMgr Peer user has stopStream, uid:"+e.streamId.high+", streamKey:"+e.streamKey,!0),e.streamKey===this.webrtcMgr.groupKey&&r.destroy())}},{key:"setClientAddress",value:function(e){var t=this;e.subscribeUuidToAddress.forEach(function(e,r){var i=t.getSubscriber(r);i&&i.setClientAddress(e)})}},{key:"onWebRTCAnswer",value:function(e){u.default.info("SubscriberMgr.onWebRTCAnswer, pkg.subscriberuid:"+e.subscribeUuid+", pkg.seqNum:"+e.seqNum);var t=this.getSubscriber(e.subscribeUuid);!e.publish&&t&&t.onWebRTCAnswer(e)}},{key:"onWebRTCEvent",value:function(e){u.default.info("SubscriberMgr.onWebRTCEvent, subscriberuid:"+e.subscribeUuid);var t=this.getSubscriber(e.subscribeUuid);!e.publish&&t&&t.onWebRTCEvent(e)}},{key:"onPLiveUserBroadCastData",value:function(e){u.default.debug("SubscriberMgr.onPLiveUserBroadCastData pkg.externalUid:"+e.externalUid+"uid:"+e.uid);var t=e.appid,r=e.uid,i=this.getUuid(t,r),n=this.getSubscriber(i);if(e.externalUid!=this.webrtcMgr.uidStr&&r==this.webrtcMgr.uid)return void this.webrtcMgr.resetUid();n&&(""!==e.externalUid&&(n.externalUid=e.externalUid),0===this.webrtcMgr.mode&&this.webrtcMgr.webrtc.trigger("remote_is_speaking",{uid:n.pubUidStr,externalUid:n.externalUid}),n.hasUidStr=!0)}},{key:"setRemoteVideoLayer",value:function(e,t){var r=this.getSubscriberByUidStr(e);return void 0===r?Promise.reject("STREAM_NOT_EXISTED"):r.setRemoteVideoLayer(t)}},{key:"subscribeMedia",value:function(){var e=[];if(0===this.webrtcMgr.mode)e.push({appid:this.webrtcMgr.appid,streamName:this.webrtcMgr.groupName,streamType:"group",channelId:this.webrtcMgr.channelId,speakerUid:void 0,speakerUidId:0,streamParam:{},version:void 0,timestamp:0});else{var t=!0,r=!1,i=void 0;try{for(var n,a=this.subscribers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){
var o=n.value,s=o.getSubscribedInfo();e=e.concat(s)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}e.length>0&&this.subscribeMediaFromInfos(e)}},{key:"subscribeMediaFromInfos",value:function(e){var t=this,r=new m.default;r.appid=this.webrtcMgr.appid,r.uid=this.webrtcMgr.uid,r.subscribe=!0;var i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done);i=!0)!function(){var e=o.value,i=e.streamName,n=t.webrtcMgr.appid+"_"+i,a=new Map;if("audio"===e.streamType)a.set(d.default.StreamCfgKey.STREAM_TYPE,d.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_AUDIO),a.set(d.default.StreamCfgKey.SPEAKER_UID,e.speakerUidId),r.streamKeyCfg.set(n,a);else if("video"===e.streamType){if(a.set(d.default.StreamCfgKey.STREAM_TYPE,d.default.StreamCfgValue.STREAM_TYPE_VALUE.VALUE_VIDEO),a.set(d.default.StreamCfgKey.SPEAKER_UID,e.speakerUidId),r.streamKeyCfg.set(n,a),e.dualStream){var s=e.dualStream;s.forEach(function(e){var i=new Map(a);i.set(d.default.StreamCfgKey.WEBRTC_STREAM_LAYER,e.layerIndex),r.streamKeyCfg.set(t.webrtcMgr.appid+"_"+e.streamName,i)})}}else"group"===e.streamType&&r.groupKeyCfg.set(n,a)}()}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}this.webrtcMgr.socket?e.length?(this.webrtcMgr.socket.send(r.marshall()),this.logger.info("WebRTCMgr avp subscribe:"+JSON.stringify(r)+" size:"+r.streamKeyCfg.size,!0)):this.logger.info("WebRTCMgr.subscribeMediaFromInfos do not subscribe, remoteStreamInfos.length:"+e.length,!0):this.logger.info("WebRTCMgr unable to avp subscribe:"+JSON.stringify(r),!0)}},{key:"onWebRTCLayerRes",value:function(e){u.default.info("SubscriberMgr.onWebRTCLayerRes, pkg.pubUid:"+e.pubUid+", pkg.layer:"+e.layer+", pkg.result:"+e.result);var t=e.appid.toString()+"_"+e.pubUid.toString(),r=this.getSubscriber(t);r&&r.onWebRTCLayerRes(e)}},{key:"checkAndSendWebRTCLayer",value:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.subscribers.values()[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){i.value.checkAndSendWebRTCLayer()}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}}}]),e}();r.default=S,t.exports=r.default},{"./protobase/MetaDataInfo":17,"./protobase/ProtoUInt64":21,"./protocol/PLiveSubscribe":35,"./subscriber":79,"./utils/browser":90,"./utils/logger":91}],81:[function(e,t,r){"use strict";function i(){if(s)return s;var e=window.AudioContext||window.webkitAudioContext;return s=new e,s.onstatechange=function(){o.default.info("AudioContext change to "+s.state),"running"!==s.state&&"closed"!==s.state&&s.resume().catch(function(){})},"suspended"===s.state&&(0,n.requestInteract)(function(){"running"!==s.state&&"closed"!==s.state&&s.resume().catch(function(){})}),s}Object.defineProperty(r,"__esModule",{value:!0}),r.default=i;var n=e("./InteractDetector"),a=e("./logger"),o=function(e){return e&&e.__esModule?e:{default:e}}(a),s=void 0;(0,n.requestInteract)(function(){i()}),t.exports=r.default},{"./InteractDetector":85,"./logger":91}],82:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){var e=function(){function e(t){i(this,e),this.webrtcMgr=t,this.audioLevels=new Map,this.speaker="",this.timer=null}return n(e,[{key:"set",value:function(e,t){this.audioLevels.set(e,t)}},{key:"remove",value:function(e){this.audioLevels.delete(e)}},{key:"onCheckTimer",value:function(){var e=0,t="";this.audioLevels.forEach(function(r,i){r>e&&(t=i,e=r)}),e>5&&t!==this.speaker&&(this.speaker=t,this.webrtcMgr.webrtc.trigger("active_speaker",this.speaker))}},{key:"enableIntervalReport",value:function(){var t=this;return null===this.timer?(this.timer=window.setInterval(function(){var e=[],r=!0,i=!1,n=void 0;try{for(var a,o=t.audioLevels.entries()[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;e.push({uid:s[0],audioLevel:s[1]})}}catch(e){i=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}t.webrtcMgr.webrtc.trigger("audio_level_report",e)},e.REPORT_INTERVAL),null):{error:"INVALID_OPERATION"}}},{key:"disableIntervalReport",value:function(){return"number"==typeof this.timer?(clearInterval(this.timer),this.timer=null,null):{error:"INVALID_OPERATION"}}}]),e}();return e.REPORT_INTERVAL=2e3,e}();r.default=a,t.exports=r.default},{}],83:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},s=e("events"),u=e("./AudioContextMgr"),l=function(e){return e&&e.__esModule?e:{default:e}}(u),h=function(e){function t(){i(this,t),o(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.context=null,this.analyser=null,this.timeDomainData=null,this.stream=null,this.sourceNode=null,this.gainNode=null,this.remoteStream=null,this.remoteGain=null}return n(t,e),a(t,[{key:"updateStream",value:function(e){var t=new MediaStream;e.getAudioTracks().length>0&&(t.addTrack(e.getAudioTracks()[0]),this.remoteStream=t,this.sourceNode||(this.context=(0,l.default)(),this.analyser=this.context.createAnalyser(),this.timeDomainData=new Uint8Array(this.analyser.frequencyBinCount),this.remoteGain=this.context.createGain(),this.remoteGain.connect(this.analyser)),t.getAudioTracks().length>0&&(this.sourceNode=this.context.createMediaStreamSource(t),this.sourceNode.connect(this.remoteGain)))}},{key:"updateNode",value:function(e){this.analyser||(this.context=(0,l.default)(),this.analyser=this.context.createAnalyser(),this.timeDomainData=new Uint8Array(this.analyser.frequencyBinCount),e.connect(this.analyser),this.gainNode=e)}},{key:"stop",value:function(){this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.analyser&&(this.analyser.disconnect(),this.analyser=null)}},{key:"level",get:function(){if(this.remoteStream){var e=this.remoteStream.getAudioTracks()[0];if(!e)return 0;if(!1===e.enabled||!0===e.muted)return 0}if(this.gainNode&&0===this.gainNode.gain.value)return 0;if(this.analyser){this.analyser.getByteTimeDomainData(this.timeDomainData);for(var t=0,r=0;r<this.timeDomainData.length;r++){var i=Math.abs(this.timeDomainData[r]-128);t=Math.max(t,i)}return 1===t&&(t=0),100*t/128}return 0}}]),t}(s.EventEmitter);r.default=h,t.exports=r.default},{"./AudioContextMgr":81,events:97}],84:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},u=e("events"),l=e("./browser"),h=i(l),c=e("../getStats"),d=i(c),f=function(e){function t(){n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.hasReportAudio=!1,this.hasReportVideo=!1}return a(t,e),o(t,[{key:"start",value:function(e,t){var r=e.getAudioTracks()[0],i=e.getVideoTracks()[0];!this.hasReportAudio&&r&&r.enabled&&this.detectTrack(r,"audio"),!this.hasReportVideo&&i&&i.enabled&&(t&&h.default.os.isIOS&&h.default.isWeChat?this.detectVideoByPC(t):this.detectTrack(i,"video"))}},{key:"detectTrack",value:function(e,t){var r=this,i=document.createElement(t);i.setAttribute("autoplay",""),i.setAttribute("muted",""),i.autoplay=!0,i.muted=!0,i.setAttribute("playsinline",""),i.setAttribute("style","position: absolute; top: 0; left: 0; width: 1px; height: 1px");var n=new MediaStream;n.addTrack(e),i.srcObject=n,h.default.os.isIOS&&document.body.appendChild(i),i.play().catch(function(){});var a=function(){s(),"audio"!==t||r.hasReportAudio?"video"===t&&(r.hasReportVideo=!0):r.hasReportAudio=!0,r.emit("first_frame_decode",r,t),i.srcObject=null,h.default.os.isIOS&&document.body.removeChild(i)},o=function(){s(),h.default.os.isIOS&&document.body.removeChild(i),i.srcObject=null},s=function(){i.removeEventListener("loadeddata",a),i.removeEventListener("play",a),i.removeEventListener("playing",a);for(var e=["abort","error","suspend","stalled","pause"],t=0;t<e.length;t++){var r=e[t];i.removeEventListener(r,o)}};i.addEventListener("loadeddata",a),i.addEventListener("play",a),i.addEventListener("playing",a);for(var u=["abort","error","suspend","stalled","pause"],l=0;l<u.length;l++){var c=u[l];i.addEventListener(c,o)}}},{key:"detectVideoByPC",value:function(e){var t=this,r=0;this.checkTimer&&clearInterval(this.checkTimer),this.checkTimer=window.setInterval(function(){r++,(0,d.default)(e).then(function(e){e.videoTrack&&e.videoTrack.framesReceived>0&&(clearInterval(t.checkTimer),t.hasReportVideo=!0,t.emit("first_frame_decode",t,"video"))}),200*r>6e4&&clearInterval(t.checkTimer),"closed"!==e.connectionState&&"failed"!==e.connectionState||clearInterval(t.checkTimer)},200)}}]),t}(u.EventEmitter);r.default=f,t.exports=r.default},{"../getStats":11,"./browser":90,events:97}],85:[function(e,t,r){"use strict";function i(e){var t=function t(){document.removeEventListener("mousedown",t,!1),document.removeEventListener("keypress",t,!1),document.removeEventListener("touchdown",t,!1),e()};document.addEventListener("mousedown",t,!1),document.addEventListener("keypress",t,!1),document.addEventListener("touchdown",t,!1)}Object.defineProperty(r,"__esModule",{value:!0}),r.requestInteract=i},{}],86:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.history=["","",""],this.current=""}return n(e,[{key:"getRecord",value:function(){return this.history.shift(),this.history.push(this.current),this.current="",this.empty?"":this.history.join("*")}},{key:"add",value:function(e){this.current?this.current=this.current+"--"+e:this.current=e}},{key:"reset",value:function(){this.history=["","",""],this.current=""}},{key:"empty",get:function(){var e=!0,t=!1,r=void 0;try{for(var i,n=this.history[Symbol.iterator]();!(e=(i=n.next()).done);e=!0){if(i.value.length>0)return!1}}catch(e){t=!0,r=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw r}}return!0}}]),e}();r.default=a,t.exports=r.default},{}],87:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e){var t=""+e;return!!t.includes("interact with the document first")||!!t.includes("not allowed by the user agent or the platform")}function o(e){return!!(""+e).includes("can only be initiated by a user gesture")}Object.defineProperty(r,"__esModule",{value:!0});var s,u=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),l=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},h=e("events"),c=e("./InteractDetector"),d=e("./browser"),f=function(e){return e&&e.__esModule?e:{default:e}}(d);!function(e){e.PAUSE="pause",e.PLAY="play",e.END="end"}(s||(s={}));var p=function(e){function t(e,r,n,a,o,u,h,c,d){i(this,t),l(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.logger=e,this.prefix=r,this.uid=n,this.stream=u,this.element=h,this.isRemote=c,this.option=d,this.state=s.PAUSE,this.muted=!this.isRemote,this.fit="cover",this.mirror=!1,this.controls=!1,this.backgroundColor="black",this.hasAudio=a,this.hasVideo=o,d&&(this.muted=void 0!==d.muted?d.muted:this.muted,this.fit=void 0!==d.fit?d.fit:this.fit,this.mirror=void 0!==d.mirror?d.mirror:this.mirror,this.controls=void 0!==d.controls?d.controls:this.controls,this.backgroundColor=void 0!==d.backgroundColor?d.backgroundColor:this.backgroundColor),this.label=r+"Player"}return n(t,e),u(t,[{key:"log",value:function(e){this.logger.info(this.label+" "+e)}},{key:"warn",value:function(e){this.logger.warn(this.label+" "+e)}},{key:"play",value:function(e){return this.log("play"),this.fatherNode=this.element,this.div=this.createDiv(),this.hasVideo?this.media=this.createVideo():this.media=this.createAudio(),this.media.volume=e,this.addEventListener(),this.media.srcObject=this.getSrcObject(),this.div.appendChild(this.media),this.fatherNode.appendChild(this.div),this.playMedia()}},{key:"getSrcObject",value:function(){if(this.isRemote){var e=new MediaStream,t=this.stream.getAudioTracks(),r=this.stream.getVideoTracks();return this.hasAudio&&t.length&&e.addTrack(t[0]),this.hasVideo&&r.length&&e.addTrack(r[0]),e}return this.stream}},{key:"playMedia",value:function(e){var t=this,r=this.media;return this.media.play().then(function(){if(t.hasVideo&&t.media){var e=t.media.getBoundingClientRect(),r=e.width,i=e.height;0!==r&&0!==i||t.warn("the height or width of player div is 0")}}).catch(function(i){if(t.media&&t.media!==r)return t.playMedia();if("AbortError"===i.name||!t.media)return Promise.reject("CANCEL");if(a(i))return e||(0,c.requestInteract)(function(){t.media&&(t.warn("interact and resume play"),t.media.muted=t.muted,t.media.play().then(function(){t.emit("mute_play_resume",t)}))}),!0===t.media.muted?Promise.resolve():(t.warn("play fail because AutoPlay Policy, try mute play"),t.media.muted=!0,t.emit("mute_play",t),t.playMedia(!0));if(o(i))return Promise.reject("NEED_USER_GESTURE");return t.warn("play fail with: "+i),Promise.reject("INTERNAL_PLAY_ERROR")})}},{key:"resume",value:function(){return this.media?(this.media.muted=this.muted,this.media.play()):Promise.reject("HAS_NOT_PLAY")}},{key:"setAudioOutputDevice",value:function(e){return this.media?"function"==typeof this.media.setSinkId?this.media.setSinkId(e):Promise.reject("NOT_SUPPORTED"):Promise.reject("HAS_NOT_PLAY")}},{key:"destroy",value:function(){this.log("destroy"),this.fatherNode&&this.div&&this.fatherNode.removeChild(this.div),this.fatherNode=void 0,this.div=void 0,this.media&&(this.media.srcObject=null),this.media=null}},{key:"update",value:function(e,t,r){if(this.hasVideo&&r&&this.media&&this.media.srcObject&&!f.default.os.isIOS){var i=this.media.srcObject;if(i.getVideoTracks()[0]===this.stream.getVideoTracks()[0]){if(!this.isRemote)return;var n=i.getAudioTracks()[0];return n&&i.removeTrack(n),t&&i.addTrack(this.stream.getAudioTracks()[0]),this.hasAudio=t,f.default.isSafari&&this.media.pause(),void this.playMedia()}}this.hasAudio=t,this.hasVideo=r,this.log("update"),this.destroy(),this.updateState(s.PAUSE,"update"),this.play(e)}},{key:"createDiv",value:function(){var e=document.createElement("div"),t="width: 100%; height: 100%; position: relative; overflow: hidden;";return this.hasVideo&&(t+="background-color: "+this.backgroundColor),e.setAttribute("style",t),e}},{key:"createVideo",value:function(){var e=document.createElement("video"),t="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: "+this.fit+";";return this.mirror&&(t+="transform: rotateY(180deg);"),e.setAttribute("style",t),e.setAttribute("playsinline",""),this.controls&&(e.controls=!0),this.muted&&(e.muted=!0),e}},{key:"createAudio",value:function(){var e=document.createElement("audio");return this.controls&&(e.controls=!0),this.muted&&(e.muted=!0),e}},{key:"addEventListener",value:function(){for(var e=this,t=["playing","canplay","abort","error","suspend","stalled","pause"],r=0;r<t.length;r++)!function(){var i=t[r];e.media&&function(){var t=e.media;e.media.addEventListener(i,function(){e.handleMediaEvent(i,t)})}()}()}},{key:"handleMediaEvent",value:function(e,t){if(this.media===t||null===this.media){var r=void 0;r=this.media?this.media.paused?s.PAUSE:s.PLAY:s.END,this.updateState(r,e)}}},{key:"updateState",value:function(e,t){e!==this.state&&(this.state=e,this.log("new state "+this.state),this.emit("state_change",this,{uid:this.uid,reason:t,state:this.state}))}},{key:"setAudioVolume",value:function(e){this.media.volume=e}},{key:"handleTrackChange",value:function(){f.default.isSafari&&this.media&&(this.media.pause(),this.media.srcObject=null,this.media.srcObject=this.getSrcObject(),this.playMedia().catch(function(){}))}},{key:"isPlaying",get:function(){return this.state===s.PLAY}},{key:"position",get:function(){if(this.hasVideo&&this.media){var e=this.media.getBoundingClientRect(),t=e.x,r=e.y,i=e.width,n=e.height;return"x"+Math.round(t)+"-y"+Math.round(r)+"-w"+Math.round(i)+"-h"+Math.round(n)}return""}}]),t}(h.EventEmitter);r.default=p,t.exports=r.default},{"./InteractDetector":85,"./browser":90,events:97}],88:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},s=e("events"),u=function(e){function t(e){i(this,t),o(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.isRemote=e,this.hasAudio=!1,this.hasVideo=!1,this.errorFlag={},this.count=0,this.firstFrameStat={audio:!1,video:!1}}return n(t,e),a(t,[{key:"update",value:function(e){++this.count%4||(this.stat&&this.checkNewStat(e),this.stat=e)}},{key:"checkFirstFrameStat",value:function(e){var t=[];return this.firstFrameStat.video||(e.videoTrack.framesSent&&(this.firstFrameStat.video=!0,t.push("send_first_video_frame_[o]")),e.videoTrack.framesReceived&&(this.firstFrameStat.video=!0,t.push("aud_receive_first_video_frame_[o]"))),this.firstFrameStat.audio||(e.audio.bytesSent&&(this.firstFrameStat.audio=!0,t.push("send_first_audio_frame")),e.audio.bytesReceived&&(this.firstFrameStat.audio=!0,t.push("aud_receive_first_audio_frame_[o]"))),t}},{key:"checkVideoUplinkException",value:function(e){return!(!this.hasVideo||this.isRemote||e.videoTrack.frameWidth||e.videoTrack.frameHeight||!this.errorFlag.video_framesEncoded||!this.errorFlag.video_bytesSent||!this.errorFlag.track_framesSent)}},{key:"checkNewStat",value:function(e){var t=this,r=this.stat,i=function(i,n,a,o){if(void 0!==r[i]&&void 0!==e[i]&&void 0!==r[i][n]&&void 0!==e[i][n]){var s=e[i][n]-r[i][n];if(s<0)return;var u=i+"_"+n;t.setFlag(u,s<a,o)}};this.hasAudio&&this.isRemote&&i("audio","bytesReceived",5,"AUDIO_RECEIVE_BITRATE_TOO_LOW"),this.hasAudio&&!this.isRemote&&i("audio","bytesSent",5,"AUDIO_SEND_BITRATE_TOO_LOW"),this.hasVideo&&this.isRemote&&(i("video","framesDecoded",2,"VIDEO_DECODE_FRAMERATE_TOO_LOW"),i("video","bytesReceived",5,"VIDEO_RECEIVE_BITRATE_TOO_LOW"),i("videoTrack","framesReceived",2,"VIDEO_RECEIVE_FRAMERATE_TOO_LOW")),this.hasVideo&&!this.isRemote&&(i("video","framesEncoded",2,"VIDEO_ENCODE_FRAMERATE_TOO_LOW"),i("video","bytesSent",5,"VIDEO_SEND_BITRATE_TOO_LOW"),i("videoTrack","framesSent",2,"VIDEO_SEND_FRAMERATE_TOO_LOW"))}},{key:"setFlag",value:function(e,t,r){t&&!this.errorFlag[e]&&(this.errorFlag[e]=!0,this.emit("exception",r)),!t&&this.errorFlag[e]&&(this.errorFlag[e]=!1,this.emit("exception",r+"_RESUME"))}},{key:"reset",value:function(){this.stat=void 0,this.firstFrameStat={audio:!1,video:!1}}}]),t}(s.EventEmitter);r.default=u,t.exports=r.default},{events:97}],89:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){i(this,e),this.video=null}return n(e,[{key:"clear",value:function(){this.video&&(this.video.srcObject=null,this.video=null)}},{key:"keep",value:function(e){this.clear();var t=document.createElement("video");t.muted=!0,t.srcObject=e,this.video=t}}]),e}();r.default=a,t.exports=r.default},{}],90:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a="undefined"!=typeof RTCPeerConnection&&"undefined"!=typeof MediaStream&&"undefined"!=typeof MediaStreamTrack,o=function(){function e(t){i(this,e),this.agent=t,this.name="",this.version="",this.major=NaN,this.minor=NaN,this.isSafari=!1,this.isChrome=!1,this.isWeChat=!1,this.os={name:"",version:"",major:NaN,minor:NaN},this.kernel={name:"",version:"",major:NaN,minor:NaN},this.detectOS(),this.detectModel(),this.detectBrowser(),this.detectKernel()}return n(e,[{key:"isSupported",value:function(){if(!a)return!1;switch(this.kernel.name){case"Chrome":if(this.kernel.major>69)return!!navigator.mediaDevices;break;case"Safari":if(this.os.isIOS)return this.os.major>12||12===this.os.major&&this.os.minor>1;if(this.kernel.major>12||12===this.kernel.major&&this.kernel.minor>0)return!!navigator.mediaDevices;break;case"AppleWebKit":if(this.os.isIOS)return this.os.major>12||12===this.os.major&&this.os.minor>1}return!1}},{key:"hasGetUserMedia",value:function(){return!!navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia}},{key:"detectOS",value:function(){var e=this.matchWindowsNT()||this.matchMac()||this.matchAndroid()||this.matchIOS()||this.matchWindowsPhone();e&&(this.os.name=e[1]||"",this.os.version=e[2]||"",this.os.major=parseInt(e[3]),this.os.minor=parseInt(e[4])),this.os.isWindows="Windows"===this.os.name,this.os.isMac="Mac"===this.os.name,this.os.isAndroid="Android"===this.os.name,this.os.isIOS="iPhone"===this.os.name||"iPad"===this.os.name||"iPod"===this.os.name,this.os.isWindowsPhone="Windows Phone"===this.os.name,this.os.isMobile=this.os.isAndroid||this.os.isIOS||this.os.isWindowsPhone}},{key:"detectModel",value:function(){var e=this.os.isAndroid&&this.agent.match(/;\s(([-a-z\d\s]+)(?:\sBuild\/([-a-z\d\.\s]+))?)(?:;\swv|\))/i);e&&(this.os.model=e[1],this.os.brand=e[2],this.os.build=e[3])}},{key:"detectBrowser",value:function(){var e=this.matchMSIE()||this.matchIETrident()||this.matchFirefox()||this.matchOpera()||this.matchEdge()||this.matchUCBrowser()||this.matchWeChat()||this.matchQQ()||this.matchQQBrowser()||this.matchSogou()||this.match360()||this.matchElectron()||this.matchChrome()||this.matchSafari()||this.matchOtherBrowser();e&&(this.name=e[1]||"",this.version=e[2]||"",this.major=parseInt(e[3]),this.minor=parseInt(e[4])),this.isSafari="Safari"===this.name,this.isChrome="Chrome"===this.name,this.isWeChat="MicroMessenger"===this.name}},{key:"detectKernel",value:function(){var e=!this.os.isIOS&&this.matchChrome()||this.isSafari&&this.matchSafari()||this.matchAppleWebKit()||this.matchGecko()||this.matchPresto()||this.matchTrident();e&&(this.kernel.name=e[1]||"",this.kernel.version=e[2]||"",this.kernel.major=parseInt(e[3]),this.kernel.minor=parseInt(e[4])),this.kernel.isChrome="Chrome"===this.kernel.name,this.kernel.isSafari="Safari"===this.kernel.name,this.kernel.isAppleWebKit="AppleWebKit"===this.kernel.name,this.kernel.isGecko="Gecko"===this.kernel.name,this.kernel.isPresto="Presto"===this.kernel.name,this.kernel.isTrident="Trident"===this.kernel.name}},{key:"matchWindowsNT",value:function(){var e=this.agent.match(/(Windows)\sNT\s((\d+)\.(\d+))/);if(e)switch(e[2]){case"6.3":e=["Windows 8.1","Windows","8.1","8","1"];break;case"6.2":e=["Windows 8.0","Windows","8.0","8","0"];break;case"6.1":e=["Windows 7.0","Windows","7.0","7","0"]}return e}},{key:"matchMac",value:function(){return this.agent.match(/(Mac)\sOS\sX\s((\d+)[\._](\d+)(?:[\._]\d+)*)/)}},{key:"matchAndroid",value:function(){return this.agent.match(/(Android)(?:\s((\d+)(?:\.(\d+))?(?:\.(\d+))*))?/)}},{key:"matchIOS",value:function(){return this.agent.match(/(iP(?:hone|ad|od)).*\s((\d+)_(\d+)(?:_\d+)*)/)}},{key:"matchWindowsPhone",value:function(){return this.agent.match(/(Windows\sPhone)(?:\sOS)?\s((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchMSIE",value:function(){return this.agent.match(/(MSIE)\s((\d+)\.(\d+))/)}},{key:"matchIETrident",value:function(){return this.agent.match(/(Trident)\/.+rv:((11)\.(\d+))/i)}},{key:"matchFirefox",value:function(){return this.agent.match(/(Firefox)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchOpera",value:function(){return this.agent.match(/(OPR|OPiOS|Opera\sMini)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchUCBrowser",value:function(){return this.agent.match(/(UCBrowser)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchEdge",value:function(){return this.agent.match(/(Edg|Edge|EdgA)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchSafari",value:function(){if(this.os.isAndroid||this.matchChrome()||!this.agent.match(/Safari/))return null;var e=this.agent.match(/Version\/((\d+)\.(\d+)(?:\.\d+)*)/);return e?["Safari/"+e[1],"Safari"].concat(e.slice(1)):null}},{key:"matchWeChat",value:function(){return this.agent.match(/(MicroMessenger)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchQQ",value:function(){return this.agent.match(/(QQ)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchQQBrowser",value:function(){return this.agent.match(/([M]?QQBrowser)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchSogou",value:function(){return this.agent.match(/(MetaSr|SogouMobileBrowser)[\s|\/]((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"match360",value:function(){return this.agent.match(/(QihooBrowser|360browser)(?:\/((\d+)\.(\d+)(?:\.\d+)*))?/)}},{key:"matchElectron",value:function(){return this.agent.match(/(Electron)(?:\/((\d+)\.(\d+)(?:\.\d+)*))?/)}},{key:"matchChrome",value:function(){return this.agent.match(/(Chrome|CriOS)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchOtherBrowser",value:function(){return this.agent.match(/\s([a-z\d]+Browser)\/((\d+)\.(\d+)(?:\.\d+)*)/i)||this.agent.match(/\s([a-z\d]+)\/((\d+)\.(\d+)(?:\.\d+)*)$/i)}},{key:"matchAppleWebKit",value:function(){return this.agent.match(/(AppleWebKit)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchGecko",value:function(){return this.agent.match(/(Gecko)\/((\d+))/)}},{key:"matchPresto",value:function(){return this.agent.match(/(Presto)\/((\d+)\.(\d+)(?:\.\d+)*)/)}},{key:"matchTrident",value:function(){return this.agent.match(/(Trident)\/((\d+)\.(\d+)(?:\.\d+)*)/)}}]),e}();r.Browser=o;var s=new o(navigator.userAgent);r.default=s},{}],91:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e){var t=e.toString().length,r=void 0;switch(t){case 1:r="00"+e;break;case 2:r="0"+e;break;default:r=e}return r}function a(e){var t=Math.floor(Math.abs(e));return(t<10?"0":"")+t}function o(){var e=new Date;return"h5 "+a(e.getHours())+":"+a(e.getMinutes())+":"+a(e.getSeconds())+"."+n(e.getMilliseconds())+":"}function s(){var e=new XMLHttpRequest;return e._noVConsole=!0,e}Object.defineProperty(r,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();r.LOGLEVEL_DEBUG=1;r.LOGLEVEL_INFO=2;r.LOGLEVEL_WARN=3;r.LOGLEVEL_ERROR=4;r.LOGLEVEL_NONE=5;var l=2,h=null,c=0,d=!1;!function(){try{h=s()}catch(e){console.error("XMLHttpRequest is not available! err:"+e)}}();var f=function(){function e(){i(this,e),this._data=[],this._length=0,this._appid=0,this._uid=0,this._reportBuff=[],this._reportBuffLen=0,this._canReport=!0}return u(e,[{key:"debug",value:function(e){var t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1],r=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];e=o()+e,this.record(e,"debug",t,r),l<=1&&console.log(e)}},{key:"info",value:function(e){var t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];e=o()+e,this.record(e,"info",t),l<=2&&console.info(e)}},{key:"warn",value:function(e){var t=arguments.length<=1||void 0===arguments[1]||arguments[1];e=o()+e,this.record(e,"warn",t),l<=3&&console.warn(e)}},{key:"error",value:function(e){var t=arguments.length<=1||void 0===arguments[1]||arguments[1];e=o()+e,this.record(e,"error",t),l<=4&&console.error(e)}},{key:"setLevel",value:function(e){console.log(o()+"set level from "+l+" to "+e),l=e}},{key:"record",value:function(e,t,r){var i=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];h&&!0===r?this.report(e,t,i):h&&d&&"debug"!==t&&this.report(e,t,i)}},{key:"report",value:function(e,t,r){c++,e="["+c+"] "+e;var i={};i.project="yy-media-log-test",i.region="cn-shenzhen",i.logStore="webrtc_sdk",i.encode=0;var n=[],a={appid:this._appid,uid:this._uid,type:t,seqNum:c,msg:e}
;r&&(a=Object.assign(a,r)),n.push(a),i.content=n;var o=JSON.stringify(i);this._reportBuffLen>=2100&&(this._reportBuff.splice(0,100),this._reportBuffLen=2e3),this._reportBuffLen++,this._reportBuff.push(o)}},{key:"onDoReportTimer",value:function(){var e=this;if(h&&this._reportBuffLen>0&&this._canReport){var t=this._reportBuff.shift();t&&(this._reportBuffLen--,h.open("post","https://cloud-log.jocloud.com/api/log/put",!0),h.timeout=500,h.onload=function(){e._canReport=!0},h.ontimeout=function(){e._canReport=!0},h.onerror=function(){e._canReport=!0},h.send(t),this._canReport=!1)}}},{key:"getLog",value:function(){return this._data}},{key:"setUid",value:function(e){this._uid=e}},{key:"init",value:function(e){setInterval(this.onDoReportTimer.bind(this),100),this._appid=e}}],[{key:"disableReport",value:function(){h=null,d=!1}},{key:"enableReport",value:function(e){d=e;try{h=s()}catch(e){console.error("XMLHttpRequest is not available! err:"+e)}}},{key:"setGlobalReportAllLog",value:function(e){d=e}}]),e}();r.Logger=f;var p=function(){function e(){i(this,e),this.logger=new f}return u(e,[{key:"debug",value:function(e){this.logger.debug(e,!1)}},{key:"info",value:function(e){var t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];this.logger.info(e,t)}},{key:"gWarn",value:function(e){this.logger.warn(e,!0)}},{key:"gError",value:function(e){this.logger.error(e,!0)}},{key:"setLevel",value:function(e){this.logger.setLevel(e)}},{key:"setUid",value:function(e){this.logger.setUid(e)}}]),e}(),v=new p;r.default=v},{}],92:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i=0,n={now:function(){0===i&&(i=Date.now()-1);var e=Date.now()-i;return e>4294967295?(i+=4294967295,Date.now()-i):e},utc:function(){return Math.round(Date.now()/1e3)}};r.default=n,t.exports=r.default},{}],93:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e){var t=[],r=[];return function(i,n){if(t.length>0){var a=t.indexOf(this);~a?t.splice(a+1):t.push(this),~a?r.splice(a,1/0,i):r.push(i),~t.indexOf(n)&&(n="[Circular ~]")}else t.push(n);return e?e.call(this,i,n):n}}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=e("./../protobase/ProtoUInt64"),u=function(e){return e&&e.__esModule?e:{default:e}}(s),l=e("long"),h=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(l),c=function(){var e=function(){function e(){i(this,e)}return o(e,null,[{key:"inetNtoa",value:function(e){var t=new Uint8Array(4),r=new DataView(t.buffer);r.setUint32(0,e);var i=r.getUint8(0),n=r.getUint8(1),a=r.getUint8(2);return r.getUint8(3)+"."+a+"."+n+"."+i}},{key:"isBiggerUint",value:function(e,t){if(e===t)return!1;if(e>t){var r=e-t;return r<2147483647}var r=t-e;return!(r<2147483647)}},{key:"isEqualOrBiggerUint",value:function(e,t){if(e===t)return!0;if(e>t){var r=e-t;return r<2147483647}var r=t-e;return!(r<2147483647)}},{key:"isBiggerUint8",value:function(e,t){if(e===t)return!1;if(e>t){var r=e-t;return r<127}var r=t-e;return!(r<127)}},{key:"getUintMax",value:function(){return 4294967295}},{key:"isUintMax",value:function(e){return 4294967295===e}},{key:"getIntMax",value:function(){return 2147483647}},{key:"getIntMin",value:function(){return-1*this.getIntMax()}},{key:"isUint64Max",value:function(e){return 4294967295===e.high&&4294967295===e.low}},{key:"uint2ip",value:function(e){return(255&e)+"."+(e>>8&255)+"."+(e>>16&255)+"."+(e>>24&255)}},{key:"ip2uint",value:function(e){var t=e.split(".");return(parseInt(t[3])<<24)+(parseInt(t[2])<<16)+(parseInt(t[1])<<8)+parseInt(t[0])>>>0}},{key:"hashString",value:function(e){for(var t=4058174404,r=0;r<e.length;r++){t<<=1;t+=e.charCodeAt(r)}return t>>>0}},{key:"hashUid",value:function(e){for(var t=h.fromInt(0,!0),r=0;r<e.length;r++){t=t.multiply(31);var i=e.charCodeAt(r);t=t.add(i)}return t.getLowBitsUnsigned()}},{key:"number2ProtoUInt64",value:function(t){if(t<=e.getUintMax())return new u.default(0,t);var r=h.fromString(t.toString());return new u.default(r.high,r.low)}},{key:"stringfyMap",value:function(t){var r=e.map2Object(t);return JSON.stringify(r)}},{key:"map2Object",value:function(t){var r={},i=!0,n=!1,o=void 0;try{for(var s,u=t[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=a(s.value,2),h=l[0],c=l[1];e.isMap(c)?r[h]=e.map2Object(c):r[h]=c}}catch(e){n=!0,o=e}finally{try{!i&&u.return&&u.return()}finally{if(n)throw o}}return r}},{key:"isMap",value:function(e){return"map"==Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()}},{key:"objectEquals",value:function(t,r){if(t===r)return!0;if(!(t instanceof Object&&r instanceof Object))return!1;if(t.constructor!==r.constructor)return!1;for(var i in t)if(t.hasOwnProperty(i)){if(!r.hasOwnProperty(i))return!1;if(t[i]!==r[i]){if("object"!=typeof t[i])return!1;if(!e.objectEquals(t[i],r[i]))return!1}}for(var i in r)if(r.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0}},{key:"getBattery",value:function(){try{return navigator.getBattery().then(function(e){return 100*e.level})}catch(e){return Promise.reject(e)}}},{key:"is32BitNumberString",value:function(e){var t=4294967295&parseInt(e);return!isNaN(t)&&t.toString()===e}},{key:"isLocalHost",value:function(){return"localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)}},{key:"isHttps",value:function(){return"https:"===window.location.protocol}},{key:"isEmptyHostname",value:function(){return""===window.location.hostname}},{key:"isSafeAddress",value:function(){return e.isHttps()||e.isLocalHost()||e.isEmptyHostname()}},{key:"isTrack",value:function(e){return e instanceof MediaStreamTrack}},{key:"isNil",value:function(e){return null==e}},{key:"mediaErrorToString",value:function(e){switch(e.name){case"NotAllowedError":return"PERMISSION_DENIED";case"NotFoundError":return"DEVICE_NOT_FOUND";case"NotReadableError":return"DEVICE_NOT_READABLE";case"InvalidAccessError":return"INVALID_ACCESS_ERROR";default:return"DEVICE_ERROR"}}},{key:"isNaturalNumber",value:function(e){return Number.isInteger(e)&&e>=0}},{key:"stringify",value:function(e,t,r){return JSON.stringify(e,n(t),r)}},{key:"argToString",value:function(t){return"object"==typeof t||"string"==typeof t?e.stringify(t):""+t}},{key:"streamIdToString",value:function(e){return!e||0===e.low&&0===e.high?"":e.toString64()}}]),e}();return e.DualStreamSetVideoModeError="set video mode fail when publish dual stream",e}();r.default=c,t.exports=r.default},{"./../protobase/ProtoUInt64":21,long:98}],94:[function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e){var t=e.getVideoTracks()[0];if(!t)return null;var r=t.getSettings().width,i=t.getSettings().height,n=t.getSettings().frameRate;if("number"==typeof n&&0!==n||(n=15),void 0===r||void 0===i)return null;var a=document.createElement("canvas");a.width=r,a.height=i;var h=a.getContext("webgl");if(!h)return null;var d=o(h,h.VERTEX_SHADER,p.VSSource),f=o(h,h.FRAGMENT_SHADER,p.FSSource);if(null===d||null===f)return null;var v=s(h,d,f);if(null===v)return null;var m=h.getUniformLocation(v,"uSampler"),g=h.getUniformLocation(v,"brightness"),y=h.getUniformLocation(v,"smoothness");if(null===m||null===g||null===y)return null;var S=u(h);if(null===S.indices||null===S.position||null===S.textureCoord)return null;var b=l(h);if(null===b)return null;var _=a.captureStream(n).getVideoTracks()[0];return{canvas:a,gl:h,vertexShader:d,fragmentShader:f,program:v,texture:b,vertexPosition:h.getAttribLocation(v,"aVertexPosition"),textureCoord:h.getAttribLocation(v,"aTextureCoord"),sampler:m,uBrightness:g,uSmoothness:y,buffers:S,inputVideo:c(t),stream:e,inputTrack:t,outputTrack:_}}function a(e){e.gl.deleteProgram(e.program),e.gl.deleteBuffer(e.buffers.indices),e.gl.deleteBuffer(e.buffers.position),e.gl.deleteBuffer(e.buffers.textureCoord),e.gl.deleteShader(e.vertexShader),e.gl.deleteShader(e.fragmentShader)}function o(e,t,r){var i=e.createShader(t);return i?(e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(this.logger.warn("An error occurred compiling the shaders: "+e.getShaderInfoLog(i)),e.deleteShader(i),null)):null}function s(e,t,r){var i=e.createProgram();return i?(e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)?i:(this.logger.warn("Unable to initialize the shader program: "+e.getProgramInfoLog(i)),null)):null}function u(e){var t=[-1,-1,1,-1,1,1,-1,1],r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t),e.STATIC_DRAW);var i=[0,1,1,1,1,0,0,0],n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW);var a=[0,1,2,0,2,3],o=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),e.STATIC_DRAW),{position:r,textureCoord:n,indices:o}}function l(e){var t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),t}function h(e,t,r){e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}function c(e){var t=document.createElement("video");t.autoplay=!0,t.muted=!0;var r=new MediaStream;return r.addTrack(e),t.srcObject=r,t.play(),t}function d(e,t,r){var i=e.gl,n=e.buffers,a=e.vertexPosition,o=e.textureCoord,s=e.texture,u=e.program,l=e.sampler,h=e.uBrightness,c=e.uSmoothness;i.bindBuffer(i.ARRAY_BUFFER,n.position),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(a),i.bindBuffer(i.ARRAY_BUFFER,n.textureCoord),i.vertexAttribPointer(o,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(o),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n.indices),i.useProgram(u),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,s),i.uniform1i(l,0),i.uniform1f(h,t),i.uniform1f(c,r),i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}Object.defineProperty(r,"__esModule",{value:!0});var f=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),p=e("./shader"),v=function(){function e(t){i(this,e),this.logger=t,this.ctx=null,this.brightness=1,this.smoothness=1}return f(e,[{key:"enable",value:function(e){return!!this.ctx||(this.ctx=n(e),null!==this.ctx&&(this.ctx.inputVideo.addEventListener("playing",this.onSourcePlayed.bind(this)),!0))}},{key:"disable",value:function(){null!==this.ctx&&(a(this.ctx),this.ctx=null)}},{key:"enabled",value:function(){return null!==this.ctx}},{key:"updatePara",value:function(e){"object"==typeof e&&(e.brightness>100&&(e.brightness=100),e.brightness<0&&(e.brightness=0),e.smoothness>100&&(e.smoothness=100),e.smoothness<0&&(e.smoothness=0),this.brightness=e.brightness/100+.5,this.smoothness=.8*e.smoothness/100+.2)}},{key:"getInputTrack",value:function(){return this.ctx?this.ctx.inputTrack:null}},{key:"getOutputTrack",value:function(){return this.ctx?this.ctx.outputTrack:null}},{key:"getStream",value:function(){return this.ctx?this.ctx.stream:null}},{key:"onSourcePlayed",value:function(){var e=this;this.ctx&&function(){e.ctx.inputVideo.removeEventListener("playing",e.onSourcePlayed);var t=setInterval(function(){if(null===e.ctx)return void clearInterval(t);e.render()},33)}()}},{key:"render",value:function(){null!==this.ctx&&(h(this.ctx.gl,this.ctx.texture,this.ctx.inputVideo),d(this.ctx,this.brightness,this.smoothness))}}]),e}();r.VideoEffector=v},{"./shader":70}],95:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(e,t,r){for(var i=!0;i;){var n=e,a=t,o=r;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;if(void 0===u)return;return u.call(o)}var l=Object.getPrototypeOf(n);if(null===l)return;e=l,t=a,r=o,i=!0,s=l=void 0}},u=e("events"),l=e("./utils/logger"),h=i(l),c=e("./webrtcmgr"),d=i(c),f=e("./utils/browser"),p=i(f),v=e("./utils/utils"),m=i(v),g=e("./constant"),y=i(g),S=e("./DeviceMgr"),b=i(S),_=function(){var e=function(e){function t(e){var r=this;n(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.webRTCMgr=null,this.browserType=p.default.name+"_ver."+p.default.major,this.kernelType=p.default.kernel.name+"_ver."+p.default.kernel.major,this.systemInfo=p.default.os.name+"_ver."+p.default.os.version,this.deviceModel=""+(p.default.os.brand||""),this.logger=new l.Logger,this.version=2010152e3,this.git="1122398",this.sdkVersion=t.VERSION,this.config=e||{},this.muteState={video:!1,audio:!1},this.deviceMgr=new b.default(this),this.triggerNotReportList=new Set,this.triggerNotReportList.add("network_score"),this.triggerNotReportList.add("video_track_end"),this.triggerNotReportList.add("audio_track_end"),this.triggerNotReportList.add("video_track_mute"),this.triggerNotReportList.add("audio_track_mute"),this.triggerNotReportList.add("video_track_unmute"),this.triggerNotReportList.add("audio_track_unmute"),document.addEventListener("visibilitychange",function(){r.webRTCMgr&&r.webRTCMgr.reportUserEventMgr&&r.webRTCMgr.reportUserEventMgr.hasSetUserInfo&&(r.logger.debug("trigger visibilitychange event, visibilityState:"+document.visibilityState,!0),"hidden"===document.visibilityState?r.webRTCMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_INFO,"room","enter_background"):"visible"===document.visibilityState&&r.webRTCMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_INFO,"room","enter_foreground")),r.webRTCMgr&&(r.webRTCMgr.subscriberMgr.onVisibilityChange("visible"===document.visibilityState),r.webRTCMgr.publisherMgr.onVisibilityChange("visible"===document.visibilityState))}),window.addEventListener("beforeunload",function(){r.webRTCMgr&&!r.webRTCMgr.isChannelStatusInit()&&(r.logger.warn("trigger beforeunload event, leave room"),r.webRTCMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_WARN,"room","shutdown_window"),r.webRTCMgr.leaveChannel())})}return a(t,e),o(t,[{key:"init",value:function(e){if(!Number.isInteger(e)||e<=0){var t="INVALID_APPID";return this.logger.error("WebRTC.init fail:"+t+" appid:"+e),{error:t}}if(this.webRTCMgr){var t="ALREADY_INIT";return this.logger.error("WebRTC.init fail:"+t),{error:t}}this.logger.init(e),this.logApi("init",e);var r="H264";return this.config.codec&&"VP8"===this.config.codec.toUpperCase()&&(r="VP8"),this.webRTCMgr=new d.default(e,r,this),null}},{key:"destroy",value:function(){return this.webRTCMgr?(this.logApi("destroy"),this.webRTCMgr.destroy(),this.webRTCMgr=null,null):{error:"HAS_NOT_INIT"}}},{key:"trigger",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];if(this.emit.apply(this,[e,e].concat(r)),this.triggerNotReportList.has(e))return void this.logger.debug("trigger event:"+e+", data:"+JSON.stringify(r));this.logger.debug("trigger event:"+e+", data:"+JSON.stringify(r),!0)}},{key:"setArea",value:function(e){var t=this;return this.logApi("setArea",e),this.run("setArea",function(){return"number"!=typeof e||0!==e&&1!==e&&2!==e?{error:"INVALID_AREA"}:(t.webRTCMgr.userArea=e,t.webRTCMgr.reportUserEventMgr.setHostByUserArea(e),null)})}},{key:"checkRoomId",value:function(e){return null!==e&&void 0!==e&&!(!/^[A-Za-z0-9_-]+$/.test(e)||e.length>64)}},{key:"checkUid",value:function(e){return"string"==typeof e&&!(!/^[A-Za-z0-9_-]+$/.test(e)||e.length>64)}},{key:"checkTaskId",value:function(e){return"string"==typeof e&&!(!/^[A-Za-z0-9_-]+$/.test(e)||e.length>20)}},{key:"checkUrl",value:function(e){return!("string"!=typeof e||!e.length||e.length>512)}},{key:"joinRoom",value:function(e){var t=this;return this.logApi("joinRoom"),this.asyncRun("joinRoom",function(){if(!e)return t.rejectWithEvent("join_room_fail","INVALID_PARAM");t.logger.setUid(e.uid),h.default.setUid(e.uid),t.logger.warn("WebRTC.joinRoom version:"+t.version+", git:"+t.git+", sdkVersion:"+t.sdkVersion+", browswer: "+p.default.name+"/"+p.default.version+"@"+p.default.kernel.name+"/"+p.default.kernel.version),t.logger.debug("UA: "+navigator.userAgent,!0);var r=e.uid,i=e.roomId,n=e.token||"",a=e.mode;if("string"!=typeof i||!t.checkRoomId(i))return t.logger.error("WebRTC.joinRoom fail:Input roomId Invalid: "+i,!0),t.rejectWithEvent("join_room_fail","INVALID_ROOM_ID");if(!t.checkUid(r))return t.logger.error("WebRTC.joinRoom fail:Input uid Invalid: "+r,!0),t.rejectWithEvent("join_room_fail","INVALID_UID");if(void 0===a&&(a=1),0!==a&&1!==a){var o="INVALID_MODE";return t.logger.error("Webrtc.joinRoom fail:"+o+", mode:"+a,!0),t.rejectWithEvent("join_room_fail",o)}if("string"!=typeof n){var o="INVALID_TOKEN";return t.logger.error("Webrtc.joinRoom fail:"+o+", token:"+n,!0),t.rejectWithEvent("join_room_fail",o)}return t.logger.info("Webrtc.joinRoom uid:"+r+" roomId:"+i+" mode:"+a+", codec:"+t.webRTCMgr.pubCodec,!0),t.webRTCMgr.joinChannel(i,r,n,a).then(function(e){return t.trigger("join_room_succ",e),e.uid}).catch(function(e){return t.rejectWithEvent("join_room_fail",e)})})}},{key:"leaveRoom",value:function(){var e=this;return this.logApi("leaveRoom"),this.run("leaveRoom",function(){var t=e.webRTCMgr.channelId,r=e.webRTCMgr.uidStr,i=e.webRTCMgr.leaveChannel();return i?(e.trigger("leave_room_fail",i),i):(e.trigger("leave_room_succ",{uid:r,roomId:t}),null)})}},{key:"createStream",value:function(e){var t=this;return this.logApi("createStream",e),this.asyncRun("createStream",function(){return t.webRTCMgr.publisherMgr.createStream(e)})}},{key:"createDualStream",value:function(e){var t=this;return this.logApi("createDualStream",e),this.asyncRun("createDualStream",function(){return p.default.os.isIOS?Promise.reject("NOT_SUPPORTED"):(t.webRTCMgr.publisherMgr.dualEnabled=!0,t.webRTCMgr.publisherMgr.createStream(e).then(function(e){return t.webRTCMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_INFO,"room","anchor_big_small_stream_enable"),e}).catch(function(e){return t.webRTCMgr.publisherMgr.dualEnabled=!1,Promise.reject(e)}))})}},{key:"enableDualStream",value:function(e){var t=this;return this.logApi("enableDualStream",e),this.asyncRun("enableDualStream",function(){return p.default.os.isIOS?Promise.reject("NOT_SUPPORTED"):t.webRTCMgr.publisherMgr.dualEnabled?Promise.reject("HAS_ENABLE_DUAL_STREAM"):(t.webRTCMgr.publisherMgr.dualEnabled=!0,t.webRTCMgr.publisherMgr.enableDualStream(e).then(function(){t.webRTCMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_INFO,"room","anchor_big_small_stream_enable")}).catch(function(e){return t.webRTCMgr.publisherMgr.dualEnabled=!1,Promise.reject(e)}))})}},{key:"disableDualStream",value:function(){var e=this;this.logApi("disableDualStream");var t=this.run("disableDualStream",function(){return e.webRTCMgr.publisherMgr.dualEnabled?(e.webRTCMgr.publisherMgr.dualEnabled=!1,e.webRTCMgr.publisherMgr.disableDualStream()):{error:"HAS_NOT_ENABLE_DUAL_STREAM"}});return t||this.webRTCMgr.reportUserEventMgr.addEvent(l.LOGLEVEL_INFO,"room","anchor_big_small_stream_disable"),t}},{key:"closeStream",value:function(){var e=this;return this.logApi("closeStream"),this.run("closeStream",function(){return e.webRTCMgr.publisherMgr.closeStream()})}},{key:"publish",value:function(){var e=this;return this.logApi("publish"),this.asyncRun("publish",function(){return e.webRTCMgr.publisherMgr.publish().then(function(){e.trigger("publish_stream_succ",{roomId:e.webRTCMgr.channelId,uid:e.webRTCMgr.uidStr})}).catch(function(t){return e.rejectWithEvent("publish_stream_fail",t)})})}},{key:"unpublish",value:function(){var e=this;this.logApi("unpublish");var t=this.run("unpublish",function(){return e.webRTCMgr.publisherMgr.unPublish()});return t?this.trigger("unpublish_stream_fail",t):this.trigger("unpublish_stream_succ",{roomId:this.webRTCMgr.channelId,uid:this.webRTCMgr.uidStr}),t}},{key:"unpublishLowStream",value:function(){var e=this;return this.asyncRun("unpublishLowStream",function(){return e.webRTCMgr.publisherMgr.destroyPublisher(1)})}},{key:"previewMedia",value:function(e){var t=this;return this.createStream(e).catch(function(e){return t.rejectWithEvent("preview_stream_fail",e)})}},{key:"stopPreviewMedia",value:function(){return this.closeStream()}},{key:"subscribe",value:function(e,t){var r=this;return this.logApi("subscribe",e,t),this.asyncRun("subscribe",function(){if(!e||"object"!=typeof e||"string"!=typeof e.uid)return r.rejectWithEvent("subscribe_stream_fail","INVALID_PARAM");if(t){if("object"!=typeof t||"boolean"!=typeof t.video||"boolean"!=typeof t.audio)return r.rejectWithEvent("subscribe_stream_fail","INVALID_PARAM");if(void 0!==t.lowStream&&"boolean"!=typeof t.lowStream)return r.rejectWithEvent("subscribe_stream_fail","INVALID_PARAM");if(!1===t.video&&!1===t.audio)return r.rejectWithEvent("subscribe_stream_fail","SUBSCRIBE_NONE")}return r.webRTCMgr.subscriberMgr.subscribe(e.uid,t).catch(function(e){return r.rejectWithEvent("subscribe_stream_fail",e)})})}},{key:"unsubscribe",value:function(e){var t=this;return this.logApi("unsubscribe",e),this.asyncRun("unsubscribe",function(){var r=void 0;if(e&&e.uid&&(r=e.uid),"string"!=typeof r)return t.rejectWithEvent("unsubscribe_stream_fail","INVALID_PARAM");var i=t.webRTCMgr.subscriberMgr.unsubscribe(r);return i?t.rejectWithEvent("unsubscribe_stream_fail",i.error):Promise.resolve()})}},{key:"addPublishOriginStreamUrl",value:function(e){var t=this;return this.logApi("addPublishOriginStreamUrl",e),this.run("addPublishOriginStreamUrl",function(){return t.checkUrl(e)?t.webRTCMgr.addPublishOriginStreamUrl(e):(t.logger.error("WebRTC.addPublishOriginStreamUrl fail:Input url Invalid: "+e),{error:"INVALID_URL"})})}},{key:"removePublishOriginStreamUrl",value:function(e){var t=this;return this.logApi("removePublishOriginStreamUrl",e),this.run("removePublishOriginStreamUrl",function(){return t.checkUrl(e)?t.webRTCMgr.removePublishOriginStreamUrl(e):(t.logger.error("WebRTC.removePublishOriginStreamUrl fail:Input url Invalid: "+e),{error:"INVALID_URL"})})}},{key:"addPublishTranscodingStreamUrl",value:function(e,t){var r=this;return this.logApi("addPublishTranscodingStreamUrl",e,t),this.run("addPublishTranscodingStreamUrl",function(){return r.checkTaskId(e)?r.checkUrl(t)?r.webRTCMgr.addPublishTranscodingStreamUrl(e,t):(r.logger.error("WebRTC.addPublishTranscodingStreamUrl fail:Input url Invalid: "+t),{error:"INVALID_URL"}):(r.logger.error("WebRTC.addPublishTranscodingStreamUrl fail:Input taskId Invalid: "+e),{error:"INVALID_TASK_ID"})})}},{key:"removePublishTranscodingStreamUrl",value:function(e,t){var r=this;return this.logApi("removePublishTranscodingStreamUrl",e,t),this.run("removePublishTranscodingStreamUrl",function(){return r.checkTaskId(e)?r.checkUrl(t)?r.webRTCMgr.removePublishTranscodingStreamUrl(e,t):(r.logger.error("WebRTC.removePublishTranscodingStreamUrl fail:Input url Invalid: "+t),{error:"INVALID_URL"}):(r.logger.error("WebRTC.removePublishTranscodingStreamUrl fail:Input taskId Invalid: "+e),{error:"INVALID_TASK_ID"})})}},{key:"setLiveTranscodingTask",value:function(e,t){var r=this;return this.logApi("setLiveTranscodingTask",e,t),this.run("setLiveTranscodingTask",function(){return r.checkTaskId(e)?r.webRTCMgr.setLiveTranscodingTask(e,t):(r.logger.error("WebRTC.setLiveTranscodingTask fail:Input taskId Invalid: "+e),{error:"INVALID_TASK_ID"})})}},{key:"removeLiveTranscodingTask",value:function(e){var t=this;return this.logApi("removeLiveTranscodingTask",e),this.run("removeLiveTranscodingTask",function(){return t.checkTaskId(e)?t.webRTCMgr.removeLiveTranscodingTask(e):(t.logger.error("WebRTC.removeLiveTranscodingTask fail:Input taskId Invalid: "+e),{error:"INVALID_TASK_ID"})})}},{key:"addSubscribe",value:function(e,t){var r=this;return this.logApi("addSubscribe",e,t),this.run("addSubscribe",function(){return r.checkUid(t)?"string"==typeof e&&e.length?r.webRTCMgr.addSubscribe(e,t):(r.logger.error("WebRTC.addSubscribe fail:Input roomId Invalid: "+e),{error:"INVALID_ROOM_ID"}):(r.logger.error("WebRTC.addSubscribe fail:Input uid Invalid: "+e),{uid:t,error:"INVALID_UID"})})}},{key:"removeSubscribe",value:function(e,t){var r=this;return this.logApi("removeSubscribe",e,t),this.run("removeSubscribe",function(){return r.checkUid(t)?"string"==typeof e&&e.length?r.webRTCMgr.removeSubscribe(e,t):(r.logger.error("WebRTC.removeSubscribe fail:Input roomId Invalid: "+e),{error:"INVALID_ROOM_ID"}):(r.logger.error("WebRTC.removeSubscribe fail:Input uid Invalid: "+e),{uid:t,error:"INVALID_UID"})})}},{key:"updateToken",value:function(e){var t=this;return this.logApi("updateToken"),this.run("updateToken",function(){return"string"!=typeof e||""===e?{error:"INVALID_TOKEN"}:(t.webRTCMgr.token=e,t.webRTCMgr.checkSendUpdateToken(e))})}},{key:"startAudioMixing",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1];return this.logApi("startAudioMixing",e,r),this.asyncRun("startAudioMixing",function(){return t.checkMixParam(e)?t.isValidMixId(r)?t.webRTCMgr.startMixing(r,e).catch(function(e){return t.trigger("start_mixing_fail",{error:e}),Promise.reject(e)}):t.rejectWithEvent("start_mixing_fail","INVALID_MIX_ID"):t.rejectWithEvent("start_mixing_fail","INVALID_PARAM")})}},{key:"stopAudioMixing",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?0:arguments[0];return this.logApi("stopAudioMixing",t),this.run("stopAudioMixing",function(){if(!e.isValidMixId(t))return{error:"INVALID_MIX_ID"};var r=e.getMixer();return r?r.stopMixing(t):{error:"MIX_AUDIO_NOT_EXISTED"}})}},{key:"pauseAudioMixing",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?0:arguments[0];return this.logApi("pauseAudioMixing",t),this.run("pauseAudioMixing",function(){if(!e.isValidMixId(t))return{error:"INVALID_MIX_ID"};var r=e.getMixer();return r?r.pause(t):{error:"MIX_AUDIO_NOT_EXISTED"}})}},{key:"resumeAudioMixing",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?0:arguments[0];return this.logApi("resumeAudioMixing",t),this.run("resumeAudioMixing",function(){if(!e.isValidMixId(t))return{error:"INVALID_MIX_ID"};var r=e.getMixer();return r?r.resume(t):{error:"MIX_AUDIO_NOT_EXISTED"}})}},{key:"setAudioMixingVolume",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1];return this.logApi("setAudioMixingVolume",e,r),this.run("setAudioMixingVolume",function(){if(!t.isValidMixId(r))return{error:"INVALID_MIX_ID"};if(!t.isValidVolume(e))return{error:"INVALID_VOLUME"};var i=t.getMixer();return i?i.setVolume(r,e):{error:"MIX_AUDIO_NOT_EXISTED"}})}},{key:"getAudioMixingDuration",value:function(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0];this.logApi("getAudioMixingDuration",e);var t=this.getMixer();return t&&this.isValidMixId(e)?t.getDuration(e):0}},{key:"getAudioMixingTime",value:function(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0],t=this.getMixer();return t&&this.isValidMixId(e)?t.getCurrentTime(e):0}},{key:"setAudioMixingTime",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1];return this.logApi("setAudioMixingTime",e,r),this.run("setAudioMixingTime",function(){if(h.default.info("WebRTC.setAudioMixingTime "+e),!t.isValidMixId(r))return{error:"INVALID_MIX_ID"};if("number"!=typeof e||e<0)return{error:"INVALID_TIME"};var i=t.getMixer();return i?i.setCurrentTime(r,e):{error:"MIX_AUDIO_NOT_EXISTED"}})}},{key:"stopAllAudioMixing",value:function(){var e=this;return this.logApi("stopAllAudioMixing"),this.run("stopAllAudioMixing",function(){var t=e.getMixer();return t?(t.getAllIds().forEach(function(e){t.stopMixing(e)}),null):null})}},{key:"pauseAllAudioMixing",value:function(){var e=this;return this.logApi("pauseAllAudioMixing"),this.run("pauseAllAudioMixing",function(){var t=e.getMixer();return t?(t.getAllIds().forEach(function(e){t.pause(e)}),null):null})}},{key:"resumeAllAudioMixing",value:function(){var e=this;return this.logApi("resumeAllAudioMixing"),this.run("resumeAllAudioMixing",function(){var t=e.getMixer();return t?(t.getAllIds().forEach(function(e){t.resume(e)}),null):null})}},{key:"isValidVolume",value:function(e){return"number"==typeof e&&e>=0&&e<=100}},{key:"isValidMixId",value:function(e){return"number"==typeof e&&e>=0&&e<1e4}},{key:"checkMixParam",value:function(e){return"object"!=typeof e?(this.logger.error("MixParam must be object"),!1):void 0!==e.local&&"boolean"!=typeof e.local?(this.logger.error("MixParam.local must be boolean"),!1):void 0!==e.url&&"string"!=typeof e.url?(this.logger.error("MixParam.url must be string"),!1):void 0!==e.cycle&&"number"!=typeof e.cycle?(this.logger.error("MixParam.cycle must be number"),!1):void 0!==e.loop&&"boolean"!=typeof e.loop?(this.logger.error("MixParam.loop must be boolean"),!1):void 0!==e.playTime&&"number"!=typeof e.playTime?(this.logger.error("MixParam.playTime must be number"),!1):void 0===e.replace||"boolean"==typeof e.replace||(this.logger.error("MixParam.replace must be boolean"),!1)}},{key:"getMixer",value:function(){try{return this.webRTCMgr.publisherMgr.publishers.get(0).getMixer()}catch(e){return null}}},{key:"setPublisherVolume",value:function(e){var t=this;return this.logApi("setPublisherVolume",e),this.run("setPublisherVolume",function(){return h.default.info("WebRTC.setPublishVolume "+e),"number"!=typeof e?(t.logger.error("volume must be number"),{error:"INVALID_VOLUME"}):e<0||e>100?(t.logger.error("volume must be 0 ~ 100"),{error:"INVALID_VOLUME"}):t.webRTCMgr.setPublisherVolume(e)})}},{key:"getPublisherAudioLevel",value:function(){return this.webRTCMgr?this.webRTCMgr.getPublisherAudioLevel():0}},{key:"getSubscriberAudioLevel",value:function(e){var t=String(e);return this.webRTCMgr?this.webRTCMgr.getSubscriberAudioLevel(t):0}},{key:"changeRemoteVideoStreamType",value:function(e,t){var r=this;return this.logApi("changeRemoteVideoStreamType",e,t),this.asyncRun("changeRemoteVideoStreamType",function(){return r.logger.info("WebRTC.changeRemoteVideoStreamType speakerUid: "+e+" videoStreamType: "+t,!0),r.webRTCMgr.setRemoteVideoLayer(e,t)})}},{key:"setAudioMode",value:function(e){var t=this;return this.logApi("setAudioMode",e),this.run("setAudioMode",function(){return t.webRTCMgr.publisherMgr.setAudioMode(e)})}},{key:"setVideoMode",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1];return this.logApi("setVideoMode",e,r),
this.asyncRun("setVideoMode",function(){return"number"!=typeof e?Promise.reject("INVALID_VIDEO_MODE"):m.default.isNaturalNumber(r)?t.webRTCMgr.publisherMgr.setVideoMode(e,r):Promise.reject("INVALID_LAYER")}).then(function(e){return t.resolveWithEvent("set_video_mode_succ",e)}).catch(function(e){return t.rejectWithEvent("set_video_mode_fail",e)})}},{key:"setVideoEncoderConfig",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1];return this.logApi("setVideoEncoderConfig",e,r),this.asyncRun("setVideoEncoderConfig",function(){return m.default.isNaturalNumber(r)?t.webRTCMgr.publisherMgr.setVideoEncoderConfig(e,r):Promise.reject("INVALID_LAYER")})}},{key:"changeDevice",value:function(e,t){var r=this;return this.logApi("changeDevice",e,t),this.asyncRun("changeDevice",function(){return"audio"!==e&&"video"!==e?r.rejectWithEvent("change_device_fail","INVALID_DEVICE_KIND"):"string"!=typeof t?r.rejectWithEvent("change_device_fail","INVALID_DEVICE_ID"):r.webRTCMgr.publisherMgr.changeDevice(e,t).then(function(i){return r.trigger("change_device_succ",{kind:e,deviceId:t}),i}).catch(function(i){return r.trigger("change_device_fail",{kind:e,deviceId:t,error:i}),Promise.reject(i)})})}},{key:"getUplinkVideoStats",value:function(){return this.webRTCMgr?this.webRTCMgr.getUplinkVideoStats():{}}},{key:"getUplinkAudioStats",value:function(){return this.webRTCMgr?this.webRTCMgr.getUplinkAudioStats():{}}},{key:"getDownlinkVideoStats",value:function(){return this.webRTCMgr?this.webRTCMgr.getDownlinkVideoStats():{}}},{key:"getDownlinkAudioStats",value:function(){return this.webRTCMgr?this.webRTCMgr.getDownlinkAudioStats():{}}},{key:"getSignalConnectionState",value:function(){if(this.webRTCMgr)return this.webRTCMgr.getSignalConnectionState();return this.logger.error("WebRTC.getSignalConnectionState fail:HAS_NOT_INIT",!0),{err:{error:"HAS_NOT_INIT"}}}},{key:"getMediaConnectionState",value:function(){if(this.webRTCMgr)return this.webRTCMgr.getMediaConnectionState();return this.logger.error("WebRTC.getMediaConnectionState fail:HAS_NOT_INIT",!0),{err:{error:"HAS_NOT_INIT"}}}},{key:"getSessionStats",value:function(){if(this.webRTCMgr)return this.webRTCMgr.getSessionStats();return this.logger.error("WebRTC.getSessionStats fail:HAS_NOT_INIT",!0),{err:{error:"HAS_NOT_INIT"}}}},{key:"enableBeauty",value:function(e){var t=this;return this.asyncRun("enableBeauty",function(){if("object"==typeof e){if("number"!=typeof e.brightness||"number"!=typeof e.smoothness)return Promise.reject("INVALID_PARAM")}else if(void 0!==e)return Promise.reject("INVALID_PARAM");return t.webRTCMgr.publisherMgr.enableBeauty(!0,e)})}},{key:"disableBeauty",value:function(){var e=this;return this.asyncRun("disableBeauty",function(){return e.webRTCMgr.publisherMgr.enableBeauty(!1)})}},{key:"play",value:function(e,t,r){var i=this;return this.logApi("play",e,t,r),this.asyncRun("play",function(){if(!i.checkUid(e))return Promise.reject("INVALID_UID");var n=void 0;if("string"==typeof t?n=document.getElementById(t):t instanceof HTMLElement&&(n=t),!n)return Promise.reject("INVALID_ELEMENT");if(r){if(void 0!==r.fit&&"cover"!==r.fit&&"contain"!==r.fit&&"fill"!==r.fit)return Promise.reject("INVALID_PLAY_OPTION");if(void 0!==r.mirror&&"boolean"!=typeof r.mirror)return Promise.reject("INVALID_PLAY_OPTION");if(void 0!==r.muted&&"boolean"!=typeof r.muted)return Promise.reject("INVALID_PLAY_OPTION");if(void 0!==r.backgroundColor&&"string"!=typeof r.backgroundColor)return Promise.reject("INVALID_BACKGROUND_COLOR")}return i.webRTCMgr.play(e,n,r)})}},{key:"stopPlay",value:function(e){var t=this;return this.logApi("stopPlay",e),this.run("stopPlay",function(){return t.checkUid(e)?t.webRTCMgr.stopPlay(e):{error:"INVALID_UID"}})}},{key:"resume",value:function(e){var t=this;return this.logApi("resume",e),this.asyncRun("resume",function(){return t.checkUid(e)?t.webRTCMgr.resume(e):Promise.reject("INVALID_UID")})}},{key:"setAudioOutputDevice",value:function(e,t){var r=this;return this.logApi("setAudioOutputDevice",e,t),this.asyncRun("setAudioOutputDevice",function(){return r.checkUid(e)?"string"!=typeof t||""===t?Promise.reject("INVALID_DEVICE_ID"):void 0===b.default.audioOutputs.get(t)?Promise.reject("INVALID_DEVICE_ID"):r.webRTCMgr.setAudioOutputDevice(e,t):Promise.reject("INVALID_UID")})}},{key:"disableAudio",value:function(e){var t=this;return this.logApi("disableAudio",e),this.run("disableAudio",function(){return void 0===e||t.checkUid(e)?t.webRTCMgr.setAudioEnableStatus(!1,e):{error:"INVALID_UID"}})}},{key:"enableAudio",value:function(e){var t=this;return this.logApi("enableAudio",e),this.run("enableAudio",function(){return void 0===e||t.checkUid(e)?t.webRTCMgr.setAudioEnableStatus(!0,e):{error:"INVALID_UID"}})}},{key:"disableVideo",value:function(e){var t=this;return this.logApi("disableVideo",e),this.run("disableVideo",function(){return void 0===e||t.checkUid(e)?t.webRTCMgr.setVideoEnableStatus(!1,e):{error:"INVALID_UID"}})}},{key:"enableVideo",value:function(e){var t=this;return this.logApi("enableVideo",e),this.run("enableVideo",function(){return void 0===e||t.checkUid(e)?t.webRTCMgr.setVideoEnableStatus(!0,e):{error:"INVALID_UID"}})}},{key:"setAudioVolume",value:function(e,t){var r=this;return this.logApi("setAudioVolume",e,t),this.run("setAudioVolume",function(){return r.checkUid(e)?p.default.os.isIOS?{error:"IOS_NOT_SUPPORTED"}:"number"!=typeof t||t<0||t>100?{error:"INVALID_VOLUME"}:r.webRTCMgr.setAudioVolume(e,t/100):{error:"INVALID_UID"}})}},{key:"hasAudio",value:function(e){return!(!this.checkUid(e)||!this.webRTCMgr)&&this.webRTCMgr.hasAudio(e)}},{key:"hasVideo",value:function(e){return!(!this.checkUid(e)||!this.webRTCMgr)&&this.webRTCMgr.hasVideo(e)}},{key:"isPlaying",value:function(e){return!(!this.checkUid(e)||!this.webRTCMgr)&&this.webRTCMgr.isPlaying(e)}},{key:"enableAudioLevelReport",value:function(){var e=this;return this.logApi("enableAudioLevelReport"),this.run("enableAudioLevelReport",function(){return e.webRTCMgr.audioLevelReporter.enableIntervalReport()})}},{key:"disableAudioLevelReport",value:function(){var e=this;return this.logApi("disableAudioLevelReport"),this.run("disableAudioLevelReport",function(){return e.webRTCMgr.audioLevelReporter.disableIntervalReport()})}},{key:"addTrack",value:function(e){var t=this;return this.logApi("addTrack",e),this.asyncRun("addTrack",function(){return m.default.isTrack(e)?t.webRTCMgr.publisherMgr.operateTrack(e,"add"):Promise.reject("INVALID_TRACK")})}},{key:"removeTrack",value:function(e){var t=this;return this.logApi("removeTrack",e),this.asyncRun("removeTrack",function(){return m.default.isTrack(e)?t.webRTCMgr.publisherMgr.operateTrack(e,"remove"):Promise.reject("INVALID_TRACK")})}},{key:"replaceTrack",value:function(e,t){var r=this;return this.logApi("replaceTrack",e,t),this.asyncRun("replace",function(){return m.default.isTrack(e)?t&&!m.default.isTrack(t)?Promise.reject("INVALID_OLD_SOURCE_TRACK"):r.webRTCMgr.publisherMgr.operateTrack(e,"replace",t):Promise.reject("INVALID_TRACK")})}},{key:"getVideoTrack",value:function(e){return this.getTrack("video",e)}},{key:"getAudioTrack",value:function(e){return this.getTrack("audio",e)}},{key:"getTrack",value:function(e,t){if(this.webRTCMgr&&(void 0===t||this.checkUid(t)))return this.webRTCMgr.getTrack(e,t)}},{key:"run",value:function(e,t){var r=null;return r=this.webRTCMgr?t():{error:"HAS_NOT_INIT"},r&&this.logger.error("WebRTC."+e+"() fail: "+r.error),r}},{key:"asyncRun",value:function(e,t){var r=this;return Promise.resolve().then(function(){if(!r.webRTCMgr)return Promise.reject("HAS_NOT_INIT")}).then(t).catch(function(t){return r.logger.error("WebRTC."+e+"() fail: "+t),Promise.reject({error:t})})}},{key:"resolveWithEvent",value:function(e,t){return this.trigger(e,t),Promise.resolve(t)}},{key:"rejectWithEvent",value:function(e,t){return this.trigger(e,{error:t}),Promise.reject(t)}},{key:"off",value:function(e,t){return this.removeListener(e,t)}},{key:"logApi",value:function(e){for(var t=[],r=arguments.length,i=Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];i.forEach(function(e){t.push(m.default.argToString(e))}),this.logger.info("WebRTC."+e+"("+t.join(",")+")",!0)}}],[{key:"enableReport",value:function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];l.Logger.enableReport(e)}},{key:"disableReport",value:function(){l.Logger.disableReport()}},{key:"isSupported",value:function(){return p.default.isSupported()}},{key:"isScreenShareSupported",value:function(){try{return t.isSupported()&&!!navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getDisplayMedia&&!p.default.os.isMobile}catch(e){return!1}}},{key:"getSupportedCodec",value:function(){var e={audio:[],video:[]};if(t.isSupported()){var r=function(){var t=void 0;try{t=new window.RTCPeerConnection({sdpSemantics:"unified-plan"})}catch(t){return{v:Promise.resolve(e)}}return t.addTransceiver("audio",{direction:"sendonly"}),t.addTransceiver("video",{direction:"sendonly"}),{v:t.createOffer().then(function(r){return r.sdp.match(/ opus/i)&&e.audio.push("OPUS"),r.sdp.match(/ VP8/i)&&e.video.push("VP8"),r.sdp.match(/ H264/i)&&e.video.push("H264"),t.close(),Promise.resolve(e)}).catch(function(){return t.close(),Promise.resolve(e)})}}();if("object"==typeof r)return r.v}return Promise.resolve(e)}},{key:"getSystemStats",value:function(){var e={system:p.default.os.name+"_ver."+p.default.os.version,browser:p.default.name+"."+p.default.major+"("+p.default.kernel.name+"."+p.default.kernel.major+")",isMobile:p.default.os.isMobile};return m.default.getBattery().then(function(t){return e.battery=t,e}).catch(function(){return e.battery=void 0,e})}},{key:"getDevices",value:function(){return b.default.getDevices()}},{key:"getAudioDevices",value:function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];return b.default.getAudioDevices(e)}},{key:"getPlayoutDevices",value:function(){return b.default.getPlayoutDevices()}},{key:"getVideoDevices",value:function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];return b.default.getVideoDevices(e)}},{key:"setLogLevel",value:function(e){return"number"!=typeof e?{error:"LOG_LEVEL_MUST_BE_NUMBER"}:(h.default.setLevel(e),null)}},{key:"detectDevice",value:function(e,t){return b.default.detectDevice(e,t)}},{key:"VERSION",get:function(){return"2.6.0"}}]),t}(u.EventEmitter);return e.DEBUG=l.LOGLEVEL_DEBUG,e.INFO=l.LOGLEVEL_INFO,e.WARN=l.LOGLEVEL_WARN,e.ERROR=l.LOGLEVEL_ERROR,e.NONE=l.LOGLEVEL_NONE,e.browser=p.default,e.Constant=y.default,e}();p.default.os.isAndroid&&_.getSupportedCodec().then(function(){}).catch(),r.default=_,t.exports=r.default},{"./DeviceMgr":2,"./constant":10,"./utils/browser":90,"./utils/logger":91,"./utils/utils":93,"./webrtcmgr":96,events:97}],96:[function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a,o=function(){function e(e,t){var r=[],i=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);i=!0);}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=e("./webrtc"),l=i(u),h=e("./utils/logger"),c=i(h),d=e("./socket.io"),f=i(d),p=e("./publisherMgr"),v=i(p),m=e("./subscriberMgr"),g=i(m),y=e("./utils/timeUtil"),S=i(y),b=e("./protocol/PLiveLoginAvpProxy"),_=i(b),E=e("./protobase/uri"),T=i(E),I=e("./protocol/PLiveAvpPing"),R=i(I),A=e("./protocol/PLiveAvpPingRes"),k=i(A),P=e("./protocol/PLiveLoginAvpProxyRes"),M=i(P),C=e("./utils/utils"),w=i(C),U=e("./protobase/ProtoUnmarshall"),O=i(U),L=e("./protocol/PLiveNotifyStreamStatus"),N=i(L),D=e("./protocol/PLiveNotifyPublishStatusRes"),V=i(D),x=e("./protocol/PLiveStopStream"),K=i(x),j=e("./protocol/PWebRTCAnswer"),B=i(j),F=e("./protocol/PWebRTCCandidateRes"),H=i(F),Y=e("./protocol/PLiveSubscribeRes"),W=i(Y),G=e("./protocol/PLiveUpdateToken"),z=i(G),X=e("./protocol/PLiveBizAuthResNotify"),q=i(X),J=e("./protocol/PLiveSdkAuthResNew"),Q=i(J),Z=e("./protocol/PWebRTCEvent"),$=i(Z),ee=e("./protocol/PWebRTCLayerRes"),te=i(ee),re=e("./StreamSvr"),ie=i(re),ne=e("./protocol/PLiveUserBroadCastData"),ae=i(ne),oe=e("./ProfileMgr"),se=e("./stat/ReportUserEventMgr"),ue=i(se),le=e("./utils/AudioLevelReporter"),he=i(le),ce=i(C),de=e("./utils/browser"),fe=i(de),pe=e("./AdvanceConfig");r.AVP_CONN_STATUS=a,function(e){e[e.INIT=0]="INIT",e[e.CONNECTING=2]="CONNECTING",e[e.CONNECTED=3]="CONNECTED",e[e.LOGIN=4]="LOGIN",e[e.DISCONNECTED=5]="DISCONNECTED"}(a||(r.AVP_CONN_STATUS=a={}));var ve;!function(e){e[e.LOGIN_ACCEPT=0]="LOGIN_ACCEPT",e[e.LOGIN_REJECT_UNKNOW_REASON=1]="LOGIN_REJECT_UNKNOW_REASON",e[e.LOGIN_REJECT_NEED_TCP_FIRST=2]="LOGIN_REJECT_NEED_TCP_FIRST",e[e.LOGIN_REJECT_FLOW_CTRL=3]="LOGIN_REJECT_FLOW_CTRL",e[e.LOGIN_REJECT_WRONG_TYPE=4]="LOGIN_REJECT_WRONG_TYPE",e[e.LOGIN_REJECT_ALREADY_LOGINED=5]="LOGIN_REJECT_ALREADY_LOGINED",e[e.LOGIN_REJECT_SAME_EXTERNALUID=6]="LOGIN_REJECT_SAME_EXTERNALUID"}(ve||(ve={}));var me=function(){function e(t,r,i){n(this,e),this.tcpRtt=0,this.tcpNetworkScore=0,this.overallNetworkScore=[],this.localOsDiffTime=0,this.joinChannelResolve=null,this.joinChannelReject=null,this.loginStamp=1,this.globalSeqNum=0,this.historySendBytes=0,this.historyRecvBytes=0,this.audioLevelReporter=new he.default(this),c.default.info("WebRTCMgr constructor appid:"+t),this.webrtc=i,this.logger=i.logger,this.wss=i.wss,this.appid=t,this.pubCodec=r,this.userArea=0,this.profileMgr=new oe.ProfileMgr(this.logger,r),this.publisherMgr=new v.default(this),this.subscriberMgr=new g.default(this),this.reportUserEventMgr=new ue.default(this.userArea,this.logger),this.streamSvr=new ie.default(this),this.checkTimes=0,this.socket=null,this.avpConnStatus=a.INIT,this.mode=0,this.connectCnt=0,this.reconnectCnt=0,this.videoProfile={},this.tokenAuthResult="",this.serverConfig={iceServers:[{urls:["stun:stun.yy.com:3478","stun:stun.yy.com:4578","stun:stun.yy.com:4078","stun:stun.mob.yy.com:3478","stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"},this.overallNetworkScore[0]=0,this.overallNetworkScore[1]=0,this.protoHandlers=new Map,this.protoHandlers.set(T.default.URI_AVP_PLiveLoginAvpProxyRes,this.onLoginAvpRes.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveAvpPingRes,this.onAvpPingRes.bind(this)),this.protoHandlers.set(T.default.URI_WEBRTC_PAnswer,this.onWebRTCAnswer.bind(this)),this.protoHandlers.set(T.default.URI_WEBRTC_PCandidateRes,this.onWebRTCCandidateRes.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveNotifyStreamStatus,this.onNotifyStreamStatus.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveNotifyPublishStatusRes,this.onNotifyPublishStatusRes.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveStopStream,this.onStopStream.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveSubscribeRes,this.onSubscribeGrouRes.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveBizAuthResNotify,this.onBizAuthResNotify.bind(this)),this.protoHandlers.set(T.default.URI_WEBRTC_PEvent,this.onWebRTCEvent.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveSdkAuthResNew,this.onSdkAuthResNew.bind(this)),this.protoHandlers.set(T.default.URI_AVP_PLiveUserBroadCastData,this.onPLiveUserBroadCastData.bind(this)),this.protoHandlers.set(T.default.URI_WEBRTC_PLayerRes,this.onWebRTCLayerRes.bind(this))}return s(e,[{key:"destroy",value:function(){this.logger.info("WebRTCMgr.destroy",!0),this.clearJoinPromise("DESTROY"),this.publisherMgr.destroy(),this.subscriberMgr.destroy(),this.reportUserEventMgr.destroy(),this.streamSvr&&this.streamSvr.stop(),this.timer&&window.clearInterval(this.timer),this.socket&&(this.socket.destroy(),this.socket=null),this.audioLevelReporter.disableIntervalReport()}},{key:"chooseUseArea",value:function(e){var t=2===e?"sslproxy.jocloud.com:4443":"sslproxy-rtc.jocloud.com:4443";this.reconnectCnt>=pe.AdvanceConfig.urlSwitchReconnectCnt&&(t=2===e?"sslproxy-backup.jocloud.com:4443":"sslproxy-rtc-backup.jocloud.com:4443");var r="wss://"+t+"/livesystem/"+this.appid+"_"+this.channelId+".wsspk?uid="+this.uid+"&clientAppid="+this.appid+"&uuid="+Math.floor(1e6*Math.random())+"&clientType=9&cfgK1=2&cfgV1=48&cfgK2=3&cfgV2=3&roomId="+this.channelId+"&sdkVersion="+this.webrtc.git;return this.logger.info("WebRTCMgr.chooseUseArea, wss: "+r+", reconnectCnt:"+this.reconnectCnt,!0),this.wss=r,r}},{key:"reportTcpConnectBehavior",value:function(){this.connectCnt?this.reportUserEventMgr.addEvent(h.LOGLEVEL_ERROR,"room","nt_reconnect_[o]","tcp"):this.reportUserEventMgr.addEvent(h.LOGLEVEL_INFO,"room","nt_connecting_[o]","tcp")}},{key:"reportTcpConnectStat",value:function(e,t){1===this.connectCnt?this.reportUserEventMgr.addEvent(e,"room","nt_connect_"+t+"_[o]","tcp"):this.reportUserEventMgr.addEvent(e,"room","nt_reconnect_"+t+"_[o]","tcp")}},{key:"connectAvp",value:function(){var e=this;this.logger.info("WebRTCMgr.connectAvp",!0),this.chooseUseArea(this.userArea),this.socket&&(this.socket.destroy(),this.socket=null),this.reportTcpConnectBehavior(),this.connectCnt++,this.socket=new f.default(this.wss,this.reconnectCnt+2,this.logger);var t=this.socket;this.socket.on("open",function(){e.onSocketOpen(t)}),this.socket.on("message",function(t,r){e.onMessageRecv(t,r)}),this.socket.on("error",function(){e.socket===t&&e.reportTcpConnectStat(h.LOGLEVEL_ERROR,"failed"),e.onExceptEventHappend(t)}),this.socket.on("close",function(){e.onExceptEventHappend(t)}),this.socket.on("timeout",function(r){e.socket===t&&(e.reconnectCnt++,e.reportTcpConnectStat(h.LOGLEVEL_ERROR,"failed"),e.reportUserEventMgr.addEvent(h.LOGLEVEL_ERROR,"room","nt_connect_cost_timeout_[o]",r.toString())),e.onExceptEventHappend(t)}),this.avpConnStatus=a.CONNECTING,this.tcpRtt=0,this.socket.connect()}},{key:"disconnectAvp",value:function(){this.logger.info("WebRTCMgr.close connect Avp",!0),this.socket&&(this.socket.destroy(),this.socket=null)}},{key:"isAvpConnect",value:function(){return!!this.socket&&this.socket.isConnected()}},{key:"start",value:function(){this.tcpNetworkScore=0,this.connectAvp(),this.timer=setInterval(this.onCheckTimer.bind(this),1e3),this.logger.info("WebRTCMgr.start appid:"+this.appid+", uid:"+this.uid,!0)}},{key:"stop",value:function(){this.logger.info("WebRTCMgr.stop appid:"+this.appid+", uid:"+this.uid,!0),this.tcpNetworkScore=0,this.avpConnStatus=a.INIT,this.disconnectAvp(),this.connectCnt=0,this.reconnectCnt=0,window.clearInterval(this.timer)}},{key:"send",value:function(e){this.socket?this.socket.send(e):this.logger.info("WebRTCMgr.send socket not ready",!0)}},{key:"checkAvpConn",value:function(){this.avpConnStatus==a.DISCONNECTED&&this.connectAvp()}},{key:"checkAvpPing",value:function(e,t){if(this.avpConnStatus==a.LOGIN&&t%2==0){if(this.pingCnt>=11)return this.logger.warn("WebRTCMgr.checkAvpPing ping time out, pingCnt:"+this.pingCnt),this.socket&&this.socket.onclose(),void(this.pingCnt=0);this.logger.debug("WebRTCMgr.sendPing"),this.pingCnt++,this.ping(e)}}},{key:"ping",value:function(e){var t=new R.default;t.appid=this.appid,t.uid=this.uid,t.stampc=e,c.default.debug("WebRTCMgr.ping avp:"+JSON.stringify(t)),this.socket.send(t.marshall())}},{key:"joinChannel",value:function(e,t,r,i){var n=this;if(this.logger.info("WebRTCMgr.joinChannel "+e+" status:"+this.avpConnStatus,!0),this.avpConnStatus===a.LOGIN)return this.reportUserEventMgr.addEvent(h.LOGLEVEL_WARN,"room","join_room_failed_[o]","HAS_JOINED"),Promise.reject("ALREADY_JOINED");if(this.avpConnStatus!=a.INIT)return this.reportUserEventMgr.addEvent(h.LOGLEVEL_WARN,"room","join_room_failed_[o]","IS_JOINING"),Promise.reject("IS_JOINING");0===i?(this.isStrUid=!1,w.default.is32BitNumberString(t)?(this.uid=parseInt(t),this.uidStr=t):(this.uid=w.default.hashUid(t),this.uidStr=this.uid.toString(),this.logger.setUid(this.uidStr),c.default.setUid(this.uidStr),this.logger.warn("32 Bit Number string uid is recommended for group mode"))):(this.isStrUid=!0,this.uidStr=t,this.uid=w.default.hashUid(t)),this.logger.info("WebRTCMgr.joinChannel uidStr:"+this.uidStr+" uid:"+this.uid,!0),this.mode=i,this.token=r,this.channelId=e,this.setChannelStatus();var o={appid:this.appid,scid:"",cn:this.channelId,uid:this.uid,euid:this.uidStr};if(this.reportUserEventMgr.setUserInfo(o),this.reportUserEventMgr.addEvent(h.LOGLEVEL_INFO,"room","join_room"),!ce.default.isSafeAddress())return Promise.reject("UNSAFE_ADDRESS");if(!l.default.isSupported()){var s="UNSUPPORTED_BROWSER";return this.logger.error("WebRTCMgr.joinChannel fail:"+s+", browserType:"+this.webrtc.browserType,!0),this.reportUserEventMgr.addEvent(h.LOGLEVEL_ERROR,"room","join_room_failed_[o]",s),Promise.reject(s)}return this.profileMgr.getWebSingleConfig({appid:this.appid,uid:this.uid,channel_id:this.channelId,userArea:this.userArea,git:this.webrtc.git,sdk_version:this.webrtc.sdkVersion,os:fe.default.os.name,osversion:fe.default.os.version,model:fe.default.name,app_ver:fe.default.major.toString()}),this.start(),new Promise(function(e,t){n.joinChannelResolve=e,n.joinChannelReject=t})}},{key:"setChannelStatus",value:function(){this.groupName="g_"+this.channelId,this.groupKey=String(this.appid)+"_"+String(this.groupName)}},{key:"joined",value:function(){return this.avpConnStatus===a.LOGIN}},{key:"isChannelStatusInit",value:function(){return this.avpConnStatus===a.INIT}},{key:"resetChannelStatus",value:function(){this.uid=void 0,this.uidStr=void 0,this.token="",this.channelId="",this.groupName="",this.groupKey="",this.loginStamp=1}},{key:"resetUid",value:function(){if(this.reportUserEventMgr.addEvent(h.LOGLEVEL_ERROR,"room","reset_uid"),this.reportUserEventMgr.destroy(),this.isStrUid){this.logger.info("WebRTCMgr.resetUid",!0);var e=this.uidStr,t=this.publisherMgr.published;t&&this.publisherMgr.unPublish(),this.disconnectAvp(),this.uid=w.default.hashUid(e+Date.now()),this.setChannelStatus();var r={appid:this.appid,scid:"",cn:this.channelId,uid:this.uid,euid:this.uidStr};this.reportUserEventMgr.setUserInfo(r),this.connectAvp(),t&&this.publisherMgr.publish()}else{var r={appid:this.appid,scid:"",cn:this.channelId,uid:this.uid,euid:this.uidStr};this.reportUserEventMgr.setUserInfo(r)}}},{key:"leaveChannel",value:function(){if(this.reportUserEventMgr.addEvent(h.LOGLEVEL_INFO,"room","leave_room"),this.avpConnStatus===a.INIT){return this.reportUserEventMgr.addEvent(h.LOGLEVEL_WARN,"room","leave_room_failed_[o]","HAS_NOT_JOIN"),{error:"HAS_NOT_JOIN"}}return this.logger.info("WebRTCMgr.leaveChannel",!0),this.clearJoinPromise("CANCEL"),this.publisherMgr.destroy(),this.subscriberMgr.destroy(),this.streamSvr&&this.streamSvr.stop(),this.stop(),this.resetChannelStatus(),this.reportUserEventMgr.addEvent(h.LOGLEVEL_INFO,"room","leave_room_success"),this.reportUserEventMgr.destroy(),null}},{key:"triggerError",value:function(e,t){this.logger.error("event: "+e+", error: "+t),this.webrtc.trigger(e,{appid:this.appid,uid:this.uidStr,error:t})}},{key:"onSocketOpen",value:function(e){this.socket===e&&(this.reportTcpConnectStat(h.LOGLEVEL_INFO,"success"),this.webrtc.trigger("connected",{uid:this.uidStr,roomId:this.channelId,reconnectCnt:this.reconnectCnt}),this.reconnectCnt=0,this.avpConnStatus=a.CONNECTED,this.tcpNetworkScore=0,this.pingCnt=0,this.onLogin(),this.checkSendUpdateToken(this.token),this.subscriberMgr.subscribeMedia())}},{key:"onMessageRecv",value:function(e,t){var r=new O.default(t),i=this.protoHandlers.get(e);if(void 0!==i)i(r);else{if(3841288==e)return;c.default.debug("WebRTCMgr.onData unknown uri="+(e>>8&4294967295)+"/"+(255&e))}}},{key:"onExceptEventHappend",value:function(e){if(this.socket!==e)return void this.logger.debug("WebRTCMgr.onExceptEventHappend with err socket avp status:"+this.avpConnStatus);this.logger.info("WebRTCMgr.onExceptEventHappend avp status:"+this.avpConnStatus,!0),this.socket.destroy(),this.socket=null,this.tcpNetworkScore=6,this.avpConnStatus!==a.LOGIN&&this.avpConnStatus!==a.CONNECTED||(this.webrtc.trigger("network_disconnect",{uid:this.uidStr}),this.webrtc.trigger("reconnect",{uid:this.uidStr,roomId:this.channelId})),this.avpConnStatus!==a.INIT&&(this.avpConnStatus=a.DISCONNECTED)}},{key:"resetMediaStat",value:function(){this.tokenAuthResult=""}},{key:"calTcpNetworkScore",value:function(){var e=1;return this.tcpRtt?this.tcpRtt>50&&this.tcpRtt<=100?e=2:this.tcpRtt>100&&this.tcpRtt<=200?e=3:this.tcpRtt>200&&this.tcpRtt<=300?e=4:this.tcpRtt>300&&(e=5):e=0,c.default.debug("WebRTCMgr.calTcpNetworkScore, tcpRtt:"+this.tcpRtt+", score:"+e),e}},{key:"onCheckTimer",value:function(){var e=S.default.now(),t=S.default.utc();this.checkTimes++,this.checkAvpConn(),this.checkAvpPing(e,this.checkTimes),this.socket&&this.socket.onCheckTimer(e),this.publisherMgr.onCheckTimer(e,t,this.checkTimes),this.subscriberMgr.onCheckTimer(e,t,this.checkTimes),this.reportUserEventMgr.onCheckTimer(),this.audioLevelReporter.onCheckTimer(),t%20==0&&this.resetMediaStat();var r=this.getOverallNetworkScore();t%2==0?(this.overallNetworkScore[0]=0===Math.min(r.uplinkScore,this.overallNetworkScore[0])?0:Math.max(r.uplinkScore,this.overallNetworkScore[0]),this.overallNetworkScore[1]=0===Math.min(r.downlinkScore,this.overallNetworkScore[1])?0:Math.max(r.downlinkScore,this.overallNetworkScore[1]),this.webrtc.trigger("network_score",{uplinkNetworkScore:this.overallNetworkScore[0],downlinkNetworkScore:this.overallNetworkScore[1]}),this.overallNetworkScore[0]=0,this.overallNetworkScore[1]=0):(this.overallNetworkScore[0]=r.uplinkScore,this.overallNetworkScore[1]=r.downlinkScore),this.profileMgr.isDefaultConfig&&t%10==0&&this.profileMgr.getWebSingleConfig({appid:this.appid,uid:this.uid,channel_id:this.channelId,userArea:this.userArea,git:this.webrtc.git,sdk_version:this.webrtc.sdkVersion,os:fe.default.os.name,osversion:fe.default.os.version,model:fe.default.name,app_ver:fe.default.major.toString()})}},{key:"getOverallNetworkScore",value:function(){var e=this.publisherMgr.getNetWorkScore(),t=this.subscriberMgr.networkScore;return this.isAvpConnect()&&(this.tcpNetworkScore=this.calTcpNetworkScore()),this.logger.debug("WebRTCMgr.onCheckTimer, networkScore:{uplink:"+e+", downlink:"+t+", tcpScore:"+this.tcpNetworkScore+"}"),{uplinkScore:null!==e?e:this.tcpNetworkScore,downlinkScore:null!==t?t:this.tcpNetworkScore}}},{key:"onAvpPingRes",value:function(e){var t=new k.default;t.unmarshall(e),c.default.debug("WebRTCMgr pingres:"+JSON.stringify(t)),this.pingCnt=0,this.setClientAddress(t);var r=S.default.now();this.tcpRtt=r-t.stampc;var i=t.stamps+this.tcpRtt/2;this.localOsDiffTime=i-r}},{key:"onLogin",value:function(){var e=new _.default;e.appid=this.appid,e.uid=this.uid,e.sdkVersion=this.webrtc.version,e.channelName=this.channelId,e.localIps=new Uint32Array(1),e.localIps[0]=236120387,e.audioCodecType=new Uint32Array(1),e.audioCodecType[0]=50,e.loginStamp=this.loginStamp,e.apToken=this.token,e.vpToken="",e.proxyType=15,e.externalUid=this.uidStr,this.logger.info("WebRTCMgr try to login:"+JSON.stringify(e),!0),this.send(e.marshall())}},{key:"onLoginAvpRes",value:function(e){var t=new M.default;if(t.unmarshall(e),t.reject===ve.LOGIN_REJECT_ALREADY_LOGINED&&this.isStrUid)return void this.resetUid();if(t.reject>0)return this.logger.warn("WebRTCMgr.onLoginVpRes uid:"+t.uid+" reject:"+t.reject+", socket close...",!0),this.avpConnStatus=a.DISCONNECTED,(t.reject===ve.LOGIN_REJECT_SAME_EXTERNALUID||t.reject===ve.LOGIN_REJECT_ALREADY_LOGINED&&!this.isStrUid)&&this.joinChannelReject?(this.clearJoinPromise("UID_CONFLICT"),void this.leaveChannel()):(this.logger.error("WebRTCMgr.onLoginVpRes, last tcp connection still exists!",!0),void this.clearJoinPromise("AVP_REJECT"));var r=w.default.inetNtoa(t.wlanIp),i=t.wlanPort;this.avpConnStatus!==a.LOGIN&&this.avpConnStatus!==a.INIT&&(this.avpConnStatus=a.LOGIN,this.loginStamp++,this.joinChannelResolve||(0===t.curTcpLoginStamp&&(this.publisherMgr.publishers.size>0&&this.publisherMgr.resetIceConnState("webSocketReset"),this.subscriberMgr.subscribers.size>0&&this.subscriberMgr.resetIceConnState("webSocketReset")),this.subscriberMgr.checkAndSendWebRTCLayer()),this.joinChannelResolve&&this.streamSvr.start(this.channelId),this.clearJoinPromise()),this.logger.info("WebRTCMgr.onLoginVpRes appid:"+t.appid+" uid:"+t.uid+" reject:"+t.reject+" selfIp:"+r+" port:"+i,!0)}},{key:"checkSendUpdateToken",value:function(e){if(!this.joined())return{error:"HAS_NOT_JOIN"};if(e&&""!==e){var t=new z.default;return t.appid=this.appid,t.uid=this.uid,t.token=e,this.send(t.marshall()),null}return{error:"INVALID_TOKEN"}}},{key:"onSubscribeGrouRes",value:function(e){var t=new W.default;t.unmarshall(e),this.logger.info("WebRTCMgr.onSubscribeGrouRes, uid: "+t.uid+", isSub: "+t.subscribe,!0)}},{key:"setClientAddress",value:function(e){e.publishLayerToAddress.size&&this.publisherMgr.setClientAddress(e),e.subscribeUuidToAddress.size&&this.subscriberMgr.setClientAddress(e)}},{key:"onWebRTCAnswer",value:function(e){var t=new B.default;t.unmarshall(e),t.publish?this.publisherMgr.onWebRTCAnswer(t):this.subscriberMgr.onWebRTCAnswer(t)}},{key:"onWebRTCCandidateRes",value:function(e){(new H.default).unmarshall(e)}},{key:"onNotifyStreamStatus",value:function(e){if(this.socket){var t=new N.default;t.unmarshall(e),this.subscriberMgr.onNotifyStreamStatus(t)}}},{key:"onNotifyPublishStatusRes",value:function(e){var t=new V.default;t.unmarshall(e),this.publisherMgr.onNotifyPublishStatusRes(t)}},{key:"onBizAuthResNotify",value:function(e){var t=new q.default;t.unmarshall(e),this.publisherMgr.onBizAuthResNotify(t)}},{key:"onSdkAuthResNew",value:function(e){var t=new Q.default;t.unmarshall(e),this.tokenAuthResult+=t.sdkAuthResult.toString()+"-",t.appid===this.appid&&t.uid===this.uid&&(10005===t.sdkAuthResult&&this.webrtc.trigger("token_request",{uid:this.uidStr}),10007===t.sdkAuthResult&&this.webrtc.trigger("token_will_expire",{uid:this.uidStr,token:this.token}),this.webrtc.trigger("sdk_auth_result",{uid:this.uidStr,result:t.sdkAuthResult}),this.reportUserEventMgr.addEvent(h.LOGLEVEL_INFO,"room","token_auth_result_[o]",t.sdkAuthResult.toString()),0!==t.sdkAuthResult&&this.logger.warn("webrtcmgr.onSdkAuthResNew, appid:"+t.appid+", uid:"+t.uid+", result:"+t.sdkAuthResult,!0))}},{key:"onPLiveUserBroadCastData",value:function(e){var t=new ae.default;t.unmarshall(e),this.subscriberMgr.onPLiveUserBroadCastData(t)}},{key:"onWebRTCEvent",value:function(e){var t=new $.default;t.unmarshall(e),t.publish?this.publisherMgr.onWebRTCEvent(t):this.subscriberMgr.onWebRTCEvent(t)}},{key:"onStopStream",value:function(e){var t=new K.default;t.unmarshall(e),this.subscriberMgr.onStopStream(t)}},{key:"addPublishOriginStreamUrl",value:function(e){return this.joined()?0===this.mode?{error:"NOT_SUPPORTED_IN_GROUP_MODE"}:this.streamSvr.addPublishOriginStreamUrl(e):{error:"HAS_NOT_JOIN"}}},{key:"removePublishOriginStreamUrl",value:function(e){return this.joined()?0===this.mode?{error:"NOT_SUPPORTED_IN_GROUP_MODE"}:this.streamSvr.removePublishOriginStreamUrl(e):{error:"HAS_NOT_JOIN"}}},{key:"addPublishTranscodingStreamUrl",value:function(e,t){return this.joined()?0===this.mode?{error:"NOT_SUPPORTED_IN_GROUP_MODE"}:this.streamSvr.addPublishTranscodingStreamUrl(e,t):{error:"HAS_NOT_JOIN"}}},{key:"removePublishTranscodingStreamUrl",value:function(e,t){return this.joined()?0===this.mode?{error:"NOT_SUPPORTED_IN_GROUP_MODE"}:this.streamSvr.removePublishTranscodingStreamUrl(e,t):{error:"HAS_NOT_JOIN"}}},{key:"checkLiveTranscoding",value:function(e){var t=0;if(!(e instanceof Object))throw"LiveTranscoding should be Object"
;if("number"!=typeof e.transcodingMode)throw"transcodingMode should be number";if(!(e.userList instanceof Array))throw"userList should be Array";var r=!0,i=!1,n=void 0;try{for(var a,o=e.userList[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;if(!(s instanceof Object))throw"userInfo should be Object";if("string"!=typeof s.uid)throw"userInfo.uid should be string";if("string"!=typeof s.roomId)throw"userInfo.roomId should be string";if(void 0!==s.bStandard&&"boolean"!=typeof s.bStandard)throw"userInfo.bStandard should be boolean";if(void 0!==s.layoutX&&"number"!=typeof s.layoutX)throw"userInfo.layoutX should be number";if(void 0!==s.layoutY&&"number"!=typeof s.layoutY)throw"userInfo.layoutY should be number";if(void 0!==s.layoutW&&"number"!=typeof s.layoutW)throw"userInfo.layoutW should be number";if(void 0!==s.layoutH&&"number"!=typeof s.layoutH)throw"userInfo.layoutH should be number";if(void 0!==s.zOrder&&"number"!=typeof s.zOrder)throw"userInfo.zOrder should be number";if(void 0!==s.bCrop&&"number"!=typeof s.bCrop)throw"userInfo.bCrop should be number";if(void 0!==s.cropX&&"number"!=typeof s.cropX)throw"userInfo.cropX should be number";if(void 0!==s.cropY&&"number"!=typeof s.cropY)throw"userInfo.cropY should be number";if(void 0!==s.cropW&&"number"!=typeof s.cropW)throw"userInfo.cropW should be number";if(void 0!==s.cropH&&"number"!=typeof s.cropH)throw"userInfo.cropH should be number";if(void 0!==s.alpha&&"number"!=typeof s.alpha)throw"userInfo.alpha should be number";if(void 0!==s.audioChannel&&"number"!=typeof s.audioChannel)throw"userInfo.audioChannel should be number"}}catch(e){i=!0,n=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}if(e.extConfig){if(!(e.extConfig instanceof Array))throw"extConfig should be Array";var u=!0,l=!1,h=void 0;try{for(var c,d=e.extConfig[Symbol.iterator]();!(u=(c=d.next()).done);u=!0){var f=c.value;if("string"!=typeof f.type)throw"extConfig item type should be string";if(void 0!==f.color&&"string"!=typeof f.color)throw"item.color should be string";if(void 0!==f.image){if(!(f.image instanceof Object))throw"item.image should be Object";if(void 0!==f.image.url&&"string"!=typeof f.image.url)throw"item.image.url should be string";if(void 0!==f.image.scale&&"number"!=typeof f.image.scale)throw"item.image.scale should be number"}if(void 0!==f.timestamp){if(!(f.timestamp instanceof Object))throw"item.timestamp should be Object";if(void 0!==f.timestamp.x&&"number"!=typeof f.timestamp.x)throw"item.timestamp.x should be number";if(void 0!==f.timestamp.y&&"number"!=typeof f.timestamp.y)throw"item.timestamp.y  should be number";if(void 0!==f.timestamp.format&&"string"!=typeof f.timestamp.format)throw"item.timestamp.format should be string";if(void 0!==f.timestamp.font&&"string"!=typeof f.timestamp.font)throw"item.timestamp.font should be string";if(void 0!==f.timestamp.size&&"number"!=typeof f.timestamp.size)throw"item.timestamp.size should be number";if(void 0!==f.timestamp.color&&"string"!=typeof f.timestamp.color)throw"item.timestamp.color should be string";if(void 0!==f.timestamp.backgroundColor&&"string"!=typeof f.timestamp.backgroundColor)throw"item.timestamp.backgroundColor should be string";if(void 0!==f.timestamp.alpha&&"number"!=typeof f.timestamp.alpha)throw"item.timestamp.alpha should be number";t++}if(void 0!==f.textList){if(!(f.textList instanceof Array))throw"item.textList should be Array";var p=!0,v=!1,m=void 0;try{for(var g,y=f.textList[Symbol.iterator]();!(p=(g=y.next()).done);p=!0){var S=g.value;if(!(S instanceof Object))throw"text should be Object";if(void 0!==S.x&&"number"!=typeof S.x)throw"text.x should be number";if(void 0!==S.y&&"number"!=typeof S.y)throw"text.y should be number";if(void 0!==S.content&&"string"!=typeof S.content)throw"text.content should be string";if(void 0!==S.font&&"string"!=typeof S.font)throw"text.font should be string";if(void 0!==S.size&&"number"!=typeof S.size)throw"text.size  should be number";if(void 0!==S.color&&"string"!=typeof S.color)throw"text.color should be string";if(void 0!==S.backgroundColor&&"string"!=typeof S.backgroundColor)throw"text.backgroundColor should be string";if(void 0!==S.alpha&&"number"!=typeof S.alpha)throw"text.alpha should be number";t++}}catch(e){v=!0,m=e}finally{try{!p&&y.return&&y.return()}finally{if(v)throw m}}}if(void 0!==f.imageList){if(!(f.imageList instanceof Array))throw"item.imageList should be Array";var b=!0,_=!1,E=void 0;try{for(var T,I=f.imageList[Symbol.iterator]();!(b=(T=I.next()).done);b=!0){var R=T.value;if(!(R instanceof Object))throw"image should be Object";if(void 0!==R.x&&"number"!=typeof R.x)throw"image.x should be number";if(void 0!==R.y&&"number"!=typeof R.y)throw"image.y  should be number";if(void 0!==R.width&&"number"!=typeof R.width)throw"image.width should be number";if(void 0!==R.height&&"number"!=typeof R.height)throw"image.height should be number";if(void 0!==R.url&&"string"!=typeof R.url)throw"image.url should be string";if(void 0!==R.scale&&"number"!=typeof R.scale)throw"image.scale should be number";if(void 0!==R.alpha&&"number"!=typeof R.alpha)throw"image.alpha should be number";t++}}catch(e){_=!0,E=e}finally{try{!b&&I.return&&I.return()}finally{if(_)throw E}}}}}catch(e){l=!0,h=e}finally{try{!u&&d.return&&d.return()}finally{if(l)throw h}}if(t>8)throw"the number of waterMark is "+t+" (larger than 8). return INVALID_LIVETRANSCODING"}}},{key:"setLiveTranscodingTask",value:function(e,t){if(!this.joined())return{error:"HAS_NOT_JOIN"};if(0===this.mode)return{error:"NOT_SUPPORTED_IN_GROUP_MODE"};try{t=JSON.parse(JSON.stringify(t))}catch(e){return this.logger.warn("invalid json"),{error:"INVALID_LIVETRANSCODING"}}try{this.checkLiveTranscoding(t)}catch(e){return this.logger.warn(e),{error:"INVALID_LIVETRANSCODING"}}return this.streamSvr.setLiveTranscodingTask(e,t)}},{key:"removeLiveTranscodingTask",value:function(e){return this.joined()?0===this.mode?{error:"NOT_SUPPORTED_IN_GROUP_MODE"}:this.streamSvr.removeLiveTranscodingTask(e):{error:"HAS_NOT_JOIN"}}},{key:"addSubscribe",value:function(e,t){return this.joined()?0===this.mode?{error:"NOT_SUPPORTED_IN_GROUP_MODE"}:(this.streamSvr.addSubscribe(e,t),null):{error:"HAS_NOT_JOIN"}}},{key:"removeSubscribe",value:function(e,t){if(!this.joined())return{error:"HAS_NOT_JOIN"};if(e===this.channelId)return this.logger.warn("removeSubscribe() same channelId "+e),{error:"REMOVE_SAME_CHANNEL"};if(0===this.mode)return{error:"NOT_SUPPORTED_IN_GROUP_MODE"};this.streamSvr.removeSubscribe(e,t);var r=this.subscriberMgr.getSubscriberByUidStr(t);return r&&r.destroy(),null}},{key:"startMixing",value:function(e,t){return this.publisherMgr.startMixing(e,t)}},{key:"setPublisherVolume",value:function(e){return this.publisherMgr.setPublishVolume(e)}},{key:"getPublisherAudioLevel",value:function(){return this.publisherMgr?this.publisherMgr.getAudioLevel():0}},{key:"getSubscriberAudioLevel",value:function(e){return this.subscriberMgr?this.subscriberMgr.getAudioLevel(this.appid,e):0}},{key:"setRemoteVideoLayer",value:function(e,t){return this.subscriberMgr.setRemoteVideoLayer(e,t)}},{key:"getUplinkVideoStats",value:function(){var e=new Map;if(this.publisherMgr.hasPublished()){var t=!0,r=!1,i=void 0;try{for(var n,a=this.publisherMgr.publishers.entries()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var s=o(n.value,2),u=s[0],l=s[1],h=l.mediaStatPerSec.data;l.isConnected()&&l.hasVideo&&e.set(u?this.uidStr+"#"+String(u):this.uidStr,{time:String(h.time),rtt:String(h.rtt),networkScore:String(l.networkScore),videoCodec:String(h.videoCodec),videoMuteState:String(this.webrtc.muteState.video),videoResolution:String(h.resolution),videoFrameRate:String(h.videoFrameRate),videoBitRate:String(h.videoBitRate),videoLostRate:String(h.videoLostRate)})}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return{result:e}}return{}}},{key:"getUplinkAudioStats",value:function(){var e=new Map;if(this.publisherMgr.hasPublished()){var t=this.publisherMgr.publishers.get(0),r=t.mediaStatPerSec.data;return t.isConnected()&&t.hasAudio&&e.set(this.uidStr,{time:String(r.time),rtt:String(r.rtt),networkScore:String(t.networkScore),audioCodec:String(r.audioCodec),audioMuteState:String(this.webrtc.muteState.audio),audioLevel:String(r.volume),audioBitRate:String(r.audioBitRate),audioLostRate:String(r.audioLostRate)}),{result:e}}return{}}},{key:"getDownlinkVideoStats",value:function(){var e=new Map;if(0!==this.subscriberMgr.subscribers.size){var t=!0,r=!1,i=void 0;try{for(var n,a=this.subscriberMgr.subscribers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,s=o.mediaStatPerSec.data;o.isConnected()&&o.hasVideo&&e.set(o.pubUidStr,{time:String(s.time),rtt:String(s.rtt),networkScore:String(o.networkScore),videoCodec:String(s.videoCodec),videoResolution:String(s.resolution),videoFrameRate:String(s.videoFrameRate),videoBitRate:String(s.videoBitRate),videoLostRate:String(s.videoLostRate)})}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return{result:e}}return{}}},{key:"getDownlinkAudioStats",value:function(){var e=new Map;if(0!==this.subscriberMgr.subscribers.size){var t=!0,r=!1,i=void 0;try{for(var n,a=this.subscriberMgr.subscribers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,s=o.mediaStatPerSec.data;o.isConnected()&&o.hasAudio&&e.set(o.pubUidStr,{time:String(s.time),rtt:String(s.rtt),networkScore:String(o.networkScore),audioCodec:String(s.audioCodec),audioLevel:String(s.volume),audioBitRate:String(s.audioBitRate),audioLostRate:String(s.audioLostRate)})}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}return{result:e}}return{}}},{key:"getSignalConnectionState",value:function(){return this.avpConnStatus===a.INIT?{result:"disconnected"}:this.isAvpConnect()&&this.avpConnStatus==a.LOGIN&&(0===this.mode||this.streamSvr.apH5&&this.streamSvr.apH5.ready())?{result:"connected"}:{result:"connecting"}}},{key:"getMediaConnectionState",value:function(){var e=new Map,t=new Map;if(this.publisherMgr.hasPublished()){var r=this.publisherMgr.publishers.get(0).isConnected()?"connected":"connecting";e.set(this.uidStr,r)}if(0!==this.subscriberMgr.subscribers.size){var i=!0,n=!1,a=void 0;try{for(var o,s=this.subscriberMgr.subscribers.values()[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var u=o.value,r=u.isConnected()?"connected":"connecting";t.set(u.pubUidStr,r)}}catch(e){n=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw a}}}return{result:{uplinkStateMap:e,downlinkStateMap:t}}}},{key:"getSessionStats",value:function(){var e={sendBitRate:0,sendBytes:this.historySendBytes,recvBitRate:0,recvBytes:this.historyRecvBytes};if(this.publisherMgr.hasPublished()){var t=!0,r=!1,i=void 0;try{for(var n,a=this.publisherMgr.publishers.values()[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,s=o.mediaStatPerSec.data;o.isConnected()&&(e.sendBitRate+=s.videoBitRate+s.audioBitRate,e.sendBytes+=s.videoPacketBytes+s.audioPacketBytes)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}}if(0!==this.subscriberMgr.subscribers.size){var u=!0,l=!1,h=void 0;try{for(var c,d=this.subscriberMgr.subscribers.values()[Symbol.iterator]();!(u=(c=d.next()).done);u=!0){var f=c.value,s=f.mediaStatPerSec.data;f.isConnected()&&(e.recvBitRate+=s.videoBitRate+s.audioBitRate,e.recvBytes+=s.videoPacketBytes+s.audioPacketBytes)}}catch(e){l=!0,h=e}finally{try{!u&&d.return&&d.return()}finally{if(l)throw h}}}return{result:e}}},{key:"play",value:function(e,t,r){var i=this.getUserStreamByUid(e);return i?i.play(e,t,r):Promise.reject("STREAM_NOT_EXISTED")}},{key:"resume",value:function(e){var t=this.getUserStreamByUid(e);return t?t.resume():Promise.reject("STREAM_NOT_EXISTED")}},{key:"setAudioOutputDevice",value:function(e,t){var r=this.getUserStreamByUid(e);return r?r.setAudioOutputDevice(t):Promise.reject("STREAM_NOT_EXISTED")}},{key:"stopPlay",value:function(e){var t=this.getUserStreamByUid(e);return t?t.stopPlay():{error:"STREAM_NOT_EXISTED"}}},{key:"setAudioEnableStatus",value:function(e,t){var r=this.getUserStreamByUid(t);return r?e?r.enableAudio():r.disableAudio():{error:"STREAM_NOT_EXISTED"}}},{key:"setVideoEnableStatus",value:function(e,t){var r=[];if(t===this.uidStr||void 0===t)this.publisherMgr.publishers.forEach(function(e){r.push(e)});else{var i=this.getUserStreamByUid(t);i&&r.push(i)}if(0===r.length)return{error:"STREAM_NOT_EXISTED"};var n=null,a=!0,o=!1,s=void 0;try{for(var u,l=r[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var i=u.value,h=e?i.enableVideo():i.disableVideo();h&&(n=h)}}catch(n){o=!0,s=n}finally{try{!a&&l.return&&l.return()}finally{if(o)throw s}}return n}},{key:"setAudioVolume",value:function(e,t){var r=this.getUserStreamByUid(e);return r?r.setAudioVolume(t):{error:"STREAM_NOT_EXISTED"}}},{key:"hasAudio",value:function(e){var t=this.getUserStreamByUid(e);return!!t&&t.hasAudio}},{key:"hasVideo",value:function(e){var t=this.getUserStreamByUid(e);return!!t&&t.hasVideo}},{key:"isPlaying",value:function(e){var t=this.getUserStreamByUid(e);return!!t&&t.isPlaying}},{key:"getUserStreamByUid",value:function(e){return e===this.uidStr||void 0===e?this.publisherMgr.publishers.get(0):this.subscriberMgr.getSubscriberByUidStr(e)}},{key:"clearJoinPromise",value:function(e){e&&this.joinChannelReject?(this.reportUserEventMgr.addEvent(h.LOGLEVEL_ERROR,"room","join_room_failed_[o]",e),this.joinChannelReject(e)):this.joinChannelResolve&&(this.reportUserEventMgr.addEvent(h.LOGLEVEL_INFO,"room","join_room_success"),this.joinChannelResolve({roomId:this.channelId,uid:this.uidStr})),this.joinChannelResolve=null,this.joinChannelReject=null}},{key:"onWebRTCLayerRes",value:function(e){var t=new te.default;t.unmarshall(e),t.uid===this.uid&&this.subscriberMgr.onWebRTCLayerRes(t)}},{key:"getTrack",value:function(e,t){var r=this.getUserStreamByUid(t);if(r)return"audio"===e?r.audioTrack:r.videoTrack}},{key:"pureAudio",get:function(){return 0===this.mode}}]),e}();r.default=me},{"./AdvanceConfig":1,"./ProfileMgr":3,"./StreamSvr":4,"./protobase/ProtoUnmarshall":22,"./protobase/uri":23,"./protocol/PLiveAvpPing":24,"./protocol/PLiveAvpPingRes":25,"./protocol/PLiveBizAuthResNotify":26,"./protocol/PLiveLoginAvpProxy":27,"./protocol/PLiveLoginAvpProxyRes":28,"./protocol/PLiveNotifyPublishStatusRes":30,"./protocol/PLiveNotifyStreamStatus":31,"./protocol/PLiveSdkAuthResNew":32,"./protocol/PLiveStopStream":34,"./protocol/PLiveSubscribeRes":36,"./protocol/PLiveUpdateToken":37,"./protocol/PLiveUserBroadCastData":38,"./protocol/PWebRTCAnswer":39,"./protocol/PWebRTCCandidateRes":41,"./protocol/PWebRTCEvent":42,"./protocol/PWebRTCLayerRes":44,"./publisherMgr":69,"./socket.io":71,"./stat/ReportUserEventMgr":76,"./subscriberMgr":80,"./utils/AudioLevelReporter":82,"./utils/browser":90,"./utils/logger":91,"./utils/timeUtil":92,"./utils/utils":93,"./webrtc":95}],97:[function(e,t,r){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function n(e){return"function"==typeof e}function a(e){return"number"==typeof e}function o(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}t.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(e){if(!a(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},i.prototype.emit=function(e){var t,r,i,a,u,l;if(this._events||(this._events={}),"error"===e&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(r=this._events[e],s(r))return!1;if(n(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:for(i=arguments.length,a=new Array(i-1),u=1;u<i;u++)a[u-1]=arguments[u];r.apply(this,a)}else if(o(r)){for(i=arguments.length,a=new Array(i-1),u=1;u<i;u++)a[u-1]=arguments[u];for(l=r.slice(),i=l.length,u=0;u<i;u++)l[u].apply(this,a)}return!0},i.prototype.addListener=function(e,t){var r;if(!n(t))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,n(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,o(this._events[e])&&!this._events[e].warned){var r;r=s(this._maxListeners)?i.defaultMaxListeners:this._maxListeners,r&&r>0&&this._events[e].length>r&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())}return this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(e,t){function r(){this.removeListener(e,r),i||(i=!0,t.apply(this,arguments))}if(!n(t))throw TypeError("listener must be a function");var i=!1;return r.listener=t,this.on(e,r),this},i.prototype.removeListener=function(e,t){var r,i,a,s;if(!n(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(r=this._events[e],a=r.length,i=-1,r===t||n(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(o(r)){for(s=a;s-- >0;)if(r[s]===t||r[s].listener&&r[s].listener===t){i=s;break}if(i<0)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},i.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[e],n(r))this.removeListener(e,r);else for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},i.prototype.listeners=function(e){return this._events&&this._events[e]?n(this._events[e])?[this._events[e]]:this._events[e].slice():[]},i.listenerCount=function(e,t){return e._events&&e._events[t]?n(e._events[t])?1:e._events[t].length:0}},{}],98:[function(e,t,r){function i(e,t,r){this.low=0|e,this.high=0|t,this.unsigned=!!r}function n(e){return!0===(e&&e.__isLong__)}function a(e,t){var r,i,n;return t?(e>>>=0,(n=0<=e&&e<256)&&(i=d[e])?i:(r=s(e,(0|e)<0?-1:0,!0),n&&(d[e]=r),r)):(e|=0,(n=-128<=e&&e<128)&&(i=c[e])?i:(r=s(e,e<0?-1:0,!1),n&&(c[e]=r),r))}function o(e,t){if(isNaN(e))return t?S:y;if(t){if(e<0)return S;if(e>=v)return I}else{if(e<=-m)return R;if(e+1>=m)return T}return e<0?o(-e,t).neg():s(e%p|0,e/p|0,t)}function s(e,t,r){return new i(e,t,r)}function u(e,t,r){if(0===e.length)throw Error("empty string");if("NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return y;if("number"==typeof t?(r=t,t=!1):t=!!t,(r=r||10)<2||36<r)throw RangeError("radix");var i;if((i=e.indexOf("-"))>0)throw Error("interior hyphen");if(0===i)return u(e.substring(1),t,r).neg();for(var n=o(f(r,8)),a=y,s=0;s<e.length;s+=8){var l=Math.min(8,e.length-s),h=parseInt(e.substring(s,s+l),r);if(l<8){var c=o(f(r,l));a=a.mul(c).add(o(h))}else a=a.mul(n),a=a.add(o(h))}return a.unsigned=t,a}function l(e,t){return"number"==typeof e?o(e,t):"string"==typeof e?u(e,t):s(e.low,e.high,"boolean"==typeof t?t:e.unsigned)}t.exports=i;var h=null;try{h=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(e){}i.prototype.__isLong__,Object.defineProperty(i.prototype,"__isLong__",{value:!0}),i.isLong=n;var c={},d={};i.fromInt=a,i.fromNumber=o,i.fromBits=s;var f=Math.pow;i.fromString=u,i.fromValue=l;var p=4294967296,v=p*p,m=v/2,g=a(1<<24),y=a(0);i.ZERO=y;var S=a(0,!0);i.UZERO=S;var b=a(1);i.ONE=b;var _=a(1,!0);i.UONE=_;var E=a(-1);i.NEG_ONE=E;var T=s(-1,2147483647,!1);i.MAX_VALUE=T;var I=s(-1,-1,!0);i.MAX_UNSIGNED_VALUE=I;var R=s(0,-2147483648,!1);i.MIN_VALUE=R;var A=i.prototype;A.toInt=function(){return this.unsigned?this.low>>>0:this.low},A.toNumber=function(){return this.unsigned?(this.high>>>0)*p+(this.low>>>0):this.high*p+(this.low>>>0)},A.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(R)){var t=o(e),r=this.div(t),i=r.mul(t).sub(this);return r.toString(e)+i.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var n=o(f(e,6),this.unsigned),a=this,s="";;){var u=a.div(n),l=a.sub(u.mul(n)).toInt()>>>0,h=l.toString(e);if(a=u,a.isZero())return h+s;for(;h.length<6;)h="0"+h;s=""+h+s}},A.getHighBits=function(){return this.high},A.getHighBitsUnsigned=function(){return this.high>>>0},A.getLowBits=function(){return this.low},A.getLowBitsUnsigned=function(){return this.low>>>0},A.getNumBitsAbs=function(){if(this.isNegative())return this.eq(R)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;t>0&&0==(e&1<<t);t--);return 0!=this.high?t+33:t+1},A.isZero=function(){return 0===this.high&&0===this.low},A.eqz=A.isZero,A.isNegative=function(){return!this.unsigned&&this.high<0},A.isPositive=function(){return this.unsigned||this.high>=0},A.isOdd=function(){return 1==(1&this.low)},A.isEven=function(){return 0==(1&this.low)},A.equals=function(e){return n(e)||(e=l(e)),(this.unsigned===e.unsigned||this.high>>>31!=1||e.high>>>31!=1)&&(this.high===e.high&&this.low===e.low)},A.eq=A.equals,A.notEquals=function(e){return!this.eq(e)},A.neq=A.notEquals,A.ne=A.notEquals,A.lessThan=function(e){return this.comp(e)<0},A.lt=A.lessThan,A.lessThanOrEqual=function(e){return this.comp(e)<=0},A.lte=A.lessThanOrEqual,A.le=A.lessThanOrEqual,A.greaterThan=function(e){return this.comp(e)>0},A.gt=A.greaterThan,A.greaterThanOrEqual=function(e){return this.comp(e)>=0},A.gte=A.greaterThanOrEqual,A.ge=A.greaterThanOrEqual,A.compare=function(e){if(n(e)||(e=l(e)),this.eq(e))return 0;var t=this.isNegative(),r=e.isNegative();return t&&!r?-1:!t&&r?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},A.comp=A.compare,A.negate=function(){return!this.unsigned&&this.eq(R)?R:this.not().add(b)},A.neg=A.negate,A.add=function(e){n(e)||(e=l(e));var t=this.high>>>16,r=65535&this.high,i=this.low>>>16,a=65535&this.low,o=e.high>>>16,u=65535&e.high,h=e.low>>>16,c=65535&e.low,d=0,f=0,p=0,v=0;return v+=a+c,p+=v>>>16,v&=65535,p+=i+h,f+=p>>>16,p&=65535,f+=r+u,d+=f>>>16,f&=65535,d+=t+o,d&=65535,s(p<<16|v,d<<16|f,this.unsigned)},A.subtract=function(e){return n(e)||(e=l(e)),this.add(e.neg())},A.sub=A.subtract,A.multiply=function(e){if(this.isZero())return y;if(n(e)||(e=l(e)),h){return s(h.mul(this.low,this.high,e.low,e.high),h.get_high(),this.unsigned)}if(e.isZero())return y;if(this.eq(R))return e.isOdd()?R:y;if(e.eq(R))return this.isOdd()?R:y;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(g)&&e.lt(g))return o(this.toNumber()*e.toNumber(),this.unsigned);var t=this.high>>>16,r=65535&this.high,i=this.low>>>16,a=65535&this.low,u=e.high>>>16,c=65535&e.high,d=e.low>>>16,f=65535&e.low,p=0,v=0,m=0,S=0;return S+=a*f,m+=S>>>16,S&=65535,m+=i*f,v+=m>>>16,m&=65535,m+=a*d,v+=m>>>16,m&=65535,v+=r*f,p+=v>>>16,v&=65535,v+=i*d,p+=v>>>16,v&=65535,v+=a*c,p+=v>>>16,v&=65535,p+=t*f+r*d+i*c+a*u,p&=65535,s(m<<16|S,p<<16|v,this.unsigned)},A.mul=A.multiply,A.divide=function(e){if(n(e)||(e=l(e)),e.isZero())throw Error("division by zero");if(h){if(!this.unsigned&&-2147483648===this.high&&-1===e.low&&-1===e.high)return this;return s((this.unsigned?h.div_u:h.div_s)(this.low,this.high,e.low,e.high),h.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?S:y;var t,r,i;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return S;if(e.gt(this.shru(1)))return _;i=S}else{if(this.eq(R)){if(e.eq(b)||e.eq(E))return R;if(e.eq(R))return b;return t=this.shr(1).div(e).shl(1),t.eq(y)?e.isNegative()?b:E:(r=this.sub(e.mul(t)),i=t.add(r.div(e)))}if(e.eq(R))return this.unsigned?S:y;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();i=y}for(r=this;r.gte(e);){t=Math.max(1,Math.floor(r.toNumber()/e.toNumber()));for(var a=Math.ceil(Math.log(t)/Math.LN2),u=a<=48?1:f(2,a-48),c=o(t),d=c.mul(e);d.isNegative()||d.gt(r);)t-=u,c=o(t,this.unsigned),d=c.mul(e);c.isZero()&&(c=b),i=i.add(c),r=r.sub(d)}return i},A.div=A.divide,A.modulo=function(e){if(n(e)||(e=l(e)),h){return s((this.unsigned?h.rem_u:h.rem_s)(this.low,this.high,e.low,e.high),h.get_high(),this.unsigned)}return this.sub(this.div(e).mul(e))},A.mod=A.modulo,A.rem=A.modulo,A.not=function(){return s(~this.low,~this.high,this.unsigned)},A.and=function(e){return n(e)||(e=l(e)),s(this.low&e.low,this.high&e.high,this.unsigned)},A.or=function(e){return n(e)||(e=l(e)),s(this.low|e.low,this.high|e.high,this.unsigned)},A.xor=function(e){return n(e)||(e=l(e)),s(this.low^e.low,this.high^e.high,this.unsigned)},A.shiftLeft=function(e){return n(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?s(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):s(0,this.low<<e-32,this.unsigned)},A.shl=A.shiftLeft,A.shiftRight=function(e){return n(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?s(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):s(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},A.shr=A.shiftRight,A.shiftRightUnsigned=function(e){if(n(e)&&(e=e.toInt()),0===(e&=63))return this;var t=this.high;if(e<32){return s(this.low>>>e|t<<32-e,t>>>e,this.unsigned)}return 32===e?s(t,0,this.unsigned):s(t>>>e-32,0,this.unsigned)},A.shru=A.shiftRightUnsigned,A.shr_u=A.shiftRightUnsigned,A.toSigned=function(){return this.unsigned?s(this.low,this.high,!1):this},A.toUnsigned=function(){return this.unsigned?this:s(this.low,this.high,!0)},A.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},A.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24,255&e,e>>>8&255,e>>>16&255,e>>>24]},A.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,255&e,t>>>24,t>>>16&255,t>>>8&255,255&t]},i.fromBytes=function(e,t,r){return r?i.fromBytesLE(e,t):i.fromBytesBE(e,t)},i.fromBytesLE=function(e,t){return new i(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},i.fromBytesBE=function(e,t){return new i(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)}},{}]},{},[95])(95)});
